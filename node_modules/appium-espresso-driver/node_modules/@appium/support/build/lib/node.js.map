{"version":3,"file":"node.js","names":["ECMA_SIZES","Object","freeze","STRING","BOOLEAN","NUMBER","linkGlobalPackage","packageName","log","debug","cmd","isWindows","exec","timeout","err","msg","message","stderr","Error","requirePackage","require","globalPackageName","path","resolve","process","env","npm_config_prefix","errorAndThrow","extractAllProperties","obj","stringProperties","prop","push","_","isFunction","getOwnPropertySymbols","_getSizeOfObject","seen","object","isNil","bytes","properties","key","has","add","getCalculator","ex","RangeError","calculator","isBuffer","length","Symbol","keyFor","toString","isArray","map","reduce","acc","curr","getObjectSize","WeakSet","OBJECTS_MAPPING","WeakMap","getObjectId","set","uuidV4","get","deepFreeze","propNames","getOwnPropertyNames","ign","name","value","getModuleRootSync","moduleName","filePath","currentDir","dirname","isAtFsRoot","manifestPath","join","_fs","existsSync","JSON","parse","readFileSync"],"sources":["../../lib/node.js"],"sourcesContent":["import {isWindows} from './system';\nimport log from './logger';\nimport _ from 'lodash';\nimport {exec} from 'teen_process';\nimport path from 'path';\nimport _fs from 'fs';\nimport {v4 as uuidV4} from 'uuid';\n\nconst ECMA_SIZES = Object.freeze({\n  STRING: 2,\n  BOOLEAN: 4,\n  NUMBER: 8,\n});\n\n/**\n * Internal utility to link global package to local context\n *\n * @param {string} packageName - name of the package to link\n * @throws {Error} If the command fails\n */\nasync function linkGlobalPackage(packageName) {\n  try {\n    log.debug(`Linking package '${packageName}'`);\n    const cmd = isWindows() ? 'npm.cmd' : 'npm';\n    await exec(cmd, ['link', packageName], {timeout: 20000});\n  } catch (err) {\n    const msg = `Unable to load package '${packageName}', linking failed: ${err.message}`;\n    log.debug(msg);\n    if (err.stderr) {\n      // log the stderr if there, but do not add to thrown error as it is\n      // _very_ verbose\n      log.debug(err.stderr);\n    }\n    throw new Error(msg);\n  }\n}\n\n/**\n * Utility function to extend node functionality, allowing us to require\n * modules that are installed globally. If the package cannot be required,\n * this will attempt to link the package and then re-require it\n *\n * @param {string} packageName - the name of the package to be required\n * @returns {Promise<unknown>} - the package object\n * @throws {Error} If the package is not found locally or globally\n */\nasync function requirePackage(packageName) {\n  // first, get it in the normal way (see https://nodejs.org/api/modules.html#modules_all_together)\n  try {\n    log.debug(`Loading local package '${packageName}'`);\n    return require(packageName);\n  } catch (err) {\n    log.debug(`Failed to load local package '${packageName}': ${err.message}`);\n  }\n\n  // second, get it from where it ought to be in the global node_modules\n  try {\n    const globalPackageName = path.resolve(\n      process.env.npm_config_prefix ?? '',\n      'lib',\n      'node_modules',\n      packageName\n    );\n    log.debug(`Loading global package '${globalPackageName}'`);\n    return require(globalPackageName);\n  } catch (err) {\n    log.debug(`Failed to load global package '${packageName}': ${err.message}`);\n  }\n\n  // third, link the file and get locally\n  try {\n    await linkGlobalPackage(packageName);\n    log.debug(`Retrying load of linked package '${packageName}'`);\n    return require(packageName);\n  } catch (err) {\n    log.errorAndThrow(`Unable to load package '${packageName}': ${err.message}`);\n  }\n}\n\nfunction extractAllProperties(obj) {\n  const stringProperties = [];\n  for (const prop in obj) {\n    stringProperties.push(prop);\n  }\n  if (_.isFunction(Object.getOwnPropertySymbols)) {\n    stringProperties.push(...Object.getOwnPropertySymbols(obj));\n  }\n  return stringProperties;\n}\n\nfunction _getSizeOfObject(seen, object) {\n  if (_.isNil(object)) {\n    return 0;\n  }\n\n  let bytes = 0;\n  const properties = extractAllProperties(object);\n  for (const key of properties) {\n    // Do not recalculate circular references\n    if (typeof object[key] === 'object' && !_.isNil(object[key])) {\n      if (seen.has(object[key])) {\n        continue;\n      }\n      seen.add(object[key]);\n    }\n\n    bytes += getCalculator(seen)(key);\n    try {\n      bytes += getCalculator(seen)(object[key]);\n    } catch (ex) {\n      if (ex instanceof RangeError) {\n        // circular reference detected, final result might be incorrect\n        // let's be nice and not throw an exception\n        bytes = 0;\n      }\n    }\n  }\n\n  return bytes;\n}\n\nfunction getCalculator(seen) {\n  return function calculator(obj) {\n    if (_.isBuffer(obj)) {\n      return obj.length;\n    }\n\n    switch (typeof obj) {\n      case 'string':\n        return obj.length * ECMA_SIZES.STRING;\n      case 'boolean':\n        return ECMA_SIZES.BOOLEAN;\n      case 'number':\n        return ECMA_SIZES.NUMBER;\n      case 'symbol':\n        return _.isFunction(Symbol.keyFor) && Symbol.keyFor(obj)\n          ? /** @type {string} */ (Symbol.keyFor(obj)).length * ECMA_SIZES.STRING\n          : (obj.toString().length - 8) * ECMA_SIZES.STRING;\n      case 'object':\n        return _.isArray(obj)\n          ? obj.map(getCalculator(seen)).reduce((acc, curr) => acc + curr, 0)\n          : _getSizeOfObject(seen, obj);\n      default:\n        return 0;\n    }\n  };\n}\n\n/**\n * Calculate the in-depth size in memory of the provided object.\n * The original implementation is borrowed from https://github.com/miktam/sizeof.\n *\n * @param {*} obj An object whose size should be calculated\n * @returns {number} Object size in bytes.\n */\nfunction getObjectSize(obj) {\n  return getCalculator(new WeakSet())(obj);\n}\n\nconst OBJECTS_MAPPING = new WeakMap();\n\n/**\n * Calculates a unique object identifier\n *\n * @param {object} object Any valid ECMA object\n * @returns {string} A uuidV4 string that uniquely identifies given object\n */\nfunction getObjectId(object) {\n  if (!OBJECTS_MAPPING.has(object)) {\n    OBJECTS_MAPPING.set(object, uuidV4());\n  }\n  return OBJECTS_MAPPING.get(object);\n}\n\n/**\n * Perform deep freeze of the given object (e. g.\n * all nested objects also become immutable).\n * If the passed object is of a plain type\n * then no change is done and the same object\n * is returned.\n * ! This function changes the given object,\n * so it becomes immutable.\n *\n * @param {*} object Any valid ECMA object\n * @returns {*} The same object that was passed to the\n * function after it was made immutable.\n */\nfunction deepFreeze(object) {\n  let propNames;\n  try {\n    propNames = Object.getOwnPropertyNames(object);\n  } catch (ign) {\n    return object;\n  }\n  for (const name of propNames) {\n    const value = object[name];\n    if (value && typeof value === 'object') {\n      deepFreeze(value);\n    }\n  }\n  return Object.freeze(object);\n}\n\n/**\n * Tries to synchronously detect the absolute path to the folder\n * where the given `moduleName` is located.\n *\n * @param {string} moduleName The name of the module as it is written in package.json\n * @param {string} filePath Full path to any of files that `moduleName` contains. Use\n * `__filename` to find the root of the module where this helper is called.\n * @returns {string?} Full path to the module root\n */\nfunction getModuleRootSync (moduleName, filePath) {\n  let currentDir = path.dirname(path.resolve(filePath));\n  let isAtFsRoot = false;\n  while (!isAtFsRoot) {\n    const manifestPath = path.join(currentDir, 'package.json');\n    try {\n      if (_fs.existsSync(manifestPath) &&\n          JSON.parse(_fs.readFileSync(manifestPath, 'utf8')).name === moduleName) {\n        return currentDir;\n      }\n    } catch (ign) {}\n    currentDir = path.dirname(currentDir);\n    isAtFsRoot = currentDir.length <= path.dirname(currentDir).length;\n  }\n  return null;\n}\n\nexport {requirePackage, getObjectSize, getObjectId, deepFreeze, getModuleRootSync};\n"],"mappings":"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"}