{"version":3,"file":"middleware.js","names":["allowCrossDomain","req","res","next","header","method","sendStatus","err","log","error","stack","allowCrossDomainAsyncExecute","basePath","receiveAsyncResponseRegExp","RegExp","_","escapeRegExp","test","url","fixPythonContentType","path","headers","defaultToJSONContentType","catchAllHandler","headersSent","message","errors","UnknownError","status","w3cStatus","json","patchWithSessionId","code","value","stacktrace","catch404Handler","debug","UnknownCommandError","SESSION_ID_PATTERN","body","match","exec","sessionId"],"sources":["../../../lib/express/middleware.js"],"sourcesContent":["import _ from 'lodash';\nimport log from './logger';\nimport {errors} from '../protocol';\nimport {handleIdempotency} from './idempotency';\n\nfunction allowCrossDomain(req, res, next) {\n  try {\n    res.header('Access-Control-Allow-Origin', '*');\n    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, OPTIONS, DELETE');\n    res.header(\n      'Access-Control-Allow-Headers',\n      'Cache-Control, Pragma, Origin, X-Requested-With, Content-Type, Accept, User-Agent'\n    );\n\n    // need to respond 200 to OPTIONS\n    if ('OPTIONS' === req.method) {\n      return res.sendStatus(200);\n    }\n  } catch (err) {\n    log.error(`Unexpected error: ${err.stack}`);\n  }\n  next();\n}\n\nfunction allowCrossDomainAsyncExecute(basePath) {\n  return (req, res, next) => {\n    // there are two paths for async responses, so cover both\n    // https://regex101.com/r/txYiEz/1\n    const receiveAsyncResponseRegExp = new RegExp(\n      `${_.escapeRegExp(basePath)}/session/[a-f0-9-]+/(appium/)?receive_async_response`\n    );\n    if (!receiveAsyncResponseRegExp.test(req.url)) {\n      return next();\n    }\n    allowCrossDomain(req, res, next);\n  };\n}\n\nfunction fixPythonContentType(basePath) {\n  return (req, res, next) => {\n    // hack because python client library gives us wrong content-type\n    if (\n      new RegExp(`^${_.escapeRegExp(basePath)}`).test(req.path) &&\n      /^Python/.test(req.headers['user-agent'])\n    ) {\n      if (req.headers['content-type'] === 'application/x-www-form-urlencoded') {\n        req.headers['content-type'] = 'application/json; charset=utf-8';\n      }\n    }\n    next();\n  };\n}\n\nfunction defaultToJSONContentType(req, res, next) {\n  if (!req.headers['content-type']) {\n    req.headers['content-type'] = 'application/json; charset=utf-8';\n  }\n  next();\n}\n\nfunction catchAllHandler(err, req, res, next) {\n  if (res.headersSent) {\n    return next(err);\n  }\n\n  log.error(`Uncaught error: ${err.message}`);\n  log.error('Sending generic error response');\n  const error = errors.UnknownError;\n  res.status(error.w3cStatus()).json(\n    patchWithSessionId(req, {\n      status: error.code(),\n      value: {\n        error: error.error(),\n        message: `An unknown server-side error occurred while processing the command: ${err.message}`,\n        stacktrace: err.stack,\n      },\n    })\n  );\n  log.error(err);\n}\n\nfunction catch404Handler(req, res) {\n  log.debug(`No route found for ${req.url}`);\n  const error = errors.UnknownCommandError;\n  res.status(error.w3cStatus()).json(\n    patchWithSessionId(req, {\n      status: error.code(),\n      value: {\n        error: error.error(),\n        message:\n          'The requested resource could not be found, or a request was ' +\n          'received using an HTTP method that is not supported by the mapped ' +\n          'resource',\n        stacktrace: '',\n      },\n    })\n  );\n}\n\nconst SESSION_ID_PATTERN = /\\/session\\/([^/]+)/;\n\nfunction patchWithSessionId(req, body) {\n  const match = SESSION_ID_PATTERN.exec(req.url);\n  if (match) {\n    body.sessionId = match[1];\n  }\n  return body;\n}\n\nexport {\n  allowCrossDomain,\n  fixPythonContentType,\n  defaultToJSONContentType,\n  catchAllHandler,\n  allowCrossDomainAsyncExecute,\n  handleIdempotency,\n  catch404Handler,\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;;;AAEA,SAASA,gBAAT,CAA0BC,GAA1B,EAA+BC,GAA/B,EAAoCC,IAApC,EAA0C;EACxC,IAAI;IACFD,GAAG,CAACE,MAAJ,CAAW,6BAAX,EAA0C,GAA1C;IACAF,GAAG,CAACE,MAAJ,CAAW,8BAAX,EAA2C,iCAA3C;IACAF,GAAG,CAACE,MAAJ,CACE,8BADF,EAEE,mFAFF;;IAMA,IAAI,cAAcH,GAAG,CAACI,MAAtB,EAA8B;MAC5B,OAAOH,GAAG,CAACI,UAAJ,CAAe,GAAf,CAAP;IACD;EACF,CAZD,CAYE,OAAOC,GAAP,EAAY;IACZC,eAAA,CAAIC,KAAJ,CAAW,qBAAoBF,GAAG,CAACG,KAAM,EAAzC;EACD;;EACDP,IAAI;AACL;;AAED,SAASQ,4BAAT,CAAsCC,QAAtC,EAAgD;EAC9C,OAAO,CAACX,GAAD,EAAMC,GAAN,EAAWC,IAAX,KAAoB;IAGzB,MAAMU,0BAA0B,GAAG,IAAIC,MAAJ,CAChC,GAAEC,eAAA,CAAEC,YAAF,CAAeJ,QAAf,CAAyB,sDADK,CAAnC;;IAGA,IAAI,CAACC,0BAA0B,CAACI,IAA3B,CAAgChB,GAAG,CAACiB,GAApC,CAAL,EAA+C;MAC7C,OAAOf,IAAI,EAAX;IACD;;IACDH,gBAAgB,CAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,CAAhB;EACD,CAVD;AAWD;;AAED,SAASgB,oBAAT,CAA8BP,QAA9B,EAAwC;EACtC,OAAO,CAACX,GAAD,EAAMC,GAAN,EAAWC,IAAX,KAAoB;IAEzB,IACE,IAAIW,MAAJ,CAAY,IAAGC,eAAA,CAAEC,YAAF,CAAeJ,QAAf,CAAyB,EAAxC,EAA2CK,IAA3C,CAAgDhB,GAAG,CAACmB,IAApD,KACA,UAAUH,IAAV,CAAehB,GAAG,CAACoB,OAAJ,CAAY,YAAZ,CAAf,CAFF,EAGE;MACA,IAAIpB,GAAG,CAACoB,OAAJ,CAAY,cAAZ,MAAgC,mCAApC,EAAyE;QACvEpB,GAAG,CAACoB,OAAJ,CAAY,cAAZ,IAA8B,iCAA9B;MACD;IACF;;IACDlB,IAAI;EACL,CAXD;AAYD;;AAED,SAASmB,wBAAT,CAAkCrB,GAAlC,EAAuCC,GAAvC,EAA4CC,IAA5C,EAAkD;EAChD,IAAI,CAACF,GAAG,CAACoB,OAAJ,CAAY,cAAZ,CAAL,EAAkC;IAChCpB,GAAG,CAACoB,OAAJ,CAAY,cAAZ,IAA8B,iCAA9B;EACD;;EACDlB,IAAI;AACL;;AAED,SAASoB,eAAT,CAAyBhB,GAAzB,EAA8BN,GAA9B,EAAmCC,GAAnC,EAAwCC,IAAxC,EAA8C;EAC5C,IAAID,GAAG,CAACsB,WAAR,EAAqB;IACnB,OAAOrB,IAAI,CAACI,GAAD,CAAX;EACD;;EAEDC,eAAA,CAAIC,KAAJ,CAAW,mBAAkBF,GAAG,CAACkB,OAAQ,EAAzC;;EACAjB,eAAA,CAAIC,KAAJ,CAAU,gCAAV;;EACA,MAAMA,KAAK,GAAGiB,gBAAA,CAAOC,YAArB;EACAzB,GAAG,CAAC0B,MAAJ,CAAWnB,KAAK,CAACoB,SAAN,EAAX,EAA8BC,IAA9B,CACEC,kBAAkB,CAAC9B,GAAD,EAAM;IACtB2B,MAAM,EAAEnB,KAAK,CAACuB,IAAN,EADc;IAEtBC,KAAK,EAAE;MACLxB,KAAK,EAAEA,KAAK,CAACA,KAAN,EADF;MAELgB,OAAO,EAAG,uEAAsElB,GAAG,CAACkB,OAAQ,EAFvF;MAGLS,UAAU,EAAE3B,GAAG,CAACG;IAHX;EAFe,CAAN,CADpB;;EAUAF,eAAA,CAAIC,KAAJ,CAAUF,GAAV;AACD;;AAED,SAAS4B,eAAT,CAAyBlC,GAAzB,EAA8BC,GAA9B,EAAmC;EACjCM,eAAA,CAAI4B,KAAJ,CAAW,sBAAqBnC,GAAG,CAACiB,GAAI,EAAxC;;EACA,MAAMT,KAAK,GAAGiB,gBAAA,CAAOW,mBAArB;EACAnC,GAAG,CAAC0B,MAAJ,CAAWnB,KAAK,CAACoB,SAAN,EAAX,EAA8BC,IAA9B,CACEC,kBAAkB,CAAC9B,GAAD,EAAM;IACtB2B,MAAM,EAAEnB,KAAK,CAACuB,IAAN,EADc;IAEtBC,KAAK,EAAE;MACLxB,KAAK,EAAEA,KAAK,CAACA,KAAN,EADF;MAELgB,OAAO,EACL,iEACA,oEADA,GAEA,UALG;MAMLS,UAAU,EAAE;IANP;EAFe,CAAN,CADpB;AAaD;;AAED,MAAMI,kBAAkB,GAAG,oBAA3B;;AAEA,SAASP,kBAAT,CAA4B9B,GAA5B,EAAiCsC,IAAjC,EAAuC;EACrC,MAAMC,KAAK,GAAGF,kBAAkB,CAACG,IAAnB,CAAwBxC,GAAG,CAACiB,GAA5B,CAAd;;EACA,IAAIsB,KAAJ,EAAW;IACTD,IAAI,CAACG,SAAL,GAAiBF,KAAK,CAAC,CAAD,CAAtB;EACD;;EACD,OAAOD,IAAP;AACD"}