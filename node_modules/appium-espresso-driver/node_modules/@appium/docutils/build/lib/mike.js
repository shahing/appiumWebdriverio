"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Mike = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("./logger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_REMOTE = 'origin';
const DEFAULT_BRANCH = 'gh-pages';
const MIKE_VER_STRING = 'mike 1.';

class Mike {
  remote;
  branch;
  prefix;
  configFile;
  _mikeVerified = false;

  constructor(opts) {
    this.remote = opts.remote || DEFAULT_REMOTE;
    this.branch = opts.branch || DEFAULT_BRANCH;
    this.prefix = opts.prefix;
    this.configFile = opts.configFile;
  }

  async verifyMike() {
    if (this._mikeVerified) {
      return;
    }

    try {
      const {
        stdout
      } = await this.exec('--version', [], false);

      if (!stdout.includes(MIKE_VER_STRING)) {
        throw new Error('Mike was installed but was not version 1.x');
      }
    } catch (err) {
      throw new Error(`Could not verify appropriate mike binary exists: ${err}`);
    }

    this._mikeVerified = true;
  }

  getMikeArgs(cmdName, cmdArgs) {
    return [cmdName, ...cmdArgs, '--config-file', this.configFile, '--remote', this.remote, '--branch', this.branch, '--prefix', this.prefix];
  }

  async exec(mikeCmd, mikeArgs = [], verify = true) {
    if (verify) {
      await this.verifyMike();
    }

    const args = this.getMikeArgs(mikeCmd, mikeArgs);

    _logger.default.debug(`Running mike ${args.join(' ')}`);

    return await (0, _teen_process.exec)('mike', args);
  }

  async list() {
    const {
      stdout
    } = await this.exec('list');
    return stdout.split('\n').map(s => s.trim()).filter(Boolean);
  }

  async setDefault(alias) {
    await this.exec('set-default', [alias]);
  }

  async deploy(opts) {
    const args = [opts.version];

    if (opts.alias) {
      args.push(opts.alias, '--update-aliases');
    }

    if (opts.shouldPush) {
      args.push('--push');
    }

    if (opts.shouldRebase) {
      args.push('--rebase');
    }

    if (opts.commit) {
      args.push('--message', opts.commit);
    }

    await this.exec('deploy', args);
  }

}

exports.Mike = Mike;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJERUZBVUxUX1JFTU9URSIsIkRFRkFVTFRfQlJBTkNIIiwiTUlLRV9WRVJfU1RSSU5HIiwiTWlrZSIsInJlbW90ZSIsImJyYW5jaCIsInByZWZpeCIsImNvbmZpZ0ZpbGUiLCJfbWlrZVZlcmlmaWVkIiwiY29uc3RydWN0b3IiLCJvcHRzIiwidmVyaWZ5TWlrZSIsInN0ZG91dCIsImV4ZWMiLCJpbmNsdWRlcyIsIkVycm9yIiwiZXJyIiwiZ2V0TWlrZUFyZ3MiLCJjbWROYW1lIiwiY21kQXJncyIsIm1pa2VDbWQiLCJtaWtlQXJncyIsInZlcmlmeSIsImFyZ3MiLCJsb2ciLCJkZWJ1ZyIsImpvaW4iLCJsaXN0Iiwic3BsaXQiLCJtYXAiLCJzIiwidHJpbSIsImZpbHRlciIsIkJvb2xlYW4iLCJzZXREZWZhdWx0IiwiYWxpYXMiLCJkZXBsb3kiLCJ2ZXJzaW9uIiwicHVzaCIsInNob3VsZFB1c2giLCJzaG91bGRSZWJhc2UiLCJjb21taXQiXSwic291cmNlcyI6WyIuLi8uLi9saWIvbWlrZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2V4ZWN9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcblxuY29uc3QgREVGQVVMVF9SRU1PVEUgPSAnb3JpZ2luJztcbmNvbnN0IERFRkFVTFRfQlJBTkNIID0gJ2doLXBhZ2VzJztcbmNvbnN0IE1JS0VfVkVSX1NUUklORyA9ICdtaWtlIDEuJztcblxuZXhwb3J0IGNsYXNzIE1pa2Uge1xuICAvKiogQHR5cGUgc3RyaW5nICovIHJlbW90ZTtcbiAgLyoqIEB0eXBlIHN0cmluZyAqLyBicmFuY2g7XG4gIC8qKiBAdHlwZSBzdHJpbmc/ICovIHByZWZpeDtcbiAgLyoqIEB0eXBlIHN0cmluZyAqLyBjb25maWdGaWxlO1xuICAvKiogQHR5cGUgYm9vbGVhbiAqLyBfbWlrZVZlcmlmaWVkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoLyoqIEB0eXBlIE1pa2VPcHRzICovIG9wdHMpIHtcbiAgICB0aGlzLnJlbW90ZSA9IG9wdHMucmVtb3RlIHx8IERFRkFVTFRfUkVNT1RFO1xuICAgIHRoaXMuYnJhbmNoID0gb3B0cy5icmFuY2ggfHwgREVGQVVMVF9CUkFOQ0g7XG4gICAgdGhpcy5wcmVmaXggPSBvcHRzLnByZWZpeDtcbiAgICB0aGlzLmNvbmZpZ0ZpbGUgPSBvcHRzLmNvbmZpZ0ZpbGU7XG4gIH1cblxuICAvKipcbiAgICogVGhyb3cgYW4gZXJyb3IgaWYgdGhlICdtaWtlJyBiaW5hcnkgY2Fubm90IGJlIGZvdW5kXG4gICAqXG4gICAqIEB0aHJvd3MgRXJyb3JcbiAgICovXG4gIGFzeW5jIHZlcmlmeU1pa2UoKSB7XG4gICAgaWYgKHRoaXMuX21pa2VWZXJpZmllZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0aGlzLmV4ZWMoJy0tdmVyc2lvbicsIFtdLCBmYWxzZSk7XG4gICAgICBpZiAoIXN0ZG91dC5pbmNsdWRlcyhNSUtFX1ZFUl9TVFJJTkcpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTWlrZSB3YXMgaW5zdGFsbGVkIGJ1dCB3YXMgbm90IHZlcnNpb24gMS54Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCB2ZXJpZnkgYXBwcm9wcmlhdGUgbWlrZSBiaW5hcnkgZXhpc3RzOiAke2Vycn1gKTtcbiAgICB9XG4gICAgdGhpcy5fbWlrZVZlcmlmaWVkID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gYXJyYXkgb2YgYXJncyBiYXNlZCBvbiB0aGUgY2xhc3MgbWVtYmVycyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggTWlrZS1yZWxhdGVkIHN1YnByb2Nlc3NcbiAgICogZXhlY3V0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjbWROYW1lIC0gdGhlIG5hbWUgb2YgdGhlIG1pa2UgY29tbWFuZCB0byBydW5cbiAgICogQHBhcmFtIHtzdHJpbmdbXX0gY21kQXJncyAtIGFuIGFycmF5IG9mIGNvbW1hbmQtc3BlY2lmaWMgYXJndW1lbnRzXG4gICAqXG4gICAqIEByZXR1cm5zIHN0cmluZ1tdXG4gICAqL1xuICBnZXRNaWtlQXJncyhjbWROYW1lLCBjbWRBcmdzKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIGNtZE5hbWUsXG4gICAgICAuLi5jbWRBcmdzLFxuICAgICAgJy0tY29uZmlnLWZpbGUnLFxuICAgICAgdGhpcy5jb25maWdGaWxlLFxuICAgICAgJy0tcmVtb3RlJyxcbiAgICAgIHRoaXMucmVtb3RlLFxuICAgICAgJy0tYnJhbmNoJyxcbiAgICAgIHRoaXMuYnJhbmNoLFxuICAgICAgJy0tcHJlZml4JyxcbiAgICAgIHRoaXMucHJlZml4LFxuICAgIF07XG4gIH1cblxuICAvKipcbiAgICogRXhlYyBtaWtlIGFzIGEgc3VicHJvY2Vzc1xuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbWlrZUNtZCAtIHRoZSBtaWtlIGNvbW1hbmQgdG8gcnVuXG4gICAqIEBwYXJhbSB7c3RyaW5nW119IFttaWtlQXJncz1bXV0gLSB0aGUgYXJndW1lbnRzIHRvIHBhc3MgdG8gdGhlIG1pa2UgY29tbWFuZFxuICAgKiBAcGFyYW0ge2Jvb2xlYW4/fSBbdmVyaWZ5PXRydWVdIC0gd2hldGhlciB0byB2ZXJpZnkgbWlrZSBleGlzdHMgZmlyc3RcbiAgICpcbiAgICogQHJldHVybnMgUHJvbWlzZTxpbXBvcnQoJ3RlZW5fcHJvY2VzcycpLkV4ZWNSZXN1bHQ8c3RyaW5nPj5cbiAgICovXG4gIGFzeW5jIGV4ZWMobWlrZUNtZCwgbWlrZUFyZ3MgPSBbXSwgdmVyaWZ5ID0gdHJ1ZSkge1xuICAgIGlmICh2ZXJpZnkpIHtcbiAgICAgIGF3YWl0IHRoaXMudmVyaWZ5TWlrZSgpO1xuICAgIH1cbiAgICBjb25zdCBhcmdzID0gdGhpcy5nZXRNaWtlQXJncyhtaWtlQ21kLCBtaWtlQXJncyk7XG4gICAgbG9nLmRlYnVnKGBSdW5uaW5nIG1pa2UgJHthcmdzLmpvaW4oJyAnKX1gKTtcbiAgICByZXR1cm4gYXdhaXQgZXhlYygnbWlrZScsIGFyZ3MpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiB0aGUgbGlzdCBvZiBtaWtlIGRlcGxveXNcbiAgICpcbiAgICogQHJldHVybnMgc3RyaW5nW11cbiAgICovXG4gIGFzeW5jIGxpc3QoKSB7XG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0aGlzLmV4ZWMoJ2xpc3QnKTtcbiAgICByZXR1cm4gc3Rkb3V0XG4gICAgICAuc3BsaXQoJ1xcbicpXG4gICAgICAubWFwKChzKSA9PiBzLnRyaW0oKSlcbiAgICAgIC5maWx0ZXIoQm9vbGVhbik7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBkZWZhdWx0IHZlcnNpb24gb3IgYWxpYXNcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFsaWFzIC0gdGhlIHZlcnNpb24gb3IgYWxpYXNcbiAgICovXG4gIGFzeW5jIHNldERlZmF1bHQoYWxpYXMpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWMoJ3NldC1kZWZhdWx0JywgW2FsaWFzXSk7XG4gIH1cblxuICAvKipcbiAgICogRGVwbG95IGRvY3MgdG8gdGhlIGJyYW5jaFxuICAgKlxuICAgKiBAcGFyYW0ge01pa2VEZXBsb3lPcHRzfSBvcHRzIC0gdGhlIGRlcGxveSBvcHRpb25zXG4gICAqL1xuICBhc3luYyBkZXBsb3kob3B0cykge1xuICAgIGNvbnN0IGFyZ3MgPSBbb3B0cy52ZXJzaW9uXTtcbiAgICBpZiAob3B0cy5hbGlhcykge1xuICAgICAgYXJncy5wdXNoKG9wdHMuYWxpYXMsICctLXVwZGF0ZS1hbGlhc2VzJyk7XG4gICAgfVxuICAgIGlmIChvcHRzLnNob3VsZFB1c2gpIHtcbiAgICAgIGFyZ3MucHVzaCgnLS1wdXNoJyk7XG4gICAgfVxuICAgIGlmIChvcHRzLnNob3VsZFJlYmFzZSkge1xuICAgICAgYXJncy5wdXNoKCctLXJlYmFzZScpO1xuICAgIH1cbiAgICBpZiAob3B0cy5jb21taXQpIHtcbiAgICAgIGFyZ3MucHVzaCgnLS1tZXNzYWdlJywgb3B0cy5jb21taXQpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLmV4ZWMoJ2RlcGxveScsIGFyZ3MpO1xuICB9XG59XG5cbi8qKlxuICogQHR5cGVkZWYgTWlrZU9wdHMgLSBvcHRpb25zIGZvciBpbnN0YW50aWF0aW5nIGEgTWlrZSBvYmplY3RcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbcmVtb3RlPVwib3JpZ2luXCJdIC0gdGhlIGdpdCByZW1vdGUgdG8gcHVzaCBkb2NzIHRvXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW2JyYW5jaD1cImdoLXBhZ2VzXCJdIC0gdGhlIGdpdCBicmFuY2ggdG8gcHVzaCBkb2NzIHRvXG4gKiBAcHJvcGVydHkge3N0cmluZz99IHByZWZpeCAtIHRoZSBwYXRoIHByZWZpeCBvbiB0aGUgYnJhbmNoIGlmIGFueVxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNvbmZpZ0ZpbGUgLSB0aGUgbWtkb2NzIGNvbmZpZyBmaWxlIHRvIHVzZVxuICovXG5cbi8qKlxuICogQHR5cGVkZWYgTWlrZURlcGxveU9wdHMgLSBvcHRpb25zIGZvciBkZXBsb3lpbmcgZG9jcyB3aXRoIE1pa2VcbiAqIEBwYXJhbSB7c3RyaW5nfSB2ZXJzaW9uIC0gdGhlIHZlcnNpb24gdG8gZGVwbG95XG4gKiBAcGFyYW0ge3N0cmluZz99IGFsaWFzIC0gdGhlIGFsaWFzIHRvIGFsaWFzIChvciByZS1hbGlhcykgdGhlIHZlcnNpb25cbiAqIEBwYXJhbSB7c3RyaW5nP30gY29tbWl0IC0gdGhlIGNvbW1pdCBtZXNzYWdlIHRvIHVzZSBhcyBhbiBvdmVycmlkZVxuICogQHBhcmFtIHtib29sZWFuP30gc2hvdWxkUHVzaCAtIHdoZXRoZXIgbWlrZSBzaG91bGQgcHVzaCB0aGUgY29tbWl0cyB0byB0aGUgcmVtb3RlXG4gKiBAcGFyYW0ge2Jvb2xlYW4/fSBzaG91bGRSZWJhc2UgLSB3aGV0aGVyIG1pa2Ug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