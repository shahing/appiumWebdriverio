{"version":3,"file":"driver.js","names":["helpers","androidHelpers","SYSTEM_PORT_RANGE","DEVICE_PORT","NO_PROXY","RegExp","CHROME_NO_PROXY","APK_EXT","AAB_EXT","SUPPORTED_EXTENSIONS","EspressoDriver","BaseDriver","constructor","opts","shouldValidateCaps","shell","locatorStrategies","desiredCapConstraints","espresso","jwpProxyActive","defaultIME","jwpProxyAvoid","apkStrings","settings","DeviceSettings","onSettingsUpdate","bind","chromedriver","sessionChromedrivers","createSession","args","sessionId","caps","serverDetails","platform","webStorageEnabled","takesScreenshot","javascriptEnabled","databaseEnabled","networkConnectionEnabled","locationContextEnabled","warnings","desired","Object","assign","curContext","defaultContextName","defaultOpts","fullReset","autoLaunch","adbPort","DEFAULT_ADB_PORT","androidInstallTimeout","_","defaults","isChromeSession","app","log","warn","errorAndThrow","reboot","setAvdFromCapabilities","addWipeDataToAvdArgs","systemPort","findAPortNotInUse","udid","emPort","getDeviceInfoFromCaps","adb","createADB","configureApp","onPostProcess","onPostConfigureApp","supportedExtensions","appOnDevice","info","appPackage","isAppInstalled","startEspressoSession","e","deleteSession","message","endsWith","isErrorType","errors","SessionNotCreatedError","err","stack","unzipApp","appPath","useSystemUnzipEnv","process","env","APPIUM_PREFER_SYSTEM_UNZIP","useSystemUnzip","isEmpty","includes","toLower","tmpRoot","tempDir","openDir","zip","extractAllTo","globPattern","map","ext","replace","join","sortedBundleItems","fs","glob","cwd","strict","sort","a","b","split","path","sep","length","unzippedAppPath","first","debug","cachedAppInfo","isUrl","presignApp","appLocation","noSign","checkApkCert","sign","hasApkExt","hasAabExt","extractUniversalApk","shouldExtract","pathInCache","isResultAppPathAlreadyCached","isPlainObject","packageHash","hash","exists","fullPath","isApk","shouldResultAppPathBeCached","isUnzippedApk","rimraf","driverData","isEmulator","avd","deviceName","platformVersion","avdDevice","avdArgs","toLowerCase","manifestPayload","getPackageInfo","version","getApiLevel","setHiddenApiPolicy","ignoreHiddenApiPolicyError","appInfo","getLaunchInfo","initDevice","isAnimationOn","setAnimationState","wasAnimationEnabled","curDeviceId","deviceUDID","initEspressoServer","forwardPort","skipUnlock","unlock","initAUT","appWaitPackage","appActivity","qualifyActivityName","appWaitActivity","startSession","waitForActivity","appWaitDuration","autoWebview","initWebview","addDeviceInfoToCaps","viewName","androidCommands","defaultWebviewName","call","timeout","autoWebviewTimeout","retryInterval","setContext","apiVersion","manufacturer","model","realDisplaySize","displayDensity","mobileGetDeviceInfo","deviceApiLevel","parseInt","deviceScreenSize","deviceScreenDensity","deviceModel","deviceManufacturer","EspressoRunner","host","remoteAdbHost","devicePort","apk","tmpDir","forceEspressoRebuild","espressoBuildConfig","showGradleLog","serverLaunchTimeout","espressoServerLaunchTimeout","skipServerInstallation","useKeystore","keystorePath","keystorePassword","keyAlias","keyPassword","disableSuppressAccessibilityService","proxyReqRes","proxyCommand","uninstallOtherPackages","parseArray","SETTINGS_HELPER_PKG_ID","TEST_APK_PKG","fastReset","resetApp","skipUninstall","uninstallApk","installApk","installTestApk","addToDeviceIdleWhitelist","stderr","screenRecordingStopTasks","_screenRecordingProperties","stopRecordingScreen","mobileIsMediaProjectionRecordingRunning","mobileStopMediaProjectionRecording","_screenStreamingProps","mobileStopScreenStreaming","removeAllSessionWebSocketHandlers","server","B","all","task","ign","unicodeKeyboard","resetKeyboard","setIME","dontStopAppOnReset","forceStop","stopLogcat","avdName","killEmulator","setDefaultHiddenApiPolicy","undefined","removePortForward","error","proxyActive","canProxy","getProxyAvoidList","isNil","nativeWebScreenshot","isChromeBrowser","browserName","isPackageOrBundle","cmd","fn","toPairs","prototype","commands"],"sources":["../../lib/driver.js"],"sourcesContent":["import _ from 'lodash';\nimport path from 'path';\nimport B from 'bluebird';\nimport { BaseDriver, errors, isErrorType, DeviceSettings} from 'appium/driver';\nimport { EspressoRunner, TEST_APK_PKG } from './espresso-runner';\nimport { fs, tempDir, zip } from 'appium/support';\nimport commands from './commands';\nimport { DEFAULT_ADB_PORT } from 'appium-adb';\nimport { androidHelpers, androidCommands, SETTINGS_HELPER_PKG_ID } from 'appium-android-driver';\nimport desiredCapConstraints from './desired-caps';\nimport { findAPortNotInUse } from 'portscanner';\nimport { retryInterval } from 'asyncbox';\nimport { qualifyActivityName, getPackageInfo } from './utils';\n\n\n// TODO merge our own helpers onto this later\nconst helpers = androidHelpers;\n\n// The range of ports we can use on the system for communicating to the\n// Espresso HTTP server on the device\nconst SYSTEM_PORT_RANGE = [8300, 8399];\n\n// This is the port that the espresso server listens to on the device. We will\n// forward one of the ports above on the system to this port on the device.\nconst DEVICE_PORT = 6791;\n\n// NO_PROXY contains the paths that we never want to proxy to espresso server.\n// TODO:  Add the list of paths that we never want to proxy to espresso server.\n// TODO: Need to segregate the paths better way using regular expressions wherever applicable.\n// (Not segregating right away because more paths to be added in the NO_PROXY list)\nconst NO_PROXY = [\n  ['GET', new RegExp('^/session/(?!.*/)')],\n  ['GET', new RegExp('^/session/[^/]+/appium/device/current_activity')],\n  ['GET', new RegExp('^/session/[^/]+/appium/device/current_package')],\n  ['GET', new RegExp('^/session/[^/]+/appium/device/display_density')],\n  ['GET', new RegExp('^/session/[^/]+/appium/device/is_keyboard_shown')],\n  ['GET', new RegExp('^/session/[^/]+/appium/device/system_bars')],\n  ['GET', new RegExp('^/session/[^/]+/appium/device/system_time')],\n  ['GET', new RegExp('^/session/[^/]+/appium/settings')],\n  ['GET', new RegExp('^/session/[^/]+/context')],\n  ['GET', new RegExp('^/session/[^/]+/contexts')],\n  ['GET', new RegExp('^/session/[^/]+/ime/[^/]+')],\n  ['GET', new RegExp('^/session/[^/]+/network_connection')],\n  ['GET', new RegExp('^/session/[^/]+/timeouts')],\n  ['GET', new RegExp('^/session/[^/]+/url')],\n  ['POST', new RegExp('^/session/[^/]+/appium/app/background')],\n  ['POST', new RegExp('^/session/[^/]+/appium/app/close')],\n  ['POST', new RegExp('^/session/[^/]+/appium/app/launch')],\n  ['POST', new RegExp('^/session/[^/]+/appium/app/reset')],\n  ['POST', new RegExp('^/session/[^/]+/appium/app/strings')],\n  ['POST', new RegExp('^/session/[^/]+/appium/compare_images')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/activate_app')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/app_installed')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/app_state')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/finger_print')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/get_clipboard')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/install_app')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/is_locked')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/lock')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/pull_file')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/pull_folder')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/push_file')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/remove_app')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/start_activity')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/terminate_app')],\n  ['POST', new RegExp('^/session/[^/]+/appium/device/unlock')],\n  ['POST', new RegExp('^/session/[^/]+/appium/getPerformanceData')],\n  ['POST', new RegExp('^/session/[^/]+/appium/performanceData/types')],\n  ['POST', new RegExp('^/session/[^/]+/appium/settings')],\n  ['POST', new RegExp('^/session/[^/]+/appium/execute_driver')],\n  ['POST', new RegExp('^/session/[^/]+/appium/start_recording_screen')],\n  ['POST', new RegExp('^/session/[^/]+/appium/stop_recording_screen')],\n  ['POST', new RegExp('^/session/[^/]+/context')],\n  ['POST', new RegExp('^/session/[^/]+/execute')],\n  ['POST', new RegExp('^/session/[^/]+/execute/async')],\n  ['POST', new RegExp('^/session/[^/]+/execute/sync')],\n  ['POST', new RegExp('^/session/[^/]+/execute_async')],\n  ['POST', new RegExp('^/session/[^/]+/ime/[^/]+')],\n  ['POST', new RegExp('^/session/[^/]+/location')],\n  ['POST', new RegExp('^/session/[^/]+/network_connection')],\n  ['POST', new RegExp('^/session/[^/]+/timeouts')],\n  ['POST', new RegExp('^/session/[^/]+/url')],\n\n  // MJSONWP commands\n  ['GET', new RegExp('^/session/[^/]+/log/types')],\n  ['POST', new RegExp('^/session/[^/]+/log')],\n\n  // W3C commands\n  // For Selenium v4 (W3C does not have this route)\n  ['GET', new RegExp('^/session/[^/]+/se/log/types')],\n  // For Selenium v4 (W3C does not have this route)\n  ['POST', new RegExp('^/session/[^/]+/se/log')],\n];\n\n// This is a set of methods and paths that we never want to proxy to Chromedriver.\nconst CHROME_NO_PROXY = [\n  ['GET', new RegExp('^/session/[^/]+/appium')],\n  ['GET', new RegExp('^/session/[^/]+/context')],\n  ['GET', new RegExp('^/session/[^/]+/element/[^/]+/rect')],\n  ['GET', new RegExp('^/session/[^/]+/orientation')],\n  ['POST', new RegExp('^/session/[^/]+/appium')],\n  ['POST', new RegExp('^/session/[^/]+/context')],\n  ['POST', new RegExp('^/session/[^/]+/orientation')],\n  ['POST', new RegExp('^/session/[^/]+/touch/multi/perform')],\n  ['POST', new RegExp('^/session/[^/]+/touch/perform')],\n\n  // this is needed to make the mobile: commands working in web context\n  ['POST', new RegExp('^/session/[^/]+/execute$')],\n  ['POST', new RegExp('^/session/[^/]+/execute/sync')],\n\n  // MJSONWP commands\n  ['GET', new RegExp('^/session/[^/]+/log/types')],\n  ['POST', new RegExp('^/session/[^/]+/log')],\n\n  // W3C commands\n  // For Selenium v4 (W3C does not have this route)\n  ['GET', new RegExp('^/session/[^/]+/se/log/types')],\n  // For Selenium v4 (W3C does not have this route)\n  ['POST', new RegExp('^/session/[^/]+/se/log')],\n];\n\n\nconst APK_EXT = '.apk';\nconst AAB_EXT = '.aab';\nconst SUPPORTED_EXTENSIONS = [APK_EXT, AAB_EXT];\n\nclass EspressoDriver extends BaseDriver {\n  constructor (opts = {}, shouldValidateCaps = true) {\n    // `shell` overwrites adb.shell, so remove\n    delete opts.shell;\n\n    super(opts, shouldValidateCaps);\n    this.locatorStrategies = [\n      'id',\n      'class name',\n      'accessibility id',\n    ];\n    this.desiredCapConstraints = desiredCapConstraints;\n    this.espresso = null;\n    this.jwpProxyActive = false;\n    this.defaultIME = null;\n    this.jwpProxyAvoid = NO_PROXY;\n\n    this.apkStrings = {}; // map of language -> strings obj\n    this.settings = new DeviceSettings({}, this.onSettingsUpdate.bind(this));\n\n    this.chromedriver = null;\n    this.sessionChromedrivers = {};\n  }\n\n  async createSession (...args) {\n    try {\n      // TODO handle otherSessionData for multiple sessions\n      let [sessionId, caps] = await super.createSession(...args);\n\n      let serverDetails = {\n        platform: 'LINUX',\n        webStorageEnabled: false,\n        takesScreenshot: true,\n        javascriptEnabled: true,\n        databaseEnabled: false,\n        networkConnectionEnabled: true,\n        locationContextEnabled: false,\n        warnings: {},\n        desired: Object.assign({}, this.caps)\n      };\n\n      this.caps = Object.assign(serverDetails, this.caps);\n\n      this.curContext = this.defaultContextName();\n\n      let defaultOpts = {\n        fullReset: false,\n        autoLaunch: true,\n        adbPort: DEFAULT_ADB_PORT,\n        androidInstallTimeout: 90000\n      };\n      _.defaults(this.opts, defaultOpts);\n\n      if (this.isChromeSession) {\n        if (this.opts.app) {\n          this.log.warn(`'browserName' capability will be ignored`);\n          this.log.warn(`Chrome browser cannot be run in Espresso sessions because Espresso automation doesn't ` +\n              `have permission to access Chrome`);\n        } else {\n          this.log.errorAndThrow(`Chrome browser sessions cannot be run in Espresso because Espresso ` +\n            `automation doesn't have permission to access Chrome`);\n        }\n      }\n\n      if (this.opts.reboot) {\n        this.setAvdFromCapabilities(caps);\n        this.addWipeDataToAvdArgs();\n      }\n\n      this.opts.systemPort = this.opts.systemPort\n        || await findAPortNotInUse(SYSTEM_PORT_RANGE[0], SYSTEM_PORT_RANGE[1]);\n      this.opts.adbPort = this.opts.adbPort || DEFAULT_ADB_PORT;\n      // get device udid for this session\n      const {udid, emPort} = await helpers.getDeviceInfoFromCaps(this.opts);\n      this.opts.udid = udid;\n      this.opts.emPort = emPort;\n      // now that we know our java version and device info, we can create our\n      // ADB instance\n      this.adb = await androidHelpers.createADB(this.opts);\n\n      if (this.opts.app) {\n        // find and copy, or download and unzip an app url or path\n        this.opts.app = await this.helpers.configureApp(this.opts.app, {\n          onPostProcess: this.onPostConfigureApp.bind(this),\n          supportedExtensions: SUPPORTED_EXTENSIONS\n        });\n      } else if (this.appOnDevice) {\n        // the app isn't an actual app file but rather something we want to\n        // assume is on the device and just launch via the appPackage\n        this.log.info(`App file was not listed, instead we're going to run ` +\n            `${this.opts.appPackage} directly on the device`);\n        if (!await this.adb.isAppInstalled(this.opts.appPackage)) {\n          this.log.errorAndThrow(`Could not find the package '${this.opts.appPackage}' ` +\n            `installed on the device`);\n        }\n      }\n\n      await this.startEspressoSession();\n      return [sessionId, caps];\n    } catch (e) {\n      await this.deleteSession();\n      e.message += `${_.endsWith(e.message, '.') ? '' : '.'} Check ` +\n        'https://github.com/appium/appium-espresso-driver#troubleshooting ' +\n        'regarding advanced session startup troubleshooting.';\n      if (isErrorType(e, errors.SessionNotCreatedError)) {\n        throw e;\n      }\n      const err = new errors.SessionNotCreatedError(e.message);\n      err.stack = e.stack;\n      throw err;\n    }\n  }\n\n  /**\n   * Unzip the given app path and return the first package that has SUPPORTED_EXTENSIONS\n   * in the archived file.\n   *\n   * @param {string} appPath The path to app file.\n   * @returns {string} Retuns the path to an unzipped app file path.\n   * @throws Raise an exception if the zip did not have any SUPPORTED_EXTENSIONS packages.\n   */\n  async unzipApp (appPath) {\n    const useSystemUnzipEnv = process.env.APPIUM_PREFER_SYSTEM_UNZIP;\n    const useSystemUnzip = _.isEmpty(useSystemUnzipEnv)\n      || !['0', 'false'].includes(_.toLower(useSystemUnzipEnv));\n    const tmpRoot = await tempDir.openDir();\n    await zip.extractAllTo(appPath, tmpRoot, {useSystemUnzip});\n\n    const globPattern = `**/*.+(${SUPPORTED_EXTENSIONS.map((ext) => ext.replace(/^\\./, '')).join('|')})`;\n    const sortedBundleItems = (await fs.glob(globPattern, {\n      cwd: tmpRoot,\n      strict: false,\n    })).sort((a, b) => a.split(path.sep).length - b.split(path.sep).length);\n    if (sortedBundleItems.length === 0) {\n      // no expected packages in the zip\n      this.log.errorAndThrow(`${this.opts.app} did not have any of '${SUPPORTED_EXTENSIONS.join(', ')}' ` +\n        `extension packages. Please make sure the provided .zip archive contains at least one valid application package.`);\n    }\n    const unzippedAppPath = path.join(tmpRoot, _.first(sortedBundleItems));\n    this.log.debug(`'${unzippedAppPath}' is the unzipped file from '${appPath}'`);\n    return unzippedAppPath;\n  }\n\n  async onPostConfigureApp ({cachedAppInfo, isUrl, appPath}) {\n    const presignApp = async (appLocation) => {\n      if (this.opts.noSign) {\n        this.log.info('Skipping application signing because noSign capability is set to true. ' +\n          'Having the application under test with improper signature/non-signed will cause ' +\n          'Espresso automation startup failure.');\n      } else if (!await this.adb.checkApkCert(appLocation, this.opts.appPackage)) {\n        await this.adb.sign(appLocation, this.opts.appPackage);\n      }\n    };\n\n    const hasApkExt = (appPath) => _.endsWith(_.toLower(appPath), APK_EXT);\n    const hasAabExt = (appPath) => _.endsWith(_.toLower(appPath), AAB_EXT);\n    const extractUniversalApk = async (shouldExtract, appPath) =>\n      shouldExtract ? appPath : await this.adb.extractUniversalApk(appPath);\n\n    let pathInCache = null;\n    let isResultAppPathAlreadyCached = false;\n    if (_.isPlainObject(cachedAppInfo)) {\n      const packageHash = await fs.hash(appPath);\n      if (packageHash === cachedAppInfo.packageHash && await fs.exists(cachedAppInfo.fullPath)) {\n        this.log.info(`Using '${cachedAppInfo.fullPath}' which is cached from '${appPath}'`);\n        isResultAppPathAlreadyCached = true;\n        pathInCache = cachedAppInfo.fullPath;\n      }\n    }\n\n    // appPath can be .zip, .apk or .aab\n    const isApk = hasApkExt(appPath);\n    // Only local .apk files that are available in-place should not be cached\n    const shouldResultAppPathBeCached = !isApk || (isApk && isUrl);\n\n    if (!isResultAppPathAlreadyCached) {\n      if (shouldResultAppPathBeCached) {\n        // .zip, .aab or downloaded .apk\n\n        let unzippedAppPath;\n        let isUnzippedApk = false;\n        if (!(hasApkExt(appPath) || hasAabExt(appPath))) {\n          unzippedAppPath = await this.unzipApp(appPath);\n          isUnzippedApk = hasApkExt(unzippedAppPath);\n        }\n\n        // unzippedAppPath or appPath has SUPPORTED_EXTENSIONS.\n        pathInCache = unzippedAppPath\n          ? await extractUniversalApk(isUnzippedApk, unzippedAppPath)\n          : await extractUniversalApk(isApk, appPath);\n\n        if (!isApk && isUrl) {\n          // Clean up the temporarily downloaded .aab or .zip package\n          await fs.rimraf(appPath);\n        }\n        if (hasAabExt(unzippedAppPath)) {\n          // Cleanup the local unzipped .aab file\n          await fs.rimraf(unzippedAppPath);\n        }\n        await presignApp(pathInCache);\n      } else if (isApk) {\n        // It is probably not the best idea to modify the provided app in-place,\n        // but this is how it was always working\n        await presignApp(appPath);\n      }\n    }\n    return shouldResultAppPathBeCached ? {appPath: pathInCache} : false;\n  }\n\n  get driverData () {\n    // TODO fille out resource info here\n    return {};\n  }\n\n  isEmulator () {\n    return helpers.isEmulator(this.adb, this.opts);\n  }\n\n  // TODO this method is duplicated from uiautomator2-driver; consolidate\n  setAvdFromCapabilities (caps) {\n    if (this.opts.avd) {\n      this.log.info('avd name defined, ignoring device name and platform version');\n    } else {\n      if (!caps.deviceName) {\n        this.log.errorAndThrow('avd or deviceName should be specified when reboot option is enables');\n      }\n      if (!caps.platformVersion) {\n        this.log.errorAndThrow('avd or platformVersion should be specified when reboot option is enabled');\n      }\n      let avdDevice = caps.deviceName.replace(/[^a-zA-Z0-9_.]/g, '-');\n      this.opts.avd = `${avdDevice}__${caps.platformVersion}`;\n    }\n  }\n\n  // TODO this method is duplicated from uiautomator2-driver; consolidate\n  addWipeDataToAvdArgs () {\n    if (!this.opts.avdArgs) {\n      this.opts.avdArgs = '-wipe-data';\n    } else if (!this.opts.avdArgs.toLowerCase().includes('-wipe-data')) {\n      this.opts.avdArgs += ' -wipe-data';\n    }\n  }\n\n  // TODO much of this logic is duplicated from uiautomator2\n  async startEspressoSession () {\n    const {manifestPayload} = await getPackageInfo();\n    this.log.info(`EspressoDriver version: ${manifestPayload.version}`);\n\n    // Read https://github.com/appium/appium-android-driver/pull/461 what happens if ther is no setHiddenApiPolicy for Android P+\n    if (await this.adb.getApiLevel() >= 28) { // Android P\n      this.log.warn('Relaxing hidden api policy');\n      await this.adb.setHiddenApiPolicy('1', !!this.opts.ignoreHiddenApiPolicyError);\n    }\n\n    // get appPackage et al from manifest if necessary\n    let appInfo = await helpers.getLaunchInfo(this.adb, this.opts);\n    if (appInfo) {\n      // and get it onto our 'opts' object so we use it from now on\n      Object.assign(this.opts, appInfo);\n    } else {\n      appInfo = this.opts;\n    }\n\n    // start an avd, set the language/locale, pick an emulator, etc...\n    // TODO with multiple devices we'll need to parameterize this\n    await helpers.initDevice(this.adb, this.opts);\n    // https://github.com/appium/appium-espresso-driver/issues/72\n    if (await this.adb.isAnimationOn()) {\n      try {\n        await this.adb.setAnimationState(false);\n        this.wasAnimationEnabled = true;\n      } catch (err) {\n        this.log.warn(`Unable to turn off animations: ${err.message}`);\n      }\n    }\n\n    // set actual device name, udid\n    this.caps.deviceName = this.adb.curDeviceId;\n    this.caps.deviceUDID = this.opts.udid;\n\n    // set up the modified espresso server etc\n    this.initEspressoServer();\n    // Further prepare the device by forwarding the espresso port\n    this.log.debug(`Forwarding Espresso Server port ${DEVICE_PORT} to ${this.opts.systemPort}`);\n    await this.adb.forwardPort(this.opts.systemPort, DEVICE_PORT);\n\n    if (!this.opts.skipUnlock) {\n      // unlock the device to prepare it for testing\n      await helpers.unlock(this, this.adb, this.caps);\n    } else {\n      this.log.debug(`'skipUnlock' capability set, so skipping device unlock`);\n    }\n\n    // set up app under test\n    // prepare our actual AUT, get it on the device, etc...\n    await this.initAUT();\n\n    //Adding AUT package name in the capabilities if package name not exist in caps\n    if (!this.caps.appPackage) {\n      this.caps.appPackage = appInfo.appPackage;\n    }\n    if (!this.caps.appWaitPackage) {\n      this.caps.appWaitPackage = appInfo.appWaitPackage || appInfo.appPackage || this.caps.appPackage;\n    }\n    if (this.caps.appActivity) {\n      this.caps.appActivity = qualifyActivityName(this.caps.appActivity, this.caps.appPackage);\n    } else {\n      this.caps.appActivity = qualifyActivityName(appInfo.appActivity, this.caps.appPackage);\n    }\n    if (this.caps.appWaitActivity) {\n      this.caps.appWaitActivity = qualifyActivityName(this.caps.appWaitActivity, this.caps.appWaitPackage);\n    } else {\n      this.caps.appWaitActivity = qualifyActivityName(appInfo.appWaitActivity || appInfo.appActivity || this.caps.appActivity,\n        this.caps.appWaitPackage);\n    }\n\n    // launch espresso and wait till its online and we have a session\n    await this.espresso.startSession(this.caps);\n    if (this.caps.autoLaunch === false) {\n      this.log.info(`Not waiting for the application activity to start because 'autoLaunch' is disabled`);\n    } else {\n      await this.adb.waitForActivity(this.caps.appWaitPackage, this.caps.appWaitActivity, this.opts.appWaitDuration);\n    }\n    // if we want to immediately get into a webview, set our context\n    // appropriately\n    if (this.opts.autoWebview) {\n      await this.initWebview();\n    }\n\n    // now that everything has started successfully, turn on proxying so all\n    // subsequent session requests go straight to/from espresso\n    this.jwpProxyActive = true;\n\n    await this.addDeviceInfoToCaps();\n  }\n\n  async initWebview () {\n    const viewName = androidCommands.defaultWebviewName.call(this);\n    const timeout = this.opts.autoWebviewTimeout || 2000;\n    this.log.info(`Setting webview to context '${viewName}' with timeout ${timeout}ms`);\n    await retryInterval(timeout / 500, 500, this.setContext.bind(this), viewName);\n  }\n\n  async addDeviceInfoToCaps () {\n    const {\n      apiVersion,\n      platformVersion,\n      manufacturer,\n      model,\n      realDisplaySize,\n      displayDensity,\n    } = await this.mobileGetDeviceInfo();\n    this.caps.deviceApiLevel = parseInt(apiVersion, 10);\n    this.caps.platformVersion = platformVersion;\n    this.caps.deviceScreenSize = realDisplaySize;\n    this.caps.deviceScreenDensity = displayDensity;\n    this.caps.deviceModel = model;\n    this.caps.deviceManufacturer = manufacturer;\n  }\n\n  initEspressoServer () {\n    // now that we have package and activity, we can create an instance of\n    // espresso with the appropriate data\n    this.espresso = new EspressoRunner(this.log, {\n      host: this.opts.remoteAdbHost || this.opts.host || '127.0.0.1',\n      systemPort: this.opts.systemPort,\n      devicePort: DEVICE_PORT,\n      adb: this.adb,\n      apk: this.opts.app,\n      tmpDir: this.opts.tmpDir,\n      appPackage: this.opts.appPackage,\n      appActivity: this.opts.appActivity,\n      forceEspressoRebuild: !!this.opts.forceEspressoRebuild,\n      espressoBuildConfig: this.opts.espressoBuildConfig,\n      showGradleLog: !!this.opts.showGradleLog,\n      serverLaunchTimeout: this.opts.espressoServerLaunchTimeout,\n      androidInstallTimeout: this.opts.androidInstallTimeout,\n      skipServerInstallation: this.opts.skipServerInstallation,\n      useKeystore: this.opts.useKeystore,\n      keystorePath: this.opts.keystorePath,\n      keystorePassword: this.opts.keystorePassword,\n      keyAlias: this.opts.keyAlias,\n      keyPassword: this.opts.keyPassword,\n      disableSuppressAccessibilityService: this.opts.disableSuppressAccessibilityService,\n    });\n    this.proxyReqRes = this.espresso.proxyReqRes.bind(this.espresso);\n    this.proxyCommand = this.espresso.proxyCommand.bind(this.espresso);\n  }\n\n  // TODO this method is mostly duplicated from uiautomator2\n  async initAUT () {\n    // set the localized strings for the current language from the apk\n    // TODO: incorporate changes from appium#5308 which fix a race cond-\n    // ition bug in old appium and need to be replicated here\n    // this.apkStrings[this.opts.language] = await androidHelpers.pushStrings(\n    //     this.opts.language, this.adb, this.opts);\n\n    // Uninstall any uninstallOtherPackages which were specified in caps\n    if (this.opts.uninstallOtherPackages) {\n      await helpers.uninstallOtherPackages(\n        this.adb,\n        helpers.parseArray(this.opts.uninstallOtherPackages),\n        [SETTINGS_HELPER_PKG_ID, TEST_APK_PKG]\n      );\n    }\n\n    if (!this.opts.app) {\n      if (this.opts.fullReset) {\n        this.log.errorAndThrow('Full reset requires an app capability, use fastReset if app is not provided');\n      }\n      this.log.debug('No app capability. Assuming it is already on the device');\n      if (this.opts.fastReset) {\n        await helpers.resetApp(this.adb, this.opts);\n      }\n    }\n\n    if (!this.opts.skipUninstall) {\n      await this.adb.uninstallApk(this.opts.appPackage);\n    }\n    if (this.opts.app) {\n      await helpers.installApk(this.adb, this.opts);\n    }\n    if (this.opts.skipServerInstallation) {\n      this.log.debug('skipServerInstallation capability is set. Not installig espresso-server ');\n    } else {\n      await this.espresso.installTestApk();\n      try {\n        await this.adb.addToDeviceIdleWhitelist(SETTINGS_HELPER_PKG_ID, TEST_APK_PKG);\n      } catch (e) {\n        this.log.warn(`Cannot add server packages to the Doze whitelist. Original error: ` +\n          (e.stderr || e.message));\n      }\n    }\n  }\n\n  async deleteSession () {\n    this.log.debug('Deleting espresso session');\n\n    const screenRecordingStopTasks = [async () => {\n      if (!_.isEmpty(this._screenRecordingProperties)) {\n        await this.stopRecordingScreen();\n      }\n    }, async () => {\n      if (await this.mobileIsMediaProjectionRecordingRunning()) {\n        await this.mobileStopMediaProjectionRecording();\n      }\n    }, async () => {\n      if (!_.isEmpty(this._screenStreamingProps)) {\n        await this.mobileStopScreenStreaming();\n      }\n    }];\n\n    await androidHelpers.removeAllSessionWebSocketHandlers(this.server, this.sessionId);\n\n    if (this.espresso) {\n      if (this.jwpProxyActive) {\n        await this.espresso.deleteSession();\n      }\n      this.espresso = null;\n    }\n    this.jwpProxyActive = false;\n\n    if (this.adb) {\n      await B.all(screenRecordingStopTasks.map((task) => {\n        (async () => {\n          try {\n            await task();\n          } catch (ign) {}\n        })();\n      }));\n      if (this.wasAnimationEnabled) {\n        try {\n          await this.adb.setAnimationState(true);\n        } catch (err) {\n          this.log.warn(`Unable to reset animation: ${err.message}`);\n        }\n      }\n      if (this.opts.unicodeKeyboard && this.opts.resetKeyboard &&\n          this.defaultIME) {\n        this.log.debug(`Resetting IME to '${this.defaultIME}'`);\n        await this.adb.setIME(this.defaultIME);\n      }\n      if (!this.isChromeSession && this.opts.appPackage && !this.opts.dontStopAppOnReset) {\n        await this.adb.forceStop(this.opts.appPackage);\n      }\n      if (this.opts.fullReset && !this.opts.skipUninstall && !this.appOnDevice) {\n        this.log.debug(`FULL_RESET set to 'true', Uninstalling '${this.opts.appPackage}'`);\n        await this.adb.uninstallApk(this.opts.appPackage);\n      }\n      await this.adb.stopLogcat();\n      if (this.opts.reboot) {\n        let avdName = this.opts.avd.replace('@', '');\n        this.log.debug(`closing emulator '${avdName}'`);\n        await this.adb.killEmulator(avdName);\n      }\n      if (await this.adb.getApiLevel() >= 28) { // Android P\n        this.log.info('Restoring hidden api policy to the device default configuration');\n        await this.adb.setDefaultHiddenApiPolicy(!!this.opts.ignoreHiddenApiPolicyError);\n      }\n    }\n    await super.deleteSession();\n    if (this.opts.systemPort !== undefined) {\n      try {\n        await this.adb.removePortForward(this.opts.systemPort);\n      } catch (error) {\n        this.log.warn(`Unable to remove port forward '${error.message}'`);\n        //Ignore, this block will also be called when we fall in catch block\n        // and before even port forward.\n      }\n    }\n  }\n\n  async onSettingsUpdate () {\n    // intentionally do nothing here, since commands.updateSettings proxies\n    // settings to the espresso server already\n  }\n\n  proxyActive (sessionId) {\n    super.proxyActive(sessionId);\n\n    // we always have an active proxy to the espresso server\n    return true;\n  }\n\n  canProxy (sessionId) {\n    super.canProxy(sessionId);\n\n    // we can always proxy to the espresso server\n    return true;\n  }\n\n  getProxyAvoidList (sessionId) {\n    super.getProxyAvoidList(sessionId);\n    // we are maintaining two sets of NO_PROXY lists, one for chromedriver(CHROME_NO_PROXY)\n    // and one for Espresso(NO_PROXY), based on current context will return related NO_PROXY list\n    this.jwpProxyAvoid = _.isNil(this.chromedriver) ? NO_PROXY : CHROME_NO_PROXY;\n    if (this.opts.nativeWebScreenshot) {\n      this.jwpProxyAvoid = [...this.jwpProxyAvoid, ['GET', new RegExp('^/session/[^/]+/screenshot')]];\n    }\n\n    return this.jwpProxyAvoid;\n  }\n\n  get isChromeSession () {\n    return helpers.isChromeBrowser(this.opts.browserName);\n  }\n\n  get appOnDevice () {\n    return !this.opts.app && this.helpers.isPackageOrBundle(this.opts.appPackage);\n  }\n}\n\n// first add the android-driver commands which we will fall back to\nfor (let [cmd, fn] of _.toPairs(androidCommands)) {\n  // we do some different/special things with these methods\n  if (!_.includes(['defaultWebviewName'], cmd)) {\n    EspressoDriver.prototype[cmd] = fn;\n  }\n}\n\n// then overwrite with any espresso-specific commands\nfor (let [cmd, fn] of _.toPairs(commands)) {\n  EspressoDriver.prototype[cmd] = fn;\n}\n\nexport { EspressoDriver };\nexport default EspressoDriver;\n"],"mappings":"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"}