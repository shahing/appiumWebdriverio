"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TEST_APK_PKG = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;
require("source-map-support/register");
var _driver = require("appium/driver");
var _asyncbox = require("asyncbox");
var _serverBuilder = require("./server-builder");
var _path = _interopRequireDefault(require("path"));
var _support = require("appium/support");
var _bluebird = _interopRequireDefault(require("bluebird"));
var _lodash = _interopRequireDefault(require("lodash"));
var _utils = require("./utils");
var _axios = _interopRequireDefault(require("axios"));
const TEST_SERVER_ROOT = _path.default.resolve(__dirname, '..', '..', 'espresso-server');
const TEST_APK_PKG = 'io.appium.espressoserver.test';
exports.TEST_APK_PKG = TEST_APK_PKG;
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS = 45000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';
class EspressoProxy extends _driver.JWProxy {
  async proxyCommand(url, method, body = null) {
    const {
      crashed,
      exited
    } = this.instrumentationState;
    if (exited) {
      throw new _driver.errors.InvalidContextError(`'${method} ${url}' cannot be proxied to Espresso server because ` + `the instrumentation process has ${crashed ? 'crashed' : 'been unexpectedly terminated'}. ` + `Check the Appium server log and the logcat output for more details`);
    }
    return await super.proxyCommand(url, method, body);
  }
}
class EspressoRunner {
  constructor(log, opts = {}) {
    for (let req of REQUIRED_PARAMS) {
      if (!opts || !_support.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }
      this[req] = opts[req];
    }
    this.log = log;
    this.jwproxy = new EspressoProxy({
      log,
      server: this.host,
      port: this.systemPort,
      base: '',
      keepAlive: true
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.proxyCommand = this.jwproxy.command.bind(this.jwproxy);
    this.jwproxy.instrumentationState = {
      exited: false,
      crashed: false
    };
    const {
      manifestPayload
    } = (0, _utils.getPackageInfoSync)();
    const modServerName = _support.fs.sanitizeName(`${TEST_APK_PKG}_${manifestPayload.version}_${this.appPackage}_${this.adb.curDeviceId}.apk`, {
      replacement: '-'
    });
    this.modServerPath = _path.default.resolve(this.tmpDir, modServerName);
    this.showGradleLog = opts.showGradleLog;
    this.espressoBuildConfig = opts.espressoBuildConfig;
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS;
    this.androidInstallTimeout = opts.androidInstallTimeout;
    this.disableSuppressAccessibilityService = opts.disableSuppressAccessibilityService;
    if (opts.useKeystore && opts.keystorePath && opts.keystorePassword && opts.keyAlias && opts.keyPassword) {
      this.signingConfig = (0, _serverBuilder.buildServerSigningConfig)({
        keystoreFile: opts.keystorePath,
        keystorePassword: opts.keystorePassword,
        keyAlias: opts.keyAlias,
        keyPassword: opts.keyPassword
      });
    } else {
      this.signingConfig = null;
    }
  }
  async isAppPackageChanged() {
    if (!(await this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
      this.log.debug('The previous target application package is unknown');
      return true;
    }
    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();
    this.log.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${this.appPackage}'`);
    return previousAppPackage !== this.appPackage;
  }
  async installServer() {
    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);
    const shouldUninstallApp = [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
    const shouldInstallApp = shouldUninstallApp || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);
    if (shouldUninstallApp) {
      this.log.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);
      try {
        await this.adb.uninstallApk(TEST_APK_PKG);
      } catch (err) {
        this.log.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);
      }
    }
    if (shouldInstallApp) {
      this.log.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);
      try {
        await this.adb.install(this.modServerPath, {
          replace: false,
          timeout: this.androidInstallTimeout
        });
        this.log.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
      } catch (err) {
        this.log.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);
      }
    }
  }
  async installTestApk() {
    let rebuild = this.forceEspressoRebuild;
    if (rebuild) {
      this.log.debug(`'forceEspressoRebuild' capability is enabled`);
    } else if (await this.isAppPackageChanged()) {
      this.log.info(`Forcing Espresso server rebuild because of changed application package`);
      rebuild = true;
    }
    if (rebuild && (await _support.fs.exists(this.modServerPath))) {
      this.log.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);
      await _support.fs.unlink(this.modServerPath);
    }
    if (!(await _support.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
    }
    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);
    if (!isSigned) {
      await this.adb.sign(this.modServerPath);
    }
    if ((rebuild || !isSigned) && (await this.adb.uninstallApk(TEST_APK_PKG))) {
      this.log.info('Uninstalled the obsolete Espresso server package from the device under test');
    }
    await this.installServer();
  }
  async buildNewModServer() {
    let buildConfiguration = {};
    if (this.espressoBuildConfig) {
      let buildConfigurationStr;
      if (await _support.fs.exists(this.espressoBuildConfig)) {
        this.log.info(`Loading the build configuration from '${this.espressoBuildConfig}'`);
        buildConfigurationStr = await _support.fs.readFile(this.espressoBuildConfig, 'utf8');
      } else {
        this.log.info(`Loading the build configuration from 'espressoBuildConfig' capability`);
        buildConfigurationStr = this.espressoBuildConfig;
      }
      try {
        buildConfiguration = JSON.parse(buildConfigurationStr);
      } catch (e) {
        this.log.error('Cannot parse the build configuration JSON', e);
        throw e;
      }
    }
    const dirName = _support.fs.sanitizeName(`espresso-server-${this.adb.curDeviceId}`, {
      replacement: '-'
    });
    const serverPath = _path.default.resolve(this.tmpDir, dirName);
    this.log.info(`Building espresso server in '${serverPath}'`);
    this.log.debug(`The build folder root could be customized by changing the 'tmpDir' capability`);
    await _support.fs.rimraf(serverPath);
    await (0, _support.mkdirp)(serverPath);
    this.log.debug(`Copying espresso server template from ('${TEST_SERVER_ROOT}' to '${serverPath}')`);
    await (0, _utils.copyGradleProjectRecursively)(TEST_SERVER_ROOT, serverPath);
    this.log.debug('Bulding espresso server');
    await new _serverBuilder.ServerBuilder(this.log, {
      serverPath,
      buildConfiguration,
      showGradleLog: this.showGradleLog,
      testAppPackage: this.appPackage,
      signingConfig: this.signingConfig
    }).build();
    const apkPath = _path.default.resolve(serverPath, 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');
    this.log.debug(`Copying built apk from '${apkPath}' to '${this.modServerPath}'`);
    await _support.fs.copyFile(apkPath, this.modServerPath);
  }
  async cleanupSessionLeftovers() {
    this.log.debug('Performing cleanup of automation leftovers');
    try {
      const {
        value
      } = (await (0, _axios.default)({
        url: `http://${this.host}:${this.systemPort}/sessions`,
        timeout: 500
      })).data;
      const activeSessionIds = value.map(sess => sess.id);
      if (activeSessionIds.length) {
        this.log.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);
        this.log.debug('Cleaning up the obsolete sessions');
        await _bluebird.default.all(activeSessionIds.map(id => (0, _axios.default)({
          url: `http://${this.host}:${this.systemPort}/session/${id}`,
          method: 'DELETE'
        })));
        await _bluebird.default.delay(1000);
      } else {
        this.log.debug('No obsolete sessions have been detected');
      }
    } catch (e) {
      this.log.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }
  async startSession(caps) {
    await this.cleanupSessionLeftovers();
    const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true', '-e', 'disableAnalytics', true];
    if (_lodash.default.isBoolean(this.disableSuppressAccessibilityService)) {
      cmd.push('-e', 'DISABLE_SUPPRESS_ACCESSIBILITY_SERVICES', this.disableSuppressAccessibilityService);
    }
    cmd.push(`${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`);
    const {
      manifestPayload
    } = await (0, _utils.getPackageInfo)();
    this.log.info(`Starting Espresso Server v${manifestPayload.version} with cmd: adb ${cmd.join(' ')}`);
    let hasSocketError = false;
    this.jwproxy.instrumentationState = {
      exited: false,
      crashed: false
    };
    this.instProcess = this.adb.createSubProcess(cmd);
    this.instProcess.on('exit', (code, signal) => {
      this.log.info(`Instrumentation process exited with code ${code} from signal ${signal}`);
      this.jwproxy.instrumentationState.exited = true;
    });
    this.instProcess.on('output', (stdout, stderr) => {
      const line = stdout || stderr;
      if (_lodash.default.isEmpty(line.trim())) {
        return;
      }
      this.log.debug(`[Instrumentation] ${line.trim()}`);
      if (line.toLowerCase().includes('java.net.socketexception')) {
        hasSocketError = true;
      } else if (line.includes('Process crashed')) {
        this.jwproxy.instrumentationState.crashed = true;
      }
    });
    const timer = new _support.timing.Timer().start();
    await this.instProcess.start(0);
    this.log.info(`Waiting up to ${this.serverLaunchTimeout}ms for Espresso server to be online`);
    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (hasSocketError) {
          this.log.errorAndThrow(`Espresso server has failed to start due to an unexpected exception. ` + `Make sure the 'INTERNET' permission is requested in the Android manifest of your ` + `application under test (<uses-permission android:name="android.permission.INTERNET" />)`);
        } else if (this.jwproxy.instrumentationState.exited) {
          this.log.errorAndThrow(`Espresso server process has been unexpectedly terminated. ` + `Check the Appium server log and the logcat output for more details`);
        }
        try {
          await this.jwproxy.command('/status', 'GET');
          return true;
        } catch (e) {
          return false;
        }
      }, {
        waitMs: this.serverLaunchTimeout,
        intervalMs: 500
      });
    } catch (e) {
      if (/Condition unmet/.test(e.message)) {
        this.log.errorAndThrow(`Timed out waiting for Espresso server to be ` + `online within ${this.serverLaunchTimeout}ms. The timeout value could be ` + `customized using 'espressoServerLaunchTimeout' capability`);
      }
      throw e;
    }
    this.log.info(`Espresso server is online. ` + `The initialization process took ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    this.log.info('Starting the session');
    await this.jwproxy.command('/session', 'POST', {
      capabilities: {
        firstMatch: [caps],
        alwaysMatch: {}
      }
    });
    await this.recordTargetAppPackage();
  }
  async recordTargetAppPackage() {
    await this.adb.shell([`echo "${this.appPackage}" > "${TARGET_PACKAGE_CONTAINER}"`]);
    this.log.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
  }
  async deleteSession() {
    this.log.debug('Deleting Espresso server session');
    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      this.log.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
    }
    if (this.instProcess && this.instProcess.isRunning) {
      await this.instProcess.stop();
    }
  }
}
exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJURVNUX1NFUlZFUl9ST09UIiwicGF0aCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJURVNUX0FQS19QS0ciLCJSRVFVSVJFRF9QQVJBTVMiLCJFU1BSRVNTT19TRVJWRVJfTEFVTkNIX1RJTUVPVVRfTVMiLCJUQVJHRVRfUEFDS0FHRV9DT05UQUlORVIiLCJFc3ByZXNzb1Byb3h5IiwiSldQcm94eSIsInByb3h5Q29tbWFuZCIsInVybCIsIm1ldGhvZCIsImJvZHkiLCJjcmFzaGVkIiwiZXhpdGVkIiwiaW5zdHJ1bWVudGF0aW9uU3RhdGUiLCJlcnJvcnMiLCJJbnZhbGlkQ29udGV4dEVycm9yIiwiRXNwcmVzc29SdW5uZXIiLCJjb25zdHJ1Y3RvciIsImxvZyIsIm9wdHMiLCJyZXEiLCJ1dGlsIiwiaGFzVmFsdWUiLCJFcnJvciIsImp3cHJveHkiLCJzZXJ2ZXIiLCJob3N0IiwicG9ydCIsInN5c3RlbVBvcnQiLCJiYXNlIiwia2VlcEFsaXZlIiwicHJveHlSZXFSZXMiLCJiaW5kIiwiY29tbWFuZCIsIm1hbmlmZXN0UGF5bG9hZCIsImdldFBhY2thZ2VJbmZvU3luYyIsIm1vZFNlcnZlck5hbWUiLCJmcyIsInNhbml0aXplTmFtZSIsInZlcnNpb24iLCJhcHBQYWNrYWdlIiwiYWRiIiwiY3VyRGV2aWNlSWQiLCJyZXBsYWNlbWVudCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJzaG93R3JhZGxlTG9nIiwiZXNwcmVzc29CdWlsZENvbmZpZyIsInNlcnZlckxhdW5jaFRpbWVvdXQiLCJhbmRyb2lkSW5zdGFsbFRpbWVvdXQiLCJkaXNhYmxlU3VwcHJlc3NBY2Nlc3NpYmlsaXR5U2VydmljZSIsInVzZUtleXN0b3JlIiwia2V5c3RvcmVQYXRoIiwia2V5c3RvcmVQYXNzd29yZCIsImtleUFsaWFzIiwia2V5UGFzc3dvcmQiLCJzaWduaW5nQ29uZmlnIiwiYnVpbGRTZXJ2ZXJTaWduaW5nQ29uZmlnIiwia2V5c3RvcmVGaWxlIiwiaXNBcHBQYWNrYWdlQ2hhbmdlZCIsImZpbGVFeGlzdHMiLCJkZWJ1ZyIsInByZXZpb3VzQXBwUGFja2FnZSIsInNoZWxsIiwidHJpbSIsImluc3RhbGxTZXJ2ZXIiLCJhcHBTdGF0ZSIsImdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlIiwic2hvdWxkVW5pbnN0YWxsQXBwIiwiQVBQX0lOU1RBTExfU1RBVEUiLCJPTERFUl9WRVJTSU9OX0lOU1RBTExFRCIsIk5FV0VSX1ZFUlNJT05fSU5TVEFMTEVEIiwiaW5jbHVkZXMiLCJzaG91bGRJbnN0YWxsQXBwIiwiTk9UX0lOU1RBTExFRCIsImluZm8iLCJ1bmluc3RhbGxBcGsiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsImluc3RhbGwiLCJyZXBsYWNlIiwidGltZW91dCIsImVycm9yQW5kVGhyb3ciLCJpbnN0YWxsVGVzdEFwayIsInJlYnVpbGQiLCJmb3JjZUVzcHJlc3NvUmVidWlsZCIsImV4aXN0cyIsInVubGluayIsImJ1aWxkTmV3TW9kU2VydmVyIiwiaXNTaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwiYnVpbGRDb25maWd1cmF0aW9uIiwiYnVpbGRDb25maWd1cmF0aW9uU3RyIiwicmVhZEZpbGUiLCJKU09OIiwicGFyc2UiLCJlIiwiZXJyb3IiLCJkaXJOYW1lIiwic2VydmVyUGF0aCIsInJpbXJhZiIsIm1rZGlycCIsImNvcHlHcmFkbGVQcm9qZWN0UmVjdXJzaXZlbHkiLCJTZXJ2ZXJCdWlsZGVyIiwidGVzdEFwcFBhY2thZ2UiLCJidWlsZCIsImFwa1BhdGgiLCJjb3B5RmlsZSIsImNsZWFudXBTZXNzaW9uTGVmdG92ZXJzIiwidmFsdWUiLCJheGlvcyIsImRhdGEiLCJhY3RpdmVTZXNzaW9uSWRzIiwibWFwIiwic2VzcyIsImlkIiwibGVuZ3RoIiwic3RyaW5naWZ5IiwiQiIsImFsbCIsImRlbGF5Iiwic3RhcnRTZXNzaW9uIiwiY2FwcyIsImNtZCIsInByb2Nlc3MiLCJlbnYiLCJFU1BSRVNTT19KQVZBX0RFQlVHIiwiXyIsImlzQm9vbGVhbiIsInB1c2giLCJnZXRQYWNrYWdlSW5mbyIsImpvaW4iLCJoYXNTb2NrZXRFcnJvciIsImluc3RQcm9jZXNzIiwiY3JlYXRlU3ViUHJvY2VzcyIsIm9uIiwiY29kZSIsInNpZ25hbCIsInN0ZG91dCIsInN0ZGVyciIsImxpbmUiLCJpc0VtcHR5IiwidG9Mb3dlckNhc2UiLCJ0aW1lciIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJ3YWl0Rm9yQ29uZGl0aW9uIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsInRlc3QiLCJnZXREdXJhdGlvbiIsImFzTWlsbGlTZWNvbmRzIiwidG9GaXhlZCIsImNhcGFiaWxpdGllcyIsImZpcnN0TWF0Y2giLCJhbHdheXNNYXRjaCIsInJlY29yZFRhcmdldEFwcFBhY2thZ2UiLCJkZWxldGVTZXNzaW9uIiwiaXNSdW5uaW5nIiwic3RvcCJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSldQcm94eSwgZXJyb3JzIH0gZnJvbSAnYXBwaXVtL2RyaXZlcic7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgU2VydmVyQnVpbGRlciwgYnVpbGRTZXJ2ZXJTaWduaW5nQ29uZmlnIH0gZnJvbSAnLi9zZXJ2ZXItYnVpbGRlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB1dGlsLCBta2RpcnAsIHRpbWluZyB9IGZyb20gJ2FwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBjb3B5R3JhZGxlUHJvamVjdFJlY3Vyc2l2ZWx5LCBnZXRQYWNrYWdlSW5mb1N5bmMsIGdldFBhY2thZ2VJbmZvIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuXG5cbmNvbnN0IFRFU1RfU0VSVkVSX1JPT1QgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnZXNwcmVzc28tc2VydmVyJyk7XG5jb25zdCBURVNUX0FQS19QS0cgPSAnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLnRlc3QnO1xuY29uc3QgUkVRVUlSRURfUEFSQU1TID0gW1xuICAnYWRiJyxcbiAgJ3RtcERpcicsXG4gICdob3N0JyxcbiAgJ3N5c3RlbVBvcnQnLFxuICAnZGV2aWNlUG9ydCcsXG4gICdhcHBQYWNrYWdlJyxcbiAgJ2ZvcmNlRXNwcmVzc29SZWJ1aWxkJyxcbl07XG5jb25zdCBFU1BSRVNTT19TRVJWRVJfTEFVTkNIX1RJTUVPVVRfTVMgPSA0NTAwMDtcbmNvbnN0IFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUiA9ICcvZGF0YS9sb2NhbC90bXAvZXNwcmVzc28uYXBwcGFja2FnZSc7XG5cbmNsYXNzIEVzcHJlc3NvUHJveHkgZXh0ZW5kcyBKV1Byb3h5IHtcbiAgYXN5bmMgcHJveHlDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBjb25zdCB7Y3Jhc2hlZCwgZXhpdGVkfSA9IHRoaXMuaW5zdHJ1bWVudGF0aW9uU3RhdGU7XG4gICAgaWYgKGV4aXRlZCkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQ29udGV4dEVycm9yKGAnJHttZXRob2R9ICR7dXJsfScgY2Fubm90IGJlIHByb3hpZWQgdG8gRXNwcmVzc28gc2VydmVyIGJlY2F1c2UgYCArXG4gICAgICAgIGB0aGUgaW5zdHJ1bWVudGF0aW9uIHByb2Nlc3MgaGFzICR7Y3Jhc2hlZCA/ICdjcmFzaGVkJyA6ICdiZWVuIHVuZXhwZWN0ZWRseSB0ZXJtaW5hdGVkJ30uIGAgK1xuICAgICAgICBgQ2hlY2sgdGhlIEFwcGl1bSBzZXJ2ZXIgbG9nIGFuZCB0aGUgbG9nY2F0IG91dHB1dCBmb3IgbW9yZSBkZXRhaWxzYCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCBzdXBlci5wcm94eUNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG59XG5cbmNsYXNzIEVzcHJlc3NvUnVubmVyIHtcbiAgY29uc3RydWN0b3IgKGxvZywgb3B0cyA9IHt9KSB7XG4gICAgZm9yIChsZXQgcmVxIG9mIFJFUVVJUkVEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICF1dGlsLmhhc1ZhbHVlKG9wdHNbcmVxXSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuICAgIHRoaXMubG9nID0gbG9nO1xuICAgIHRoaXMuandwcm94eSA9IG5ldyBFc3ByZXNzb1Byb3h5KHtcbiAgICAgIGxvZyxcbiAgICAgIHNlcnZlcjogdGhpcy5ob3N0LFxuICAgICAgcG9ydDogdGhpcy5zeXN0ZW1Qb3J0LFxuICAgICAgYmFzZTogJycsXG4gICAgICBrZWVwQWxpdmU6IHRydWUsXG4gICAgfSk7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG4gICAgdGhpcy5wcm94eUNvbW1hbmQgPSB0aGlzLmp3cHJveHkuY29tbWFuZC5iaW5kKHRoaXMuandwcm94eSk7XG4gICAgdGhpcy5qd3Byb3h5Lmluc3RydW1lbnRhdGlvblN0YXRlID0ge1xuICAgICAgZXhpdGVkOiBmYWxzZSxcbiAgICAgIGNyYXNoZWQ6IGZhbHNlLFxuICAgIH07XG5cbiAgICBjb25zdCB7IG1hbmlmZXN0UGF5bG9hZCB9ID0gZ2V0UGFja2FnZUluZm9TeW5jKCk7XG4gICAgY29uc3QgbW9kU2VydmVyTmFtZSA9IGZzLnNhbml0aXplTmFtZShcbiAgICAgIGAke1RFU1RfQVBLX1BLR31fJHttYW5pZmVzdFBheWxvYWQudmVyc2lvbn1fJHt0aGlzLmFwcFBhY2thZ2V9XyR7dGhpcy5hZGIuY3VyRGV2aWNlSWR9LmFwa2AsXG4gICAgICB7cmVwbGFjZW1lbnQ6ICctJ31cbiAgICApO1xuICAgIHRoaXMubW9kU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgbW9kU2VydmVyTmFtZSk7XG4gICAgdGhpcy5zaG93R3JhZGxlTG9nID0gb3B0cy5zaG93R3JhZGxlTG9nO1xuICAgIHRoaXMuZXNwcmVzc29CdWlsZENvbmZpZyA9IG9wdHMuZXNwcmVzc29CdWlsZENvbmZpZztcblxuICAgIHRoaXMuc2VydmVyTGF1bmNoVGltZW91dCA9IG9wdHMuc2VydmVyTGF1bmNoVGltZW91dCB8fCBFU1BSRVNTT19TRVJWRVJfTEFVTkNIX1RJTUVPVVRfTVM7XG4gICAgdGhpcy5hbmRyb2lkSW5zdGFsbFRpbWVvdXQgPSBvcHRzLmFuZHJvaWRJbnN0YWxsVGltZW91dDtcblxuICAgIHRoaXMuZGlzYWJsZVN1cHByZXNzQWNjZXNzaWJpbGl0eVNlcnZpY2UgPSBvcHRzLmRpc2FibGVTdXBwcmVzc0FjY2Vzc2liaWxpdHlTZXJ2aWNlO1xuXG4gICAgLy8gRXNwcmVzc28gU2VydmVyIGFwcCBuZWVkcyB0byBiZSBzaWduZWQgd2l0aCBzYW1lIGtleVN0b3JlIGFzIGFwcFBhY2thZ2VcbiAgICBpZiAob3B0cy51c2VLZXlzdG9yZSAmJiBvcHRzLmtleXN0b3JlUGF0aCAmJiBvcHRzLmtleXN0b3JlUGFzc3dvcmQgJiYgb3B0cy5rZXlBbGlhcyAmJiBvcHRzLmtleVBhc3N3b3JkKSB7XG4gICAgICB0aGlzLnNpZ25pbmdDb25maWcgPSBidWlsZFNlcnZlclNpZ25pbmdDb25maWcoe1xuICAgICAgICBrZXlzdG9yZUZpbGU6IG9wdHMua2V5c3RvcmVQYXRoLFxuICAgICAgICBrZXlzdG9yZVBhc3N3b3JkOiBvcHRzLmtleXN0b3JlUGFzc3dvcmQsXG4gICAgICAgIGtleUFsaWFzOiBvcHRzLmtleUFsaWFzLFxuICAgICAgICBrZXlQYXNzd29yZDogb3B0cy5rZXlQYXNzd29yZFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2lnbmluZ0NvbmZpZyA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaXNBcHBQYWNrYWdlQ2hhbmdlZCAoKSB7XG4gICAgaWYgKCFhd2FpdCB0aGlzLmFkYi5maWxlRXhpc3RzKFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUikpIHtcbiAgICAgIHRoaXMubG9nLmRlYnVnKCdUaGUgcHJldmlvdXMgdGFyZ2V0IGFwcGxpY2F0aW9uIHBhY2thZ2UgaXMgdW5rbm93bicpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGNvbnN0IHByZXZpb3VzQXBwUGFja2FnZSA9IChhd2FpdCB0aGlzLmFkYi5zaGVsbChbJ2NhdCcsIFRBUkdFVF9QQUNLQUdFX0NPTlRBSU5FUl0pKS50cmltKCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYFRoZSBwcmV2aW91cyB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSB3YXMgJyR7cHJldmlvdXNBcHBQYWNrYWdlfScuIGAgK1xuICAgICAgYFRoZSBjdXJyZW50IHBhY2thZ2UgaXMgJyR7dGhpcy5hcHBQYWNrYWdlfSdgKTtcbiAgICByZXR1cm4gcHJldmlvdXNBcHBQYWNrYWdlICE9PSB0aGlzLmFwcFBhY2thZ2U7XG4gIH1cblxuICAvKipcbiAgICogSW5zdGFsbHMgRXNwcmVzc28gc2VydmVyIGFwayBvbiB0byB0aGUgZGV2aWNlIG9yIGVtdWxhdG9yLlxuICAgKiBFYWNoIGFkYiBjb21tYW5kIHVzZXMgZGVmYXVsdCB0aW1lb3V0IGJ5IHRoZW0uXG4gICAqL1xuICBhc3luYyBpbnN0YWxsU2VydmVyICgpIHtcbiAgICBjb25zdCBhcHBTdGF0ZSA9IGF3YWl0IHRoaXMuYWRiLmdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlKHRoaXMubW9kU2VydmVyUGF0aCwgVEVTVF9BUEtfUEtHKTtcblxuICAgIGNvbnN0IHNob3VsZFVuaW5zdGFsbEFwcCA9IFtcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk9MREVSX1ZFUlNJT05fSU5TVEFMTEVELFxuICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuTkVXRVJfVkVSU0lPTl9JTlNUQUxMRURcbiAgICBdLmluY2x1ZGVzKGFwcFN0YXRlKTtcbiAgICBjb25zdCBzaG91bGRJbnN0YWxsQXBwID0gc2hvdWxkVW5pbnN0YWxsQXBwIHx8IFtcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk5PVF9JTlNUQUxMRURcbiAgICBdLmluY2x1ZGVzKGFwcFN0YXRlKTtcblxuICAgIGlmIChzaG91bGRVbmluc3RhbGxBcHApIHtcbiAgICAgIHRoaXMubG9nLmluZm8oYFVuaW5zdGFsbGluZyBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgZnJvbSB0aGUgdGFyZ2V0IGRldmljZSAocGtnOiAnJHtURVNUX0FQS19QS0d9JylgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhURVNUX0FQS19QS0cpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMubG9nLndhcm4oYEVycm9yIHVuaW5zdGFsbGluZyAnJHtURVNUX0FQS19QS0d9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc2hvdWxkSW5zdGFsbEFwcCkge1xuICAgICAgdGhpcy5sb2cuaW5mbyhgSW5zdGFsbGluZyBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgZnJvbSB0aGUgdGFyZ2V0IGRldmljZSAocGF0aDogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScpYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKHRoaXMubW9kU2VydmVyUGF0aCwgeyByZXBsYWNlOiBmYWxzZSwgdGltZW91dDogdGhpcy5hbmRyb2lkSW5zdGFsbFRpbWVvdXQgfSk7XG4gICAgICAgIHRoaXMubG9nLmluZm8oYEluc3RhbGxlZCBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhpcy5sb2cuZXJyb3JBbmRUaHJvdyhgQ2Fubm90IGluc3RhbGwgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgYmVjYXVzZSBvZiAnJHtlcnIubWVzc2FnZX0nYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFRlc3RBcGsgKCkge1xuICAgIGxldCByZWJ1aWxkID0gdGhpcy5mb3JjZUVzcHJlc3NvUmVidWlsZDtcbiAgICBpZiAocmVidWlsZCkge1xuICAgICAgdGhpcy5sb2cuZGVidWcoYCdmb3JjZUVzcHJlc3NvUmVidWlsZCcgY2FwYWJpbGl0eSBpcyBlbmFibGVkYCk7XG4gICAgfSBlbHNlIGlmIChhd2FpdCB0aGlzLmlzQXBwUGFja2FnZUNoYW5nZWQoKSkge1xuICAgICAgdGhpcy5sb2cuaW5mbyhgRm9yY2luZyBFc3ByZXNzbyBzZXJ2ZXIgcmVidWlsZCBiZWNhdXNlIG9mIGNoYW5nZWQgYXBwbGljYXRpb24gcGFja2FnZWApO1xuICAgICAgcmVidWlsZCA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHJlYnVpbGQgJiYgYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpIHtcbiAgICAgIHRoaXMubG9nLmRlYnVnKGBEZWxldGluZyB0aGUgb2Jzb2xldGUgRXNwcmVzc28gc2VydmVyIHBhY2thZ2UgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgICAgIGF3YWl0IGZzLnVubGluayh0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIH1cbiAgICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5tb2RTZXJ2ZXJQYXRoKSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuYnVpbGROZXdNb2RTZXJ2ZXIoKTtcbiAgICB9XG4gICAgY29uc3QgaXNTaWduZWQgPSBhd2FpdCB0aGlzLmFkYi5jaGVja0Fwa0NlcnQodGhpcy5tb2RTZXJ2ZXJQYXRoLCBURVNUX0FQS19QS0cpO1xuICAgIGlmICghaXNTaWduZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24odGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICB9XG4gICAgaWYgKChyZWJ1aWxkIHx8ICFpc1NpZ25lZCkgJiYgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKFRFU1RfQVBLX1BLRykpIHtcbiAgICAgIHRoaXMubG9nLmluZm8oJ1VuaW5zdGFsbGVkIHRoZSBvYnNvbGV0ZSBFc3ByZXNzbyBzZXJ2ZXIgcGFja2FnZSBmcm9tIHRoZSBkZXZpY2UgdW5kZXIgdGVzdCcpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuaW5zdGFsbFNlcnZlcigpO1xuICB9XG5cbiAgYXN5bmMgYnVpbGROZXdNb2RTZXJ2ZXIgKCkge1xuICAgIGxldCBidWlsZENvbmZpZ3VyYXRpb24gPSB7fTtcbiAgICBpZiAodGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnKSB7XG4gICAgICBsZXQgYnVpbGRDb25maWd1cmF0aW9uU3RyO1xuICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyh0aGlzLmVzcHJlc3NvQnVpbGRDb25maWcpKSB7XG4gICAgICAgIHRoaXMubG9nLmluZm8oYExvYWRpbmcgdGhlIGJ1aWxkIGNvbmZpZ3VyYXRpb24gZnJvbSAnJHt0aGlzLmVzcHJlc3NvQnVpbGRDb25maWd9J2ApO1xuICAgICAgICBidWlsZENvbmZpZ3VyYXRpb25TdHIgPSBhd2FpdCBmcy5yZWFkRmlsZSh0aGlzLmVzcHJlc3NvQnVpbGRDb25maWcsICd1dGY4Jyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvZy5pbmZvKGBMb2FkaW5nIHRoZSBidWlsZCBjb25maWd1cmF0aW9uIGZyb20gJ2VzcHJlc3NvQnVpbGRDb25maWcnIGNhcGFiaWxpdHlgKTtcbiAgICAgICAgYnVpbGRDb25maWd1cmF0aW9uU3RyID0gdGhpcy5lc3ByZXNzb0J1aWxkQ29uZmlnO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgYnVpbGRDb25maWd1cmF0aW9uID0gSlNPTi5wYXJzZShidWlsZENvbmZpZ3VyYXRpb25TdHIpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aGlzLmxvZy5lcnJvcignQ2Fubm90IHBhcnNlIHRoZSBidWlsZCBjb25maWd1cmF0aW9uIEpTT04nLCBlKTtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgZGlyTmFtZSA9IGZzLnNhbml0aXplTmFtZShgZXNwcmVzc28tc2VydmVyLSR7dGhpcy5hZGIuY3VyRGV2aWNlSWR9YCwge1xuICAgICAgcmVwbGFjZW1lbnQ6ICctJyxcbiAgICB9KTtcbiAgICBjb25zdCBzZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBkaXJOYW1lKTtcbiAgICB0aGlzLmxvZy5pbmZvKGBCdWlsZGluZyBlc3ByZXNzbyBzZXJ2ZXIgaW4gJyR7c2VydmVyUGF0aH0nYCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYFRoZSBidWlsZCBmb2xkZXIgcm9vdCBjb3VsZCBiZSBjdXN0b21pemVkIGJ5IGNoYW5naW5nIHRoZSAndG1wRGlyJyBjYXBhYmlsaXR5YCk7XG4gICAgYXdhaXQgZnMucmltcmFmKHNlcnZlclBhdGgpO1xuICAgIGF3YWl0IG1rZGlycChzZXJ2ZXJQYXRoKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgQ29weWluZyBlc3ByZXNzbyBzZXJ2ZXIgdGVtcGxhdGUgZnJvbSAoJyR7VEVTVF9TRVJWRVJfUk9PVH0nIHRvICcke3NlcnZlclBhdGh9JylgKTtcbiAgICBhd2FpdCBjb3B5R3JhZGxlUHJvamVjdFJlY3Vyc2l2ZWx5KFRFU1RfU0VSVkVSX1JPT1QsIHNlcnZlclBhdGgpO1xuICAgIHRoaXMubG9nLmRlYnVnKCdCdWxkaW5nIGVzcHJlc3NvIHNlcnZlcicpO1xuICAgIGF3YWl0IG5ldyBTZXJ2ZXJCdWlsZGVyKHRoaXMubG9nLCB7XG4gICAgICBzZXJ2ZXJQYXRoLCBidWlsZENvbmZpZ3VyYXRpb24sXG4gICAgICBzaG93R3JhZGxlTG9nOiB0aGlzLnNob3dHcmFkbGVMb2csXG4gICAgICB0ZXN0QXBwUGFja2FnZTogdGhpcy5hcHBQYWNrYWdlLFxuICAgICAgc2lnbmluZ0NvbmZpZzogdGhpcy5zaWduaW5nQ29uZmlnXG4gICAgfSkuYnVpbGQoKTtcbiAgICBjb25zdCBhcGtQYXRoID0gcGF0aC5yZXNvbHZlKHNlcnZlclBhdGgsICdhcHAnLCAnYnVpbGQnLCAnb3V0cHV0cycsICdhcGsnLCAnYW5kcm9pZFRlc3QnLCAnZGVidWcnLCAnYXBwLWRlYnVnLWFuZHJvaWRUZXN0LmFwaycpO1xuICAgIHRoaXMubG9nLmRlYnVnKGBDb3B5aW5nIGJ1aWx0IGFwayBmcm9tICcke2Fwa1BhdGh9JyB0byAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICAgIGF3YWl0IGZzLmNvcHlGaWxlKGFwa1BhdGgsIHRoaXMubW9kU2VydmVyUGF0aCk7XG4gIH1cblxuICBhc3luYyBjbGVhbnVwU2Vzc2lvbkxlZnRvdmVycyAoKSB7XG4gICAgdGhpcy5sb2cuZGVidWcoJ1BlcmZvcm1pbmcgY2xlYW51cCBvZiBhdXRvbWF0aW9uIGxlZnRvdmVycycpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHt2YWx1ZX0gPSAoYXdhaXQgYXhpb3Moe1xuICAgICAgICB1cmw6IGBodHRwOi8vJHt0aGlzLmhvc3R9OiR7dGhpcy5zeXN0ZW1Qb3J0fS9zZXNzaW9uc2AsXG4gICAgICAgIHRpbWVvdXQ6IDUwMCxcbiAgICAgIH0pKS5kYXRhO1xuICAgICAgY29uc3QgYWN0aXZlU2Vzc2lvbklkcyA9IHZhbHVlLm1hcCgoc2VzcykgPT4gc2Vzcy5pZCk7XG4gICAgICBpZiAoYWN0aXZlU2Vzc2lvbklkcy5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoYFRoZSBmb2xsb3dpbmcgb2Jzb2xldGUgc2Vzc2lvbnMgYXJlIHN0aWxsIHJ1bm5pbmc6ICR7SlNPTi5zdHJpbmdpZnkoYWN0aXZlU2Vzc2lvbklkcyl9YCk7XG4gICAgICAgIHRoaXMubG9nLmRlYnVnKCdDbGVhbmluZyB1cCB0aGUgb2Jzb2xldGUgc2Vzc2lvbnMnKTtcbiAgICAgICAgYXdhaXQgQi5hbGwoYWN0aXZlU2Vzc2lvbklkcy5tYXAoKGlkKSA9PlxuICAgICAgICAgIGF4aW9zKHtcbiAgICAgICAgICAgIHVybDogYGh0dHA6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnN5c3RlbVBvcnR9L3Nlc3Npb24vJHtpZH1gLFxuICAgICAgICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgICAgICB9KVxuICAgICAgICApKTtcbiAgICAgICAgLy8gTGV0IGFsbCBzZXNzaW9ucyB0byBiZSBwcm9wZXJseSB0ZXJtaW5hdGVkIGJlZm9yZSBjb250aW51aW5nXG4gICAgICAgIGF3YWl0IEIuZGVsYXkoMTAwMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZygnTm8gb2Jzb2xldGUgc2Vzc2lvbnMgaGF2ZSBiZWVuIGRldGVjdGVkJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5sb2cuZGVidWcoYE5vIG9ic29sZXRlIHNlc3Npb25zIGhhdmUgYmVlbiBkZXRlY3RlZCAoJHtlLm1lc3NhZ2V9KWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoY2Fwcykge1xuICAgIGF3YWl0IHRoaXMuY2xlYW51cFNlc3Npb25MZWZ0b3ZlcnMoKTtcblxuICAgIGNvbnN0IGNtZCA9IFtcbiAgICAgICdzaGVsbCcsXG4gICAgICAnYW0nLCAnaW5zdHJ1bWVudCcsXG4gICAgICAnLXcnLFxuICAgICAgJy1lJywgJ2RlYnVnJywgcHJvY2Vzcy5lbnYuRVNQUkVTU09fSkFWQV9ERUJVRyA9PT0gJ3RydWUnLFxuICAgICAgJy1lJywgJ2Rpc2FibGVBbmFseXRpY3MnLCB0cnVlLCAvLyBUbyBhdm9pZCB1bmV4cGVjdGVkIGVycm9yIGJ5IGdvb2dsZSBhbmFseXRpY3NcbiAgICBdO1xuXG4gICAgaWYgKF8uaXNCb29sZWFuKHRoaXMuZGlzYWJsZVN1cHByZXNzQWNjZXNzaWJpbGl0eVNlcnZpY2UpKSB7XG4gICAgICBjbWQucHVzaCgnLWUnLCAnRElTQUJMRV9TVVBQUkVTU19BQ0NFU1NJQklMSVRZX1NFUlZJQ0VTJywgdGhpcy5kaXNhYmxlU3VwcHJlc3NBY2Nlc3NpYmlsaXR5U2VydmljZSk7XG4gICAgfVxuXG4gICAgY21kLnB1c2goYCR7VEVTVF9BUEtfUEtHfS9hbmRyb2lkeC50ZXN0LnJ1bm5lci5BbmRyb2lkSlVuaXRSdW5uZXJgKTtcblxuICAgIGNvbnN0IHttYW5pZmVzdFBheWxvYWR9ID0gYXdhaXQgZ2V0UGFja2FnZUluZm8oKTtcbiAgICB0aGlzLmxvZy5pbmZvKGBTdGFydGluZyBFc3ByZXNzbyBTZXJ2ZXIgdiR7bWFuaWZlc3RQYXlsb2FkLnZlcnNpb259IHdpdGggY21kOiBhZGIgJHtjbWQuam9pbignICcpfWApO1xuXG4gICAgbGV0IGhhc1NvY2tldEVycm9yID0gZmFsc2U7XG4gICAgLy8gc3RhcnQgdGhlIGluc3RydW1lbnRhdGlvbiBwcm9jZXNzXG4gICAgdGhpcy5qd3Byb3h5Lmluc3RydW1lbnRhdGlvblN0YXRlID0ge1xuICAgICAgZXhpdGVkOiBmYWxzZSxcbiAgICAgIGNyYXNoZWQ6IGZhbHNlLFxuICAgIH07XG4gICAgdGhpcy5pbnN0UHJvY2VzcyA9IHRoaXMuYWRiLmNyZWF0ZVN1YlByb2Nlc3MoY21kKTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgdGhpcy5sb2cuaW5mbyhgSW5zdHJ1bWVudGF0aW9uIHByb2Nlc3MgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9IGZyb20gc2lnbmFsICR7c2lnbmFsfWApO1xuICAgICAgdGhpcy5qd3Byb3h5Lmluc3RydW1lbnRhdGlvblN0YXRlLmV4aXRlZCA9IHRydWU7XG4gICAgfSk7XG4gICAgdGhpcy5pbnN0UHJvY2Vzcy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBjb25zdCBsaW5lID0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICAgIGlmIChfLmlzRW1wdHkobGluZS50cmltKCkpKSB7XG4gICAgICAgIC8vIERvIG5vdCBwcmludCBlbXB0eSBsaW5lcyBpbnRvIHRoZSBzeXN0ZW0gbG9nXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5sb2cuZGVidWcoYFtJbnN0cnVtZW50YXRpb25dICR7bGluZS50cmltKCl9YCk7XG4gICAgICAvLyBBICdTb2NrZXRFeGNlcHRpb24nIGluZGljYXRlcyB0aGF0IHdlIGNvdWxkbid0IGNvbm5lY3QgdG8gdGhlIEVzcHJlc3NvIHNlcnZlcixcbiAgICAgIC8vIGJlY2F1c2UgdGhlIElOVEVSTkVUIHBlcm1pc3Npb24gaXMgbm90IHNldFxuICAgICAgaWYgKGxpbmUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnamF2YS5uZXQuc29ja2V0ZXhjZXB0aW9uJykpIHtcbiAgICAgICAgaGFzU29ja2V0RXJyb3IgPSB0cnVlO1xuICAgICAgfSBlbHNlIGlmIChsaW5lLmluY2x1ZGVzKCdQcm9jZXNzIGNyYXNoZWQnKSkge1xuICAgICAgICB0aGlzLmp3cHJveHkuaW5zdHJ1bWVudGF0aW9uU3RhdGUuY3Jhc2hlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICAgIGF3YWl0IHRoaXMuaW5zdFByb2Nlc3Muc3RhcnQoMCk7XG4gICAgdGhpcy5sb2cuaW5mbyhgV2FpdGluZyB1cCB0byAke3RoaXMuc2VydmVyTGF1bmNoVGltZW91dH1tcyBmb3IgRXNwcmVzc28gc2VydmVyIHRvIGJlIG9ubGluZWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKGhhc1NvY2tldEVycm9yKSB7XG4gICAgICAgICAgdGhpcy5sb2cuZXJyb3JBbmRUaHJvdyhgRXNwcmVzc28gc2VydmVyIGhhcyBmYWlsZWQgdG8gc3RhcnQgZHVlIHRvIGFuIHVuZXhwZWN0ZWQgZXhjZXB0aW9uLiBgICtcbiAgICAgICAgICAgIGBNYWtlIHN1cmUgdGhlICdJTlRFUk5FVCcgcGVybWlzc2lvbiBpcyByZXF1ZXN0ZWQgaW4gdGhlIEFuZHJvaWQgbWFuaWZlc3Qgb2YgeW91ciBgICtcbiAgICAgICAgICAgIGBhcHBsaWNhdGlvbiB1bmRlciB0ZXN0ICg8dXNlcy1wZXJtaXNzaW9uIGFuZHJvaWQ6bmFtZT1cImFuZHJvaWQucGVybWlzc2lvbi5JTlRFUk5FVFwiIC8+KWApO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuandwcm94eS5pbnN0cnVtZW50YXRpb25TdGF0ZS5leGl0ZWQpIHtcbiAgICAgICAgICB0aGlzLmxvZy5lcnJvckFuZFRocm93KGBFc3ByZXNzbyBzZXJ2ZXIgcHJvY2VzcyBoYXMgYmVlbiB1bmV4cGVjdGVkbHkgdGVybWluYXRlZC4gYCArXG4gICAgICAgICAgICBgQ2hlY2sgdGhlIEFwcGl1bSBzZXJ2ZXIgbG9nIGFuZCB0aGUgbG9nY2F0IG91dHB1dCBmb3IgbW9yZSBkZXRhaWxzYCk7XG4gICAgICAgIH1cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSwge1xuICAgICAgICB3YWl0TXM6IHRoaXMuc2VydmVyTGF1bmNoVGltZW91dCxcbiAgICAgICAgaW50ZXJ2YWxNczogNTAwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKC9Db25kaXRpb24gdW5tZXQvLnRlc3QoZS5tZXNzYWdlKSkge1xuICAgICAgICB0aGlzLmxvZy5lcnJvckFuZFRocm93KGBUaW1lZCBvdXQgd2FpdGluZyBmb3IgRXNwcmVzc28gc2VydmVyIHRvIGJlIGAgK1xuICAgICAgICAgIGBvbmxpbmUgd2l0aGluICR7dGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0fW1zLiBUaGUgdGltZW91dCB2YWx1ZSBjb3VsZCBiZSBgICtcbiAgICAgICAgICBgY3VzdG9taXplZCB1c2luZyAnZXNwcmVzc29TZXJ2ZXJMYXVuY2hUaW1lb3V0JyBjYXBhYmlsaXR5YCk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgICB0aGlzLmxvZy5pbmZvKGBFc3ByZXNzbyBzZXJ2ZXIgaXMgb25saW5lLiBgICtcbiAgICAgIGBUaGUgaW5pdGlhbGl6YXRpb24gcHJvY2VzcyB0b29rICR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgdGhpcy5sb2cuaW5mbygnU3RhcnRpbmcgdGhlIHNlc3Npb24nKTtcblxuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge1xuICAgICAgY2FwYWJpbGl0aWVzOiB7XG4gICAgICAgIGZpcnN0TWF0Y2g6IFtjYXBzXSxcbiAgICAgICAgYWx3YXlzTWF0Y2g6IHt9XG4gICAgICB9XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5yZWNvcmRUYXJnZXRBcHBQYWNrYWdlKCk7XG4gIH1cblxuICBhc3luYyByZWNvcmRUYXJnZXRBcHBQYWNrYWdlICgpIHtcbiAgICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbYGVjaG8gXCIke3RoaXMuYXBwUGFja2FnZX1cIiA+IFwiJHtUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJ9XCJgXSk7XG4gICAgdGhpcy5sb2cuaW5mbyhgUmVjb3JkZWQgdGhlIHRhcmdldCBhcHBsaWNhdGlvbiBwYWNrYWdlICcke3RoaXMuYXBwUGFja2FnZX0nIHRvICR7VEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSfWApO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgdGhpcy5sb2cuZGVidWcoJ0RlbGV0aW5nIEVzcHJlc3NvIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5sb2cud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIEVzcHJlc3NvIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pbnN0UHJvY2VzcyAmJiB0aGlzLmluc3RQcm9jZXNzLmlzUnVubmluZykge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0UHJvY2Vzcy5zdG9wKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IEVzcHJlc3NvUnVubmVyLCBSRVFVSVJFRF9QQVJBTVMsIFRFU1RfQVBLX1BLRyB9O1xuZXhwb3J0IGRlZmF1bHQgRXNwcmVzc29SdW5uZXI7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBR0EsTUFBTUEsZ0JBQWdCLEdBQUdDLGFBQUksQ0FBQ0MsT0FBTyxDQUFDQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxpQkFBaUIsQ0FBQztBQUMvRSxNQUFNQyxZQUFZLEdBQUcsK0JBQStCO0FBQUM7QUFDckQsTUFBTUMsZUFBZSxHQUFHLENBQ3RCLEtBQUssRUFDTCxRQUFRLEVBQ1IsTUFBTSxFQUNOLFlBQVksRUFDWixZQUFZLEVBQ1osWUFBWSxFQUNaLHNCQUFzQixDQUN2QjtBQUFDO0FBQ0YsTUFBTUMsaUNBQWlDLEdBQUcsS0FBSztBQUMvQyxNQUFNQyx3QkFBd0IsR0FBRyxxQ0FBcUM7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