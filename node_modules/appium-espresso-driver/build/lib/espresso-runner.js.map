{"version":3,"file":"espresso-runner.js","names":["TEST_SERVER_ROOT","path","resolve","__dirname","TEST_APK_PKG","REQUIRED_PARAMS","ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS","TARGET_PACKAGE_CONTAINER","EspressoProxy","JWProxy","proxyCommand","url","method","body","crashed","exited","instrumentationState","errors","InvalidContextError","EspressoRunner","constructor","log","opts","req","util","hasValue","Error","jwproxy","server","host","port","systemPort","base","keepAlive","proxyReqRes","bind","command","manifestPayload","getPackageInfoSync","modServerName","fs","sanitizeName","version","appPackage","adb","curDeviceId","replacement","modServerPath","tmpDir","showGradleLog","espressoBuildConfig","serverLaunchTimeout","androidInstallTimeout","disableSuppressAccessibilityService","useKeystore","keystorePath","keystorePassword","keyAlias","keyPassword","signingConfig","buildServerSigningConfig","keystoreFile","isAppPackageChanged","fileExists","debug","previousAppPackage","shell","trim","installServer","appState","getApplicationInstallState","shouldUninstallApp","APP_INSTALL_STATE","OLDER_VERSION_INSTALLED","NEWER_VERSION_INSTALLED","includes","shouldInstallApp","NOT_INSTALLED","info","uninstallApk","err","warn","message","install","replace","timeout","errorAndThrow","installTestApk","rebuild","forceEspressoRebuild","exists","unlink","buildNewModServer","isSigned","checkApkCert","sign","buildConfiguration","buildConfigurationStr","readFile","JSON","parse","e","error","dirName","serverPath","rimraf","mkdirp","copyGradleProjectRecursively","ServerBuilder","testAppPackage","build","apkPath","copyFile","cleanupSessionLeftovers","value","axios","data","activeSessionIds","map","sess","id","length","stringify","B","all","delay","startSession","caps","cmd","process","env","ESPRESSO_JAVA_DEBUG","_","isBoolean","push","getPackageInfo","join","hasSocketError","instProcess","createSubProcess","on","code","signal","stdout","stderr","line","isEmpty","toLowerCase","timer","timing","Timer","start","waitForCondition","waitMs","intervalMs","test","getDuration","asMilliSeconds","toFixed","capabilities","firstMatch","alwaysMatch","recordTargetAppPackage","deleteSession","isRunning","stop"],"sources":["../../lib/espresso-runner.js"],"sourcesContent":["import { JWProxy, errors } from 'appium/driver';\nimport { waitForCondition } from 'asyncbox';\nimport { ServerBuilder, buildServerSigningConfig } from './server-builder';\nimport path from 'path';\nimport { fs, util, mkdirp, timing } from 'appium/support';\nimport B from 'bluebird';\nimport _ from 'lodash';\nimport { copyGradleProjectRecursively, getPackageInfoSync, getPackageInfo } from './utils';\nimport axios from 'axios';\n\n\nconst TEST_SERVER_ROOT = path.resolve(__dirname, '..', '..', 'espresso-server');\nconst TEST_APK_PKG = 'io.appium.espressoserver.test';\nconst REQUIRED_PARAMS = [\n  'adb',\n  'tmpDir',\n  'host',\n  'systemPort',\n  'devicePort',\n  'appPackage',\n  'forceEspressoRebuild',\n];\nconst ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS = 45000;\nconst TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';\n\nclass EspressoProxy extends JWProxy {\n  async proxyCommand (url, method, body = null) {\n    const {crashed, exited} = this.instrumentationState;\n    if (exited) {\n      throw new errors.InvalidContextError(`'${method} ${url}' cannot be proxied to Espresso server because ` +\n        `the instrumentation process has ${crashed ? 'crashed' : 'been unexpectedly terminated'}. ` +\n        `Check the Appium server log and the logcat output for more details`);\n    }\n    return await super.proxyCommand(url, method, body);\n  }\n}\n\nclass EspressoRunner {\n  constructor (log, opts = {}) {\n    for (let req of REQUIRED_PARAMS) {\n      if (!opts || !util.hasValue(opts[req])) {\n        throw new Error(`Option '${req}' is required!`);\n      }\n      this[req] = opts[req];\n    }\n    this.log = log;\n    this.jwproxy = new EspressoProxy({\n      log,\n      server: this.host,\n      port: this.systemPort,\n      base: '',\n      keepAlive: true,\n    });\n    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);\n    this.proxyCommand = this.jwproxy.command.bind(this.jwproxy);\n    this.jwproxy.instrumentationState = {\n      exited: false,\n      crashed: false,\n    };\n\n    const { manifestPayload } = getPackageInfoSync();\n    const modServerName = fs.sanitizeName(\n      `${TEST_APK_PKG}_${manifestPayload.version}_${this.appPackage}_${this.adb.curDeviceId}.apk`,\n      {replacement: '-'}\n    );\n    this.modServerPath = path.resolve(this.tmpDir, modServerName);\n    this.showGradleLog = opts.showGradleLog;\n    this.espressoBuildConfig = opts.espressoBuildConfig;\n\n    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT_MS;\n    this.androidInstallTimeout = opts.androidInstallTimeout;\n\n    this.disableSuppressAccessibilityService = opts.disableSuppressAccessibilityService;\n\n    // Espresso Server app needs to be signed with same keyStore as appPackage\n    if (opts.useKeystore && opts.keystorePath && opts.keystorePassword && opts.keyAlias && opts.keyPassword) {\n      this.signingConfig = buildServerSigningConfig({\n        keystoreFile: opts.keystorePath,\n        keystorePassword: opts.keystorePassword,\n        keyAlias: opts.keyAlias,\n        keyPassword: opts.keyPassword\n      });\n    } else {\n      this.signingConfig = null;\n    }\n  }\n\n  async isAppPackageChanged () {\n    if (!await this.adb.fileExists(TARGET_PACKAGE_CONTAINER)) {\n      this.log.debug('The previous target application package is unknown');\n      return true;\n    }\n    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();\n    this.log.debug(`The previous target application package was '${previousAppPackage}'. ` +\n      `The current package is '${this.appPackage}'`);\n    return previousAppPackage !== this.appPackage;\n  }\n\n  /**\n   * Installs Espresso server apk on to the device or emulator.\n   * Each adb command uses default timeout by them.\n   */\n  async installServer () {\n    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);\n\n    const shouldUninstallApp = [\n      this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED,\n      this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED\n    ].includes(appState);\n    const shouldInstallApp = shouldUninstallApp || [\n      this.adb.APP_INSTALL_STATE.NOT_INSTALLED\n    ].includes(appState);\n\n    if (shouldUninstallApp) {\n      this.log.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);\n      try {\n        await this.adb.uninstallApk(TEST_APK_PKG);\n      } catch (err) {\n        this.log.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);\n      }\n    }\n\n    if (shouldInstallApp) {\n      this.log.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);\n      try {\n        await this.adb.install(this.modServerPath, { replace: false, timeout: this.androidInstallTimeout });\n        this.log.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);\n      } catch (err) {\n        this.log.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);\n      }\n    }\n  }\n\n  async installTestApk () {\n    let rebuild = this.forceEspressoRebuild;\n    if (rebuild) {\n      this.log.debug(`'forceEspressoRebuild' capability is enabled`);\n    } else if (await this.isAppPackageChanged()) {\n      this.log.info(`Forcing Espresso server rebuild because of changed application package`);\n      rebuild = true;\n    }\n\n    if (rebuild && await fs.exists(this.modServerPath)) {\n      this.log.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);\n      await fs.unlink(this.modServerPath);\n    }\n    if (!(await fs.exists(this.modServerPath))) {\n      await this.buildNewModServer();\n    }\n    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);\n    if (!isSigned) {\n      await this.adb.sign(this.modServerPath);\n    }\n    if ((rebuild || !isSigned) && await this.adb.uninstallApk(TEST_APK_PKG)) {\n      this.log.info('Uninstalled the obsolete Espresso server package from the device under test');\n    }\n\n    await this.installServer();\n  }\n\n  async buildNewModServer () {\n    let buildConfiguration = {};\n    if (this.espressoBuildConfig) {\n      let buildConfigurationStr;\n      if (await fs.exists(this.espressoBuildConfig)) {\n        this.log.info(`Loading the build configuration from '${this.espressoBuildConfig}'`);\n        buildConfigurationStr = await fs.readFile(this.espressoBuildConfig, 'utf8');\n      } else {\n        this.log.info(`Loading the build configuration from 'espressoBuildConfig' capability`);\n        buildConfigurationStr = this.espressoBuildConfig;\n      }\n      try {\n        buildConfiguration = JSON.parse(buildConfigurationStr);\n      } catch (e) {\n        this.log.error('Cannot parse the build configuration JSON', e);\n        throw e;\n      }\n    }\n    const dirName = fs.sanitizeName(`espresso-server-${this.adb.curDeviceId}`, {\n      replacement: '-',\n    });\n    const serverPath = path.resolve(this.tmpDir, dirName);\n    this.log.info(`Building espresso server in '${serverPath}'`);\n    this.log.debug(`The build folder root could be customized by changing the 'tmpDir' capability`);\n    await fs.rimraf(serverPath);\n    await mkdirp(serverPath);\n    this.log.debug(`Copying espresso server template from ('${TEST_SERVER_ROOT}' to '${serverPath}')`);\n    await copyGradleProjectRecursively(TEST_SERVER_ROOT, serverPath);\n    this.log.debug('Bulding espresso server');\n    await new ServerBuilder(this.log, {\n      serverPath, buildConfiguration,\n      showGradleLog: this.showGradleLog,\n      testAppPackage: this.appPackage,\n      signingConfig: this.signingConfig\n    }).build();\n    const apkPath = path.resolve(serverPath, 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');\n    this.log.debug(`Copying built apk from '${apkPath}' to '${this.modServerPath}'`);\n    await fs.copyFile(apkPath, this.modServerPath);\n  }\n\n  async cleanupSessionLeftovers () {\n    this.log.debug('Performing cleanup of automation leftovers');\n\n    try {\n      const {value} = (await axios({\n        url: `http://${this.host}:${this.systemPort}/sessions`,\n        timeout: 500,\n      })).data;\n      const activeSessionIds = value.map((sess) => sess.id);\n      if (activeSessionIds.length) {\n        this.log.debug(`The following obsolete sessions are still running: ${JSON.stringify(activeSessionIds)}`);\n        this.log.debug('Cleaning up the obsolete sessions');\n        await B.all(activeSessionIds.map((id) =>\n          axios({\n            url: `http://${this.host}:${this.systemPort}/session/${id}`,\n            method: 'DELETE',\n          })\n        ));\n        // Let all sessions to be properly terminated before continuing\n        await B.delay(1000);\n      } else {\n        this.log.debug('No obsolete sessions have been detected');\n      }\n    } catch (e) {\n      this.log.debug(`No obsolete sessions have been detected (${e.message})`);\n    }\n  }\n\n  async startSession (caps) {\n    await this.cleanupSessionLeftovers();\n\n    const cmd = [\n      'shell',\n      'am', 'instrument',\n      '-w',\n      '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true',\n      '-e', 'disableAnalytics', true, // To avoid unexpected error by google analytics\n    ];\n\n    if (_.isBoolean(this.disableSuppressAccessibilityService)) {\n      cmd.push('-e', 'DISABLE_SUPPRESS_ACCESSIBILITY_SERVICES', this.disableSuppressAccessibilityService);\n    }\n\n    cmd.push(`${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`);\n\n    const {manifestPayload} = await getPackageInfo();\n    this.log.info(`Starting Espresso Server v${manifestPayload.version} with cmd: adb ${cmd.join(' ')}`);\n\n    let hasSocketError = false;\n    // start the instrumentation process\n    this.jwproxy.instrumentationState = {\n      exited: false,\n      crashed: false,\n    };\n    this.instProcess = this.adb.createSubProcess(cmd);\n    this.instProcess.on('exit', (code, signal) => {\n      this.log.info(`Instrumentation process exited with code ${code} from signal ${signal}`);\n      this.jwproxy.instrumentationState.exited = true;\n    });\n    this.instProcess.on('output', (stdout, stderr) => {\n      const line = stdout || stderr;\n      if (_.isEmpty(line.trim())) {\n        // Do not print empty lines into the system log\n        return;\n      }\n\n      this.log.debug(`[Instrumentation] ${line.trim()}`);\n      // A 'SocketException' indicates that we couldn't connect to the Espresso server,\n      // because the INTERNET permission is not set\n      if (line.toLowerCase().includes('java.net.socketexception')) {\n        hasSocketError = true;\n      } else if (line.includes('Process crashed')) {\n        this.jwproxy.instrumentationState.crashed = true;\n      }\n    });\n\n    const timer = new timing.Timer().start();\n    await this.instProcess.start(0);\n    this.log.info(`Waiting up to ${this.serverLaunchTimeout}ms for Espresso server to be online`);\n    try {\n      await waitForCondition(async () => {\n        if (hasSocketError) {\n          this.log.errorAndThrow(`Espresso server has failed to start due to an unexpected exception. ` +\n            `Make sure the 'INTERNET' permission is requested in the Android manifest of your ` +\n            `application under test (<uses-permission android:name=\"android.permission.INTERNET\" />)`);\n        } else if (this.jwproxy.instrumentationState.exited) {\n          this.log.errorAndThrow(`Espresso server process has been unexpectedly terminated. ` +\n            `Check the Appium server log and the logcat output for more details`);\n        }\n        try {\n          await this.jwproxy.command('/status', 'GET');\n          return true;\n        } catch (e) {\n          return false;\n        }\n      }, {\n        waitMs: this.serverLaunchTimeout,\n        intervalMs: 500,\n      });\n    } catch (e) {\n      if (/Condition unmet/.test(e.message)) {\n        this.log.errorAndThrow(`Timed out waiting for Espresso server to be ` +\n          `online within ${this.serverLaunchTimeout}ms. The timeout value could be ` +\n          `customized using 'espressoServerLaunchTimeout' capability`);\n      }\n      throw e;\n    }\n    this.log.info(`Espresso server is online. ` +\n      `The initialization process took ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);\n    this.log.info('Starting the session');\n\n    await this.jwproxy.command('/session', 'POST', {\n      capabilities: {\n        firstMatch: [caps],\n        alwaysMatch: {}\n      }\n    });\n    await this.recordTargetAppPackage();\n  }\n\n  async recordTargetAppPackage () {\n    await this.adb.shell([`echo \"${this.appPackage}\" > \"${TARGET_PACKAGE_CONTAINER}\"`]);\n    this.log.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);\n  }\n\n  async deleteSession () {\n    this.log.debug('Deleting Espresso server session');\n    // rely on jwproxy's intelligence to know what we're talking about and\n    // delete the current session\n    try {\n      await this.jwproxy.command('/', 'DELETE');\n    } catch (err) {\n      this.log.warn(`Did not get confirmation Espresso deleteSession worked; ` +\n          `Error was: ${err}`);\n    }\n\n    if (this.instProcess && this.instProcess.isRunning) {\n      await this.instProcess.stop();\n    }\n  }\n}\n\nexport { EspressoRunner, REQUIRED_PARAMS, TEST_APK_PKG };\nexport default EspressoRunner;\n"],"mappings":"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"}