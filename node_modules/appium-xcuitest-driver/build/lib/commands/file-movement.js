"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;
exports.parseContainerPath = parseContainerPath;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _support = require("appium/support");
var _path = _interopRequireDefault(require("path"));
var _logger = _interopRequireDefault(require("../logger"));
var _appiumIosDevice = require("appium-ios-device");
var _iosFsHelpers = require("../ios-fs-helpers");
var _driver = require("appium/driver");
var _utils = require("../utils");
const CONTAINER_PATH_MARKER = '@';
const CONTAINER_PATH_PATTERN = new RegExp(`^${CONTAINER_PATH_MARKER}([^/]+)/(.*)`);
const CONTAINER_TYPE_SEPARATOR = ':';
const CONTAINER_DOCUMENTS_PATH = 'Documents';
const OBJECT_NOT_FOUND_ERROR_MESSAGE = 'OBJECT_NOT_FOUND';
const commands = {};
exports.commands = commands;
function verifyIsSubPath(originalPath, root) {
  const normalizedRoot = _path.default.normalize(root);
  const normalizedPath = _path.default.normalize(_path.default.dirname(originalPath));
  if (normalizedRoot !== originalPath && !normalizedPath.startsWith(normalizedRoot)) {
    throw new Error(`'${normalizedPath}' is expected to be a subpath of '${normalizedRoot}'`);
  }
}
async function createAfcClient(udid, bundleId, containerType) {
  if (!bundleId) {
    return await _appiumIosDevice.services.startAfcService(udid);
  }
  const service = await _appiumIosDevice.services.startHouseArrestService(udid);
  return isDocumentsContainer(containerType) ? await service.vendDocuments(bundleId) : await service.vendContainer(bundleId);
}
function isDocumentsContainer(containerType) {
  return _lodash.default.toLower(containerType) === _lodash.default.toLower(CONTAINER_DOCUMENTS_PATH);
}
async function createService(udid, remotePath) {
  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer,
      containerType
    } = await parseContainerPath(remotePath);
    const service = await createAfcClient(udid, bundleId, containerType);
    const relativePath = isDocumentsContainer(containerType) ? _path.default.join(CONTAINER_DOCUMENTS_PATH, pathInContainer) : pathInContainer;
    return {
      service,
      relativePath
    };
  } else {
    const service = await createAfcClient(udid);
    return {
      service,
      relativePath: remotePath
    };
  }
}
async function parseContainerPath(remotePath, containerRootSupplier) {
  const match = CONTAINER_PATH_PATTERN.exec(remotePath);
  if (!match) {
    throw new Error(`It is expected that package identifier ` + `starts with '${CONTAINER_PATH_MARKER}' and is separated from the ` + `relative path with a single slash. '${remotePath}' is given instead`);
  }
  let [, bundleId, relativePath] = match;
  let containerType = null;
  const typeSeparatorPos = bundleId.indexOf(CONTAINER_TYPE_SEPARATOR);
  if (typeSeparatorPos > 0 && typeSeparatorPos < bundleId.length - 1) {
    containerType = bundleId.substring(typeSeparatorPos + 1);
    _logger.default.debug(`Parsed container type: ${containerType}`);
    bundleId = bundleId.substring(0, typeSeparatorPos);
  }
  if (_lodash.default.isNil(containerRootSupplier)) {
    const pathInContainer = relativePath;
    return {
      bundleId,
      pathInContainer,
      containerType
    };
  }
  const containerRoot = _lodash.default.isFunction(containerRootSupplier) ? await containerRootSupplier(bundleId, containerType) : containerRootSupplier;
  const pathInContainer = _path.default.posix.resolve(containerRoot, relativePath);
  verifyIsSubPath(pathInContainer, containerRoot);
  return {
    bundleId,
    pathInContainer,
    containerType
  };
}
async function pushFileToSimulator(device, remotePath, base64Data) {
  const buffer = Buffer.from(base64Data, 'base64');
  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer: dstPath
    } = await parseContainerPath(remotePath, async (appBundle, containerType) => await device.simctl.getAppContainer(appBundle, containerType));
    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will put the data into '${dstPath}'`);
    if (!(await _support.fs.exists(_path.default.dirname(dstPath)))) {
      _logger.default.debug(`The destination folder '${_path.default.dirname(dstPath)}' does not exist. Creating...`);
      await (0, _support.mkdirp)(_path.default.dirname(dstPath));
    }
    await _support.fs.writeFile(dstPath, buffer);
    return;
  }
  const dstFolder = await _support.tempDir.openDir();
  const dstPath = _path.default.resolve(dstFolder, _path.default.basename(remotePath));
  try {
    await _support.fs.writeFile(dstPath, buffer);
    await device.simctl.addMedia(dstPath);
  } finally {
    await _support.fs.rimraf(dstFolder);
  }
}
async function pushFileToRealDevice(device, remotePath, base64Data) {
  const {
    service,
    relativePath
  } = await createService(device.udid, remotePath);
  try {
    await (0, _iosFsHelpers.pushFile)(service, relativePath, base64Data);
  } catch (e) {
    _logger.default.debug(e.stack);
    throw new Error(`Could not push the file to '${remotePath}'.  Original error: ${e.message}`);
  } finally {
    service.close();
  }
}
async function deleteFileOrFolder(device, remotePath, isSimulator) {
  return isSimulator ? await deleteFromSimulator(device, remotePath) : await deleteFromRealDevice(device, remotePath);
}
async function pullFromSimulator(device, remotePath, isFile) {
  let pathOnServer;
  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer: dstPath
    } = await parseContainerPath(remotePath, async (appBundle, containerType) => await device.simctl.getAppContainer(appBundle, containerType));
    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will get the data from '${dstPath}'`);
    pathOnServer = dstPath;
  } else {
    const simRoot = device.getDir();
    pathOnServer = _path.default.posix.join(simRoot, remotePath);
    verifyIsSubPath(pathOnServer, simRoot);
    _logger.default.info(`Got the full item path: ${pathOnServer}`);
  }
  if (!(await _support.fs.exists(pathOnServer))) {
    _logger.default.errorAndThrow(`The remote ${isFile ? 'file' : 'folder'} at '${pathOnServer}' does not exist`);
  }
  const buffer = isFile ? await _support.util.toInMemoryBase64(pathOnServer) : await _support.zip.toInMemoryZip(pathOnServer, {
    encodeToBase64: true
  });
  return buffer.toString();
}
async function pullFromRealDevice(device, remotePath, isFile) {
  const {
    service,
    relativePath
  } = await createService(device.udid, remotePath);
  try {
    const fileInfo = await service.getFileInfo(relativePath);
    if (isFile && fileInfo.isDirectory()) {
      throw new Error(`The requested path is not a file. Path: '${remotePath}'`);
    }
    if (!isFile && !fileInfo.isDirectory()) {
      throw new Error(`The requested path is not a folder. Path: '${remotePath}'`);
    }
    return fileInfo.isFile() ? (await (0, _iosFsHelpers.pullFile)(service, relativePath)).toString('base64') : (await (0, _iosFsHelpers.pullFolder)(service, relativePath)).toString();
  } finally {
    service.close();
  }
}
async function deleteFromSimulator(device, remotePath) {
  let pathOnServer;
  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const {
      bundleId,
      pathInContainer: dstPath
    } = await parseContainerPath(remotePath, async (appBundle, containerType) => await device.simctl.getAppContainer(appBundle, containerType));
    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `'${dstPath}' will be deleted`);
    pathOnServer = dstPath;
  } else {
    const simRoot = device.getDir();
    pathOnServer = _path.default.posix.join(simRoot, remotePath);
    verifyIsSubPath(pathOnServer, simRoot);
    _logger.default.info(`Got the full path: ${pathOnServer}`);
  }
  if (!(await _support.fs.exists(pathOnServer))) {
    throw new _driver.errors.InvalidArgumentError(`The remote path at '${pathOnServer}' does not exist`);
  }
  await _support.fs.rimraf(pathOnServer);
}
async function deleteFromRealDevice(device, remotePath) {
  const {
    service,
    relativePath
  } = await createService(device.udid, remotePath);
  try {
    await service.deleteDirectory(relativePath);
  } catch (e) {
    if (e.message.includes(OBJECT_NOT_FOUND_ERROR_MESSAGE)) {
      throw new Error(`Path '${remotePath}' does not exist on the device`);
    }
    throw e;
  } finally {
    service.close();
  }
}
commands.pushFile = async function pushFile(remotePath, base64Data) {
  if (remotePath.endsWith('/')) {
    throw new _driver.errors.InvalidArgumentError(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }
  if (_lodash.default.isArray(base64Data)) {
    base64Data = Buffer.from(base64Data).toString('utf8');
  }
  return this.isSimulator() ? await pushFileToSimulator(this.opts.device, remotePath, base64Data) : await pushFileToRealDevice(this.opts.device, remotePath, base64Data);
};
commands.mobilePushFile = async function mobilePushFile(opts = {}) {
  const {
    remotePath,
    payload
  } = (0, _utils.requireArgs)(['remotePath', 'payload'], opts);
  return await this.pushFile(remotePath, payload);
};
commands.pullFile = async function pullFile(remotePath) {
  if (remotePath.endsWith('/')) {
    throw new _driver.errors.InvalidArgumentError(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }
  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, true) : await pullFromRealDevice(this.opts.device, remotePath, true);
};
commands.mobilePullFile = async function mobilePullFile(opts = {}) {
  const {
    remotePath
  } = (0, _utils.requireArgs)('remotePath', opts);
  return await this.pullFile(remotePath);
};
commands.mobileDeleteFolder = async function mobileDeleteFolder(opts = {}) {
  let {
    remotePath
  } = (0, _utils.requireArgs)('remotePath', opts);
  if (!remotePath.endsWith('/')) {
    remotePath = `${remotePath}/`;
  }
  return await deleteFileOrFolder(this.opts.device, remotePath, this.isSimulator());
};
commands.mobileDeleteFile = async function mobileDeleteFile(opts = {}) {
  const {
    remotePath
  } = (0, _utils.requireArgs)('remotePath', opts);
  if (remotePath.endsWith('/')) {
    throw new _driver.errors.InvalidArgumentError(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }
  return await deleteFileOrFolder(this.opts.device, remotePath, this.isSimulator());
};
commands.pullFolder = async function pullFolder(remotePath) {
  if (!remotePath.endsWith('/')) {
    remotePath = `${remotePath}/`;
  }
  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, false) : await pullFromRealDevice(this.opts.device, remotePath, false);
};
commands.mobilePullFolder = async function mobilePullFolder(opts = {}) {
  const {
    remotePath
  } = (0, _utils.requireArgs)('remotePath', opts);
  return await this.pullFolder(remotePath);
};
var _default = commands;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDT05UQUlORVJfUEFUSF9NQVJLRVIiLCJDT05UQUlORVJfUEFUSF9QQVRURVJOIiwiUmVnRXhwIiwiQ09OVEFJTkVSX1RZUEVfU0VQQVJBVE9SIiwiQ09OVEFJTkVSX0RPQ1VNRU5UU19QQVRIIiwiT0JKRUNUX05PVF9GT1VORF9FUlJPUl9NRVNTQUdFIiwiY29tbWFuZHMiLCJ2ZXJpZnlJc1N1YlBhdGgiLCJvcmlnaW5hbFBhdGgiLCJyb290Iiwibm9ybWFsaXplZFJvb3QiLCJwYXRoIiwibm9ybWFsaXplIiwibm9ybWFsaXplZFBhdGgiLCJkaXJuYW1lIiwic3RhcnRzV2l0aCIsIkVycm9yIiwiY3JlYXRlQWZjQ2xpZW50IiwidWRpZCIsImJ1bmRsZUlkIiwiY29udGFpbmVyVHlwZSIsInNlcnZpY2VzIiwic3RhcnRBZmNTZXJ2aWNlIiwic2VydmljZSIsInN0YXJ0SG91c2VBcnJlc3RTZXJ2aWNlIiwiaXNEb2N1bWVudHNDb250YWluZXIiLCJ2ZW5kRG9jdW1lbnRzIiwidmVuZENvbnRhaW5lciIsIl8iLCJ0b0xvd2VyIiwiY3JlYXRlU2VydmljZSIsInJlbW90ZVBhdGgiLCJ0ZXN0IiwicGF0aEluQ29udGFpbmVyIiwicGFyc2VDb250YWluZXJQYXRoIiwicmVsYXRpdmVQYXRoIiwiam9pbiIsImNvbnRhaW5lclJvb3RTdXBwbGllciIsIm1hdGNoIiwiZXhlYyIsInR5cGVTZXBhcmF0b3JQb3MiLCJpbmRleE9mIiwibGVuZ3RoIiwic3Vic3RyaW5nIiwibG9nIiwiZGVidWciLCJpc05pbCIsImNvbnRhaW5lclJvb3QiLCJpc0Z1bmN0aW9uIiwicG9zaXgiLCJyZXNvbHZlIiwicHVzaEZpbGVUb1NpbXVsYXRvciIsImRldmljZSIsImJhc2U2NERhdGEiLCJidWZmZXIiLCJCdWZmZXIiLCJmcm9tIiwiZHN0UGF0aCIsImFwcEJ1bmRsZSIsInNpbWN0bCIsImdldEFwcENvbnRhaW5lciIsImluZm8iLCJmcyIsImV4aXN0cyIsIm1rZGlycCIsIndyaXRlRmlsZSIsImRzdEZvbGRlciIsInRlbXBEaXIiLCJvcGVuRGlyIiwiYmFzZW5hbWUiLCJhZGRNZWRpYSIsInJpbXJhZiIsInB1c2hGaWxlVG9SZWFsRGV2aWNlIiwicHVzaEZpbGUiLCJlIiwic3RhY2siLCJtZXNzYWdlIiwiY2xvc2UiLCJkZWxldGVGaWxlT3JGb2xkZXIiLCJpc1NpbXVsYXRvciIsImRlbGV0ZUZyb21TaW11bGF0b3IiLCJkZWxldGVGcm9tUmVhbERldmljZSIsInB1bGxGcm9tU2ltdWxhdG9yIiwiaXNGaWxlIiwicGF0aE9uU2VydmVyIiwic2ltUm9vdCIsImdldERpciIsImVycm9yQW5kVGhyb3ciLCJ1dGlsIiwidG9Jbk1lbW9yeUJhc2U2NCIsInppcCIsInRvSW5NZW1vcnlaaXAiLCJlbmNvZGVUb0Jhc2U2NCIsInRvU3RyaW5nIiwicHVsbEZyb21SZWFsRGV2aWNlIiwiZmlsZUluZm8iLCJnZXRGaWxlSW5mbyIsImlzRGlyZWN0b3J5IiwicHVsbEZpbGUiLCJwdWxsRm9sZGVyIiwiZXJyb3JzIiwiSW52YWxpZEFyZ3VtZW50RXJyb3IiLCJkZWxldGVEaXJlY3RvcnkiLCJpbmNsdWRlcyIsImVuZHNXaXRoIiwiaXNBcnJheSIsIm9wdHMiLCJtb2JpbGVQdXNoRmlsZSIsInBheWxvYWQiLCJyZXF1aXJlQXJncyIsIm1vYmlsZVB1bGxGaWxlIiwibW9iaWxlRGVsZXRlRm9sZGVyIiwibW9iaWxlRGVsZXRlRmlsZSIsIm1vYmlsZVB1bGxGb2xkZXIiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvY29tbWFuZHMvZmlsZS1tb3ZlbWVudC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIsIG1rZGlycCwgemlwLCB1dGlsIH0gZnJvbSAnYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBzZXJ2aWNlcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCB7IHB1bGxGaWxlLCBwdWxsRm9sZGVyLCBwdXNoRmlsZSB9IGZyb20gJy4uL2lvcy1mcy1oZWxwZXJzJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS9kcml2ZXInO1xuaW1wb3J0IHsgcmVxdWlyZUFyZ3MgfSBmcm9tICcuLi91dGlscyc7XG5cbmNvbnN0IENPTlRBSU5FUl9QQVRIX01BUktFUiA9ICdAJztcbi8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3IvUExkQjBHLzJcbmNvbnN0IENPTlRBSU5FUl9QQVRIX1BBVFRFUk4gPSBuZXcgUmVnRXhwKGBeJHtDT05UQUlORVJfUEFUSF9NQVJLRVJ9KFteL10rKS8oLiopYCk7XG5jb25zdCBDT05UQUlORVJfVFlQRV9TRVBBUkFUT1IgPSAnOic7XG5jb25zdCBDT05UQUlORVJfRE9DVU1FTlRTX1BBVEggPSAnRG9jdW1lbnRzJztcbmNvbnN0IE9CSkVDVF9OT1RfRk9VTkRfRVJST1JfTUVTU0FHRSA9ICdPQkpFQ1RfTk9UX0ZPVU5EJztcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuZnVuY3Rpb24gdmVyaWZ5SXNTdWJQYXRoIChvcmlnaW5hbFBhdGgsIHJvb3QpIHtcbiAgY29uc3Qgbm9ybWFsaXplZFJvb3QgPSBwYXRoLm5vcm1hbGl6ZShyb290KTtcbiAgY29uc3Qgbm9ybWFsaXplZFBhdGggPSBwYXRoLm5vcm1hbGl6ZShwYXRoLmRpcm5hbWUob3JpZ2luYWxQYXRoKSk7XG4gIC8vIElmIG9yaWdpbmFsUGF0aCBpcyByb290LCBgL2AsIG9yaWdpbmFsUGF0aCBzaG91bGQgZXF1YWwgdG8gbm9ybWFsaXplZFJvb3RcbiAgaWYgKG5vcm1hbGl6ZWRSb290ICE9PSBvcmlnaW5hbFBhdGggJiYgIW5vcm1hbGl6ZWRQYXRoLnN0YXJ0c1dpdGgobm9ybWFsaXplZFJvb3QpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAnJHtub3JtYWxpemVkUGF0aH0nIGlzIGV4cGVjdGVkIHRvIGJlIGEgc3VicGF0aCBvZiAnJHtub3JtYWxpemVkUm9vdH0nYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQWZjQ2xpZW50ICh1ZGlkLCBidW5kbGVJZCwgY29udGFpbmVyVHlwZSkge1xuICBpZiAoIWJ1bmRsZUlkKSB7XG4gICAgcmV0dXJuIGF3YWl0IHNlcnZpY2VzLnN0YXJ0QWZjU2VydmljZSh1ZGlkKTtcbiAgfVxuICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRIb3VzZUFycmVzdFNlcnZpY2UodWRpZCk7XG4gIHJldHVybiBpc0RvY3VtZW50c0NvbnRhaW5lcihjb250YWluZXJUeXBlKVxuICAgID8gYXdhaXQgc2VydmljZS52ZW5kRG9jdW1lbnRzKGJ1bmRsZUlkKVxuICAgIDogYXdhaXQgc2VydmljZS52ZW5kQ29udGFpbmVyKGJ1bmRsZUlkKTtcbn1cblxuZnVuY3Rpb24gaXNEb2N1bWVudHNDb250YWluZXIgKGNvbnRhaW5lclR5cGUpIHtcbiAgcmV0dXJuIF8udG9Mb3dlcihjb250YWluZXJUeXBlKSA9PT0gXy50b0xvd2VyKENPTlRBSU5FUl9ET0NVTUVOVFNfUEFUSCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNlcnZpY2UgKHVkaWQsIHJlbW90ZVBhdGgpIHtcbiAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IHtidW5kbGVJZCwgcGF0aEluQ29udGFpbmVyLCBjb250YWluZXJUeXBlfSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoKTtcbiAgICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgY3JlYXRlQWZjQ2xpZW50KHVkaWQsIGJ1bmRsZUlkLCBjb250YWluZXJUeXBlKTtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBpc0RvY3VtZW50c0NvbnRhaW5lcihjb250YWluZXJUeXBlKVxuICAgICAgPyBwYXRoLmpvaW4oQ09OVEFJTkVSX0RPQ1VNRU5UU19QQVRILCBwYXRoSW5Db250YWluZXIpXG4gICAgICA6IHBhdGhJbkNvbnRhaW5lcjtcbiAgICByZXR1cm4ge3NlcnZpY2UsIHJlbGF0aXZlUGF0aH07XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc2VydmljZSA9IGF3YWl0IGNyZWF0ZUFmY0NsaWVudCh1ZGlkKTtcbiAgICByZXR1cm4ge3NlcnZpY2UsIHJlbGF0aXZlUGF0aDogcmVtb3RlUGF0aH07XG4gIH1cbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDb250YWluZXJPYmplY3RcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYnVuZGxlSWQgLSBUaGUgcGFyc2VkIGJ1bmRsZSBpZGVudGlmaWVyXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGF0aEluQ29udGFpbmVyIC0gVGhlIGFic29sdXRlIGZ1bGwgcGF0aCBvZiB0aGUgaXRlbSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW1cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gY29udGFpbmVyVHlwZSAtIFRoZSBjb250YWluZXIgdHlwZVxuICovXG5cbi8qKlxuICogUGFyc2VzIHRoZSBhY3R1YWwgcGF0aCBhbmQgdGhlIGJ1bmRsZSBpZGVudGlmaWVyIGZyb20gdGhlIGdpdmVuIHBhdGggc3RyaW5nXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgZ2l2ZW4gcGF0aCBzdHJpbmcuIFRoZSBzdHJpbmcgc2hvdWxkXG4gKiBtYXRjaCBgQ09OVEFJTkVSX1BBVEhfUEFUVEVSTmAgcmVnZXhwLCBvdGhlcndpc2UgYW4gZXJyb3IgaXMgZ29pbmdcbiAqIHRvIGJlIHRocm93bi4gQSB2YWxpZCBzdHJpbmcgZXhhbXBsZTogYEBidW5kbGUuaWRlbnRpZmllcjpjb250YWluZXJfdHlwZS9yZWxhdGl2ZV9wYXRoX2luX2NvbnRhaW5lcmBcbiAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb250YWluZXJSb290U3VwcGxpZXIgLSBFaXRoZXIgYSBzdHJpbmcsIHRoYXQgY29udGFpbnNcbiAqIGZ1bGwgcGF0aCB0byB0aGUgbW91bnQgcm9vdCBmb3IgcmVhbCBkZXZpY2VzIG9yIGEgZnVuY3Rpb24sIHdoaWNoIGFjY2VwdHMgdHdvIHBhcmFtZXRlcnNcbiAqIChidW5kbGUgaWRlbnRpZmllciBhbmQgb3B0aW9uYWwgY29udGFpbmVyIHR5cGUpIGFuZCByZXR1cm5zIGZ1bGwgcGF0aCB0byBjb250YWluZXJcbiAqIHJvb3QgZm9sZGVyIG9uIHRoZSBsb2NhbCBmaWxlIHN5c3RlbSwgZm9yIFNpbXVsYXRvclxuICogQHJldHVybnMge0NvbnRhaW5lck9iamVjdH1cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcGFyc2VDb250YWluZXJQYXRoIChyZW1vdGVQYXRoLCBjb250YWluZXJSb290U3VwcGxpZXIpIHtcbiAgY29uc3QgbWF0Y2ggPSBDT05UQUlORVJfUEFUSF9QQVRURVJOLmV4ZWMocmVtb3RlUGF0aCk7XG4gIGlmICghbWF0Y2gpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEl0IGlzIGV4cGVjdGVkIHRoYXQgcGFja2FnZSBpZGVudGlmaWVyIGAgK1xuICAgICAgYHN0YXJ0cyB3aXRoICcke0NPTlRBSU5FUl9QQVRIX01BUktFUn0nIGFuZCBpcyBzZXBhcmF0ZWQgZnJvbSB0aGUgYCArXG4gICAgICBgcmVsYXRpdmUgcGF0aCB3aXRoIGEgc2luZ2xlIHNsYXNoLiAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGxldCBbLCBidW5kbGVJZCwgcmVsYXRpdmVQYXRoXSA9IG1hdGNoO1xuICBsZXQgY29udGFpbmVyVHlwZSA9IG51bGw7XG4gIGNvbnN0IHR5cGVTZXBhcmF0b3JQb3MgPSBidW5kbGVJZC5pbmRleE9mKENPTlRBSU5FUl9UWVBFX1NFUEFSQVRPUik7XG4gIC8vIFdlIG9ubHkgY29uc2lkZXIgY29udGFpbmVyIHR5cGUgZXhpc3RzIGlmIGl0cyBsZW5ndGggaXMgZ3JlYXRlciB0aGFuIHplcm9cbiAgLy8gbm90IGNvdW50aW5nIHRoZSBjb2xvblxuICBpZiAodHlwZVNlcGFyYXRvclBvcyA+IDAgJiYgdHlwZVNlcGFyYXRvclBvcyA8IGJ1bmRsZUlkLmxlbmd0aCAtIDEpIHtcbiAgICBjb250YWluZXJUeXBlID0gYnVuZGxlSWQuc3Vic3RyaW5nKHR5cGVTZXBhcmF0b3JQb3MgKyAxKTtcbiAgICBsb2cuZGVidWcoYFBhcnNlZCBjb250YWluZXIgdHlwZTogJHtjb250YWluZXJUeXBlfWApO1xuICAgIGJ1bmRsZUlkID0gYnVuZGxlSWQuc3Vic3RyaW5nKDAsIHR5cGVTZXBhcmF0b3JQb3MpO1xuICB9XG4gIGlmIChfLmlzTmlsKGNvbnRhaW5lclJvb3RTdXBwbGllcikpIHtcbiAgICBjb25zdCBwYXRoSW5Db250YWluZXIgPSByZWxhdGl2ZVBhdGg7XG4gICAgcmV0dXJuIHsgYnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lciwgY29udGFpbmVyVHlwZSB9O1xuICB9XG4gIGNvbnN0IGNvbnRhaW5lclJvb3QgPSBfLmlzRnVuY3Rpb24oY29udGFpbmVyUm9vdFN1cHBsaWVyKVxuICAgID8gYXdhaXQgY29udGFpbmVyUm9vdFN1cHBsaWVyKGJ1bmRsZUlkLCBjb250YWluZXJUeXBlKVxuICAgIDogY29udGFpbmVyUm9vdFN1cHBsaWVyO1xuICBjb25zdCBwYXRoSW5Db250YWluZXIgPSBwYXRoLnBvc2l4LnJlc29sdmUoY29udGFpbmVyUm9vdCwgcmVsYXRpdmVQYXRoKTtcbiAgdmVyaWZ5SXNTdWJQYXRoKHBhdGhJbkNvbnRhaW5lciwgY29udGFpbmVyUm9vdCk7XG4gIHJldHVybiB7YnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lciwgY29udGFpbmVyVHlwZX07XG59XG5cbi8qKlxuICogU2F2ZSB0aGUgZ2l2ZW4gYmFzZTY0IGRhdGEgY2h1bmsgYXMgYSBiaW5hcnkgZmlsZSBvbiB0aGUgU2ltdWxhdG9yIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSByZW1vdGUgcGF0aCBvbiB0aGUgZGV2aWNlLiBUaGlzIHZhcmlhYmxlIGNhbiBiZSBwcmVmaXhlZCB3aXRoXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1bmRsZSBpZCwgc28gdGhlbiB0aGUgZmlsZSB3aWxsIGJlIHVwbG9hZGVkIHRvIHRoZSBjb3JyZXNwb25kaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlciwgZm9yIGV4YW1wbGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0Bjb20ubXlhcHAuYmxhOmRhdGEvUmVsYXRpdmVQYXRoSW5Db250YWluZXIvMTExLnBuZycuIFRoZSAnQCcgY2hhcmFjdGVyIGF0IHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWdpbm5pbmcgb2YgdGhlIGFyZ3VtZW50IGlzIG1hbmRhdG9yeSBpbiBzdWNoIGNhc2UuIFRoZSBjb2xvbiBhdCB0aGUgZW5kIG9mIGJ1bmRsZSBpZGVudGlmaWVyXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzIG9wdGlvbmFsIGFuZCBpcyB1c2VkIHRvIGRpc3Rpbmd1aXNoIHRoZSBjb250YWluZXIgdHlwZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9zc2libGUgdmFsdWVzIHRoZXJlIGFyZSAnYXBwJywgJ2RhdGEnLCAnZ3JvdXBzJywgJzxBIHNwZWNpZmljIEFwcCBHcm91cCBjb250YWluZXI+Jy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgdmFsdWUgaXMgJ2FwcCcuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSByZWxhdGl2ZSBmb2xkZXIgcGF0aCBpcyBpZ25vcmVkIGlmIHRoZSBmaWxlIGlzIGdvaW5nIHRvIGJlIHVwbG9hZGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlciBhbmQgb25seSB0aGUgZmlsZSBuYW1lIGlzIGNvbnNpZGVyZWQgaW1wb3J0YW50LlxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2U2NERhdGEgLSBCYXNlLTY0IGVuY29kZWQgY29udGVudCBvZiB0aGUgZmlsZSB0byBiZSB1cGxvYWRlZC5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVzaEZpbGVUb1NpbXVsYXRvciAoZGV2aWNlLCByZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGJhc2U2NERhdGEsICdiYXNlNjQnKTtcbiAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IHtidW5kbGVJZCwgcGF0aEluQ29udGFpbmVyOiBkc3RQYXRofSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoLFxuICAgICAgYXN5bmMgKGFwcEJ1bmRsZSwgY29udGFpbmVyVHlwZSkgPT4gYXdhaXQgZGV2aWNlLnNpbWN0bC5nZXRBcHBDb250YWluZXIoYXBwQnVuZGxlLCBjb250YWluZXJUeXBlKSk7XG4gICAgbG9nLmluZm8oYFBhcnNlZCBidW5kbGUgaWRlbnRpZmllciAnJHtidW5kbGVJZH0nIGZyb20gJyR7cmVtb3RlUGF0aH0nLiBgICtcbiAgICAgIGBXaWxsIHB1dCB0aGUgZGF0YSBpbnRvICcke2RzdFBhdGh9J2ApO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHBhdGguZGlybmFtZShkc3RQYXRoKSkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVGhlIGRlc3RpbmF0aW9uIGZvbGRlciAnJHtwYXRoLmRpcm5hbWUoZHN0UGF0aCl9JyBkb2VzIG5vdCBleGlzdC4gQ3JlYXRpbmcuLi5gKTtcbiAgICAgIGF3YWl0IG1rZGlycChwYXRoLmRpcm5hbWUoZHN0UGF0aCkpO1xuICAgIH1cbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZHN0UGF0aCwgYnVmZmVyKTtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgZHN0Rm9sZGVyID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIGNvbnN0IGRzdFBhdGggPSBwYXRoLnJlc29sdmUoZHN0Rm9sZGVyLCBwYXRoLmJhc2VuYW1lKHJlbW90ZVBhdGgpKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZHN0UGF0aCwgYnVmZmVyKTtcbiAgICBhd2FpdCBkZXZpY2Uuc2ltY3RsLmFkZE1lZGlhKGRzdFBhdGgpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZihkc3RGb2xkZXIpO1xuICB9XG59XG5cbi8qKlxuICogU2F2ZSB0aGUgZ2l2ZW4gYmFzZTY0IGRhdGEgY2h1bmsgYXMgYSBiaW5hcnkgZmlsZSBvbiB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSByZW1vdGUgcGF0aCBvbiB0aGUgZGV2aWNlLiBUaGlzIHZhcmlhYmxlIGNhbiBiZSBwcmVmaXhlZCB3aXRoXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1bmRsZSBpZCwgc28gdGhlbiB0aGUgZmlsZSB3aWxsIGJlIHVwbG9hZGVkIHRvIHRoZSBjb3JyZXNwb25kaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IG1lZGlhIGZvbGRlci4gVXNlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEA8YXBwX2J1bmRsZV9pZD46PG9wdGlvbmFsX2NvbnRhaW5lcl90eXBlPi88cGF0aF90b190aGVfZmlsZV9vcl9mb2xkZXJfaW5zaWRlX2NvbnRhaW5lcj5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0IHRvIHB1bGwgYSBmaWxlIG9yIGEgZm9sZGVyIGZyb20gYW4gYXBwbGljYXRpb24gY29udGFpbmVyIG9mIHRoZSBnaXZlbiB0eXBlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgb25seSBzdXBwb3J0ZWQgY29udGFpbmVyIHR5cGUgaXMgJ2RvY3VtZW50cycuIElmIHRoZSBjb250YWluZXIgdHlwZSBpcyBub3Qgc2V0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGxpY2l0bHkgZm9yIGEgYnVuZGxlIGlkLCB0aGVuIHRoZSBkZWZhdWx0IGFwcGxpY2F0aW9uIGNvbnRhaW5lciBpcyBnb2luZyB0byBiZSBtb3VudGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChha2EgLS1jb250YWluZXIgaWZ1c2UgYXJndW1lbnQpXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuZy4gSWYgYEBjb20ubXlhcHAuYmxhOmRvY3VtZW50cy8xMTEucG5nYCBpcyBwcm92aWRlZCxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgT24gTXkgaVBob25lLzxhcHAgbmFtZT5gIGluIEZpbGVzIGFwcCB3aWxsIGJlIG1vdW50ZWQgaW4gdGhlIGhvc3QgbWFjaGluZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBCYXNlNjQgZW5jb2RlZCBgMTExLnBuZ2Agd2lsbCBiZSBwdXNoZWQgaW50byBgT24gTXkgaVBob25lLzxhcHAgbmFtZT4vMTExLnBuZ2BcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcyBiYXNlNjQgZGVjb2RlZCBkYXRhLlxuICogQHBhcmFtIHtzdHJpbmd9IGJhc2U2NERhdGEgLSBCYXNlLTY0IGVuY29kZWQgY29udGVudCBvZiB0aGUgZmlsZSB0byBiZSB1cGxvYWRlZC5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVzaEZpbGVUb1JlYWxEZXZpY2UgKGRldmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBjb25zdCB7c2VydmljZSwgcmVsYXRpdmVQYXRofSA9IGF3YWl0IGNyZWF0ZVNlcnZpY2UoZGV2aWNlLnVkaWQsIHJlbW90ZVBhdGgpO1xuICB0cnkge1xuICAgIGF3YWl0IHB1c2hGaWxlKHNlcnZpY2UsIHJlbGF0aXZlUGF0aCwgYmFzZTY0RGF0YSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoZS5zdGFjayk7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgcHVzaCB0aGUgZmlsZSB0byAnJHtyZW1vdGVQYXRofScuICBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH0gZmluYWxseSB7XG4gICAgc2VydmljZS5jbG9zZSgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUZpbGVPckZvbGRlciAoZGV2aWNlLCByZW1vdGVQYXRoLCBpc1NpbXVsYXRvcikge1xuICByZXR1cm4gaXNTaW11bGF0b3JcbiAgICA/IGF3YWl0IGRlbGV0ZUZyb21TaW11bGF0b3IoZGV2aWNlLCByZW1vdGVQYXRoKVxuICAgIDogYXdhaXQgZGVsZXRlRnJvbVJlYWxEZXZpY2UoZGV2aWNlLCByZW1vdGVQYXRoKTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIGNvbnRlbnQgb2YgZ2l2ZW4gZmlsZSBvciBmb2xkZXIgZnJvbSBpT1MgU2ltdWxhdG9yIGFuZCByZXR1cm4gaXQgYXMgYmFzZS02NCBlbmNvZGVkIHN0cmluZy5cbiAqIEZvbGRlciBjb250ZW50IGlzIHJlY3Vyc2l2ZWx5IHBhY2tlZCBpbnRvIGEgemlwIGFyY2hpdmUuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIGEgZmlsZSBvciBhIGZvbGRlciwgd2hpY2ggZXhpc3RzIGluIHRoZSBjb3JyZXNwb25kaW5nIGFwcGxpY2F0aW9uXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciBvbiBTaW11bGF0b3IuIFVzZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBAPGFwcF9idW5kbGVfaWQ+OjxvcHRpb25hbF9jb250YWluZXJfdHlwZT4vPHBhdGhfdG9fdGhlX2ZpbGVfb3JfZm9sZGVyX2luc2lkZV9jb250YWluZXI+XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdCB0byBwdWxsIGEgZmlsZSBvciBhIGZvbGRlciBmcm9tIGFuIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBvZiB0aGUgZ2l2ZW4gdHlwZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9zc2libGUgY29udGFpbmVyIHR5cGVzIGFyZSAnYXBwJywgJ2RhdGEnLCAnZ3JvdXBzJywgJzxBIHNwZWNpZmljIEFwcCBHcm91cCBjb250YWluZXI+Jy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgdHlwZSBpcyAnYXBwJy5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNGaWxlIC0gV2hldGhlciB0aGUgZGVzdGluYXRpb24gaXRlbSBpcyBhIGZpbGUgb3IgYSBmb2xkZXJcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlLlxuICovXG5hc3luYyBmdW5jdGlvbiBwdWxsRnJvbVNpbXVsYXRvciAoZGV2aWNlLCByZW1vdGVQYXRoLCBpc0ZpbGUpIHtcbiAgbGV0IHBhdGhPblNlcnZlcjtcbiAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IHtidW5kbGVJZCwgcGF0aEluQ29udGFpbmVyOiBkc3RQYXRofSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoLFxuICAgICAgYXN5bmMgKGFwcEJ1bmRsZSwgY29udGFpbmVyVHlwZSkgPT4gYXdhaXQgZGV2aWNlLnNpbWN0bC5nZXRBcHBDb250YWluZXIoYXBwQnVuZGxlLCBjb250YWluZXJUeXBlKSk7XG4gICAgbG9nLmluZm8oYFBhcnNlZCBidW5kbGUgaWRlbnRpZmllciAnJHtidW5kbGVJZH0nIGZyb20gJyR7cmVtb3RlUGF0aH0nLiBgICtcbiAgICAgIGBXaWxsIGdldCB0aGUgZGF0YSBmcm9tICcke2RzdFBhdGh9J2ApO1xuICAgIHBhdGhPblNlcnZlciA9IGRzdFBhdGg7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc2ltUm9vdCA9IGRldmljZS5nZXREaXIoKTtcbiAgICBwYXRoT25TZXJ2ZXIgPSBwYXRoLnBvc2l4LmpvaW4oc2ltUm9vdCwgcmVtb3RlUGF0aCk7XG4gICAgdmVyaWZ5SXNTdWJQYXRoKHBhdGhPblNlcnZlciwgc2ltUm9vdCk7XG4gICAgbG9nLmluZm8oYEdvdCB0aGUgZnVsbCBpdGVtIHBhdGg6ICR7cGF0aE9uU2VydmVyfWApO1xuICB9XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKHBhdGhPblNlcnZlcikpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIHJlbW90ZSAke2lzRmlsZSA/ICdmaWxlJyA6ICdmb2xkZXInfSBhdCAnJHtwYXRoT25TZXJ2ZXJ9JyBkb2VzIG5vdCBleGlzdGApO1xuICB9XG4gIGNvbnN0IGJ1ZmZlciA9IGlzRmlsZVxuICAgID8gYXdhaXQgdXRpbC50b0luTWVtb3J5QmFzZTY0KHBhdGhPblNlcnZlcilcbiAgICA6IGF3YWl0IHppcC50b0luTWVtb3J5WmlwKHBhdGhPblNlcnZlciwge2VuY29kZVRvQmFzZTY0OiB0cnVlfSk7XG4gIHJldHVybiBidWZmZXIudG9TdHJpbmcoKTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIGNvbnRlbnQgb2YgZ2l2ZW4gZmlsZSBvciBmb2xkZXIgZnJvbSB0aGUgcmVhbCBkZXZpY2UgdW5kZXIgdGVzdCBhbmQgcmV0dXJuIGl0IGFzIGJhc2UtNjQgZW5jb2RlZCBzdHJpbmcuXG4gKiBGb2xkZXIgY29udGVudCBpcyByZWN1cnNpdmVseSBwYWNrZWQgaW50byBhIHppcCBhcmNoaXZlLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZXZpY2UgLSBUaGUgZGV2aWNlIG9iamVjdCwgd2hpY2ggcmVwcmVzZW50cyB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvYmplY3QgaXMgZXhwZWN0ZWQgdG8gaGF2ZSB0aGUgYHVkaWRgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgZGV2aWNlIElELlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byBhbiBleGlzdGluZyByZW1vdGUgZmlsZSBvbiB0aGUgZGV2aWNlLiBUaGlzIHZhcmlhYmxlIGNhbiBiZSBwcmVmaXhlZCB3aXRoXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1bmRsZSBpZCwgc28gdGhlbiB0aGUgZmlsZSB3aWxsIGJlIGRvd25sb2FkZWQgZnJvbSB0aGUgY29ycmVzcG9uZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBjb250YWluZXIgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBtZWRpYSBmb2xkZXIuIFVzZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBAPGFwcF9idW5kbGVfaWQ+OjxvcHRpb25hbF9jb250YWluZXJfdHlwZT4vPHBhdGhfdG9fdGhlX2ZpbGVfb3JfZm9sZGVyX2luc2lkZV9jb250YWluZXI+XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdCB0byBwdWxsIGEgZmlsZSBvciBhIGZvbGRlciBmcm9tIGFuIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBvZiB0aGUgZ2l2ZW4gdHlwZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIG9ubHkgc3VwcG9ydGVkIGNvbnRhaW5lciB0eXBlIGlzICdkb2N1bWVudHMnLiBJZiB0aGUgY29udGFpbmVyIHR5cGUgaXMgbm90IHNldFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHBsaWNpdGx5IGZvciBhIGJ1bmRsZSBpZCwgdGhlbiB0aGUgZGVmYXVsdCBhcHBsaWNhdGlvbiBjb250YWluZXIgaXMgZ29pbmcgdG8gYmUgbW91bnRlZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYWthIC0tY29udGFpbmVyIGlmdXNlIGFyZ3VtZW50KVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLmcuIElmIGBAY29tLm15YXBwLmJsYTpkb2N1bWVudHMvMTExLnBuZ2AgaXMgcHJvdmlkZWQsXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYE9uIE15IGlQaG9uZS88YXBwIG5hbWU+YCBpbiBGaWxlcyBhcHAgd2lsbCBiZSBtb3VudGVkIGluIHRoZSBob3N0IG1hY2hpbmUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYE9uIE15IGlQaG9uZS88YXBwIG5hbWU+LzExMS5wbmdgIHdpbCBiZSBwdWxsZWQgaW50byB0aGUgbW91bnRlZCBob3N0IG1hY2hpbmVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmQgQXBwaXVtIHJldHVybnMgdGhlIGRhdGEgYXMgYmFzZTY0LWVuY29kZWQgc3RyaW5nIHRvIGNsaWVudC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgQGNvbS5teWFwcC5ibGE6ZG9jdW1lbnRzL2AgbWVhbnMgYE9uIE15IGlQaG9uZS88YXBwIG5hbWU+YC5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNGaWxlIC0gV2hldGhlciB0aGUgZGVzdGluYXRpb24gaXRlbSBpcyBhIGZpbGUgb3IgYSBmb2xkZXJcbiAqIEByZXR1cm4ge3N0cmluZ30gQmFzZS02NCBlbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlbW90ZSBmaWxlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1bGxGcm9tUmVhbERldmljZSAoZGV2aWNlLCByZW1vdGVQYXRoLCBpc0ZpbGUpIHtcbiAgY29uc3Qge3NlcnZpY2UsIHJlbGF0aXZlUGF0aH0gPSBhd2FpdCBjcmVhdGVTZXJ2aWNlKGRldmljZS51ZGlkLCByZW1vdGVQYXRoKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBmaWxlSW5mbyA9IGF3YWl0IHNlcnZpY2UuZ2V0RmlsZUluZm8ocmVsYXRpdmVQYXRoKTtcbiAgICBpZiAoaXNGaWxlICYmIGZpbGVJbmZvLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHJlcXVlc3RlZCBwYXRoIGlzIG5vdCBhIGZpbGUuIFBhdGg6ICcke3JlbW90ZVBhdGh9J2ApO1xuICAgIH1cbiAgICBpZiAoIWlzRmlsZSAmJiAhZmlsZUluZm8uaXNEaXJlY3RvcnkoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgcmVxdWVzdGVkIHBhdGggaXMgbm90IGEgZm9sZGVyLiBQYXRoOiAnJHtyZW1vdGVQYXRofSdgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmlsZUluZm8uaXNGaWxlKClcbiAgICAgID8gKGF3YWl0IHB1bGxGaWxlKHNlcnZpY2UsIHJlbGF0aXZlUGF0aCkpLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgOiAoYXdhaXQgcHVsbEZvbGRlcihzZXJ2aWNlLCByZWxhdGl2ZVBhdGgpKS50b1N0cmluZygpO1xuICB9IGZpbmFsbHkge1xuICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgfVxufVxuXG4vKipcbiAqIFJlbW92ZSB0aGUgZmlsZSBvciBmb2xkZXIgZnJvbSB0aGUgZGV2aWNlXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGRldmljZSAtIFRoZSBkZXZpY2Ugb2JqZWN0LCB3aGljaCByZXByZXNlbnRzIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBUaGlzIG9iamVjdCBpcyBleHBlY3RlZCB0byBoYXZlIHRoZSBgdWRpZGAgcHJvcGVydHkgY29udGFpbmluZyB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZCBkZXZpY2UgSUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIGEgZmlsZSBvciBhIGZvbGRlciwgd2hpY2ggZXhpc3RzIGluIHRoZSBjb3JyZXNwb25kaW5nIGFwcGxpY2F0aW9uXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lciBvbiBTaW11bGF0b3IuIFVzZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBAPGFwcF9idW5kbGVfaWQ+OjxvcHRpb25hbF9jb250YWluZXJfdHlwZT4vPHBhdGhfdG9fdGhlX2ZpbGVfb3JfZm9sZGVyX2luc2lkZV9jb250YWluZXI+XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdCB0byBwdWxsIGEgZmlsZSBvciBhIGZvbGRlciBmcm9tIGFuIGFwcGxpY2F0aW9uIGNvbnRhaW5lciBvZiB0aGUgZ2l2ZW4gdHlwZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUG9zc2libGUgY29udGFpbmVyIHR5cGVzIGFyZSAnYXBwJywgJ2RhdGEnLCAnZ3JvdXBzJywgJzxBIHNwZWNpZmljIEFwcCBHcm91cCBjb250YWluZXI+Jy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgdHlwZSBpcyAnYXBwJy5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZGVsZXRlRnJvbVNpbXVsYXRvciAoZGV2aWNlLCByZW1vdGVQYXRoKSB7XG4gIGxldCBwYXRoT25TZXJ2ZXI7XG4gIGlmIChDT05UQUlORVJfUEFUSF9QQVRURVJOLnRlc3QocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCB7YnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lcjogZHN0UGF0aH0gPSBhd2FpdCBwYXJzZUNvbnRhaW5lclBhdGgocmVtb3RlUGF0aCxcbiAgICAgIGFzeW5jIChhcHBCdW5kbGUsIGNvbnRhaW5lclR5cGUpID0+IGF3YWl0IGRldmljZS5zaW1jdGwuZ2V0QXBwQ29udGFpbmVyKGFwcEJ1bmRsZSwgY29udGFpbmVyVHlwZSkpO1xuICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICBgJyR7ZHN0UGF0aH0nIHdpbGwgYmUgZGVsZXRlZGApO1xuICAgIHBhdGhPblNlcnZlciA9IGRzdFBhdGg7XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgc2ltUm9vdCA9IGRldmljZS5nZXREaXIoKTtcbiAgICBwYXRoT25TZXJ2ZXIgPSBwYXRoLnBvc2l4LmpvaW4oc2ltUm9vdCwgcmVtb3RlUGF0aCk7XG4gICAgdmVyaWZ5SXNTdWJQYXRoKHBhdGhPblNlcnZlciwgc2ltUm9vdCk7XG4gICAgbG9nLmluZm8oYEdvdCB0aGUgZnVsbCBwYXRoOiAke3BhdGhPblNlcnZlcn1gKTtcbiAgfVxuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYXRoT25TZXJ2ZXIpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcihgVGhlIHJlbW90ZSBwYXRoIGF0ICcke3BhdGhPblNlcnZlcn0nIGRvZXMgbm90IGV4aXN0YCk7XG4gIH1cbiAgYXdhaXQgZnMucmltcmFmKHBhdGhPblNlcnZlcik7XG59XG5cbi8qKlxuICogUmVtb3ZlIHRoZSBmaWxlIG9yIGZvbGRlciBmcm9tIHRoZSBkZXZpY2VcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gYW4gZXhpc3RpbmcgcmVtb3RlIGZpbGUgb24gdGhlIGRldmljZS4gVGhpcyB2YXJpYWJsZSBjYW4gYmUgcHJlZml4ZWQgd2l0aFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidW5kbGUgaWQsIHNvIHRoZW4gdGhlIGZpbGUgd2lsbCBiZSBkb3dubG9hZGVkIGZyb20gdGhlIGNvcnJlc3BvbmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gY29udGFpbmVyIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyLiBVc2VcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQDxhcHBfYnVuZGxlX2lkPjo8b3B0aW9uYWxfY29udGFpbmVyX3R5cGU+LzxwYXRoX3RvX3RoZV9maWxlX29yX2ZvbGRlcl9pbnNpZGVfY29udGFpbmVyPlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQgdG8gcHVsbCBhIGZpbGUgb3IgYSBmb2xkZXIgZnJvbSBhbiBhcHBsaWNhdGlvbiBjb250YWluZXIgb2YgdGhlIGdpdmVuIHR5cGUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBvbmx5IHN1cHBvcnRlZCBjb250YWluZXIgdHlwZSBpcyAnZG9jdW1lbnRzJy4gSWYgdGhlIGNvbnRhaW5lciB0eXBlIGlzIG5vdCBzZXRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwbGljaXRseSBmb3IgYSBidW5kbGUgaWQsIHRoZW4gdGhlIGRlZmF1bHQgYXBwbGljYXRpb24gY29udGFpbmVyIGlzIGdvaW5nIHRvIGJlIG1vdW50ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGFrYSAtLWNvbnRhaW5lciBpZnVzZSBhcmd1bWVudClcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5nLiBJZiBgQGNvbS5teWFwcC5ibGE6ZG9jdW1lbnRzLzExMS5wbmdgIGlzIHByb3ZpZGVkLFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBPbiBNeSBpUGhvbmUvPGFwcCBuYW1lPmAgaW4gRmlsZXMgYXBwIHdpbGwgYmUgbW91bnRlZCBpbiB0aGUgaG9zdCBtYWNoaW5lLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBPbiBNeSBpUGhvbmUvPGFwcCBuYW1lPi8xMTEucG5nYCB3aWwgYmUgcHVsbGVkIGludG8gdGhlIG1vdW50ZWQgaG9zdCBtYWNoaW5lXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5kIEFwcGl1bSByZXR1cm5zIHRoZSBkYXRhIGFzIGJhc2U2NC1lbmNvZGVkIHN0cmluZyB0byBjbGllbnQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYEBjb20ubXlhcHAuYmxhOmRvY3VtZW50cy9gIG1lYW5zIGBPbiBNeSBpUGhvbmUvPGFwcCBuYW1lPmAuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGRlbGV0ZUZyb21SZWFsRGV2aWNlIChkZXZpY2UsIHJlbW90ZVBhdGgpIHtcbiAgY29uc3QgeyBzZXJ2aWNlLCByZWxhdGl2ZVBhdGggfSA9IGF3YWl0IGNyZWF0ZVNlcnZpY2UoZGV2aWNlLnVkaWQsIHJlbW90ZVBhdGgpO1xuICB0cnkge1xuICAgIGF3YWl0IHNlcnZpY2UuZGVsZXRlRGlyZWN0b3J5KHJlbGF0aXZlUGF0aCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5tZXNzYWdlLmluY2x1ZGVzKE9CSkVDVF9OT1RfRk9VTkRfRVJST1JfTUVTU0FHRSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUGF0aCAnJHtyZW1vdGVQYXRofScgZG9lcyBub3QgZXhpc3Qgb24gdGhlIGRldmljZWApO1xuICAgIH1cbiAgICB0aHJvdyBlO1xuICB9IGZpbmFsbHkge1xuICAgIHNlcnZpY2UuY2xvc2UoKTtcbiAgfVxufVxuXG4vKipcbiAqIFB1c2hlcyB0aGUgZ2l2ZW4gZGF0YSB0byBhIGZpbGUgb24gdGhlIHJlbW90ZSBkZXZpY2VcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCBUaGUgZnVsbCBwYXRoIHRvIHRoZSByZW1vdGUgZmlsZSBvclxuICogYSBmaWxlIGluc2lkZSBhIHBhY2thZ2UgYnVuZGxlLiBDaGVjayB0aGUgZG9jdW1lbnRhdGlvbiBvblxuICogYHB1c2hGaWxlVG9SZWFsRGV2aWNlYCBhbmQgYHB1c2hGaWxlVG9TaW11bGF0b3JgIGZvciBtb3JlIGluZm9ybWF0aW9uXG4gKiBvbiBhY2NlcHRhYmxlIHZhbHVlcy5cbiAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlNjREYXRhIEJhc2U2NCBlbmNvZGVkIGRhdGEgdG8gYmUgd3JpdHRlbiB0byB0aGVcbiAqIHJlbW90ZSBmaWxlLiBUaGUgcmVtb3RlIGZpbGUgd2lsbCBiZSBzaWxlbnRseSBvdmVycmlkZGVuIGlmIGl0IGFscmVhZHkgZXhpc3RzLlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBwdXNoaW5nIHRoZSBkYXRhXG4gKi9cbmNvbW1hbmRzLnB1c2hGaWxlID0gYXN5bmMgZnVuY3Rpb24gcHVzaEZpbGUgKHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpIHtcbiAgaWYgKHJlbW90ZVBhdGguZW5kc1dpdGgoJy8nKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgIGAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGlmIChfLmlzQXJyYXkoYmFzZTY0RGF0YSkpIHtcbiAgICAvLyBzb21lIGNsaWVudHMgKGFoZW0pIGphdmEsIHNlbmQgYSBieXRlIGFycmF5IGVuY29kaW5nIHV0ZjggY2hhcmFjdGVyc1xuICAgIC8vIGluc3RlYWQgb2YgYSBzdHJpbmcsIHdoaWNoIHdvdWxkIGJlIGluZmluaXRlbHkgYmV0dGVyIVxuICAgIGJhc2U2NERhdGEgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhKS50b1N0cmluZygndXRmOCcpO1xuICB9XG4gIHJldHVybiB0aGlzLmlzU2ltdWxhdG9yKClcbiAgICA/IGF3YWl0IHB1c2hGaWxlVG9TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSlcbiAgICA6IGF3YWl0IHB1c2hGaWxlVG9SZWFsRGV2aWNlKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBQdXNoRmlsZU9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSByZW1vdGVQYXRoIFRoZSBmdWxsIHBhdGggdG8gdGhlIHJlbW90ZSBmaWxlXG4gKiBvciBhIHNwZWNpYWxseSBmb3JtYXR0ZWQgcGF0aCwgd2hpY2ggcG9pbnRzIHRvIGFuIGl0ZW0gaW5zaWRlIGFuIGFwcCBidW5kbGUuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGF5bG9hZCBCYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlIHRvIGJlIHB1c2hlZC5cbiAqL1xuXG4vKipcbiAqIFB1c2hlcyB0aGUgZ2l2ZW4gZGF0YSB0byBhIGZpbGUgb24gdGhlIHJlbW90ZSBkZXZpY2UuXG4gKlxuICogQHBhcmFtIHtQdXNoRmlsZU9wdGlvbnN9IG9wdHNcbiAqL1xuY29tbWFuZHMubW9iaWxlUHVzaEZpbGUgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVQdXNoRmlsZSAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHsgcmVtb3RlUGF0aCwgcGF5bG9hZCB9ID0gcmVxdWlyZUFyZ3MoWydyZW1vdGVQYXRoJywgJ3BheWxvYWQnXSwgb3B0cyk7XG4gIHJldHVybiBhd2FpdCB0aGlzLnB1c2hGaWxlKHJlbW90ZVBhdGgsIHBheWxvYWQpO1xufTtcblxuLyoqXG4gKiBQdWxscyBhIHJlbW90ZSBmaWxlIGZyb20gdGhlIGRldmljZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlUGF0aCBUaGUgZnVsbCBwYXRoIHRvIHRoZSByZW1vdGUgZmlsZVxuICogb3IgYSBzcGVjaWFsbHkgZm9ybWF0dGVkIHBhdGgsIHdoaWNoIHBvaW50cyB0byBhbiBpdGVtIGluc2lkZSBhcHAgYnVuZGxlLlxuICogU2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciBgcHVsbEZyb21SZWFsRGV2aWNlYCBhbmQgYHB1bGxGcm9tU2ltdWxhdG9yYFxuICogdG8gZ2V0IG1vcmUgaW5mb3JtYXRpb24gb24gYWNjZXB0YWJsZSB2YWx1ZXMuXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBCYXNlNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBwdWxsZWQgZmlsZVxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSBwdWxsIG9wZXJhdGlvbiBmYWlsZWRcbiAqL1xuY29tbWFuZHMucHVsbEZpbGUgPSBhc3luYyBmdW5jdGlvbiBwdWxsRmlsZSAocmVtb3RlUGF0aCkge1xuICBpZiAocmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkQXJndW1lbnRFcnJvcihgSXQgaXMgZXhwZWN0ZWQgdGhhdCByZW1vdGUgcGF0aCBwb2ludHMgdG8gYSBmaWxlIGFuZCBub3QgdG8gYSBmb2xkZXIuIGAgK1xuICAgICAgYCcke3JlbW90ZVBhdGh9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cbiAgcmV0dXJuIHRoaXMuaXNTaW11bGF0b3IoKVxuICAgID8gYXdhaXQgcHVsbEZyb21TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgdHJ1ZSlcbiAgICA6IGF3YWl0IHB1bGxGcm9tUmVhbERldmljZSh0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCB0cnVlKTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUHVsbEZpbGVPcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcmVtb3RlUGF0aCBUaGUgZnVsbCBwYXRoIHRvIHRoZSByZW1vdGUgZmlsZVxuICogb3IgYSBzcGVjaWFsbHkgZm9ybWF0dGVkIHBhdGgsIHdoaWNoIHBvaW50cyB0byBhbiBpdGVtIGluc2lkZSBhcHAgYnVuZGxlLlxuICogU2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciBgcHVsbEZyb21SZWFsRGV2aWNlYCBhbmQgYHB1bGxGcm9tU2ltdWxhdG9yYFxuICogdG8gZ2V0IG1vcmUgaW5mb3JtYXRpb24gb24gYWNjZXB0YWJsZSB2YWx1ZXMuXG4gKi9cblxuLyoqXG4gKiBQdWxscyBhIHJlbW90ZSBmaWxlIGZyb20gdGhlIGRldmljZS5cbiAqXG4gKiBAcGFyYW0ge1B1bGxGaWxlT3B0aW9uc30gb3B0c1xuICogQHJldHVybnMge3N0cmluZ30gVGhlIHNhbWUgYXMgaW4gYHB1bGxGaWxlYFxuICovXG5jb21tYW5kcy5tb2JpbGVQdWxsRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVB1bGxGaWxlIChvcHRzID0ge30pIHtcbiAgY29uc3QgeyByZW1vdGVQYXRoIH0gPSByZXF1aXJlQXJncygncmVtb3RlUGF0aCcsIG9wdHMpO1xuICByZXR1cm4gYXdhaXQgdGhpcy5wdWxsRmlsZShyZW1vdGVQYXRoKTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRGVsZXRlRm9sZGVyT3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IHJlbW90ZVBhdGggVGhlIGZ1bGwgcGF0aCB0byB0aGUgcmVtb3RlIGZvbGRlclxuICogb3IgYSBzcGVjaWFsbHkgZm9ybWF0dGVkIHBhdGgsIHdoaWNoIHBvaW50cyB0byBhbiBpdGVtIGluc2lkZSBhcHAgYnVuZGxlLlxuICogU2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciBgcHVsbEZyb21SZWFsRGV2aWNlYCBhbmQgYHB1bGxGcm9tU2ltdWxhdG9yYFxuICogdG8gZ2V0IG1vcmUgaW5mb3JtYXRpb24gb24gYWNjZXB0YWJsZSB2YWx1ZXMuXG4gKi9cblxuLyoqXG4gKiBEZWxldGUgYSByZW1vdGUgZm9sZGVyIGZyb20gdGhlIGRldmljZS5cbiAqXG4gKiBAcGFyYW0ge0RlbGV0ZUZvbGRlck9wdGlvbnN9IG9wdHNcbiAqL1xuY29tbWFuZHMubW9iaWxlRGVsZXRlRm9sZGVyID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlRGVsZXRlRm9sZGVyIChvcHRzID0ge30pIHtcbiAgbGV0IHsgcmVtb3RlUGF0aCB9ID0gcmVxdWlyZUFyZ3MoJ3JlbW90ZVBhdGgnLCBvcHRzKTtcbiAgaWYgKCFyZW1vdGVQYXRoLmVuZHNXaXRoKCcvJykpIHtcbiAgICByZW1vdGVQYXRoID0gYCR7cmVtb3RlUGF0aH0vYDtcbiAgfVxuICByZXR1cm4gYXdhaXQgZGVsZXRlRmlsZU9yRm9sZGVyKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIHRoaXMuaXNTaW11bGF0b3IoKSk7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IERlbGV0ZUZpbGVPcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcmVtb3RlUGF0aCBUaGUgZnVsbCBwYXRoIHRvIHRoZSByZW1vdGUgZmlsZVxuICogb3IgYSBzcGVjaWFsbHkgZm9ybWF0dGVkIHBhdGgsIHdoaWNoIHBvaW50cyB0byBhbiBpdGVtIGluc2lkZSBhcHAgYnVuZGxlLlxuICogU2VlIHRoZSBkb2N1bWVudGF0aW9uIGZvciBgcHVsbEZyb21SZWFsRGV2aWNlYCBhbmQgYHB1bGxGcm9tU2ltdWxhdG9yYFxuICogdG8gZ2V0IG1vcmUgaW5mb3JtYXRpb24gb24gYWNjZXB0YWJsZSB2YWx1ZXMuXG4gKi9cblxuLyoqXG4gKiBEZWxldGUgYSByZW1vdGUgZmlsZSBmcm9tIHRoZSBkZXZpY2UuXG4gKlxuICogQHBhcmFtIHtEZWxldGVGaWxlT3B0aW9uc30gb3B0c1xuICovXG5jb21tYW5kcy5tb2JpbGVEZWxldGVGaWxlID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlRGVsZXRlRmlsZSAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHsgcmVtb3RlUGF0aCB9ID0gcmVxdWlyZUFyZ3MoJ3JlbW90ZVBhdGgnLCBvcHRzKTtcbiAgaWYgKHJlbW90ZVBhdGguZW5kc1dpdGgoJy8nKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgIGAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIHJldHVybiBhd2FpdCBkZWxldGVGaWxlT3JGb2xkZXIodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgdGhpcy5pc1NpbXVsYXRvcigpKTtcbn07XG5cbi8qKlxuICogUHVsbHMgdGhlIHdob2xlIGZvbGRlciBmcm9tIHRoZSByZW1vdGUgZGV2aWNlXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggVGhlIGZ1bGwgcGF0aCB0byBhIGZvbGRlciBvbiB0aGVcbiAqIHJlbW90ZSBkZXZpY2Ugb3IgYSBmb2xkZXIgaW5zaWRlIGFuIGFwcGxpY2F0aW9uIGJ1bmRsZVxuICogQHJldHVybnMge3N0cmluZ30gWmlwcGVkIGFuZCBiYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmb2xkZXJcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYSBmYWlsdXJlIHdoaWxlIGdldHRpbmcgdGhlIGZvbGRlciBjb250ZW50XG4gKi9cbmNvbW1hbmRzLnB1bGxGb2xkZXIgPSBhc3luYyBmdW5jdGlvbiBwdWxsRm9sZGVyIChyZW1vdGVQYXRoKSB7XG4gIGlmICghcmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgcmVtb3RlUGF0aCA9IGAke3JlbW90ZVBhdGh9L2A7XG4gIH1cbiAgcmV0dXJuIHRoaXMuaXNTaW11bGF0b3IoKVxuICAgID8gYXdhaXQgcHVsbEZyb21TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgZmFsc2UpXG4gICAgOiBhd2FpdCBwdWxsRnJvbVJlYWxEZXZpY2UodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgZmFsc2UpO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBQdWxsRm9sZGVyT3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IHJlbW90ZVBhdGggVGhlIGZ1bGwgcGF0aCB0byB0aGUgcmVtb3RlIGZvbGRlci5cbiAqL1xuXG4vKipcbiAqIFB1bGxzIHRoZSB3aG9sZSBmb2xkZXIgZnJvbSB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKlxuICogQHBhcmFtIHtQdWxsRm9sZGVyT3B0aW9uc30gb3B0c1xuICogQHJldHVybnMge3N0cmluZ30gVGhlIHNhbWUgYXMgYHB1bGxGb2xkZXJgXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVB1bGxGb2xkZXIgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVQdWxsRm9sZGVyIChvcHRzID0ge30pIHtcbiAgY29uc3QgeyByZW1vdGVQYXRoIH0gPSByZXF1aXJlQXJncygncmVtb3RlUGF0aCcsIG9wdHMpO1xuICByZXR1cm4gYXdhaXQgdGhpcy5wdWxsRm9sZGVyKHJlbW90ZVBhdGgpO1xufTtcblxuZXhwb3J0IHsgY29tbWFuZHMsIC8qIGZvciB0ZXN0aW5nICovIHBhcnNlQ29udGFpbmVyUGF0aCB9O1xuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFFQSxNQUFNQSxxQkFBcUIsR0FBRyxHQUFHO0FBRWpDLE1BQU1DLHNCQUFzQixHQUFHLElBQUlDLE1BQU0sQ0FBRSxJQUFHRixxQkFBc0IsY0FBYSxDQUFDO0FBQ2xGLE1BQU1HLHdCQUF3QixHQUFHLEdBQUc7QUFDcEMsTUFBTUMsd0JBQXdCLEdBQUcsV0FBVztBQUM1QyxNQUFNQyw4QkFBOEIsR0FBRyxrQkFBa0I7QUFFekQsTUFBTUMsUUFBUSxHQUFHLENBQUMsQ0FBQztBQUFDO0FBRXBCLFNBQVNDLGVBQWUsQ0FBRUMsWUFBWSxFQUFFQyxJQUFJLEVBQUU7RUFDNUMsTUFBTUMsY0FBYyxHQUFHQyxhQUFJLENBQUNDLFNBQVMsQ0FBQ0gsSUFBSSxDQUFDO0VBQzNDLE1BQU1JLGNBQWMsR0FBR0YsYUFBSSxDQUFDQyxTQUFTLENBQUNELGFBQUksQ0FBQ0csT0FBTyxDQUFDTixZQUFZLENBQUMsQ0FBQztFQUVqRSxJQUFJRSxjQUFjLEtBQUtGLFlBQVksSUFBSSxDQUFDSyxjQUFjLENBQUNFLFVBQVUsQ0FBQ0wsY0FBYyxDQUFDLEVBQUU7SUFDakYsTUFBTSxJQUFJTSxLQUFLLENBQUUsSUFBR0gsY0FBZSxxQ0FBb0NILGNBQWUsR0FBRSxDQUFDO0VBQzNGO0FBQ0Y7QUFFQSxlQUFlTyxlQUFlLENBQUVDLElBQUksRUFBRUMsUUFBUSxFQUFFQyxhQUFhLEVBQUU7RUFDN0QsSUFBSSxDQUFDRCxRQUFRLEVBQUU7SUFDYixPQUFPLE1BQU1FLHlCQUFRLENBQUNDLGVBQWUsQ0FBQ0osSUFBSSxDQUFDO0VBQzdDO0VBQ0EsTUFBTUssT0FBTyxHQUFHLE1BQU1GLHlCQUFRLENBQUNHLHVCQUF1QixDQUFDTixJQUFJLENBQUM7RUFDNUQsT0FBT08sb0JBQW9CLENBQUNMLGFBQWEsQ0FBQyxHQUN0QyxNQUFNRyxPQUFPLENBQUNHLGFBQWEsQ0FBQ1AsUUFBUSxDQUFDLEdBQ3JDLE1BQU1JLE9BQU8sQ0FBQ0ksYUFBYSxDQUFDUixRQUFRLENBQUM7QUFDM0M7QUFFQSxTQUFTTSxvQkFBb0IsQ0FBRUwsYUFBYSxFQUFFO0VBQzVDLE9BQU9RLGVBQUMsQ0FBQ0MsT0FBTyxDQUFDVCxhQUFhLENBQUMsS0FBS1EsZUFBQyxDQUFDQyxPQUFPLENBQUN6Qix3QkFBd0IsQ0FBQztBQUN6RTtBQUVBLGVBQWUwQixhQUFhLENBQUVaLElBQUksRUFBRWEsVUFBVSxFQUFFO0VBQzlDLElBQUk5QixzQkFBc0IsQ0FBQytCLElBQUksQ0FBQ0QsVUFBVSxDQUFDLEVBQUU7SUFDM0MsTUFBTTtNQUFDWixRQUFRO01BQUVjLGVBQWU7TUFBRWI7SUFBYSxDQUFDLEdBQUcsTUFBTWMsa0JBQWtCLENBQUNILFVBQVUsQ0FBQztJQUN2RixNQUFNUixPQUFPLEdBQUcsTUFBTU4sZUFBZSxDQUFDQyxJQUFJLEVBQUVDLFFBQVEsRUFBRUMsYUFBYSxDQUFDO0lBQ3BFLE1BQU1lLFlBQVksR0FBR1Ysb0JBQW9CLENBQUNMLGFBQWEsQ0FBQyxHQUNwRFQsYUFBSSxDQUFDeUIsSUFBSSxDQUFDaEMsd0JBQXdCLEVBQUU2QixlQUFlLENBQUMsR0FDcERBLGVBQWU7SUFDbkIsT0FBTztNQUFDVixPQUFPO01BQUVZO0lBQVksQ0FBQztFQUNoQyxDQUFDLE1BQU07SUFDTCxNQUFNWixPQUFPLEdBQUcsTUFBTU4sZUFBZSxDQUFDQyxJQUFJLENBQUM7SUFDM0MsT0FBTztNQUFDSyxPQUFPO01BQUVZLFlBQVksRUFBRUo7SUFBVSxDQUFDO0VBQzVDO0FBQ0Y7QUFzQkEsZUFBZUcsa0JBQWtCLENBQUVILFVBQVUsRUFBRU0scUJBQXFCLEVBQUU7RUFDcEUsTUFBTUMsS0FBSyxHQUFHckMsc0JBQXNCLENBQUNzQyxJQUFJLENBQUNSLFVBQVUsQ0FBQztFQUNyRCxJQUFJLENBQUNPLEtBQUssRUFBRTtJQUNWLE1BQU0sSUFBSXRCLEtBQUssQ0FBRSx5Q0FBd0MsR0FDdEQsZ0JBQWVoQixxQkFBc0IsOEJBQTZCLEdBQ2xFLHVDQUFzQytCLFVBQVcsb0JBQW1CLENBQUM7RUFDMUU7RUFDQSxJQUFJLEdBQUdaLFFBQVEsRUFBRWdCLFlBQVksQ0FBQyxHQUFHRyxLQUFLO0VBQ3RDLElBQUlsQixhQUFhLEdBQUcsSUFBSTtFQUN4QixNQUFNb0IsZ0JBQWdCLEdBQUdyQixRQUFRLENBQUNzQixPQUFPLENBQUN0Qyx3QkFBd0IsQ0FBQztFQUduRSxJQUFJcUMsZ0JBQWdCLEdBQUcsQ0FBQyxJQUFJQSxnQkFBZ0IsR0FBR3JCLFFBQVEsQ0FBQ3VCLE1BQU0sR0FBRyxDQUFDLEVBQUU7SUFDbEV0QixhQUFhLEdBQUdELFFBQVEsQ0FBQ3dCLFNBQVMsQ0FBQ0gsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDO0lBQ3hESSxlQUFHLENBQUNDLEtBQUssQ0FBRSwwQkFBeUJ6QixhQUFjLEVBQUMsQ0FBQztJQUNwREQsUUFBUSxHQUFHQSxRQUFRLENBQUN3QixTQUFTLENBQUMsQ0FBQyxFQUFFSCxnQkFBZ0IsQ0FBQztFQUNwRDtFQUNBLElBQUlaLGVBQUMsQ0FBQ2tCLEtBQUssQ0FBQ1QscUJBQXFCLENBQUMsRUFBRTtJQUNsQyxNQUFNSixlQUFlLEdBQUdFLFlBQVk7SUFDcEMsT0FBTztNQUFFaEIsUUFBUTtNQUFFYyxlQUFlO01BQUViO0lBQWMsQ0FBQztFQUNyRDtFQUNBLE1BQU0yQixhQUFhLEdBQUduQixlQUFDLENBQUNvQixVQUFVLENBQUNYLHFCQUFxQixDQUFDLEdBQ3JELE1BQU1BLHFCQUFxQixDQUFDbEIsUUFBUSxFQUFFQyxhQUFhLENBQUMsR0FDcERpQixxQkFBcUI7RUFDekIsTUFBTUosZUFBZSxHQUFHdEIsYUFBSSxDQUFDc0MsS0FBSyxDQUFDQyxPQUFPLENBQUNILGFBQWEsRUFBRVosWUFBWSxDQUFDO0VBQ3ZFNUIsZUFBZSxDQUFDMEIsZUFBZSxFQUFFYyxhQUFhLENBQUM7RUFDL0MsT0FBTztJQUFDNUIsUUFBUTtJQUFFYyxlQUFlO0lBQUViO0VBQWEsQ0FBQztBQUNuRDtBQW9CQSxlQUFlK0IsbUJBQW1CLENBQUVDLE1BQU0sRUFBRXJCLFVBQVUsRUFBRXNCLFVBQVUsRUFBRTtFQUNsRSxNQUFNQyxNQUFNLEdBQUdDLE1BQU0sQ0FBQ0MsSUFBSSxDQUFDSCxVQUFVLEVBQUUsUUFBUSxDQUFDO0VBQ2hELElBQUlwRCxzQkFBc0IsQ0FBQytCLElBQUksQ0FBQ0QsVUFBVSxDQUFDLEVBQUU7SUFDM0MsTUFBTTtNQUFDWixRQUFRO01BQUVjLGVBQWUsRUFBRXdCO0lBQU8sQ0FBQyxHQUFHLE1BQU12QixrQkFBa0IsQ0FBQ0gsVUFBVSxFQUM5RSxPQUFPMkIsU0FBUyxFQUFFdEMsYUFBYSxLQUFLLE1BQU1nQyxNQUFNLENBQUNPLE1BQU0sQ0FBQ0MsZUFBZSxDQUFDRixTQUFTLEVBQUV0QyxhQUFhLENBQUMsQ0FBQztJQUNwR3dCLGVBQUcsQ0FBQ2lCLElBQUksQ0FBRSw2QkFBNEIxQyxRQUFTLFdBQVVZLFVBQVcsS0FBSSxHQUNyRSwyQkFBMEIwQixPQUFRLEdBQUUsQ0FBQztJQUN4QyxJQUFJLEVBQUMsTUFBTUssV0FBRSxDQUFDQyxNQUFNLENBQUNwRCxhQUFJLENBQUNHLE9BQU8sQ0FBQzJDLE9BQU8sQ0FBQyxDQUFDLEdBQUU7TUFDM0NiLGVBQUcsQ0FBQ0MsS0FBSyxDQUFFLDJCQUEwQmxDLGFBQUksQ0FBQ0csT0FBTyxDQUFDMkMsT0FBTyxDQUFFLCtCQUE4QixDQUFDO01BQzFGLE1BQU0sSUFBQU8sZUFBTSxFQUFDckQsYUFBSSxDQUFDRyxPQUFPLENBQUMyQyxPQUFPLENBQUMsQ0FBQztJQUNyQztJQUNBLE1BQU1LLFdBQUUsQ0FBQ0csU0FBUyxDQUFDUixPQUFPLEVBQUVILE1BQU0sQ0FBQztJQUNuQztFQUNGO0VBQ0EsTUFBTVksU0FBUyxHQUFHLE1BQU1DLGdCQUFPLENBQUNDLE9BQU8sRUFBRTtFQUN6QyxNQUFNWCxPQUFPLEdBQUc5QyxhQUFJLENBQUN1QyxPQUFPLENBQUNnQixTQUFTLEVBQUV2RCxhQUFJLENBQUMwRCxRQUFRLENBQUN0QyxVQUFVLENBQUMsQ0FBQztFQUNsRSxJQUFJO0lBQ0YsTUFBTStCLFdBQUUsQ0FBQ0csU0FBUyxDQUFDUixPQUFPLEVBQUVILE1BQU0sQ0FBQztJQUNuQyxNQUFNRixNQUFNLENBQUNPLE1BQU0sQ0FBQ1csUUFBUSxDQUFDYixPQUFPLENBQUM7RUFDdkMsQ0FBQyxTQUFTO0lBQ1IsTUFBTUssV0FBRSxDQUFDUyxNQUFNLENBQUNMLFNBQVMsQ0FBQztFQUM1QjtBQUNGO0FBc0JBLGVBQWVNLG9CQUFvQixDQUFFcEIsTUFBTSxFQUFFckIsVUFBVSxFQUFFc0IsVUFBVSxFQUFFO0VBQ25FLE1BQU07SUFBQzlCLE9BQU87SUFBRVk7RUFBWSxDQUFDLEdBQUcsTUFBTUwsYUFBYSxDQUFDc0IsTUFBTSxDQUFDbEMsSUFBSSxFQUFFYSxVQUFVLENBQUM7RUFDNUUsSUFBSTtJQUNGLE1BQU0sSUFBQTBDLHNCQUFRLEVBQUNsRCxPQUFPLEVBQUVZLFlBQVksRUFBRWtCLFVBQVUsQ0FBQztFQUNuRCxDQUFDLENBQUMsT0FBT3FCLENBQUMsRUFBRTtJQUNWOUIsZUFBRyxDQUFDQyxLQUFLLENBQUM2QixDQUFDLENBQUNDLEtBQUssQ0FBQztJQUNsQixNQUFNLElBQUkzRCxLQUFLLENBQUUsK0JBQThCZSxVQUFXLHVCQUFzQjJDLENBQUMsQ0FBQ0UsT0FBUSxFQUFDLENBQUM7RUFDOUYsQ0FBQyxTQUFTO0lBQ1JyRCxPQUFPLENBQUNzRCxLQUFLLEVBQUU7RUFDakI7QUFDRjtBQUVBLGVBQWVDLGtCQUFrQixDQUFFMUIsTUFBTSxFQUFFckIsVUFBVSxFQUFFZ0QsV0FBVyxFQUFFO0VBQ2xFLE9BQU9BLFdBQVcsR0FDZCxNQUFNQyxtQkFBbUIsQ0FBQzVCLE1BQU0sRUFBRXJCLFVBQVUsQ0FBQyxHQUM3QyxNQUFNa0Qsb0JBQW9CLENBQUM3QixNQUFNLEVBQUVyQixVQUFVLENBQUM7QUFDcEQ7QUFrQkEsZUFBZW1ELGlCQUFpQixDQUFFOUIsTUFBTSxFQUFFckIsVUFBVSxFQUFFb0QsTUFBTSxFQUFFO0VBQzVELElBQUlDLFlBQVk7RUFDaEIsSUFBSW5GLHNCQUFzQixDQUFDK0IsSUFBSSxDQUFDRCxVQUFVLENBQUMsRUFBRTtJQUMzQyxNQUFNO01BQUNaLFFBQVE7TUFBRWMsZUFBZSxFQUFFd0I7SUFBTyxDQUFDLEdBQUcsTUFBTXZCLGtCQUFrQixDQUFDSCxVQUFVLEVBQzlFLE9BQU8yQixTQUFTLEVBQUV0QyxhQUFhLEtBQUssTUFBTWdDLE1BQU0sQ0FBQ08sTUFBTSxDQUFDQyxlQUFlLENBQUNGLFNBQVMsRUFBRXRDLGFBQWEsQ0FBQyxDQUFDO0lBQ3BHd0IsZUFBRyxDQUFDaUIsSUFBSSxDQUFFLDZCQUE0QjFDLFFBQVMsV0FBVVksVUFBVyxLQUFJLEdBQ3JFLDJCQUEwQjBCLE9BQVEsR0FBRSxDQUFDO0lBQ3hDMkIsWUFBWSxHQUFHM0IsT0FBTztFQUN4QixDQUFDLE1BQU07SUFDTCxNQUFNNEIsT0FBTyxHQUFHakMsTUFBTSxDQUFDa0MsTUFBTSxFQUFFO0lBQy9CRixZQUFZLEdBQUd6RSxhQUFJLENBQUNzQyxLQUFLLENBQUNiLElBQUksQ0FBQ2lELE9BQU8sRUFBRXRELFVBQVUsQ0FBQztJQUNuRHhCLGVBQWUsQ0FBQzZFLFlBQVksRUFBRUMsT0FBTyxDQUFDO0lBQ3RDekMsZUFBRyxDQUFDaUIsSUFBSSxDQUFFLDJCQUEwQnVCLFlBQWEsRUFBQyxDQUFDO0VBQ3JEO0VBQ0EsSUFBSSxFQUFDLE1BQU10QixXQUFFLENBQUNDLE1BQU0sQ0FBQ3FCLFlBQVksQ0FBQyxHQUFFO0lBQ2xDeEMsZUFBRyxDQUFDMkMsYUFBYSxDQUFFLGNBQWFKLE1BQU0sR0FBRyxNQUFNLEdBQUcsUUFBUyxRQUFPQyxZQUFhLGtCQUFpQixDQUFDO0VBQ25HO0VBQ0EsTUFBTTlCLE1BQU0sR0FBRzZCLE1BQU0sR0FDakIsTUFBTUssYUFBSSxDQUFDQyxnQkFBZ0IsQ0FBQ0wsWUFBWSxDQUFDLEdBQ3pDLE1BQU1NLFlBQUcsQ0FBQ0MsYUFBYSxDQUFDUCxZQUFZLEVBQUU7SUFBQ1EsY0FBYyxFQUFFO0VBQUksQ0FBQyxDQUFDO0VBQ2pFLE9BQU90QyxNQUFNLENBQUN1QyxRQUFRLEVBQUU7QUFDMUI7QUF5QkEsZUFBZUMsa0JBQWtCLENBQUUxQyxNQUFNLEVBQUVyQixVQUFVLEVBQUVvRCxNQUFNLEVBQUU7RUFDN0QsTUFBTTtJQUFDNUQsT0FBTztJQUFFWTtFQUFZLENBQUMsR0FBRyxNQUFNTCxhQUFhLENBQUNzQixNQUFNLENBQUNsQyxJQUFJLEVBQUVhLFVBQVUsQ0FBQztFQUM1RSxJQUFJO0lBQ0YsTUFBTWdFLFFBQVEsR0FBRyxNQUFNeEUsT0FBTyxDQUFDeUUsV0FBVyxDQUFDN0QsWUFBWSxDQUFDO0lBQ3hELElBQUlnRCxNQUFNLElBQUlZLFFBQVEsQ0FBQ0UsV0FBVyxFQUFFLEVBQUU7TUFDcEMsTUFBTSxJQUFJakYsS0FBSyxDQUFFLDRDQUEyQ2UsVUFBVyxHQUFFLENBQUM7SUFDNUU7SUFDQSxJQUFJLENBQUNvRCxNQUFNLElBQUksQ0FBQ1ksUUFBUSxDQUFDRSxXQUFXLEVBQUUsRUFBRTtNQUN0QyxNQUFNLElBQUlqRixLQUFLLENBQUUsOENBQTZDZSxVQUFXLEdBQUUsQ0FBQztJQUM5RTtJQUVBLE9BQU9nRSxRQUFRLENBQUNaLE1BQU0sRUFBRSxHQUNwQixDQUFDLE1BQU0sSUFBQWUsc0JBQVEsRUFBQzNFLE9BQU8sRUFBRVksWUFBWSxDQUFDLEVBQUUwRCxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQzFELENBQUMsTUFBTSxJQUFBTSx3QkFBVSxFQUFDNUUsT0FBTyxFQUFFWSxZQUFZLENBQUMsRUFBRTBELFFBQVEsRUFBRTtFQUMxRCxDQUFDLFNBQVM7SUFDUnRFLE9BQU8sQ0FBQ3NELEtBQUssRUFBRTtFQUNqQjtBQUNGO0FBZUEsZUFBZUcsbUJBQW1CLENBQUU1QixNQUFNLEVBQUVyQixVQUFVLEVBQUU7RUFDdEQsSUFBSXFELFlBQVk7RUFDaEIsSUFBSW5GLHNCQUFzQixDQUFDK0IsSUFBSSxDQUFDRCxVQUFVLENBQUMsRUFBRTtJQUMzQyxNQUFNO01BQUNaLFFBQVE7TUFBRWMsZUFBZSxFQUFFd0I7SUFBTyxDQUFDLEdBQUcsTUFBTXZCLGtCQUFrQixDQUFDSCxVQUFVLEVBQzlFLE9BQU8yQixTQUFTLEVBQUV0QyxhQUFhLEtBQUssTUFBTWdDLE1BQU0sQ0FBQ08sTUFBTSxDQUFDQyxlQUFlLENBQUNGLFNBQVMsRUFBRXRDLGFBQWEsQ0FBQyxDQUFDO0lBQ3BHd0IsZUFBRyxDQUFDaUIsSUFBSSxDQUFFLDZCQUE0QjFDLFFBQVMsV0FBVVksVUFBVyxLQUFJLEdBQ3JFLElBQUcwQixPQUFRLG1CQUFrQixDQUFDO0lBQ2pDMkIsWUFBWSxHQUFHM0IsT0FBTztFQUN4QixDQUFDLE1BQU07SUFDTCxNQUFNNEIsT0FBTyxHQUFHakMsTUFBTSxDQUFDa0MsTUFBTSxFQUFFO0lBQy9CRixZQUFZLEdBQUd6RSxhQUFJLENBQUNzQyxLQUFLLENBQUNiLElBQUksQ0FBQ2lELE9BQU8sRUFBRXRELFVBQVUsQ0FBQztJQUNuRHhCLGVBQWUsQ0FBQzZFLFlBQVksRUFBRUMsT0FBTyxDQUFDO0lBQ3RDekMsZUFBRyxDQUFDaUIsSUFBSSxDQUFFLHNCQUFxQnVCLFlBQWEsRUFBQyxDQUFDO0VBQ2hEO0VBQ0EsSUFBSSxFQUFDLE1BQU10QixXQUFFLENBQUNDLE1BQU0sQ0FBQ3FCLFlBQVksQ0FBQyxHQUFFO0lBQ2xDLE1BQU0sSUFBSWdCLGNBQU0sQ0FBQ0Msb0JBQW9CLENBQUUsdUJBQXNCakIsWUFBYSxrQkFBaUIsQ0FBQztFQUM5RjtFQUNBLE1BQU10QixXQUFFLENBQUNTLE1BQU0sQ0FBQ2EsWUFBWSxDQUFDO0FBQy9CO0FBc0JBLGVBQWVILG9CQUFvQixDQUFFN0IsTUFBTSxFQUFFckIsVUFBVSxFQUFFO0VBQ3ZELE1BQU07SUFBRVIsT0FBTztJQUFFWTtFQUFhLENBQUMsR0FBRyxNQUFNTCxhQUFhLENBQUNzQixNQUFNLENBQUNsQyxJQUFJLEVBQUVhLFVBQVUsQ0FBQztFQUM5RSxJQUFJO0lBQ0YsTUFBTVIsT0FBTyxDQUFDK0UsZUFBZSxDQUFDbkUsWUFBWSxDQUFDO0VBQzdDLENBQUMsQ0FBQyxPQUFPdUMsQ0FBQyxFQUFFO0lBQ1YsSUFBSUEsQ0FBQyxDQUFDRSxPQUFPLENBQUMyQixRQUFRLENBQUNsRyw4QkFBOEIsQ0FBQyxFQUFFO01BQ3RELE1BQU0sSUFBSVcsS0FBSyxDQUFFLFNBQVFlLFVBQVcsZ0NBQStCLENBQUM7SUFDdEU7SUFDQSxNQUFNMkMsQ0FBQztFQUNULENBQUMsU0FBUztJQUNSbkQsT0FBTyxDQUFDc0QsS0FBSyxFQUFFO0VBQ2pCO0FBQ0Y7QUFhQXZFLFFBQVEsQ0FBQ21FLFFBQVEsR0FBRyxlQUFlQSxRQUFRLENBQUUxQyxVQUFVLEVBQUVzQixVQUFVLEVBQUU7RUFDbkUsSUFBSXRCLFVBQVUsQ0FBQ3lFLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtJQUM1QixNQUFNLElBQUlKLGNBQU0sQ0FBQ0Msb0JBQW9CLENBQUUsd0VBQXVFLEdBQzNHLElBQUd0RSxVQUFXLG9CQUFtQixDQUFDO0VBQ3ZDO0VBQ0EsSUFBSUgsZUFBQyxDQUFDNkUsT0FBTyxDQUFDcEQsVUFBVSxDQUFDLEVBQUU7SUFHekJBLFVBQVUsR0FBR0UsTUFBTSxDQUFDQyxJQUFJLENBQUNILFVBQVUsQ0FBQyxDQUFDd0MsUUFBUSxDQUFDLE1BQU0sQ0FBQztFQUN2RDtFQUNBLE9BQU8sSUFBSSxDQUFDZCxXQUFXLEVBQUUsR0FDckIsTUFBTTVCLG1CQUFtQixDQUFDLElBQUksQ0FBQ3VELElBQUksQ0FBQ3RELE1BQU0sRUFBRXJCLFVBQVUsRUFBRXNCLFVBQVUsQ0FBQyxHQUNuRSxNQUFNbUIsb0JBQW9CLENBQUMsSUFBSSxDQUFDa0MsSUFBSSxDQUFDdEQsTUFBTSxFQUFFckIsVUFBVSxFQUFFc0IsVUFBVSxDQUFDO0FBQzFFLENBQUM7QUFjRC9DLFFBQVEsQ0FBQ3FHLGNBQWMsR0FBRyxlQUFlQSxjQUFjLENBQUVELElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtFQUNsRSxNQUFNO0lBQUUzRSxVQUFVO0lBQUU2RTtFQUFRLENBQUMsR0FBRyxJQUFBQyxrQkFBVyxFQUFDLENBQUMsWUFBWSxFQUFFLFNBQVMsQ0FBQyxFQUFFSCxJQUFJLENBQUM7RUFDNUUsT0FBTyxNQUFNLElBQUksQ0FBQ2pDLFFBQVEsQ0FBQzFDLFVBQVUsRUFBRTZFLE9BQU8sQ0FBQztBQUNqRCxDQUFDO0FBWUR0RyxRQUFRLENBQUM0RixRQUFRLEdBQUcsZUFBZUEsUUFBUSxDQUFFbkUsVUFBVSxFQUFFO0VBQ3ZELElBQUlBLFVBQVUsQ0FBQ3lFLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtJQUM1QixNQUFNLElBQUlKLGNBQU0sQ0FBQ0Msb0JBQW9CLENBQUUsd0VBQXVFLEdBQzNHLElBQUd0RSxVQUFXLG9CQUFtQixDQUFDO0VBQ3ZDO0VBQ0EsT0FBTyxJQUFJLENBQUNnRCxXQUFXLEVBQUUsR0FDckIsTUFBTUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDd0IsSUFBSSxDQUFDdEQsTUFBTSxFQUFFckIsVUFBVSxFQUFFLElBQUksQ0FBQyxHQUMzRCxNQUFNK0Qsa0JBQWtCLENBQUMsSUFBSSxDQUFDWSxJQUFJLENBQUN0RCxNQUFNLEVBQUVyQixVQUFVLEVBQUUsSUFBSSxDQUFDO0FBQ2xFLENBQUM7QUFnQkR6QixRQUFRLENBQUN3RyxjQUFjLEdBQUcsZUFBZUEsY0FBYyxDQUFFSixJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUU7RUFDbEUsTUFBTTtJQUFFM0U7RUFBVyxDQUFDLEdBQUcsSUFBQThFLGtCQUFXLEVBQUMsWUFBWSxFQUFFSCxJQUFJLENBQUM7RUFDdEQsT0FBTyxNQUFNLElBQUksQ0FBQ1IsUUFBUSxDQUFDbkUsVUFBVSxDQUFDO0FBQ3hDLENBQUM7QUFlRHpCLFFBQVEsQ0FBQ3lHLGtCQUFrQixHQUFHLGVBQWVBLGtCQUFrQixDQUFFTCxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUU7RUFDMUUsSUFBSTtJQUFFM0U7RUFBVyxDQUFDLEdBQUcsSUFBQThFLGtCQUFXLEVBQUMsWUFBWSxFQUFFSCxJQUFJLENBQUM7RUFDcEQsSUFBSSxDQUFDM0UsVUFBVSxDQUFDeUUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO0lBQzdCekUsVUFBVSxHQUFJLEdBQUVBLFVBQVcsR0FBRTtFQUMvQjtFQUNBLE9BQU8sTUFBTStDLGtCQUFrQixDQUFDLElBQUksQ0FBQzRCLElBQUksQ0FBQ3RELE1BQU0sRUFBRXJCLFVBQVUsRUFBRSxJQUFJLENBQUNnRCxXQUFXLEVBQUUsQ0FBQztBQUNuRixDQUFDO0FBZUR6RSxRQUFRLENBQUMwRyxnQkFBZ0IsR0FBRyxlQUFlQSxnQkFBZ0IsQ0FBRU4sSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ3RFLE1BQU07SUFBRTNFO0VBQVcsQ0FBQyxHQUFHLElBQUE4RSxrQkFBVyxFQUFDLFlBQVksRUFBRUgsSUFBSSxDQUFDO0VBQ3RELElBQUkzRSxVQUFVLENBQUN5RSxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7SUFDNUIsTUFBTSxJQUFJSixjQUFNLENBQUNDLG9CQUFvQixDQUFFLHdFQUF1RSxHQUMzRyxJQUFHdEUsVUFBVyxvQkFBbUIsQ0FBQztFQUN2QztFQUNBLE9BQU8sTUFBTStDLGtCQUFrQixDQUFDLElBQUksQ0FBQzRCLElBQUksQ0FBQ3RELE1BQU0sRUFBRXJCLFVBQVUsRUFBRSxJQUFJLENBQUNnRCxXQUFXLEVBQUUsQ0FBQztBQUNuRixDQUFDO0FBVUR6RSxRQUFRLENBQUM2RixVQUFVLEdBQUcsZUFBZUEsVUFBVSxDQUFFcEUsVUFBVSxFQUFFO0VBQzNELElBQUksQ0FBQ0EsVUFBVSxDQUFDeUUsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO0lBQzdCekUsVUFBVSxHQUFJLEdBQUVBLFVBQVcsR0FBRTtFQUMvQjtFQUNBLE9BQU8sSUFBSSxDQUFDZ0QsV0FBVyxFQUFFLEdBQ3JCLE1BQU1HLGlCQUFpQixDQUFDLElBQUksQ0FBQ3dCLElBQUksQ0FBQ3RELE1BQU0sRUFBRXJCLFVBQVUsRUFBRSxLQUFLLENBQUMsR0FDNUQsTUFBTStELGtCQUFrQixDQUFDLElBQUksQ0FBQ1ksSUFBSSxDQUFDdEQsTUFBTSxFQUFFckIsVUFBVSxFQUFFLEtBQUssQ0FBQztBQUNuRSxDQUFDO0FBYUR6QixRQUFRLENBQUMyRyxnQkFBZ0IsR0FBRyxlQUFlQSxnQkFBZ0IsQ0FBRVAsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ3RFLE1BQU07SUFBRTNFO0VBQVcsQ0FBQyxHQUFHLElBQUE4RSxrQkFBVyxFQUFDLFlBQVksRUFBRUgsSUFBSSxDQUFDO0VBQ3RELE9BQU8sTUFBTSxJQUFJLENBQUNQLFVBQVUsQ0FBQ3BFLFVBQVUsQ0FBQztBQUMxQyxDQUFDO0FBQUMsZUFHYXpCLFFBQVE7QUFBQSJ9