"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.default = exports.commands = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _cssConverter = _interopRequireDefault(require("../css-converter"));
var _driver = require("appium/driver");
var _support = require("appium/support");
const MAGIC_FIRST_VIS_CHILD_SEL = /\/\*\[@firstVisible\s*=\s*('|")true\1\]/;
const MAGIC_SCROLLABLE_SEL = /\/\/\*\[@scrollable\s*=\s*('|")true\1\]/;
const WDA_CLASS_CHAIN_STRATEGY = 'class chain';
let helpers = {},
  commands = {},
  extensions = {};
exports.commands = commands;
exports.helpers = helpers;
helpers.findElOrEls = async function findElOrEls(strategy, selector, mult, context) {
  if (this.isWebview()) {
    return await this.findWebElementOrElements(strategy, selector, mult, context);
  } else {
    return await this.findNativeElementOrElements(strategy, selector, mult, context);
  }
};
helpers.findNativeElementOrElements = async function findNativeElementOrElements(strategy, selector, mult, context) {
  const initSelector = selector;
  let rewroteSelector = false;
  if (strategy === '-ios predicate string') {
    strategy = 'predicate string';
  } else if (strategy === '-ios class chain') {
    strategy = WDA_CLASS_CHAIN_STRATEGY;
  } else if (strategy === 'css selector') {
    strategy = WDA_CLASS_CHAIN_STRATEGY;
    selector = _cssConverter.default.toIosClassChainSelector(selector);
  }
  function stripViewFromSelector(selector) {
    const keepView = ['XCUIElementTypeScrollView', 'XCUIElementTypeCollectionView', 'XCUIElementTypeTextView', 'XCUIElementTypeWebView'].includes(selector);
    if (!keepView && selector.indexOf('View') === selector.length - 4) {
      return selector.substr(0, selector.length - 4);
    } else {
      return selector;
    }
  }
  if (strategy === 'class name') {
    if (selector.startsWith('UIA')) {
      selector = selector.substring(3);
    }
    if (!selector.startsWith('XCUIElementType')) {
      selector = stripViewFromSelector(`XCUIElementType${selector}`);
      rewroteSelector = true;
    }
  }
  if (strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector)) {
    return await this.getFirstVisibleChild(mult, context);
  } else if (strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector)) {
    [strategy, selector] = rewriteMagicScrollable(mult, this.log);
  } else if (strategy === 'xpath') {
    selector = selector.replace(/(^|\/)(UIA)([^[/]+)/g, (str, g1, g2, g3) => {
      rewroteSelector = true;
      return g1 + stripViewFromSelector(`XCUIElementType${g3}`);
    });
  }
  if (rewroteSelector) {
    this.log.info(`Rewrote incoming selector from '${initSelector}' to ` + `'${selector}' to match XCUI type. You should consider ` + `updating your tests to use the new selectors directly`);
  }
  return await this.doNativeFind(strategy, selector, mult, context);
};
helpers.doNativeFind = async function doNativeFind(strategy, selector, mult, context) {
  context = _support.util.unwrapElement(context);
  let endpoint = `/element${context ? `/${context}/element` : ''}${mult ? 's' : ''}`;
  let body = {
    using: strategy,
    value: selector
  };
  let method = 'POST';
  let els;
  try {
    await this.implicitWaitForCondition(async () => {
      try {
        els = await this.proxyCommand(endpoint, method, body);
      } catch (err) {
        els = [];
      }
      return !_lodash.default.isEmpty(els);
    });
  } catch (err) {
    if (err.message && err.message.match(/Condition unmet/)) {
      els = [];
    } else {
      throw err;
    }
  }
  if (mult) {
    return els;
  }
  if (_lodash.default.isEmpty(els)) {
    throw new _driver.errors.NoSuchElementError();
  }
  return els;
};
helpers.getFirstVisibleChild = async function getFirstVisibleChild(mult, context) {
  this.log.info(`Getting first visible child`);
  if (mult) {
    throw new Error('Cannot get multiple first visible children!');
  }
  if (!context) {
    throw new Error('Cannot get first visible child without a context element');
  }
  let index = 1;
  while (true) {
    const strategy = WDA_CLASS_CHAIN_STRATEGY;
    const selector = `*[${index}]`;
    const nthChild = await this.doNativeFind(strategy, selector, false, context);
    const visible = await this.getAttribute('visible', nthChild);
    if (visible === 'true') {
      this.log.info(`Found first visible child at position ${index}`);
      return nthChild;
    }
    index++;
  }
};
function rewriteMagicScrollable(mult, log = null) {
  const pred = ['ScrollView', 'Table', 'CollectionView', 'WebView'].map(t => `type == "XCUIElementType${t}"`).join(' OR ');
  const strategy = WDA_CLASS_CHAIN_STRATEGY;
  let selector = '**/*[`' + pred + '`]';
  if (!mult) {
    selector += '[1]';
  }
  log === null || log === void 0 ? void 0 : log.info('Rewrote request for scrollable descendants to class chain ' + `format with selector '${selector}'`);
  return [strategy, selector];
}
Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJNQUdJQ19GSVJTVF9WSVNfQ0hJTERfU0VMIiwiTUFHSUNfU0NST0xMQUJMRV9TRUwiLCJXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1kiLCJoZWxwZXJzIiwiY29tbWFuZHMiLCJleHRlbnNpb25zIiwiZmluZEVsT3JFbHMiLCJzdHJhdGVneSIsInNlbGVjdG9yIiwibXVsdCIsImNvbnRleHQiLCJpc1dlYnZpZXciLCJmaW5kV2ViRWxlbWVudE9yRWxlbWVudHMiLCJmaW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMiLCJpbml0U2VsZWN0b3IiLCJyZXdyb3RlU2VsZWN0b3IiLCJDc3NDb252ZXJ0ZXIiLCJ0b0lvc0NsYXNzQ2hhaW5TZWxlY3RvciIsInN0cmlwVmlld0Zyb21TZWxlY3RvciIsImtlZXBWaWV3IiwiaW5jbHVkZXMiLCJpbmRleE9mIiwibGVuZ3RoIiwic3Vic3RyIiwic3RhcnRzV2l0aCIsInN1YnN0cmluZyIsInRlc3QiLCJnZXRGaXJzdFZpc2libGVDaGlsZCIsInJld3JpdGVNYWdpY1Njcm9sbGFibGUiLCJsb2ciLCJyZXBsYWNlIiwic3RyIiwiZzEiLCJnMiIsImczIiwiaW5mbyIsImRvTmF0aXZlRmluZCIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiZW5kcG9pbnQiLCJib2R5IiwidXNpbmciLCJ2YWx1ZSIsIm1ldGhvZCIsImVscyIsImltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiIsInByb3h5Q29tbWFuZCIsImVyciIsIl8iLCJpc0VtcHR5IiwibWVzc2FnZSIsIm1hdGNoIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiRXJyb3IiLCJpbmRleCIsIm50aENoaWxkIiwidmlzaWJsZSIsImdldEF0dHJpYnV0ZSIsInByZWQiLCJtYXAiLCJ0Iiwiam9pbiIsIk9iamVjdCIsImFzc2lnbiJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jb21tYW5kcy9maW5kLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQ3NzQ29udmVydGVyIGZyb20gJy4uL2Nzcy1jb252ZXJ0ZXInO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtL2RyaXZlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtL3N1cHBvcnQnO1xuXG4vLyB3ZSBvdmVycmlkZSB0aGUgeHBhdGggc2VhcmNoIGZvciB0aGlzIGZpcnN0LXZpc2libGUtY2hpbGQgc2VsZWN0b3IsIHdoaWNoXG4vLyBsb29rcyBsaWtlIC8qW0BmaXJzdFZpc2libGU9XCJ0cnVlXCJdXG5jb25zdCBNQUdJQ19GSVJTVF9WSVNfQ0hJTERfU0VMID0gL1xcL1xcKlxcW0BmaXJzdFZpc2libGVcXHMqPVxccyooJ3xcIil0cnVlXFwxXFxdLztcblxuLy8gd2UgbGlrZXdpc2Ugb3ZlcnJpZGUgeHBhdGggc2VhcmNoIHRvIHByb3ZpZGUgYSBzaG9ydGN1dCBmb3IgZmluZGluZyBhbGxcbi8vIHNjcm9sbGFibGUgZWxlbWVudHNcbmNvbnN0IE1BR0lDX1NDUk9MTEFCTEVfU0VMID0gL1xcL1xcL1xcKlxcW0BzY3JvbGxhYmxlXFxzKj1cXHMqKCd8XCIpdHJ1ZVxcMVxcXS87XG5cbmNvbnN0IFdEQV9DTEFTU19DSEFJTl9TVFJBVEVHWSA9ICdjbGFzcyBjaGFpbic7XG5cbmxldCBoZWxwZXJzID0ge30sIGNvbW1hbmRzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuaGVscGVycy5maW5kRWxPckVscyA9IGFzeW5jIGZ1bmN0aW9uIGZpbmRFbE9yRWxzIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgaWYgKHRoaXMuaXNXZWJ2aWV3KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kV2ViRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfVxufTtcblxuaGVscGVycy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMgPSBhc3luYyBmdW5jdGlvbiBmaW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMgKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBjb25zdCBpbml0U2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgbGV0IHJld3JvdGVTZWxlY3RvciA9IGZhbHNlO1xuICBpZiAoc3RyYXRlZ3kgPT09ICctaW9zIHByZWRpY2F0ZSBzdHJpbmcnKSB7XG4gICAgLy8gV2ViRHJpdmVyQWdlbnQgdXNlcyAncHJlZGljYXRlIHN0cmluZydcbiAgICBzdHJhdGVneSA9ICdwcmVkaWNhdGUgc3RyaW5nJztcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gJy1pb3MgY2xhc3MgY2hhaW4nKSB7XG4gICAgLy8gV2ViRHJpdmVyQWdlbnQgdXNlcyAnY2xhc3MgY2hhaW4nXG4gICAgc3RyYXRlZ3kgPSBXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1k7XG4gIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09ICdjc3Mgc2VsZWN0b3InKSB7XG4gICAgc3RyYXRlZ3kgPSBXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1k7XG4gICAgc2VsZWN0b3IgPSBDc3NDb252ZXJ0ZXIudG9Jb3NDbGFzc0NoYWluU2VsZWN0b3Ioc2VsZWN0b3IpO1xuICB9XG5cbiAgLy8gQ2hlY2sgaWYgdGhlIHdvcmQgJ1ZpZXcnIGlzIGFwcGVuZGVkIHRvIHNlbGVjdG9yIGFuZCBpZiBpdCBpcywgc3RyaXAgaXQgb3V0XG4gIGZ1bmN0aW9uIHN0cmlwVmlld0Zyb21TZWxlY3RvciAoc2VsZWN0b3IpIHtcbiAgICAvLyBEb24ndCBzdHJpcCBpdCBvdXQgaWYgaXQncyBvbmUgb2YgdGhlc2UgNCBlbGVtZW50IHR5cGVzXG4gICAgLy8gKHNlZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svV2ViRHJpdmVyQWdlbnQvYmxvYi9tYXN0ZXIvV2ViRHJpdmVyQWdlbnRMaWIvVXRpbGl0aWVzL0ZCRWxlbWVudFR5cGVUcmFuc2Zvcm1lci5tIGZvciByZWZlcmVuY2UpXG4gICAgY29uc3Qga2VlcFZpZXcgPSBbXG4gICAgICAnWENVSUVsZW1lbnRUeXBlU2Nyb2xsVmlldycsXG4gICAgICAnWENVSUVsZW1lbnRUeXBlQ29sbGVjdGlvblZpZXcnLFxuICAgICAgJ1hDVUlFbGVtZW50VHlwZVRleHRWaWV3JyxcbiAgICAgICdYQ1VJRWxlbWVudFR5cGVXZWJWaWV3JyxcbiAgICBdLmluY2x1ZGVzKHNlbGVjdG9yKTtcblxuICAgIGlmICgha2VlcFZpZXcgJiYgc2VsZWN0b3IuaW5kZXhPZignVmlldycpID09PSBzZWxlY3Rvci5sZW5ndGggLSA0KSB7XG4gICAgICByZXR1cm4gc2VsZWN0b3Iuc3Vic3RyKDAsIHNlbGVjdG9yLmxlbmd0aCAtIDQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gc2VsZWN0b3I7XG4gICAgfVxuICB9XG5cbiAgaWYgKHN0cmF0ZWd5ID09PSAnY2xhc3MgbmFtZScpIHtcbiAgICAvLyBYQ1VJVGVzdCBjbGFzc2VzIGhhdmUgYFhDVUlFbGVtZW50VHlwZWAgcHJlcGVuZGVkXG4gICAgLy8gZmlyc3QgY2hlY2sgaWYgdGhlcmUgaXMgdGhlIG9sZCBgVUlBYCBwcmVmaXhcbiAgICBpZiAoc2VsZWN0b3Iuc3RhcnRzV2l0aCgnVUlBJykpIHtcbiAgICAgIHNlbGVjdG9yID0gc2VsZWN0b3Iuc3Vic3RyaW5nKDMpO1xuICAgIH1cbiAgICAvLyBub3cgY2hlY2sgaWYgd2UgbmVlZCB0byBhZGQgYFhDVUlFbGVtZW50VHlwZWBcbiAgICBpZiAoIXNlbGVjdG9yLnN0YXJ0c1dpdGgoJ1hDVUlFbGVtZW50VHlwZScpKSB7XG4gICAgICBzZWxlY3RvciA9IHN0cmlwVmlld0Zyb21TZWxlY3RvcihgWENVSUVsZW1lbnRUeXBlJHtzZWxlY3Rvcn1gKTtcbiAgICAgIHJld3JvdGVTZWxlY3RvciA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgaWYgKHN0cmF0ZWd5ID09PSAneHBhdGgnICYmIE1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwudGVzdChzZWxlY3RvcikpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRGaXJzdFZpc2libGVDaGlsZChtdWx0LCBjb250ZXh0KTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gJ3hwYXRoJyAmJiBNQUdJQ19TQ1JPTExBQkxFX1NFTC50ZXN0KHNlbGVjdG9yKSkge1xuICAgIFtzdHJhdGVneSwgc2VsZWN0b3JdID0gcmV3cml0ZU1hZ2ljU2Nyb2xsYWJsZShtdWx0LCB0aGlzLmxvZyk7XG4gIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09ICd4cGF0aCcpIHtcbiAgICAvLyBSZXBsYWNlIFVJQSBpZiBpdCBjb21lcyBhZnRlciBhIGZvcndhcmQgc2xhc2ggb3IgaXMgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgc3RyaW5nXG4gICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKC8oXnxcXC8pKFVJQSkoW15bL10rKS9nLCAoc3RyLCBnMSwgZzIsIGczKSA9PiB7XG4gICAgICByZXdyb3RlU2VsZWN0b3IgPSB0cnVlO1xuICAgICAgcmV0dXJuIGcxICsgc3RyaXBWaWV3RnJvbVNlbGVjdG9yKGBYQ1VJRWxlbWVudFR5cGUke2czfWApO1xuICAgIH0pO1xuICB9XG5cbiAgaWYgKHJld3JvdGVTZWxlY3Rvcikge1xuICAgIHRoaXMubG9nLmluZm8oYFJld3JvdGUgaW5jb21pbmcgc2VsZWN0b3IgZnJvbSAnJHtpbml0U2VsZWN0b3J9JyB0byBgICtcbiAgICAgICAgICAgICBgJyR7c2VsZWN0b3J9JyB0byBtYXRjaCBYQ1VJIHR5cGUuIFlvdSBzaG91bGQgY29uc2lkZXIgYCArXG4gICAgICAgICAgICAgYHVwZGF0aW5nIHlvdXIgdGVzdHMgdG8gdXNlIHRoZSBuZXcgc2VsZWN0b3JzIGRpcmVjdGx5YCk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgdGhpcy5kb05hdGl2ZUZpbmQoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbn07XG5cbmhlbHBlcnMuZG9OYXRpdmVGaW5kID0gYXN5bmMgZnVuY3Rpb24gZG9OYXRpdmVGaW5kIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgY29udGV4dCA9IHV0aWwudW53cmFwRWxlbWVudChjb250ZXh0KTtcblxuICBsZXQgZW5kcG9pbnQgPSBgL2VsZW1lbnQke2NvbnRleHQgPyBgLyR7Y29udGV4dH0vZWxlbWVudGAgOiAnJ30ke211bHQgPyAncycgOiAnJ31gO1xuXG4gIGxldCBib2R5ID0ge1xuICAgIHVzaW5nOiBzdHJhdGVneSxcbiAgICB2YWx1ZTogc2VsZWN0b3JcbiAgfTtcblxuICBsZXQgbWV0aG9kID0gJ1BPU1QnO1xuXG4gIC8vIFRoaXMgaXMgZWl0aGVyIGFuIGFycmF5IGlzIG11bHQgPT09IHRydWVcbiAgLy8gb3IgYW4gb2JqZWN0IGlmIG11bHQgPT09IGZhbHNlXG4gIGxldCBlbHM7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgZWxzID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoZW5kcG9pbnQsIG1ldGhvZCwgYm9keSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgZWxzID0gW107XG4gICAgICB9XG4gICAgICAvLyB3ZSBzdWNjZWVkIGlmIHdlIGdldCBzb21lIGVsZW1lbnRzXG4gICAgICByZXR1cm4gIV8uaXNFbXB0eShlbHMpO1xuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XG4gICAgICAvLyBjb25kaXRpb24gd2FzIG5vdCBtZXQgc2V0dGluZyByZXMgdG8gZW1wdHkgYXJyYXlcbiAgICAgIGVscyA9IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG4gIGlmIChtdWx0KSB7XG4gICAgcmV0dXJuIGVscztcbiAgfVxuICBpZiAoXy5pc0VtcHR5KGVscykpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICB9XG4gIHJldHVybiBlbHM7XG59O1xuXG5oZWxwZXJzLmdldEZpcnN0VmlzaWJsZUNoaWxkID0gYXN5bmMgZnVuY3Rpb24gZ2V0Rmlyc3RWaXNpYmxlQ2hpbGQgKG11bHQsIGNvbnRleHQpIHtcbiAgdGhpcy5sb2cuaW5mbyhgR2V0dGluZyBmaXJzdCB2aXNpYmxlIGNoaWxkYCk7XG4gIGlmIChtdWx0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZ2V0IG11bHRpcGxlIGZpcnN0IHZpc2libGUgY2hpbGRyZW4hJyk7XG4gIH1cbiAgaWYgKCFjb250ZXh0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZ2V0IGZpcnN0IHZpc2libGUgY2hpbGQgd2l0aG91dCBhIGNvbnRleHQgZWxlbWVudCcpO1xuICB9XG4gIGxldCBpbmRleCA9IDE7XG4gIC8vIGxvb3AgdGhyb3VnaCBjaGlsZHJlbiB2aWEgY2xhc3MtY2hhaW4gZmluZHMsIHVudGlsIHdlIHJ1biBvdXQgb2YgY2hpbGRyZW5cbiAgLy8gb3Igd2UgZmluZCBhIHZpc2libGUgb25lLiBUaGlzIGxvb3AgbG9va3MgaW5maW5pdGUgYnV0IGl0cyBub3QsIGJlY2F1c2UgYXRcbiAgLy8gc29tZSBwb2ludCB0aGUgY2FsbCB0byBkb05hdGl2ZUZpbmQgd2lsbCB0aHJvdyB3aXRoIGFuIEVsZW1lbnQgTm90IEZvdW5kXG4gIC8vIGVycm9yLCB3aGVuIHRoZSBpbmRleCBnZXRzIGhpZ2hlciB0aGFuIHRoZSBudW1iZXIgb2YgY2hpbGQgZWxlbWVudHMuIFRoaXNcbiAgLy8gaXMgd2hhdCB3ZSB3YW50IGJlY2F1c2UgdGhhdCBlcnJvciB3aWxsIGhhbHQgdGhlIGxvb3AgYW5kIG1ha2UgaXQgYWxsIHRoZVxuICAvLyB3YXkgdG8gdGhlIGNsaWVudC5cbiAgd2hpbGUgKHRydWUpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zdGFudC1jb25kaXRpb25cbiAgICBjb25zdCBzdHJhdGVneSA9IFdEQV9DTEFTU19DSEFJTl9TVFJBVEVHWTtcbiAgICBjb25zdCBzZWxlY3RvciA9IGAqWyR7aW5kZXh9XWA7XG4gICAgY29uc3QgbnRoQ2hpbGQgPSBhd2FpdCB0aGlzLmRvTmF0aXZlRmluZChzdHJhdGVneSwgc2VsZWN0b3IsIGZhbHNlLCBjb250ZXh0KTtcbiAgICBjb25zdCB2aXNpYmxlID0gYXdhaXQgdGhpcy5nZXRBdHRyaWJ1dGUoJ3Zpc2libGUnLCBudGhDaGlsZCk7XG4gICAgaWYgKHZpc2libGUgPT09ICd0cnVlJykge1xuICAgICAgdGhpcy5sb2cuaW5mbyhgRm91bmQgZmlyc3QgdmlzaWJsZSBjaGlsZCBhdCBwb3NpdGlvbiAke2luZGV4fWApO1xuICAgICAgcmV0dXJuIG50aENoaWxkO1xuICAgIH1cbiAgICBpbmRleCsrO1xuICB9XG59O1xuXG5mdW5jdGlvbiByZXdyaXRlTWFnaWNTY3JvbGxhYmxlIChtdWx0LCBsb2cgPSBudWxsKSB7XG4gIGNvbnN0IHByZWQgPSBbXG4gICAgJ1Njcm9sbFZpZXcnLFxuICAgICdUYWJsZScsXG4gICAgJ0NvbGxlY3Rpb25WaWV3JyxcbiAgICAnV2ViVmlldydcbiAgXS5tYXAoKHQpID0+IGB0eXBlID09IFwiWENVSUVsZW1lbnRUeXBlJHt0fVwiYCkuam9pbignIE9SICcpO1xuICBjb25zdCBzdHJhdGVneSA9IFdEQV9DTEFTU19DSEFJTl9TVFJBVEVHWTtcbiAgbGV0IHNlbGVjdG9yID0gJyoqLypbYCcgKyBwcmVkICsgJ2BdJztcbiAgaWYgKCFtdWx0KSB7XG4gICAgc2VsZWN0b3IgKz0gJ1sxXSc7XG4gIH1cbiAgbG9nPy5pbmZvKCdSZXdyb3RlIHJlcXVlc3QgZm9yIHNjcm9sbGFibGUgZGVzY2VuZGFudHMgdG8gY2xhc3MgY2hhaW4gJyArXG4gICAgYGZvcm1hdCB3aXRoIHNlbGVjdG9yICcke3NlbGVjdG9yfSdgKTtcbiAgcmV0dXJuIFtzdHJhdGVneSwgc2VsZWN0b3JdO1xufVxuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnN9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUlBLE1BQU1BLHlCQUF5QixHQUFHLHlDQUF5QztBQUkzRSxNQUFNQyxvQkFBb0IsR0FBRyx5Q0FBeUM7QUFFdEUsTUFBTUMsd0JBQXdCLEdBQUcsYUFBYTtBQUU5QyxJQUFJQyxPQUFPLEdBQUcsQ0FBQyxDQUFDO0VBQUVDLFFBQVEsR0FBRyxDQUFDLENBQUM7RUFBRUMsVUFBVSxHQUFHLENBQUMsQ0FBQztBQUFDO0FBQUE7QUFFakRGLE9BQU8sQ0FBQ0csV0FBVyxHQUFHLGVBQWVBLFdBQVcsQ0FBRUMsUUFBUSxFQUFFQyxRQUFRLEVBQUVDLElBQUksRUFBRUMsT0FBTyxFQUFFO0VBQ25GLElBQUksSUFBSSxDQUFDQyxTQUFTLEVBQUUsRUFBRTtJQUNwQixPQUFPLE1BQU0sSUFBSSxDQUFDQyx3QkFBd0IsQ0FBQ0wsUUFBUSxFQUFFQyxRQUFRLEVBQUVDLElBQUksRUFBRUMsT0FBTyxDQUFDO0VBQy9FLENBQUMsTUFBTTtJQUNMLE9BQU8sTUFBTSxJQUFJLENBQUNHLDJCQUEyQixDQUFDTixRQUFRLEVBQUVDLFFBQVEsRUFBRUMsSUFBSSxFQUFFQyxPQUFPLENBQUM7RUFDbEY7QUFDRixDQUFDO0FBRURQLE9BQU8sQ0FBQ1UsMkJBQTJCLEdBQUcsZUFBZUEsMkJBQTJCLENBQUVOLFFBQVEsRUFBRUMsUUFBUSxFQUFFQyxJQUFJLEVBQUVDLE9BQU8sRUFBRTtFQUNuSCxNQUFNSSxZQUFZLEdBQUdOLFFBQVE7RUFDN0IsSUFBSU8sZUFBZSxHQUFHLEtBQUs7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