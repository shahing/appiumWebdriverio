"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getConnectedDevices = getConnectedDevices;
exports.getOSVersion = getOSVersion;
exports.getRealDeviceObj = getRealDeviceObj;
exports.installToRealDevice = installToRealDevice;
exports.runRealDeviceReset = runRealDeviceReset;
require("source-map-support/register");
var _appiumIosDevice = require("appium-ios-device");
var _iosDeploy = _interopRequireDefault(require("./ios-deploy"));
var _logger = _interopRequireDefault(require("./logger"));
var _appUtils = require("./app-utils");
async function getConnectedDevices() {
  return await _appiumIosDevice.utilities.getConnectedDevices();
}
async function getOSVersion(udid) {
  return await _appiumIosDevice.utilities.getOSVersion(udid);
}
async function resetRealDevice(device, opts) {
  const {
    bundleId,
    fullReset
  } = opts;
  if (!bundleId) {
    return;
  }
  if (bundleId === _appUtils.SAFARI_BUNDLE_ID) {
    _logger.default.debug('Reset requested. About to terminate Safari');
    await device.terminateApp(bundleId);
    return;
  }
  if (!fullReset) {
    return;
  }
  _logger.default.debug(`Reset: fullReset requested. Will try to uninstall the app '${bundleId}'.`);
  if (!(await device.isAppInstalled(bundleId))) {
    _logger.default.debug('Reset: app not installed. No need to uninstall');
    return;
  }
  try {
    await device.remove(bundleId);
  } catch (err) {
    _logger.default.error(`Reset: could not remove '${bundleId}' from device: ${err.message}`);
    throw err;
  }
  _logger.default.debug(`Reset: removed '${bundleId}'`);
}
async function runRealDeviceReset(device, opts) {
  if (!opts.noReset || opts.fullReset) {
    _logger.default.debug('Reset: running ios real device reset flow');
    if (!opts.noReset) {
      await resetRealDevice(device, opts);
    }
  } else {
    _logger.default.debug('Reset: fullReset not set. Leaving as is');
  }
}
async function installToRealDevice(device, app, bundleId, opts = {}) {
  if (!device.udid || !app) {
    _logger.default.debug('No device id or app, not installing to real device.');
    return;
  }
  const {
    noReset = false,
    strategy,
    timeout
  } = opts;
  if (await device.isAppInstalled(bundleId)) {
    if (noReset) {
      _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);
      return;
    }
    _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);
    await device.remove(bundleId);
  }
  _logger.default.debug(`Installing '${app}' on device with UUID '${device.udid}'...`);
  await device.install(app, timeout, strategy);
  _logger.default.debug('The app has been installed successfully.');
}
function getRealDeviceObj(udid) {
  _logger.default.debug(`Creating iDevice object with udid '${udid}'`);
  return new _iosDeploy.default(udid);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRDb25uZWN0ZWREZXZpY2VzIiwidXRpbGl0aWVzIiwiZ2V0T1NWZXJzaW9uIiwidWRpZCIsInJlc2V0UmVhbERldmljZSIsImRldmljZSIsIm9wdHMiLCJidW5kbGVJZCIsImZ1bGxSZXNldCIsIlNBRkFSSV9CVU5ETEVfSUQiLCJsb2ciLCJkZWJ1ZyIsInRlcm1pbmF0ZUFwcCIsImlzQXBwSW5zdGFsbGVkIiwicmVtb3ZlIiwiZXJyIiwiZXJyb3IiLCJtZXNzYWdlIiwicnVuUmVhbERldmljZVJlc2V0Iiwibm9SZXNldCIsImluc3RhbGxUb1JlYWxEZXZpY2UiLCJhcHAiLCJzdHJhdGVneSIsInRpbWVvdXQiLCJpbnN0YWxsIiwiZ2V0UmVhbERldmljZU9iaiIsIklPU0RlcGxveSJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9yZWFsLWRldmljZS1tYW5hZ2VtZW50LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHV0aWxpdGllcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCBJT1NEZXBsb3kgZnJvbSAnLi9pb3MtZGVwbG95JztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgU0FGQVJJX0JVTkRMRV9JRCB9IGZyb20gJy4vYXBwLXV0aWxzJztcblxuXG5hc3luYyBmdW5jdGlvbiBnZXRDb25uZWN0ZWREZXZpY2VzICgpIHtcbiAgcmV0dXJuIGF3YWl0IHV0aWxpdGllcy5nZXRDb25uZWN0ZWREZXZpY2VzKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE9TVmVyc2lvbiAodWRpZCkge1xuICByZXR1cm4gYXdhaXQgdXRpbGl0aWVzLmdldE9TVmVyc2lvbih1ZGlkKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVzZXRSZWFsRGV2aWNlIChkZXZpY2UsIG9wdHMpIHtcbiAgY29uc3QgeyBidW5kbGVJZCwgZnVsbFJlc2V0IH0gPSBvcHRzO1xuICBpZiAoIWJ1bmRsZUlkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKGJ1bmRsZUlkID09PSBTQUZBUklfQlVORExFX0lEKSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldCByZXF1ZXN0ZWQuIEFib3V0IHRvIHRlcm1pbmF0ZSBTYWZhcmknKTtcbiAgICBhd2FpdCBkZXZpY2UudGVybWluYXRlQXBwKGJ1bmRsZUlkKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIWZ1bGxSZXNldCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgUmVzZXQ6IGZ1bGxSZXNldCByZXF1ZXN0ZWQuIFdpbGwgdHJ5IHRvIHVuaW5zdGFsbCB0aGUgYXBwICcke2J1bmRsZUlkfScuYCk7XG4gIGlmICghYXdhaXQgZGV2aWNlLmlzQXBwSW5zdGFsbGVkKGJ1bmRsZUlkKSkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IGFwcCBub3QgaW5zdGFsbGVkLiBObyBuZWVkIHRvIHVuaW5zdGFsbCcpO1xuICAgIHJldHVybjtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IGRldmljZS5yZW1vdmUoYnVuZGxlSWQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3IoYFJlc2V0OiBjb3VsZCBub3QgcmVtb3ZlICcke2J1bmRsZUlkfScgZnJvbSBkZXZpY2U6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG4gIGxvZy5kZWJ1ZyhgUmVzZXQ6IHJlbW92ZWQgJyR7YnVuZGxlSWR9J2ApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5SZWFsRGV2aWNlUmVzZXQgKGRldmljZSwgb3B0cykge1xuICBpZiAoIW9wdHMubm9SZXNldCB8fCBvcHRzLmZ1bGxSZXNldCkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IHJ1bm5pbmcgaW9zIHJlYWwgZGV2aWNlIHJlc2V0IGZsb3cnKTtcbiAgICBpZiAoIW9wdHMubm9SZXNldCkge1xuICAgICAgYXdhaXQgcmVzZXRSZWFsRGV2aWNlKGRldmljZSwgb3B0cyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IGZ1bGxSZXNldCBub3Qgc2V0LiBMZWF2aW5nIGFzIGlzJyk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbFRvUmVhbERldmljZSAoZGV2aWNlLCBhcHAsIGJ1bmRsZUlkLCBvcHRzID0ge30pIHtcbiAgaWYgKCFkZXZpY2UudWRpZCB8fCAhYXBwKSB7XG4gICAgbG9nLmRlYnVnKCdObyBkZXZpY2UgaWQgb3IgYXBwLCBub3QgaW5zdGFsbGluZyB0byByZWFsIGRldmljZS4nKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7XG4gICAgbm9SZXNldCA9IGZhbHNlLFxuICAgIHN0cmF0ZWd5LFxuICAgIHRpbWVvdXQsXG4gIH0gPSBvcHRzO1xuXG4gIGlmIChhd2FpdCBkZXZpY2UuaXNBcHBJbnN0YWxsZWQoYnVuZGxlSWQpKSB7XG4gICAgaWYgKG5vUmVzZXQpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQXBwICcke2J1bmRsZUlkfScgaXMgYWxyZWFkeSBpbnN0YWxsZWQuIE5vIG5lZWQgdG8gcmVpbnN0YWxsLmApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFJlc2V0IHJlcXVlc3RlZC4gUmVtb3ZpbmcgYXBwIHdpdGggaWQgJyR7YnVuZGxlSWR9JyBmcm9tIHRoZSBkZXZpY2VgKTtcbiAgICBhd2FpdCBkZXZpY2UucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgfVxuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgJyR7YXBwfScgb24gZGV2aWNlIHdpdGggVVVJRCAnJHtkZXZpY2UudWRpZH0nLi4uYCk7XG4gIGF3YWl0IGRldmljZS5pbnN0YWxsKGFwcCwgdGltZW91dCwgc3RyYXRlZ3kpO1xuICBsb2cuZGVidWcoJ1RoZSBhcHAgaGFzIGJlZW4gaW5zdGFsbGVkIHN1Y2Nlc3NmdWxseS4nKTtcbn1cblxuZnVuY3Rpb24gZ2V0UmVhbERldmljZU9iaiAodWRpZCkge1xuICBsb2cuZGVidWcoYENyZWF0aW5nIGlEZXZpY2Ugb2JqZWN0IHdpdGggdWRpZCAnJHt1ZGlkfSdgKTtcbiAgcmV0dXJuIG5ldyBJT1NEZXBsb3kodWRpZCk7XG59XG5cbmV4cG9ydCB7IGdldENvbm5lY3RlZERldmljZXMsIGdldE9TVmVyc2lvbiwgcnVuUmVhbERldmljZVJlc2V0LCBpbnN0YWxsVG9SZWFsRGV2aWNlLFxuICBnZXRSZWFsRGV2aWNlT2JqIH07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBR0EsZUFBZUEsbUJBQW1CLEdBQUk7RUFDcEMsT0FBTyxNQUFNQywwQkFBUyxDQUFDRCxtQkFBbUIsRUFBRTtBQUM5QztBQUVBLGVBQWVFLFlBQVksQ0FBRUMsSUFBSSxFQUFFO0VBQ2pDLE9BQU8sTUFBTUYsMEJBQVMsQ0FBQ0MsWUFBWSxDQUFDQyxJQUFJLENBQUM7QUFDM0M7QUFFQSxlQUFlQyxlQUFlLENBQUVDLE1BQU0sRUFBRUMsSUFBSSxFQUFFO0VBQzVDLE1BQU07SUFBRUMsUUFBUTtJQUFFQztFQUFVLENBQUMsR0FBR0YsSUFBSTtFQUNwQyxJQUFJLENBQUNDLFFBQVEsRUFBRTtJQUNiO0VBQ0Y7RUFFQSxJQUFJQSxRQUFRLEtBQUtFLDBCQUFnQixFQUFFO0lBQ2pDQyxlQUFHLENBQUNDLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQztJQUN2RCxNQUFNTixNQUFNLENBQUNPLFlBQVksQ0FBQ0wsUUFBUSxDQUFDO0lBQ25DO0VBQ0Y7RUFFQSxJQUFJLENBQUNDLFNBQVMsRUFBRTtJQUNkO0VBQ0Y7RUFFQUUsZUFBRyxDQUFDQyxLQUFLLENBQUUsOERBQTZESixRQUFTLElBQUcsQ0FBQztFQUNyRixJQUFJLEVBQUMsTUFBTUYsTUFBTSxDQUFDUSxjQUFjLENBQUNOLFFBQVEsQ0FBQyxHQUFFO0lBQzFDRyxlQUFHLENBQUNDLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQztJQUMzRDtFQUNGO0VBQ0EsSUFBSTtJQUNGLE1BQU1OLE1BQU0sQ0FBQ1MsTUFBTSxDQUFDUCxRQUFRLENBQUM7RUFDL0IsQ0FBQyxDQUFDLE9BQU9RLEdBQUcsRUFBRTtJQUNaTCxlQUFHLENBQUNNLEtBQUssQ0FBRSw0QkFBMkJULFFBQVMsa0JBQWlCUSxHQUFHLENBQUNFLE9BQVEsRUFBQyxDQUFDO0lBQzlFLE1BQU1GLEdBQUc7RUFDWDtFQUNBTCxlQUFHLENBQUNDLEtBQUssQ0FBRSxtQkFBa0JKLFFBQVMsR0FBRSxDQUFDO0FBQzNDO0FBRUEsZUFBZVcsa0JBQWtCLENBQUViLE1BQU0sRUFBRUMsSUFBSSxFQUFFO0VBQy9DLElBQUksQ0FBQ0EsSUFBSSxDQUFDYSxPQUFPLElBQUliLElBQUksQ0FBQ0UsU0FBUyxFQUFFO0lBQ25DRSxlQUFHLENBQUNDLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQztJQUN0RCxJQUFJLENBQUNMLElBQUksQ0FBQ2EsT0FBTyxFQUFFO01BQ2pCLE1BQU1mLGVBQWUsQ0FBQ0MsTUFBTSxFQUFFQyxJQUFJLENBQUM7SUFDckM7RUFDRixDQUFDLE1BQU07SUFDTEksZUFBRyxDQUFDQyxLQUFLLENBQUMseUNBQXlDLENBQUM7RUFDdEQ7QUFDRjtBQUVBLGVBQWVTLG1CQUFtQixDQUFFZixNQUFNLEVBQUVnQixHQUFHLEVBQUVkLFFBQVEsRUFBRUQsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ3BFLElBQUksQ0FBQ0QsTUFBTSxDQUFDRixJQUFJLElBQUksQ0FBQ2tCLEdBQUcsRUFBRTtJQUN4QlgsZUFBRyxDQUFDQyxLQUFLLENBQUMscURBQXFELENBQUM7SUFDaEU7RUFDRjtFQUVBLE1BQU07SUFDSlEsT0FBTyxHQUFHLEtBQUs7SUFDZkcsUUFBUTtJQUNSQztFQUNGLENBQUMsR0FBR2pCLElBQUk7RUFFUixJQUFJLE1BQU1ELE1BQU0sQ0FBQ1EsY0FBYyxDQUFDTixRQUFRLENBQUMsRUFBRTtJQUN6QyxJQUFJWSxPQUFPLEVBQUU7TUFDWFQsZUFBRyxDQUFDQyxLQUFLLENBQUUsUUFBT0osUUFBUywrQ0FBOEMsQ0FBQztNQUMxRTtJQUNGO0lBQ0FHLGVBQUcsQ0FBQ0MsS0FBSyxDQUFFLDBDQUF5Q0osUUFBUyxtQkFBa0IsQ0FBQztJQUNoRixNQUFNRixNQUFNLENBQUNTLE1BQU0sQ0FBQ1AsUUFBUSxDQUFDO0VBQy9CO0VBQ0FHLGVBQUcsQ0FBQ0MsS0FBSyxDQUFFLGVBQWNVLEdBQUksMEJBQXlCaEIsTUFBTSxDQUFDRixJQUFLLE1BQUssQ0FBQztFQUN4RSxNQUFNRSxNQUFNLENBQUNtQixPQUFPLENBQUNILEdBQUcsRUFBRUUsT0FBTyxFQUFFRCxRQUFRLENBQUM7RUFDNUNaLGVBQUcsQ0FBQ0MsS0FBSyxDQUFDLDBDQUEwQyxDQUFDO0FBQ3ZEO0FBRUEsU0FBU2MsZ0JBQWdCLENBQUV0QixJQUFJLEVBQUU7RUFDL0JPLGVBQUcsQ0FBQ0MsS0FBSyxDQUFFLHNDQUFxQ1IsSUFBSyxHQUFFLENBQUM7RUFDeEQsT0FBTyxJQUFJdUIsa0JBQVMsQ0FBQ3ZCLElBQUksQ0FBQztBQUM1QiJ9