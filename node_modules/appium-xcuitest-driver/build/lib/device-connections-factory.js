"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.DeviceConnectionsFactory = exports.DEVICE_CONNECTIONS_FACTORY = void 0;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _net = _interopRequireDefault(require("net"));
var _bluebird = _interopRequireDefault(require("bluebird"));
var _support = require("appium/support");
var _appiumIosDevice = require("appium-ios-device");
var _portscanner = require("portscanner");
var _asyncbox = require("asyncbox");
const LOCALHOST = '127.0.0.1';
class iProxy {
  constructor(udid, localport, deviceport) {
    this.localport = parseInt(localport, 10);
    this.deviceport = parseInt(deviceport, 10);
    this.udid = udid;
    this.localServer = null;
    this.log = _support.logger.getLogger(`iProxy@${udid.substring(0, 8)}:${this.localport}`);
  }
  async start() {
    if (this.localServer) {
      return;
    }
    this.localServer = _net.default.createServer(async localSocket => {
      let remoteSocket;
      try {
        remoteSocket = await _appiumIosDevice.utilities.connectPort(this.udid, this.deviceport);
      } catch (e) {
        this.log.debug(e.message);
        localSocket.destroy();
        return;
      }
      const destroyCommChannel = () => {
        remoteSocket.unpipe(localSocket);
        localSocket.unpipe(remoteSocket);
      };
      remoteSocket.once('close', () => {
        destroyCommChannel();
        localSocket.destroy();
      });
      remoteSocket.on('error', e => this.log.debug(e));
      localSocket.once('end', destroyCommChannel);
      localSocket.once('close', () => {
        destroyCommChannel();
        remoteSocket.destroy();
      });
      localSocket.on('error', e => this.log.warn(e.message));
      localSocket.pipe(remoteSocket);
      remoteSocket.pipe(localSocket);
    });
    const listeningPromise = new _bluebird.default((resolve, reject) => {
      this.localServer.once('listening', resolve);
      this.localServer.once('error', reject);
    });
    this.localServer.listen(this.localport);
    try {
      await listeningPromise;
    } catch (e) {
      this.localServer = null;
      throw e;
    }
    this.localServer.on('error', e => this.log.warn(e.message));
    this.localServer.once('close', e => {
      if (e) {
        this.log.info(`The connection has been closed with error ${e.message}`);
      } else {
        this.log.info(`The connection has been closed`);
      }
      this.localServer = null;
    });
    this.onBeforeProcessExit = this._closeLocalServer.bind(this);
    process.on('beforeExit', this.onBeforeProcessExit);
  }
  _closeLocalServer() {
    if (!this.localServer) {
      return;
    }
    this.log.debug(`Closing the connection`);
    this.localServer.close();
    this.localServer = null;
  }
  stop() {
    if (this.onBeforeProcessExit) {
      process.off('beforeExit', this.onBeforeProcessExit);
      this.onBeforeProcessExit = null;
    }
    this._closeLocalServer();
  }
}
const log = _support.logger.getLogger('DevCon Factory');
const PORT_CLOSE_TIMEOUT = 15 * 1000;
const SPLITTER = ':';
class DeviceConnectionsFactory {
  constructor() {
    this._connectionsMapping = {};
  }
  _udidAsToken(udid) {
    return `${_support.util.hasValue(udid) ? udid : ''}${SPLITTER}`;
  }
  _portAsToken(port) {
    return `${SPLITTER}${_support.util.hasValue(port) ? port : ''}`;
  }
  _toKey(udid = null, port = null) {
    return `${_support.util.hasValue(udid) ? udid : ''}${SPLITTER}${_support.util.hasValue(port) ? port : ''}`;
  }
  _releaseProxiedConnections(connectionKeys) {
    const keys = connectionKeys.filter(k => _lodash.default.has(this._connectionsMapping[k], 'iproxy'));
    for (const key of keys) {
      log.info(`Releasing the listener for '${key}'`);
      try {
        this._connectionsMapping[key].iproxy.stop();
      } catch (e) {
        log.debug(e);
      }
    }
    return keys;
  }
  listConnections(udid = null, port = null, strict = false) {
    if (!udid && !port) {
      return [];
    }
    return _lodash.default.keys(this._connectionsMapping).filter(key => strict && udid && port ? key === this._toKey(udid, port) : udid && key.startsWith(this._udidAsToken(udid)) || port && key.endsWith(this._portAsToken(port)));
  }
  async requestConnection(udid, port, options = {}) {
    if (!udid || !port) {
      log.warn('Did not know how to request the connection:');
      if (!udid) {
        log.warn('- Device UDID is unset');
      }
      if (!port) {
        log.warn('- The local port number is unset');
      }
      return;
    }
    const {
      usePortForwarding,
      devicePort
    } = options;
    log.info(`Requesting connection for device ${udid} on local port ${port}` + (devicePort ? `, device port ${devicePort}` : ''));
    log.debug(`Cached connections count: ${_lodash.default.size(this._connectionsMapping)}`);
    const connectionsOnPort = this.listConnections(null, port);
    if (!_lodash.default.isEmpty(connectionsOnPort)) {
      log.info(`Found cached connections on port #${port}: ${JSON.stringify(connectionsOnPort)}`);
    }
    if (usePortForwarding) {
      let isPortBusy = (await (0, _portscanner.checkPortStatus)(port, LOCALHOST)) === 'open';
      if (isPortBusy) {
        log.warn(`Port #${port} is busy. Did you quit the previous driver session(s) properly?`);
        if (!_lodash.default.isEmpty(connectionsOnPort)) {
          log.info('Trying to release the port');
          for (const key of this._releaseProxiedConnections(connectionsOnPort)) {
            delete this._connectionsMapping[key];
          }
          const timer = new _support.timing.Timer().start();
          try {
            await (0, _asyncbox.waitForCondition)(async () => {
              try {
                if ((await (0, _portscanner.checkPortStatus)(port, LOCALHOST)) !== 'open') {
                  log.info(`Port #${port} has been successfully released after ` + `${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
                  isPortBusy = false;
                  return true;
                }
              } catch (ign) {}
              return false;
            }, {
              waitMs: PORT_CLOSE_TIMEOUT,
              intervalMs: 300
            });
          } catch (ign) {
            log.warn(`Did not know how to release port #${port} in ` + `${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
          }
        }
      }
      if (isPortBusy) {
        throw new Error(`The port #${port} is occupied by an other process. ` + `You can either quit that process or select another free port.`);
      }
    }
    const currentKey = this._toKey(udid, port);
    if (usePortForwarding) {
      const iproxy = new iProxy(udid, port, devicePort);
      try {
        await iproxy.start();
        this._connectionsMapping[currentKey] = {
          iproxy
        };
      } catch (e) {
        try {
          iproxy.stop();
        } catch (e1) {
          log.debug(e1);
        }
        throw e;
      }
    } else {
      this._connectionsMapping[currentKey] = {};
    }
    log.info(`Successfully requested the connection for ${currentKey}`);
  }
  releaseConnection(udid = null, port = null) {
    if (!udid && !port) {
      log.warn('Neither device UDID nor local port is set. ' + 'Did not know how to release the connection');
      return;
    }
    log.info(`Releasing connections for ${udid || 'any'} device on ${port || 'any'} port number`);
    const keys = this.listConnections(udid, port, true);
    if (_lodash.default.isEmpty(keys)) {
      log.info('No cached connections have been found');
      return;
    }
    log.info(`Found cached connections to release: ${JSON.stringify(keys)}`);
    this._releaseProxiedConnections(keys);
    for (const key of keys) {
      delete this._connectionsMapping[key];
    }
    log.debug(`Cached connections count: ${_lodash.default.size(this._connectionsMapping)}`);
  }
}
exports.DeviceConnectionsFactory = DeviceConnectionsFactory;
const DEVICE_CONNECTIONS_FACTORY = new DeviceConnectionsFactory();
exports.DEVICE_CONNECTIONS_FACTORY = DEVICE_CONNECTIONS_FACTORY;
var _default = DEVICE_CONNECTIONS_FACTORY;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJMT0NBTEhPU1QiLCJpUHJveHkiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJsb2NhbHBvcnQiLCJkZXZpY2Vwb3J0IiwicGFyc2VJbnQiLCJsb2NhbFNlcnZlciIsImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsInN1YnN0cmluZyIsInN0YXJ0IiwibmV0IiwiY3JlYXRlU2VydmVyIiwibG9jYWxTb2NrZXQiLCJyZW1vdGVTb2NrZXQiLCJ1dGlsaXRpZXMiLCJjb25uZWN0UG9ydCIsImUiLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJkZXN0cm95IiwiZGVzdHJveUNvbW1DaGFubmVsIiwidW5waXBlIiwib25jZSIsIm9uIiwid2FybiIsInBpcGUiLCJsaXN0ZW5pbmdQcm9taXNlIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJsaXN0ZW4iLCJpbmZvIiwib25CZWZvcmVQcm9jZXNzRXhpdCIsIl9jbG9zZUxvY2FsU2VydmVyIiwiYmluZCIsInByb2Nlc3MiLCJjbG9zZSIsInN0b3AiLCJvZmYiLCJQT1JUX0NMT1NFX1RJTUVPVVQiLCJTUExJVFRFUiIsIkRldmljZUNvbm5lY3Rpb25zRmFjdG9yeSIsIl9jb25uZWN0aW9uc01hcHBpbmciLCJfdWRpZEFzVG9rZW4iLCJ1dGlsIiwiaGFzVmFsdWUiLCJfcG9ydEFzVG9rZW4iLCJwb3J0IiwiX3RvS2V5IiwiX3JlbGVhc2VQcm94aWVkQ29ubmVjdGlvbnMiLCJjb25uZWN0aW9uS2V5cyIsImtleXMiLCJmaWx0ZXIiLCJrIiwiXyIsImhhcyIsImtleSIsImlwcm94eSIsImxpc3RDb25uZWN0aW9ucyIsInN0cmljdCIsInN0YXJ0c1dpdGgiLCJlbmRzV2l0aCIsInJlcXVlc3RDb25uZWN0aW9uIiwib3B0aW9ucyIsInVzZVBvcnRGb3J3YXJkaW5nIiwiZGV2aWNlUG9ydCIsInNpemUiLCJjb25uZWN0aW9uc09uUG9ydCIsImlzRW1wdHkiLCJKU09OIiwic3RyaW5naWZ5IiwiaXNQb3J0QnVzeSIsImNoZWNrUG9ydFN0YXR1cyIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJ3YWl0Rm9yQ29uZGl0aW9uIiwiZ2V0RHVyYXRpb24iLCJhc01pbGxpU2Vjb25kcyIsInRvRml4ZWQiLCJpZ24iLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwiRXJyb3IiLCJjdXJyZW50S2V5IiwiZTEiLCJyZWxlYXNlQ29ubmVjdGlvbiIsIkRFVklDRV9DT05ORUNUSU9OU19GQUNUT1JZIl0sInNvdXJjZXMiOlsiLi4vLi4vbGliL2RldmljZS1jb25uZWN0aW9ucy1mYWN0b3J5LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBsb2dnZXIsIHV0aWwsIHRpbWluZyB9IGZyb20gJ2FwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IHV0aWxpdGllcyB9IGZyb20gJ2FwcGl1bS1pb3MtZGV2aWNlJztcbmltcG9ydCB7IGNoZWNrUG9ydFN0YXR1cyB9IGZyb20gJ3BvcnRzY2FubmVyJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5cblxuY29uc3QgTE9DQUxIT1NUID0gJzEyNy4wLjAuMSc7XG5cbmNsYXNzIGlQcm94eSB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCBsb2NhbHBvcnQsIGRldmljZXBvcnQpIHtcbiAgICB0aGlzLmxvY2FscG9ydCA9IHBhcnNlSW50KGxvY2FscG9ydCwgMTApO1xuICAgIHRoaXMuZGV2aWNlcG9ydCA9IHBhcnNlSW50KGRldmljZXBvcnQsIDEwKTtcbiAgICB0aGlzLnVkaWQgPSB1ZGlkO1xuICAgIHRoaXMubG9jYWxTZXJ2ZXIgPSBudWxsO1xuICAgIHRoaXMubG9nID0gbG9nZ2VyLmdldExvZ2dlcihgaVByb3h5QCR7dWRpZC5zdWJzdHJpbmcoMCwgOCl9OiR7dGhpcy5sb2NhbHBvcnR9YCk7XG4gIH1cblxuICBhc3luYyBzdGFydCAoKSB7XG4gICAgaWYgKHRoaXMubG9jYWxTZXJ2ZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmxvY2FsU2VydmVyID0gbmV0LmNyZWF0ZVNlcnZlcihhc3luYyAobG9jYWxTb2NrZXQpID0+IHtcbiAgICAgIGxldCByZW1vdGVTb2NrZXQ7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBXZSBjYW4gb25seSBjb25uZWN0IHRvIHRoZSByZW1vdGUgc29ja2V0IGFmdGVyIHRoZSBsb2NhbCBzb2NrZXQgY29ubmVjdGlvbiBzdWNjZWVkc1xuICAgICAgICByZW1vdGVTb2NrZXQgPSBhd2FpdCB1dGlsaXRpZXMuY29ubmVjdFBvcnQodGhpcy51ZGlkLCB0aGlzLmRldmljZXBvcnQpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aGlzLmxvZy5kZWJ1ZyhlLm1lc3NhZ2UpO1xuICAgICAgICBsb2NhbFNvY2tldC5kZXN0cm95KCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGVzdHJveUNvbW1DaGFubmVsID0gKCkgPT4ge1xuICAgICAgICByZW1vdGVTb2NrZXQudW5waXBlKGxvY2FsU29ja2V0KTtcbiAgICAgICAgbG9jYWxTb2NrZXQudW5waXBlKHJlbW90ZVNvY2tldCk7XG4gICAgICB9O1xuICAgICAgcmVtb3RlU29ja2V0Lm9uY2UoJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBkZXN0cm95Q29tbUNoYW5uZWwoKTtcbiAgICAgICAgbG9jYWxTb2NrZXQuZGVzdHJveSgpO1xuICAgICAgfSk7XG4gICAgICAvLyBub3QgYWxsIHJlbW90ZSBzb2NrZXQgZXJyb3JzIGFyZSBjcml0aWNhbCBmb3IgdGhlIHVzZXJcbiAgICAgIHJlbW90ZVNvY2tldC5vbignZXJyb3InLCAoZSkgPT4gdGhpcy5sb2cuZGVidWcoZSkpO1xuICAgICAgbG9jYWxTb2NrZXQub25jZSgnZW5kJywgZGVzdHJveUNvbW1DaGFubmVsKTtcbiAgICAgIGxvY2FsU29ja2V0Lm9uY2UoJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBkZXN0cm95Q29tbUNoYW5uZWwoKTtcbiAgICAgICAgcmVtb3RlU29ja2V0LmRlc3Ryb3koKTtcbiAgICAgIH0pO1xuICAgICAgbG9jYWxTb2NrZXQub24oJ2Vycm9yJywgKGUpID0+IHRoaXMubG9nLndhcm4oZS5tZXNzYWdlKSk7XG4gICAgICBsb2NhbFNvY2tldC5waXBlKHJlbW90ZVNvY2tldCk7XG4gICAgICByZW1vdGVTb2NrZXQucGlwZShsb2NhbFNvY2tldCk7XG4gICAgfSk7XG4gICAgY29uc3QgbGlzdGVuaW5nUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMubG9jYWxTZXJ2ZXIub25jZSgnbGlzdGVuaW5nJywgcmVzb2x2ZSk7XG4gICAgICB0aGlzLmxvY2FsU2VydmVyLm9uY2UoJ2Vycm9yJywgcmVqZWN0KTtcbiAgICB9KTtcbiAgICB0aGlzLmxvY2FsU2VydmVyLmxpc3Rlbih0aGlzLmxvY2FscG9ydCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGxpc3RlbmluZ1Byb21pc2U7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5sb2NhbFNlcnZlciA9IG51bGw7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgICB0aGlzLmxvY2FsU2VydmVyLm9uKCdlcnJvcicsIChlKSA9PiB0aGlzLmxvZy53YXJuKGUubWVzc2FnZSkpO1xuICAgIHRoaXMubG9jYWxTZXJ2ZXIub25jZSgnY2xvc2UnLCAoZSkgPT4ge1xuICAgICAgaWYgKGUpIHtcbiAgICAgICAgdGhpcy5sb2cuaW5mbyhgVGhlIGNvbm5lY3Rpb24gaGFzIGJlZW4gY2xvc2VkIHdpdGggZXJyb3IgJHtlLm1lc3NhZ2V9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxvZy5pbmZvKGBUaGUgY29ubmVjdGlvbiBoYXMgYmVlbiBjbG9zZWRgKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9jYWxTZXJ2ZXIgPSBudWxsO1xuICAgIH0pO1xuXG4gICAgdGhpcy5vbkJlZm9yZVByb2Nlc3NFeGl0ID0gdGhpcy5fY2xvc2VMb2NhbFNlcnZlci5iaW5kKHRoaXMpO1xuICAgIC8vIE1ha2Ugc3VyZSB3ZSBmcmVlIHVwIHRoZSBzb2NrZXQgb24gcHJvY2VzcyBleGl0XG4gICAgcHJvY2Vzcy5vbignYmVmb3JlRXhpdCcsIHRoaXMub25CZWZvcmVQcm9jZXNzRXhpdCk7XG4gIH1cblxuICBfY2xvc2VMb2NhbFNlcnZlciAoKSB7XG4gICAgaWYgKCF0aGlzLmxvY2FsU2VydmVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5sb2cuZGVidWcoYENsb3NpbmcgdGhlIGNvbm5lY3Rpb25gKTtcbiAgICB0aGlzLmxvY2FsU2VydmVyLmNsb3NlKCk7XG4gICAgdGhpcy5sb2NhbFNlcnZlciA9IG51bGw7XG4gIH1cblxuICBzdG9wICgpIHtcbiAgICBpZiAodGhpcy5vbkJlZm9yZVByb2Nlc3NFeGl0KSB7XG4gICAgICBwcm9jZXNzLm9mZignYmVmb3JlRXhpdCcsIHRoaXMub25CZWZvcmVQcm9jZXNzRXhpdCk7XG4gICAgICB0aGlzLm9uQmVmb3JlUHJvY2Vzc0V4aXQgPSBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuX2Nsb3NlTG9jYWxTZXJ2ZXIoKTtcbiAgfVxufVxuXG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0RldkNvbiBGYWN0b3J5Jyk7XG5jb25zdCBQT1JUX0NMT1NFX1RJTUVPVVQgPSAxNSAqIDEwMDA7IC8vIDE1IHNlY29uZHNcbmNvbnN0IFNQTElUVEVSID0gJzonO1xuXG5jbGFzcyBEZXZpY2VDb25uZWN0aW9uc0ZhY3Rvcnkge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5fY29ubmVjdGlvbnNNYXBwaW5nID0ge307XG4gIH1cblxuICBfdWRpZEFzVG9rZW4gKHVkaWQpIHtcbiAgICByZXR1cm4gYCR7dXRpbC5oYXNWYWx1ZSh1ZGlkKSA/IHVkaWQgOiAnJ30ke1NQTElUVEVSfWA7XG4gIH1cblxuICBfcG9ydEFzVG9rZW4gKHBvcnQpIHtcbiAgICByZXR1cm4gYCR7U1BMSVRURVJ9JHt1dGlsLmhhc1ZhbHVlKHBvcnQpID8gcG9ydCA6ICcnfWA7XG4gIH1cblxuICBfdG9LZXkgKHVkaWQgPSBudWxsLCBwb3J0ID0gbnVsbCkge1xuICAgIHJldHVybiBgJHt1dGlsLmhhc1ZhbHVlKHVkaWQpID8gdWRpZCA6ICcnfSR7U1BMSVRURVJ9JHt1dGlsLmhhc1ZhbHVlKHBvcnQpID8gcG9ydCA6ICcnfWA7XG4gIH1cblxuICBfcmVsZWFzZVByb3hpZWRDb25uZWN0aW9ucyAoY29ubmVjdGlvbktleXMpIHtcbiAgICBjb25zdCBrZXlzID0gY29ubmVjdGlvbktleXNcbiAgICAgIC5maWx0ZXIoKGspID0+IF8uaGFzKHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZ1trXSwgJ2lwcm94eScpKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICBsb2cuaW5mbyhgUmVsZWFzaW5nIHRoZSBsaXN0ZW5lciBmb3IgJyR7a2V5fSdgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZ1trZXldLmlwcm94eS5zdG9wKCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGtleXM7XG4gIH1cblxuICBsaXN0Q29ubmVjdGlvbnMgKHVkaWQgPSBudWxsLCBwb3J0ID0gbnVsbCwgc3RyaWN0ID0gZmFsc2UpIHtcbiAgICBpZiAoIXVkaWQgJiYgIXBvcnQpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvLyBgdGhpcy5fY29ubmVjdGlvbk1hcHBpbmdgIGtleXMgaGF2ZSBmb3JtYXQgYHVkaWQ6cG9ydGBcbiAgICAvLyB0aGUgYHN0cmljdGAgYXJndW1lbnQgZW5mb3JjZXMgdG8gbWF0Y2gga2V5cyBoYXZpbmcgYm90aCBgdWRpZGAgYW5kIGBwb3J0YFxuICAgIC8vIGlmIHRoZXkgYXJlIGRlZmluZWRcbiAgICAvLyB3aGlsZSBpbiBub24tc3RyaWN0IG1vZGUga2V5cyBoYXZpbmcgYW55IG9mIHRoZXNlIGFyZSBnb2luZyB0byBiZSBtYXRjaGVkXG4gICAgcmV0dXJuIF8ua2V5cyh0aGlzLl9jb25uZWN0aW9uc01hcHBpbmcpXG4gICAgICAuZmlsdGVyKChrZXkpID0+IChzdHJpY3QgJiYgdWRpZCAmJiBwb3J0KVxuICAgICAgICA/IChrZXkgPT09IHRoaXMuX3RvS2V5KHVkaWQsIHBvcnQpKVxuICAgICAgICA6ICh1ZGlkICYmIGtleS5zdGFydHNXaXRoKHRoaXMuX3VkaWRBc1Rva2VuKHVkaWQpKSB8fCBwb3J0ICYmIGtleS5lbmRzV2l0aCh0aGlzLl9wb3J0QXNUb2tlbihwb3J0KSkpXG4gICAgICApO1xuICB9XG5cbiAgYXN5bmMgcmVxdWVzdENvbm5lY3Rpb24gKHVkaWQsIHBvcnQsIG9wdGlvbnMgPSB7fSkge1xuICAgIGlmICghdWRpZCB8fCAhcG9ydCkge1xuICAgICAgbG9nLndhcm4oJ0RpZCBub3Qga25vdyBob3cgdG8gcmVxdWVzdCB0aGUgY29ubmVjdGlvbjonKTtcbiAgICAgIGlmICghdWRpZCkge1xuICAgICAgICBsb2cud2FybignLSBEZXZpY2UgVURJRCBpcyB1bnNldCcpO1xuICAgICAgfVxuICAgICAgaWYgKCFwb3J0KSB7XG4gICAgICAgIGxvZy53YXJuKCctIFRoZSBsb2NhbCBwb3J0IG51bWJlciBpcyB1bnNldCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIHVzZVBvcnRGb3J3YXJkaW5nLFxuICAgICAgZGV2aWNlUG9ydCxcbiAgICB9ID0gb3B0aW9ucztcblxuICAgIGxvZy5pbmZvKGBSZXF1ZXN0aW5nIGNvbm5lY3Rpb24gZm9yIGRldmljZSAke3VkaWR9IG9uIGxvY2FsIHBvcnQgJHtwb3J0fWAgK1xuICAgICAgKGRldmljZVBvcnQgPyBgLCBkZXZpY2UgcG9ydCAke2RldmljZVBvcnR9YCA6ICcnKSk7XG4gICAgbG9nLmRlYnVnKGBDYWNoZWQgY29ubmVjdGlvbnMgY291bnQ6ICR7Xy5zaXplKHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZyl9YCk7XG4gICAgY29uc3QgY29ubmVjdGlvbnNPblBvcnQgPSB0aGlzLmxpc3RDb25uZWN0aW9ucyhudWxsLCBwb3J0KTtcbiAgICBpZiAoIV8uaXNFbXB0eShjb25uZWN0aW9uc09uUG9ydCkpIHtcbiAgICAgIGxvZy5pbmZvKGBGb3VuZCBjYWNoZWQgY29ubmVjdGlvbnMgb24gcG9ydCAjJHtwb3J0fTogJHtKU09OLnN0cmluZ2lmeShjb25uZWN0aW9uc09uUG9ydCl9YCk7XG4gICAgfVxuXG4gICAgaWYgKHVzZVBvcnRGb3J3YXJkaW5nKSB7XG4gICAgICBsZXQgaXNQb3J0QnVzeSA9IChhd2FpdCBjaGVja1BvcnRTdGF0dXMocG9ydCwgTE9DQUxIT1NUKSkgPT09ICdvcGVuJztcbiAgICAgIGlmIChpc1BvcnRCdXN5KSB7XG4gICAgICAgIGxvZy53YXJuKGBQb3J0ICMke3BvcnR9IGlzIGJ1c3kuIERpZCB5b3UgcXVpdCB0aGUgcHJldmlvdXMgZHJpdmVyIHNlc3Npb24ocykgcHJvcGVybHk/YCk7XG4gICAgICAgIGlmICghXy5pc0VtcHR5KGNvbm5lY3Rpb25zT25Qb3J0KSkge1xuICAgICAgICAgIGxvZy5pbmZvKCdUcnlpbmcgdG8gcmVsZWFzZSB0aGUgcG9ydCcpO1xuICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHRoaXMuX3JlbGVhc2VQcm94aWVkQ29ubmVjdGlvbnMoY29ubmVjdGlvbnNPblBvcnQpKSB7XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5fY29ubmVjdGlvbnNNYXBwaW5nW2tleV07XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGlmICgoYXdhaXQgY2hlY2tQb3J0U3RhdHVzKHBvcnQsIExPQ0FMSE9TVCkpICE9PSAnb3BlbicpIHtcbiAgICAgICAgICAgICAgICAgIGxvZy5pbmZvKGBQb3J0ICMke3BvcnR9IGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSByZWxlYXNlZCBhZnRlciBgICtcbiAgICAgICAgICAgICAgICAgICAgYCR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcy50b0ZpeGVkKDApfW1zYCk7XG4gICAgICAgICAgICAgICAgICBpc1BvcnRCdXN5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSwge1xuICAgICAgICAgICAgICB3YWl0TXM6IFBPUlRfQ0xPU0VfVElNRU9VVCxcbiAgICAgICAgICAgICAgaW50ZXJ2YWxNczogMzAwLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAgICAgICBsb2cud2FybihgRGlkIG5vdCBrbm93IGhvdyB0byByZWxlYXNlIHBvcnQgIyR7cG9ydH0gaW4gYCArXG4gICAgICAgICAgICAgIGAke3RpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoaXNQb3J0QnVzeSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBwb3J0ICMke3BvcnR9IGlzIG9jY3VwaWVkIGJ5IGFuIG90aGVyIHByb2Nlc3MuIGAgK1xuICAgICAgICAgIGBZb3UgY2FuIGVpdGhlciBxdWl0IHRoYXQgcHJvY2VzcyBvciBzZWxlY3QgYW5vdGhlciBmcmVlIHBvcnQuYCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGN1cnJlbnRLZXkgPSB0aGlzLl90b0tleSh1ZGlkLCBwb3J0KTtcbiAgICBpZiAodXNlUG9ydEZvcndhcmRpbmcpIHtcbiAgICAgIGNvbnN0IGlwcm94eSA9IG5ldyBpUHJveHkodWRpZCwgcG9ydCwgZGV2aWNlUG9ydCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBpcHJveHkuc3RhcnQoKTtcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvbnNNYXBwaW5nW2N1cnJlbnRLZXldID0ge2lwcm94eX07XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgaXByb3h5LnN0b3AoKTtcbiAgICAgICAgfSBjYXRjaCAoZTEpIHtcbiAgICAgICAgICBsb2cuZGVidWcoZTEpO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZ1tjdXJyZW50S2V5XSA9IHt9O1xuICAgIH1cbiAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IHJlcXVlc3RlZCB0aGUgY29ubmVjdGlvbiBmb3IgJHtjdXJyZW50S2V5fWApO1xuICB9XG5cbiAgcmVsZWFzZUNvbm5lY3Rpb24gKHVkaWQgPSBudWxsLCBwb3J0ID0gbnVsbCkge1xuICAgIGlmICghdWRpZCAmJiAhcG9ydCkge1xuICAgICAgbG9nLndhcm4oJ05laXRoZXIgZGV2aWNlIFVESUQgbm9yIGxvY2FsIHBvcnQgaXMgc2V0LiAnICtcbiAgICAgICAgJ0RpZCBub3Qga25vdyBob3cgdG8gcmVsZWFzZSB0aGUgY29ubmVjdGlvbicpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgUmVsZWFzaW5nIGNvbm5lY3Rpb25zIGZvciAke3VkaWQgfHwgJ2FueSd9IGRldmljZSBvbiAke3BvcnQgfHwgJ2FueSd9IHBvcnQgbnVtYmVyYCk7XG5cbiAgICBjb25zdCBrZXlzID0gdGhpcy5saXN0Q29ubmVjdGlvbnModWRpZCwgcG9ydCwgdHJ1ZSk7XG4gICAgaWYgKF8uaXNFbXB0eShrZXlzKSkge1xuICAgICAgbG9nLmluZm8oJ05vIGNhY2hlZCBjb25uZWN0aW9ucyBoYXZlIGJlZW4gZm91bmQnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmluZm8oYEZvdW5kIGNhY2hlZCBjb25uZWN0aW9ucyB0byByZWxlYXNlOiAke0pTT04uc3RyaW5naWZ5KGtleXMpfWApO1xuICAgIHRoaXMuX3JlbGVhc2VQcm94aWVkQ29ubmVjdGlvbnMoa2V5cyk7XG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgZGVsZXRlIHRoaXMuX2Nvbm5lY3Rpb25zTWFwcGluZ1trZXldO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYENhY2hlZCBjb25uZWN0aW9ucyBjb3VudDogJHtfLnNpemUodGhpcy5fY29ubmVjdGlvbnNNYXBwaW5nKX1gKTtcbiAgfVxufVxuXG5jb25zdCBERVZJQ0VfQ09OTkVDVElPTlNfRkFDVE9SWSA9IG5ldyBEZXZpY2VDb25uZWN0aW9uc0ZhY3RvcnkoKTtcblxuZXhwb3J0IHsgREVWSUNFX0NPTk5FQ1RJT05TX0ZBQ1RPUlksIERldmljZUNvbm5lY3Rpb25zRmFjdG9yeSB9O1xuZXhwb3J0IGRlZmF1bHQgREVWSUNFX0NPTk5FQ1RJT05TX0ZBQ1RPUlk7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFHQSxNQUFNQSxTQUFTLEdBQUcsV0FBVztBQUU3QixNQUFNQyxNQUFNLENBQUM7RUFDWEMsV0FBVyxDQUFFQyxJQUFJLEVBQUVDLFNBQVMsRUFBRUMsVUFBVSxFQUFFO0lBQ3hDLElBQUksQ0FBQ0QsU0FBUyxHQUFHRSxRQUFRLENBQUNGLFNBQVMsRUFBRSxFQUFFLENBQUM7SUFDeEMsSUFBSSxDQUFDQyxVQUFVLEdBQUdDLFFBQVEsQ0FBQ0QsVUFBVSxFQUFFLEVBQUUsQ0FBQztJQUMxQyxJQUFJLENBQUNGLElBQUksR0FBR0EsSUFBSTtJQUNoQixJQUFJLENBQUNJLFdBQVcsR0FBRyxJQUFJO0lBQ3ZCLElBQUksQ0FBQ0MsR0FBRyxHQUFHQyxlQUFNLENBQUNDLFNBQVMsQ0FBRSxVQUFTUCxJQUFJLENBQUNRLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFFLElBQUcsSUFBSSxDQUFDUCxTQUFVLEVBQUMsQ0FBQztFQUNqRjtFQUVBLE1BQU1RLEtBQUssR0FBSTtJQUNiLElBQUksSUFBSSxDQUFDTCxXQUFXLEVBQUU7TUFDcEI7SUFDRjtJQUVBLElBQUksQ0FBQ0EsV0FBVyxHQUFHTSxZQUFHLENBQUNDLFlBQVksQ0FBQyxNQUFPQyxXQUFXLElBQUs7TUFDekQsSUFBSUMsWUFBWTtNQUNoQixJQUFJO1FBRUZBLFlBQVksR0FBRyxNQUFNQywwQkFBUyxDQUFDQyxXQUFXLENBQUMsSUFBSSxDQUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDRSxVQUFVLENBQUM7TUFDeEUsQ0FBQyxDQUFDLE9BQU9jLENBQUMsRUFBRTtRQUNWLElBQUksQ0FBQ1gsR0FBRyxDQUFDWSxLQUFLLENBQUNELENBQUMsQ0FBQ0UsT0FBTyxDQUFDO1FBQ3pCTixXQUFXLENBQUNPLE9BQU8sRUFBRTtRQUNyQjtNQUNGO01BRUEsTUFBTUMsa0JBQWtCLEdBQUcsTUFBTTtRQUMvQlAsWUFBWSxDQUFDUSxNQUFNLENBQUNULFdBQVcsQ0FBQztRQUNoQ0EsV0FBVyxDQUFDUyxNQUFNLENBQUNSLFlBQVksQ0FBQztNQUNsQyxDQUFDO01BQ0RBLFlBQVksQ0FBQ1MsSUFBSSxDQUFDLE9BQU8sRUFBRSxNQUFNO1FBQy9CRixrQkFBa0IsRUFBRTtRQUNwQlIsV0FBVyxDQUFDTyxPQUFPLEVBQUU7TUFDdkIsQ0FBQyxDQUFDO01BRUZOLFlBQVksQ0FBQ1UsRUFBRSxDQUFDLE9BQU8sRUFBR1AsQ0FBQyxJQUFLLElBQUksQ0FBQ1gsR0FBRyxDQUFDWSxLQUFLLENBQUNELENBQUMsQ0FBQyxDQUFDO01BQ2xESixXQUFXLENBQUNVLElBQUksQ0FBQyxLQUFLLEVBQUVGLGtCQUFrQixDQUFDO01BQzNDUixXQUFXLENBQUNVLElBQUksQ0FBQyxPQUFPLEVBQUUsTUFBTTtRQUM5QkYsa0JBQWtCLEVBQUU7UUFDcEJQLFlBQVksQ0FBQ00sT0FBTyxFQUFFO01BQ3hCLENBQUMsQ0FBQztNQUNGUCxXQUFXLENBQUNXLEVBQUUsQ0FBQyxPQUFPLEVBQUdQLENBQUMsSUFBSyxJQUFJLENBQUNYLEdBQUcsQ0FBQ21CLElBQUksQ0FBQ1IsQ0FBQyxDQUFDRSxPQUFPLENBQUMsQ0FBQztNQUN4RE4sV0FBVyxDQUFDYSxJQUFJLENBQUNaLFlBQVksQ0FBQztNQUM5QkEsWUFBWSxDQUFDWSxJQUFJLENBQUNiLFdBQVcsQ0FBQztJQUNoQyxDQUFDLENBQUM7SUFDRixNQUFNYyxnQkFBZ0IsR0FBRyxJQUFJQyxpQkFBQyxDQUFDLENBQUNDLE9BQU8sRUFBRUMsTUFBTSxLQUFLO01BQ2xELElBQUksQ0FBQ3pCLFdBQVcsQ0FBQ2tCLElBQUksQ0FBQyxXQUFXLEVBQUVNLE9BQU8sQ0FBQztNQUMzQyxJQUFJLENBQUN4QixXQUFXLENBQUNrQixJQUFJLENBQUMsT0FBTyxFQUFFTyxNQUFNLENBQUM7SUFDeEMsQ0FBQyxDQUFDO0lBQ0YsSUFBSSxDQUFDekIsV0FBVyxDQUFDMEIsTUFBTSxDQUFDLElBQUksQ0FBQzdCLFNBQVMsQ0FBQztJQUN2QyxJQUFJO01BQ0YsTUFBTXlCLGdCQUFnQjtJQUN4QixDQUFDLENBQUMsT0FBT1YsQ0FBQyxFQUFFO01BQ1YsSUFBSSxDQUFDWixXQUFXLEdBQUcsSUFBSTtNQUN2QixNQUFNWSxDQUFDO0lBQ1Q7SUFDQSxJQUFJLENBQUNaLFdBQVcsQ0FBQ21CLEVBQUUsQ0FBQyxPQUFPLEVBQUdQLENBQUMsSUFBSyxJQUFJLENBQUNYLEdBQUcsQ0FBQ21CLElBQUksQ0FBQ1IsQ0FBQyxDQUFDRSxPQUFPLENBQUMsQ0FBQztJQUM3RCxJQUFJLENBQUNkLFdBQVcsQ0FBQ2tCLElBQUksQ0FBQyxPQUFPLEVBQUdOLENBQUMsSUFBSztNQUNwQyxJQUFJQSxDQUFDLEVBQUU7UUFDTCxJQUFJLENBQUNYLEdBQUcsQ0FBQzBCLElBQUksQ0FBRSw2Q0FBNENmLENBQUMsQ0FBQ0UsT0FBUSxFQUFDLENBQUM7TUFDekUsQ0FBQyxNQUFNO1FBQ0wsSUFBSSxDQUFDYixHQUFHLENBQUMwQixJQUFJLENBQUUsZ0NBQStCLENBQUM7TUFDakQ7TUFDQSxJQUFJLENBQUMzQixXQUFXLEdBQUcsSUFBSTtJQUN6QixDQUFDLENBQUM7SUFFRixJQUFJLENBQUM0QixtQkFBbUIsR0FBRyxJQUFJLENBQUNDLGlCQUFpQixDQUFDQyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBRTVEQyxPQUFPLENBQUNaLEVBQUUsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDUyxtQkFBbUIsQ0FBQztFQUNwRDtFQUVBQyxpQkFBaUIsR0FBSTtJQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDN0IsV0FBVyxFQUFFO01BQ3JCO0lBQ0Y7SUFFQSxJQUFJLENBQUNDLEdBQUcsQ0FBQ1ksS0FBSyxDQUFFLHdCQUF1QixDQUFDO0lBQ3hDLElBQUksQ0FBQ2IsV0FBVyxDQUFDZ0MsS0FBSyxFQUFFO0lBQ3hCLElBQUksQ0FBQ2hDLFdBQVcsR0FBRyxJQUFJO0VBQ3pCO0VBRUFpQyxJQUFJLEdBQUk7SUFDTixJQUFJLElBQUksQ0FBQ0wsbUJBQW1CLEVBQUU7TUFDNUJHLE9BQU8sQ0FBQ0csR0FBRyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUNOLG1CQUFtQixDQUFDO01BQ25ELElBQUksQ0FBQ0EsbUJBQW1CLEdBQUcsSUFBSTtJQUNqQztJQUVBLElBQUksQ0FBQ0MsaUJBQWlCLEVBQUU7RUFDMUI7QUFDRjtBQUdBLE1BQU01QixHQUFHLEdBQUdDLGVBQU0sQ0FBQ0MsU0FBUyxDQUFDLGdCQUFnQixDQUFDO0FBQzlDLE1BQU1nQyxrQkFBa0IsR0FBRyxFQUFFLEdBQUcsSUFBSTtBQUNwQyxNQUFNQyxRQUFRLEdBQUcsR0FBRztBQUVwQixNQUFNQyx3QkFBd0IsQ0FBQztFQUM3QjFDLFdBQVcsR0FBSTtJQUNiLElBQUksQ0FBQzJDLG1CQUFtQixHQUFHLENBQUMsQ0FBQztFQUMvQjtFQUVBQyxZQUFZLENBQUUzQyxJQUFJLEVBQUU7SUFDbEIsT0FBUSxHQUFFNEMsYUFBSSxDQUFDQyxRQUFRLENBQUM3QyxJQUFJLENBQUMsR0FBR0EsSUFBSSxHQUFHLEVBQUcsR0FBRXdDLFFBQVMsRUFBQztFQUN4RDtFQUVBTSxZQUFZLENBQUVDLElBQUksRUFBRTtJQUNsQixPQUFRLEdBQUVQLFFBQVMsR0FBRUksYUFBSSxDQUFDQyxRQUFRLENBQUNFLElBQUksQ0FBQyxHQUFHQSxJQUFJLEdBQUcsRUFBRyxFQUFDO0VBQ3hEO0VBRUFDLE1BQU0sQ0FBRWhELElBQUksR0FBRyxJQUFJLEVBQUUrQyxJQUFJLEdBQUcsSUFBSSxFQUFFO0lBQ2hDLE9BQVEsR0FBRUgsYUFBSSxDQUFDQyxRQUFRLENBQUM3QyxJQUFJLENBQUMsR0FBR0EsSUFBSSxHQUFHLEVBQUcsR0FBRXdDLFFBQVMsR0FBRUksYUFBSSxDQUFDQyxRQUFRLENBQUNFLElBQUksQ0FBQyxHQUFHQSxJQUFJLEdBQUcsRUFBRyxFQUFDO0VBQzFGO0VBRUFFLDBCQUEwQixDQUFFQyxjQUFjLEVBQUU7SUFDMUMsTUFBTUMsSUFBSSxHQUFHRCxjQUFjLENBQ3hCRSxNQUFNLENBQUVDLENBQUMsSUFBS0MsZUFBQyxDQUFDQyxHQUFHLENBQUMsSUFBSSxDQUFDYixtQkFBbUIsQ0FBQ1csQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDOUQsS0FBSyxNQUFNRyxHQUFHLElBQUlMLElBQUksRUFBRTtNQUN0QjlDLEdBQUcsQ0FBQzBCLElBQUksQ0FBRSwrQkFBOEJ5QixHQUFJLEdBQUUsQ0FBQztNQUMvQyxJQUFJO1FBQ0YsSUFBSSxDQUFDZCxtQkFBbUIsQ0FBQ2MsR0FBRyxDQUFDLENBQUNDLE1BQU0sQ0FBQ3BCLElBQUksRUFBRTtNQUM3QyxDQUFDLENBQUMsT0FBT3JCLENBQUMsRUFBRTtRQUNWWCxHQUFHLENBQUNZLEtBQUssQ0FBQ0QsQ0FBQyxDQUFDO01BQ2Q7SUFDRjtJQUNBLE9BQU9tQyxJQUFJO0VBQ2I7RUFFQU8sZUFBZSxDQUFFMUQsSUFBSSxHQUFHLElBQUksRUFBRStDLElBQUksR0FBRyxJQUFJLEVBQUVZLE1BQU0sR0FBRyxLQUFLLEVBQUU7SUFDekQsSUFBSSxDQUFDM0QsSUFBSSxJQUFJLENBQUMrQyxJQUFJLEVBQUU7TUFDbEIsT0FBTyxFQUFFO0lBQ1g7SUFNQSxPQUFPTyxlQUFDLENBQUNILElBQUksQ0FBQyxJQUFJLENBQUNULG1CQUFtQixDQUFDLENBQ3BDVSxNQUFNLENBQUVJLEdBQUcsSUFBTUcsTUFBTSxJQUFJM0QsSUFBSSxJQUFJK0MsSUFBSSxHQUNuQ1MsR0FBRyxLQUFLLElBQUksQ0FBQ1IsTUFBTSxDQUFDaEQsSUFBSSxFQUFFK0MsSUFBSSxDQUFDLEdBQy9CL0MsSUFBSSxJQUFJd0QsR0FBRyxDQUFDSSxVQUFVLENBQUMsSUFBSSxDQUFDakIsWUFBWSxDQUFDM0MsSUFBSSxDQUFDLENBQUMsSUFBSStDLElBQUksSUFBSVMsR0FBRyxDQUFDSyxRQUFRLENBQUMsSUFBSSxDQUFDZixZQUFZLENBQUNDLElBQUksQ0FBQyxDQUFFLENBQ3JHO0VBQ0w7RUFFQSxNQUFNZSxpQkFBaUIsQ0FBRTlELElBQUksRUFBRStDLElBQUksRUFBRWdCLE9BQU8sR0FBRyxDQUFDLENBQUMsRUFBRTtJQUNqRCxJQUFJLENBQUMvRCxJQUFJLElBQUksQ0FBQytDLElBQUksRUFBRTtNQUNsQjFDLEdBQUcsQ0FBQ21CLElBQUksQ0FBQyw2Q0FBNkMsQ0FBQztNQUN2RCxJQUFJLENBQUN4QixJQUFJLEVBQUU7UUFDVEssR0FBRyxDQUFDbUIsSUFBSSxDQUFDLHdCQUF3QixDQUFDO01BQ3BDO01BQ0EsSUFBSSxDQUFDdUIsSUFBSSxFQUFFO1FBQ1QxQyxHQUFHLENBQUNtQixJQUFJLENBQUMsa0NBQWtDLENBQUM7TUFDOUM7TUFDQTtJQUNGO0lBRUEsTUFBTTtNQUNKd0MsaUJBQWlCO01BQ2pCQztJQUNGLENBQUMsR0FBR0YsT0FBTztJQUVYMUQsR0FBRyxDQUFDMEIsSUFBSSxDQUFFLG9DQUFtQy9CLElBQUssa0JBQWlCK0MsSUFBSyxFQUFDLElBQ3RFa0IsVUFBVSxHQUFJLGlCQUFnQkEsVUFBVyxFQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDcEQ1RCxHQUFHLENBQUNZLEtBQUssQ0FBRSw2QkFBNEJxQyxlQUFDLENBQUNZLElBQUksQ0FBQyxJQUFJLENBQUN4QixtQkFBbUIsQ0FBRSxFQUFDLENBQUM7SUFDMUUsTUFBTXlCLGlCQUFpQixHQUFHLElBQUksQ0FBQ1QsZUFBZSxDQUFDLElBQUksRUFBRVgsSUFBSSxDQUFDO0lBQzFELElBQUksQ0FBQ08sZUFBQyxDQUFDYyxPQUFPLENBQUNELGlCQUFpQixDQUFDLEVBQUU7TUFDakM5RCxHQUFHLENBQUMwQixJQUFJLENBQUUscUNBQW9DZ0IsSUFBSyxLQUFJc0IsSUFBSSxDQUFDQyxTQUFTLENBQUNILGlCQUFpQixDQUFFLEVBQUMsQ0FBQztJQUM3RjtJQUVBLElBQUlILGlCQUFpQixFQUFFO01BQ3JCLElBQUlPLFVBQVUsR0FBRyxDQUFDLE1BQU0sSUFBQUMsNEJBQWUsRUFBQ3pCLElBQUksRUFBRWxELFNBQVMsQ0FBQyxNQUFNLE1BQU07TUFDcEUsSUFBSTBFLFVBQVUsRUFBRTtRQUNkbEUsR0FBRyxDQUFDbUIsSUFBSSxDQUFFLFNBQVF1QixJQUFLLGlFQUFnRSxDQUFDO1FBQ3hGLElBQUksQ0FBQ08sZUFBQyxDQUFDYyxPQUFPLENBQUNELGlCQUFpQixDQUFDLEVBQUU7VUFDakM5RCxHQUFHLENBQUMwQixJQUFJLENBQUMsNEJBQTRCLENBQUM7VUFDdEMsS0FBSyxNQUFNeUIsR0FBRyxJQUFJLElBQUksQ0FBQ1AsMEJBQTBCLENBQUNrQixpQkFBaUIsQ0FBQyxFQUFFO1lBQ3BFLE9BQU8sSUFBSSxDQUFDekIsbUJBQW1CLENBQUNjLEdBQUcsQ0FBQztVQUN0QztVQUNBLE1BQU1pQixLQUFLLEdBQUcsSUFBSUMsZUFBTSxDQUFDQyxLQUFLLEVBQUUsQ0FBQ2xFLEtBQUssRUFBRTtVQUN4QyxJQUFJO1lBQ0YsTUFBTSxJQUFBbUUsMEJBQWdCLEVBQUMsWUFBWTtjQUNqQyxJQUFJO2dCQUNGLElBQUksQ0FBQyxNQUFNLElBQUFKLDRCQUFlLEVBQUN6QixJQUFJLEVBQUVsRCxTQUFTLENBQUMsTUFBTSxNQUFNLEVBQUU7a0JBQ3ZEUSxHQUFHLENBQUMwQixJQUFJLENBQUUsU0FBUWdCLElBQUssd0NBQXVDLEdBQzNELEdBQUUwQixLQUFLLENBQUNJLFdBQVcsRUFBRSxDQUFDQyxjQUFjLENBQUNDLE9BQU8sQ0FBQyxDQUFDLENBQUUsSUFBRyxDQUFDO2tCQUN2RFIsVUFBVSxHQUFHLEtBQUs7a0JBQ2xCLE9BQU8sSUFBSTtnQkFDYjtjQUNGLENBQUMsQ0FBQyxPQUFPUyxHQUFHLEVBQUUsQ0FBQztjQUNmLE9BQU8sS0FBSztZQUNkLENBQUMsRUFBRTtjQUNEQyxNQUFNLEVBQUUxQyxrQkFBa0I7Y0FDMUIyQyxVQUFVLEVBQUU7WUFDZCxDQUFDLENBQUM7VUFDSixDQUFDLENBQUMsT0FBT0YsR0FBRyxFQUFFO1lBQ1ozRSxHQUFHLENBQUNtQixJQUFJLENBQUUscUNBQW9DdUIsSUFBSyxNQUFLLEdBQ3JELEdBQUUwQixLQUFLLENBQUNJLFdBQVcsRUFBRSxDQUFDQyxjQUFjLENBQUNDLE9BQU8sQ0FBQyxDQUFDLENBQUUsSUFBRyxDQUFDO1VBQ3pEO1FBQ0Y7TUFDRjtNQUVBLElBQUlSLFVBQVUsRUFBRTtRQUNkLE1BQU0sSUFBSVksS0FBSyxDQUFFLGFBQVlwQyxJQUFLLG9DQUFtQyxHQUNsRSwrREFBOEQsQ0FBQztNQUNwRTtJQUNGO0lBQ0EsTUFBTXFDLFVBQVUsR0FBRyxJQUFJLENBQUNwQyxNQUFNLENBQUNoRCxJQUFJLEVBQUUrQyxJQUFJLENBQUM7SUFDMUMsSUFBSWlCLGlCQUFpQixFQUFFO01BQ3JCLE1BQU1QLE1BQU0sR0FBRyxJQUFJM0QsTUFBTSxDQUFDRSxJQUFJLEVBQUUrQyxJQUFJLEVBQUVrQixVQUFVLENBQUM7TUFDakQsSUFBSTtRQUNGLE1BQU1SLE1BQU0sQ0FBQ2hELEtBQUssRUFBRTtRQUNwQixJQUFJLENBQUNpQyxtQkFBbUIsQ0FBQzBDLFVBQVUsQ0FBQyxHQUFHO1VBQUMzQjtRQUFNLENBQUM7TUFDakQsQ0FBQyxDQUFDLE9BQU96QyxDQUFDLEVBQUU7UUFDVixJQUFJO1VBQ0Z5QyxNQUFNLENBQUNwQixJQUFJLEVBQUU7UUFDZixDQUFDLENBQUMsT0FBT2dELEVBQUUsRUFBRTtVQUNYaEYsR0FBRyxDQUFDWSxLQUFLLENBQUNvRSxFQUFFLENBQUM7UUFDZjtRQUNBLE1BQU1yRSxDQUFDO01BQ1Q7SUFDRixDQUFDLE1BQU07TUFDTCxJQUFJLENBQUMwQixtQkFBbUIsQ0FBQzBDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQztJQUNBL0UsR0FBRyxDQUFDMEIsSUFBSSxDQUFFLDZDQUE0Q3FELFVBQVcsRUFBQyxDQUFDO0VBQ3JFO0VBRUFFLGlCQUFpQixDQUFFdEYsSUFBSSxHQUFHLElBQUksRUFBRStDLElBQUksR0FBRyxJQUFJLEVBQUU7SUFDM0MsSUFBSSxDQUFDL0MsSUFBSSxJQUFJLENBQUMrQyxJQUFJLEVBQUU7TUFDbEIxQyxHQUFHLENBQUNtQixJQUFJLENBQUMsNkNBQTZDLEdBQ3BELDRDQUE0QyxDQUFDO01BQy9DO0lBQ0Y7SUFDQW5CLEdBQUcsQ0FBQzBCLElBQUksQ0FBRSw2QkFBNEIvQixJQUFJLElBQUksS0FBTSxjQUFhK0MsSUFBSSxJQUFJLEtBQU0sY0FBYSxDQUFDO0lBRTdGLE1BQU1JLElBQUksR0FBRyxJQUFJLENBQUNPLGVBQWUsQ0FBQzFELElBQUksRUFBRStDLElBQUksRUFBRSxJQUFJLENBQUM7SUFDbkQsSUFBSU8sZUFBQyxDQUFDYyxPQUFPLENBQUNqQixJQUFJLENBQUMsRUFBRTtNQUNuQjlDLEdBQUcsQ0FBQzBCLElBQUksQ0FBQyx1Q0FBdUMsQ0FBQztNQUNqRDtJQUNGO0lBQ0ExQixHQUFHLENBQUMwQixJQUFJLENBQUUsd0NBQXVDc0MsSUFBSSxDQUFDQyxTQUFTLENBQUNuQixJQUFJLENBQUUsRUFBQyxDQUFDO0lBQ3hFLElBQUksQ0FBQ0YsMEJBQTBCLENBQUNFLElBQUksQ0FBQztJQUNyQyxLQUFLLE1BQU1LLEdBQUcsSUFBSUwsSUFBSSxFQUFFO01BQ3RCLE9BQU8sSUFBSSxDQUFDVCxtQkFBbUIsQ0FBQ2MsR0FBRyxDQUFDO0lBQ3RDO0lBQ0FuRCxHQUFHLENBQUNZLEtBQUssQ0FBRSw2QkFBNEJxQyxlQUFDLENBQUNZLElBQUksQ0FBQyxJQUFJLENBQUN4QixtQkFBbUIsQ0FBRSxFQUFDLENBQUM7RUFDNUU7QUFDRjtBQUFDO0FBRUQsTUFBTTZDLDBCQUEwQixHQUFHLElBQUk5Qyx3QkFBd0IsRUFBRTtBQUFDO0FBQUEsZUFHbkQ4QywwQkFBMEI7QUFBQSJ9