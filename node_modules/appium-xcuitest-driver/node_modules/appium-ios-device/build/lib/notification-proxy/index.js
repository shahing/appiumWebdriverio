"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.NotificationProxyService = exports.NOTIFICATION_PROXY_SERVICE_NAME = void 0;
require("source-map-support/register");
var _plistServiceEncoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-encoder"));
var _plistServiceDecoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-decoder"));
var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));
var _constants = require("../constants");
var _lodash = _interopRequireDefault(require("lodash"));
var _baseService = require("../base-service");
const NOTIFICATION_PROXY_SERVICE_NAME = 'com.apple.mobile.notification_proxy';
exports.NOTIFICATION_PROXY_SERVICE_NAME = NOTIFICATION_PROXY_SERVICE_NAME;
const MAX_FRAME_SIZE = 16 * _constants.KB;
const RELAY_NOTIFICATION = 'RelayNotification';
const PROXY_DEATH = 'ProxyDeath';
class NotificationProxyService extends _baseService.BaseServiceSocket {
  constructor(socketClient) {
    super(socketClient);
    this._decoder = new _plistServiceDecoder.default();
    this._splitter = new _lengthBasedSplitter.default({
      readableStream: socketClient,
      littleEndian: false,
      maxFrameLength: MAX_FRAME_SIZE,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 4
    });
    this._socketClient.pipe(this._splitter).pipe(this._decoder);
    this._encoder = new _plistServiceEncoder.default();
    this._encoder.pipe(this._socketClient);
    this._assignClientFailureHandlers(this._encoder);
    this._listeners = {};
    this._decoder.on('data', this._handleData.bind(this));
  }
  _handleData(data) {
    switch (data.Command) {
      case RELAY_NOTIFICATION:
        {
          const listener = this._listeners[data.Name];
          if (!listener) {
            return;
          }
          if (_lodash.default.isFunction(listener.notification)) {
            listener.notification();
          }
          break;
        }
      case PROXY_DEATH:
        {
          const listener = this._listeners[data.Name];
          if (!listener) {
            return;
          }
          if (_lodash.default.isFunction(listener.proxyDeath)) {
            listener.proxyDeath();
          }
          delete this._listeners[data.Name];
          break;
        }
      default:
        throw new Error(`Unknown data type ${JSON.stringify(data)}`);
    }
  }
  observeNotification(notification, listener) {
    if (this._listeners[notification]) {
      throw new Error(`Notification listener for ${notification} already exists. Another one can't be added`);
    }
    this._listeners[notification] = listener;
    this._encoder.write({
      Command: 'ObserveNotification',
      Name: notification
    });
  }
  postNotification(notification) {
    this._encoder.write({
      Command: 'PostNotification',
      Name: notification
    });
  }
  shutdown() {
    this._encoder.write({
      Command: 'Shutdown'
    });
  }
  close() {
    this.shutdown();
    super.close();
  }
}
exports.NotificationProxyService = NotificationProxyService;
var _default = NotificationProxyService;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJOT1RJRklDQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FIiwiTUFYX0ZSQU1FX1NJWkUiLCJLQiIsIlJFTEFZX05PVElGSUNBVElPTiIsIlBST1hZX0RFQVRIIiwiTm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlIiwiQmFzZVNlcnZpY2VTb2NrZXQiLCJjb25zdHJ1Y3RvciIsInNvY2tldENsaWVudCIsIl9kZWNvZGVyIiwiUGxpc3RTZXJ2aWNlRGVjb2RlciIsIl9zcGxpdHRlciIsIkxlbmd0aEJhc2VkU3BsaXR0ZXIiLCJyZWFkYWJsZVN0cmVhbSIsImxpdHRsZUVuZGlhbiIsIm1heEZyYW1lTGVuZ3RoIiwibGVuZ3RoRmllbGRPZmZzZXQiLCJsZW5ndGhGaWVsZExlbmd0aCIsImxlbmd0aEFkanVzdG1lbnQiLCJfc29ja2V0Q2xpZW50IiwicGlwZSIsIl9lbmNvZGVyIiwiUGxpc3RTZXJ2aWNlRW5jb2RlciIsIl9hc3NpZ25DbGllbnRGYWlsdXJlSGFuZGxlcnMiLCJfbGlzdGVuZXJzIiwib24iLCJfaGFuZGxlRGF0YSIsImJpbmQiLCJkYXRhIiwiQ29tbWFuZCIsImxpc3RlbmVyIiwiTmFtZSIsIl8iLCJpc0Z1bmN0aW9uIiwibm90aWZpY2F0aW9uIiwicHJveHlEZWF0aCIsIkVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsIm9ic2VydmVOb3RpZmljYXRpb24iLCJ3cml0ZSIsInBvc3ROb3RpZmljYXRpb24iLCJzaHV0ZG93biIsImNsb3NlIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL25vdGlmaWNhdGlvbi1wcm94eS9pbmRleC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUGxpc3RTZXJ2aWNlRW5jb2RlciBmcm9tICcuLi9wbGlzdC1zZXJ2aWNlL3RyYW5zZm9ybWVyL3BsaXN0LXNlcnZpY2UtZW5jb2Rlcic7XG5pbXBvcnQgUGxpc3RTZXJ2aWNlRGVjb2RlciBmcm9tICcuLi9wbGlzdC1zZXJ2aWNlL3RyYW5zZm9ybWVyL3BsaXN0LXNlcnZpY2UtZGVjb2Rlcic7XG5pbXBvcnQgTGVuZ3RoQmFzZWRTcGxpdHRlciBmcm9tICcuLi91dGlsL3RyYW5zZm9ybWVyL2xlbmd0aC1iYXNlZC1zcGxpdHRlcic7XG5pbXBvcnQgeyBLQiB9IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgQmFzZVNlcnZpY2VTb2NrZXQgfSBmcm9tICcuLi9iYXNlLXNlcnZpY2UnO1xuXG5cbmNvbnN0IE5PVElGSUNBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUgPSAnY29tLmFwcGxlLm1vYmlsZS5ub3RpZmljYXRpb25fcHJveHknO1xuY29uc3QgTUFYX0ZSQU1FX1NJWkUgPSAxNiAqIEtCO1xuXG5jb25zdCBSRUxBWV9OT1RJRklDQVRJT04gPSAnUmVsYXlOb3RpZmljYXRpb24nO1xuY29uc3QgUFJPWFlfREVBVEggPSAnUHJveHlEZWF0aCc7XG5cbmNsYXNzIE5vdGlmaWNhdGlvblByb3h5U2VydmljZSBleHRlbmRzIEJhc2VTZXJ2aWNlU29ja2V0IHtcbiAgY29uc3RydWN0b3IgKHNvY2tldENsaWVudCkge1xuICAgIHN1cGVyKHNvY2tldENsaWVudCk7XG5cbiAgICB0aGlzLl9kZWNvZGVyID0gbmV3IFBsaXN0U2VydmljZURlY29kZXIoKTtcbiAgICB0aGlzLl9zcGxpdHRlciA9IG5ldyBMZW5ndGhCYXNlZFNwbGl0dGVyKHtcbiAgICAgIHJlYWRhYmxlU3RyZWFtOiBzb2NrZXRDbGllbnQsXG4gICAgICBsaXR0bGVFbmRpYW46IGZhbHNlLFxuICAgICAgbWF4RnJhbWVMZW5ndGg6IE1BWF9GUkFNRV9TSVpFLFxuICAgICAgbGVuZ3RoRmllbGRPZmZzZXQ6IDAsXG4gICAgICBsZW5ndGhGaWVsZExlbmd0aDogNCxcbiAgICAgIGxlbmd0aEFkanVzdG1lbnQ6IDQsXG4gICAgfSk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50LnBpcGUodGhpcy5fc3BsaXR0ZXIpLnBpcGUodGhpcy5fZGVjb2Rlcik7XG5cbiAgICB0aGlzLl9lbmNvZGVyID0gbmV3IFBsaXN0U2VydmljZUVuY29kZXIoKTtcbiAgICB0aGlzLl9lbmNvZGVyLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcbiAgICB0aGlzLl9hc3NpZ25DbGllbnRGYWlsdXJlSGFuZGxlcnModGhpcy5fZW5jb2Rlcik7XG5cbiAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTtcbiAgICB0aGlzLl9kZWNvZGVyLm9uKCdkYXRhJywgdGhpcy5faGFuZGxlRGF0YS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIF9oYW5kbGVEYXRhIChkYXRhKSB7XG4gICAgc3dpdGNoIChkYXRhLkNvbW1hbmQpIHtcbiAgICAgIGNhc2UgUkVMQVlfTk9USUZJQ0FUSU9OOiB7XG4gICAgICAgIGNvbnN0IGxpc3RlbmVyID0gdGhpcy5fbGlzdGVuZXJzW2RhdGEuTmFtZV07XG4gICAgICAgIGlmICghbGlzdGVuZXIpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihsaXN0ZW5lci5ub3RpZmljYXRpb24pKSB7XG4gICAgICAgICAgbGlzdGVuZXIubm90aWZpY2F0aW9uKCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjYXNlIFBST1hZX0RFQVRIOiB7XG4gICAgICAgIGNvbnN0IGxpc3RlbmVyID0gdGhpcy5fbGlzdGVuZXJzW2RhdGEuTmFtZV07XG4gICAgICAgIGlmICghbGlzdGVuZXIpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihsaXN0ZW5lci5wcm94eURlYXRoKSkge1xuICAgICAgICAgIGxpc3RlbmVyLnByb3h5RGVhdGgoKTtcbiAgICAgICAgfVxuICAgICAgICBkZWxldGUgdGhpcy5fbGlzdGVuZXJzW2RhdGEuTmFtZV07XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGRhdGEgdHlwZSAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgYXBpIHRvIGxpc3RlbiB0byBub3RpZmljYXRpb25zIHRoYXQgdGhlIHBob25lIGJyb2FkY2FzdHNcbiAgICogQHBhcmFtIHtzdHJpbmd9IG5vdGlmaWNhdGlvbiBUaGUgbmFtZSBvZiB0aGUgbm90aWZpY2F0aW9uIHdoaWNoIGlzIGRlc2lyZWQgdG8gYmUgb2JzZXJ2ZWRcbiAgICogQHBhcmFtIHtPYmplY3R9IGxpc3RlbmVyIFRoZSBsaXN0ZW5lciBvYmplY3Qgd2hpY2ggd2lsbCBiZSBpbnZva2VkIHdoZW4gdGhlcmUgaXMgYSBub3RpZmljYXRpb24gb3IgaWYgdGhlIHByb3h5IGlzIGRlYWRcbiAgICovXG4gIG9ic2VydmVOb3RpZmljYXRpb24gKG5vdGlmaWNhdGlvbiwgbGlzdGVuZXIpIHtcbiAgICBpZiAodGhpcy5fbGlzdGVuZXJzW25vdGlmaWNhdGlvbl0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTm90aWZpY2F0aW9uIGxpc3RlbmVyIGZvciAke25vdGlmaWNhdGlvbn0gYWxyZWFkeSBleGlzdHMuIEFub3RoZXIgb25lIGNhbid0IGJlIGFkZGVkYCk7XG4gICAgfVxuICAgIHRoaXMuX2xpc3RlbmVyc1tub3RpZmljYXRpb25dID0gbGlzdGVuZXI7XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZSh7XG4gICAgICBDb21tYW5kOiAnT2JzZXJ2ZU5vdGlmaWNhdGlvbicsXG4gICAgICBOYW1lOiBub3RpZmljYXRpb25cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgYXBpIHRvIGJyb2FkY2FzdCBub3RpZmljYXRpb25zIHRvIHRoZSBwaG9uZS4gVGhpcyBhbGxvd3MgdGhlIGNsaWVudCB0byB0YWxrIHRvIHRoZSBkYWVtb25zIG9yIGFwcHMgb24gdGhlIHBob25lXG4gICAqIEBwYXJhbSB7Kn0gbm90aWZpY2F0aW9uIFRoZSBuYW1lIG9mIHRoZSBub3RpZmljYXRpb24gd2hpY2ggaXMgZGVzaXJlZCBub3RpZmllZFxuICAgKi9cbiAgcG9zdE5vdGlmaWNhdGlvbiAobm90aWZpY2F0aW9uKSB7XG4gICAgdGhpcy5fZW5jb2Rlci53cml0ZSh7XG4gICAgICBDb21tYW5kOiAnUG9zdE5vdGlmaWNhdGlvbicsXG4gICAgICBOYW1lOiBub3RpZmljYXRpb25cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgYXBpIHRvIHNodXRkb3duIHRoZSBwcm94eS4gQ29uc2VxdWVudGx5LCBhbGwgdGhlIG5vdGlmaWNhdGlvbnMgdGhhdCBhcmUgb2JzZXJ2aW5nIHdpbGwgcmVjaWV2ZSB0aGUgcHJveHlEZWF0aCByZXNwb25zZVxuICAgKiBAcGFyYW0geyp9IG5vdGlmaWNhdGlvbiBUaGUgbmFtZSBvZiB0aGUgbm90aWZpY2F0aW9uIHdoaWNoIGlzIGRlc2lyZWQgbm90aWZpZWRcbiAgICovXG4gIHNodXRkb3duICgpIHtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKHtcbiAgICAgIENvbW1hbmQ6ICdTaHV0ZG93bicsXG4gICAgfSk7XG4gIH1cblxuICBjbG9zZSAoKSB7XG4gICAgdGhpcy5zaHV0ZG93bigpO1xuICAgIHN1cGVyLmNsb3NlKCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlO1xuZXhwb3J0IHsgTm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlLCBOT1RJRklDQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FIH07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBR0EsTUFBTUEsK0JBQStCLEdBQUcscUNBQXFDO0FBQUM7QUFDOUUsTUFBTUMsY0FBYyxHQUFHLEVBQUUsR0FBR0MsYUFBRTtBQUU5QixNQUFNQyxrQkFBa0IsR0FBRyxtQkFBbUI7QUFDOUMsTUFBTUMsV0FBVyxHQUFHLFlBQVk7QUFFaEMsTUFBTUMsd0JBQXdCLFNBQVNDLDhC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