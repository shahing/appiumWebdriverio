"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger"));
var _asyncbox = require("asyncbox");
const commands = {};
commands.startBootMonitor = async function startBootMonitor(opts = {}) {
  const {
    timeout = 240000,
    onWaitingDataMigration,
    onWaitingSystemApp,
    onFinished,
    onError,
    shouldPreboot
  } = opts;
  const udid = this.requireUdid('bootstatus');
  let status = '';
  let isBootingFinished = false;
  let error = null;
  let timeoutHandler = null;
  const args = [udid];
  if (shouldPreboot) {
    args.push('-b');
  }
  const bootMonitor = await this.exec('bootstatus', {
    args,
    asynchronous: true
  });
  bootMonitor.on('output', (stdout, stderr) => {
    status += stdout || stderr;
    if (stdout) {
      if (stdout.includes('Waiting on Data Migration') && onWaitingDataMigration) {
        onWaitingDataMigration();
      } else if (stdout.includes('Waiting on System App') && onWaitingSystemApp) {
        onWaitingSystemApp();
      }
    }
  });
  bootMonitor.on('exit', (code, signal) => {
    if (timeoutHandler) {
      clearTimeout(timeoutHandler);
    }
    if (code === 0) {
      if (onFinished) {
        onFinished();
      }
      isBootingFinished = true;
    } else {
      status = status || signal;
      error = new Error(status);
      if (onError) {
        onError(error);
      }
    }
  });
  await bootMonitor.start(0);
  const stopMonitor = async () => {
    if (bootMonitor.isRunning) {
      try {
        await bootMonitor.stop();
      } catch (e) {
        _logger.default.warn(e.message);
      }
    }
  };
  const start = process.hrtime();
  if (onFinished) {
    timeoutHandler = setTimeout(stopMonitor, timeout);
  } else {
    try {
      await (0, _asyncbox.waitForCondition)(() => {
        if (error) {
          throw error;
        }
        return isBootingFinished;
      }, {
        waitMs: timeout,
        intervalMs: 500
      });
    } catch (err) {
      await stopMonitor();
      const [seconds] = process.hrtime(start);
      throw new Error(`The simulator ${udid} has failed to finish booting after ${seconds}s. ` + `Original status: ${status}`);
    }
  }
  return bootMonitor;
};
var _default = commands;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb21tYW5kcyIsInN0YXJ0Qm9vdE1vbml0b3IiLCJvcHRzIiwidGltZW91dCIsIm9uV2FpdGluZ0RhdGFNaWdyYXRpb24iLCJvbldhaXRpbmdTeXN0ZW1BcHAiLCJvbkZpbmlzaGVkIiwib25FcnJvciIsInNob3VsZFByZWJvb3QiLCJ1ZGlkIiwicmVxdWlyZVVkaWQiLCJzdGF0dXMiLCJpc0Jvb3RpbmdGaW5pc2hlZCIsImVycm9yIiwidGltZW91dEhhbmRsZXIiLCJhcmdzIiwicHVzaCIsImJvb3RNb25pdG9yIiwiZXhlYyIsImFzeW5jaHJvbm91cyIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwiaW5jbHVkZXMiLCJjb2RlIiwic2lnbmFsIiwiY2xlYXJUaW1lb3V0IiwiRXJyb3IiLCJzdGFydCIsInN0b3BNb25pdG9yIiwiaXNSdW5uaW5nIiwic3RvcCIsImUiLCJsb2ciLCJ3YXJuIiwibWVzc2FnZSIsInByb2Nlc3MiLCJocnRpbWUiLCJzZXRUaW1lb3V0Iiwid2FpdEZvckNvbmRpdGlvbiIsIndhaXRNcyIsImludGVydmFsTXMiLCJlcnIiLCJzZWNvbmRzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL3N1YmNvbW1hbmRzL2Jvb3RzdGF0dXMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcblxuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEJvb3RNb25pdG9yT3B0aW9uc1xuICogQHByb3BlcnR5IHs/bnVtYmVyfSB0aW1lb3V0IFsyNDAwMDBdIC0gU2ltdWxhdG9yIGJvb3RpbmcgdGltZW91dCBpbiBtcy5cbiAqIEBwcm9wZXJ0eSB7P0Z1bmN0aW9ufSBvbldhaXRpbmdEYXRhTWlncmF0aW9uIC0gVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIGRhdGEgbWlncmF0aW9uIHN0YWdlIHN0YXJ0cy5cbiAqIEBwcm9wZXJ0eSB7P0Z1bmN0aW9ufSBvbldhaXRpbmdTeXN0ZW1BcHAgLSBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gc3lzdGVtIGFwcCB3YWl0IHN0YWdlIHN0YXJ0cy5cbiAqIEBwcm9wZXJ0eSB7P0Z1bmN0aW9ufSBvbkZpbmlzaGVkIC0gVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIFNpbXVsYXRvciBpcyBmdWxseSBib290ZWQuXG4gKiBAcHJvcGVydHkgez9GdW5jdGlvbn0gb25FcnJvciAtIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgbW9uaXRvcmluZyB0aGUgYm9vdGluZyBwcm9jZXNzXG4gKiBvciB3aGVuIHRoZSB0aW1lb3V0IGhhcyBleHBpcmVkLlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gc2hvdWxkUHJlYm9vdCBbZmFsc2VdIFdoZXRoZXIgdG8gcHJlYm9vdCB0aGUgU2ltdWxhdG9yXG4gKiBpZiB0aGlzIGNvbW1hbmQgaXMgY2FsbGVkIGFuZCBpdCBpcyBub3QgYWxyZWFkeSBpbiBib290ZWQgb3IgYm9vdGluZyBzdGF0ZS5cbiAqL1xuXG4vKipcbiAqIFN0YXJ0IG1vbml0b3JpbmcgZm9yIGJvb3Qgc3RhdHVzIG9mIHRoZSBwYXJ0aWN1bGFyIFNpbXVsYXRvci5cbiAqIElmIG9uRmluaXNoZWQgcHJvcGVydHkgaXMgbm90IHNldCB0aGVuIHRoZSBtZXRob2Qgd2lsbCBibG9ja1xuICogdW50aWwgU2ltdWxhdG9yIGJvb3RpbmcgaXMgY29tcGxldGVkLlxuICogVGhlIG1ldGhvZCBpcyBvbmx5IGF2YWlsYWJsZSBzaW5jZSBYY29kZTguXG4gKlxuICogQHBhcmFtIHs/Qm9vdE1vbml0b3JPcHRpb25zfSBvcHRzIC0gTW9uaXRvcmluZyBvcHRpb25zLlxuICogQHJldHVybnMge1N1YlByb2Nlc3N9IFRoZSBpbnN0YW5jZSBvZiB0aGUgY29ycmVzcG9uZGluZyBtb25pdG9yaW5nIHByb2Nlc3MuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIFNpbXVsYXRvciBmYWlscyB0byBmaW5pc2ggYm9vdGluZyB3aXRoaW4gdGhlIGdpdmVuIHRpbWVvdXQgYW5kIG9uRmluaXNoZWRcbiAqIHByb3BlcnR5IGlzIG5vdCBzZXQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGB1ZGlkYCBpbnN0YW5jZSBwcm9wZXJ0eSBpcyB1bnNldFxuICovXG5jb21tYW5kcy5zdGFydEJvb3RNb25pdG9yID0gYXN5bmMgZnVuY3Rpb24gc3RhcnRCb290TW9uaXRvciAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICB0aW1lb3V0ID0gMjQwMDAwLFxuICAgIG9uV2FpdGluZ0RhdGFNaWdyYXRpb24sXG4gICAgb25XYWl0aW5nU3lzdGVtQXBwLFxuICAgIG9uRmluaXNoZWQsXG4gICAgb25FcnJvcixcbiAgICBzaG91bGRQcmVib290LFxuICB9ID0gb3B0cztcbiAgY29uc3QgdWRpZCA9IHRoaXMucmVxdWlyZVVkaWQoJ2Jvb3RzdGF0dXMnKTtcblxuICBsZXQgc3RhdHVzID0gJyc7XG4gIGxldCBpc0Jvb3RpbmdGaW5pc2hlZCA9IGZhbHNlO1xuICBsZXQgZXJyb3IgPSBudWxsO1xuICBsZXQgdGltZW91dEhhbmRsZXIgPSBudWxsO1xuICBjb25zdCBhcmdzID0gW3VkaWRdO1xuICBpZiAoc2hvdWxkUHJlYm9vdCkge1xuICAgIGFyZ3MucHVzaCgnLWInKTtcbiAgfVxuICBjb25zdCBib290TW9uaXRvciA9IGF3YWl0IHRoaXMuZXhlYygnYm9vdHN0YXR1cycsIHtcbiAgICBhcmdzLFxuICAgIGFzeW5jaHJvbm91czogdHJ1ZSxcbiAgfSk7XG4gIGJvb3RNb25pdG9yLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICBzdGF0dXMgKz0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICBpZiAoc3Rkb3V0KSB7XG4gICAgICBpZiAoc3Rkb3V0LmluY2x1ZGVzKCdXYWl0aW5nIG9uIERhdGEgTWlncmF0aW9uJykgJiYgb25XYWl0aW5nRGF0YU1pZ3JhdGlvbikge1xuICAgICAgICBvbldhaXRpbmdEYXRhTWlncmF0aW9uKCk7XG4gICAgICB9IGVsc2UgaWYgKHN0ZG91dC5pbmNsdWRlcygnV2FpdGluZyBvbiBTeXN0ZW0gQXBwJykgJiYgb25XYWl0aW5nU3lzdGVtQXBwKSB7XG4gICAgICAgIG9uV2FpdGluZ1N5c3RlbUFwcCgpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIGJvb3RNb25pdG9yLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgIGlmICh0aW1lb3V0SGFuZGxlcikge1xuICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRIYW5kbGVyKTtcbiAgICB9XG4gICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgIGlmIChvbkZpbmlzaGVkKSB7XG4gICAgICAgIG9uRmluaXNoZWQoKTtcbiAgICAgIH1cbiAgICAgIGlzQm9vdGluZ0ZpbmlzaGVkID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3RhdHVzID0gc3RhdHVzIHx8IHNpZ25hbDtcbiAgICAgIGVycm9yID0gbmV3IEVycm9yKHN0YXR1cyk7XG4gICAgICBpZiAob25FcnJvcikge1xuICAgICAgICBvbkVycm9yKGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuICBhd2FpdCBib290TW9uaXRvci5zdGFydCgwKTtcbiAgY29uc3Qgc3RvcE1vbml0b3IgPSBhc3luYyAoKSA9PiB7XG4gICAgaWYgKGJvb3RNb25pdG9yLmlzUnVubmluZykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgYm9vdE1vbml0b3Iuc3RvcCgpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihlLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgY29uc3Qgc3RhcnQgPSBwcm9jZXNzLmhydGltZSgpO1xuICBpZiAob25GaW5pc2hlZCkge1xuICAgIHRpbWVvdXRIYW5kbGVyID0gc2V0VGltZW91dChzdG9wTW9uaXRvciwgdGltZW91dCk7XG4gIH0gZWxzZSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oKCkgPT4ge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXNCb290aW5nRmluaXNoZWQ7XG4gICAgICB9LCB7d2FpdE1zOiB0aW1lb3V0LCBpbnRlcnZhbE1zOiA1MDB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGF3YWl0IHN0b3BNb25pdG9yKCk7XG4gICAgICBjb25zdCBbc2Vjb25kc10gPSBwcm9jZXNzLmhydGltZShzdGFydCk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGUgc2ltdWxhdG9yICR7dWRpZH0gaGFzIGZhaWxlZCB0byBmaW5pc2ggYm9vdGluZyBhZnRlciAke3NlY29uZHN9cy4gYCArXG4gICAgICAgIGBPcmlnaW5hbCBzdGF0dXM6ICR7c3RhdHVzfWApO1xuICAgIH1cbiAgfVxuICByZXR1cm4gYm9vdE1vbml0b3I7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBR0EsTUFBTUEsUUFBUSxHQUFHLENBQUMsQ0FBQztBQTBCbkJBLFFBQVEsQ0FBQ0MsZ0JBQWdCLEdBQUcsZUFBZUEsZ0JBQWdCLENBQUVDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtFQUN0RSxNQUFNO0lBQ0pDLE9BQU8sR0FBRyxNQUFNO0lBQ2hCQyxzQkFBc0I7SUFDdEJDLGtCQUFrQjtJQUNsQkMsVUFBVTtJQUNWQyxPQUFPO0lBQ1BDO0VBQ0YsQ0FBQyxHQUFHTixJQUFJO0VBQ1IsTUFBTU8sSUFBSSxHQUFHLElBQUksQ0FBQ0MsV0FBVyxDQUFDLFlBQVksQ0FBQztFQUUzQyxJQUFJQyxNQUFNLEdBQUcsRUFBRTtFQUNmLElBQUlDLGlCQUFpQixHQUFHLEtBQUs7RUFDN0IsSUFBSUMs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