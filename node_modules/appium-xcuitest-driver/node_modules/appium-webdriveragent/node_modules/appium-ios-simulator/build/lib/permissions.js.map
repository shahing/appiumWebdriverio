{"version":3,"file":"permissions.js","names":["STATUS_UNSET","STATUS_YES","STATUS_NO","WIX_SIM_UTILS","SERVICES","calendar","camera","contacts","homekit","microphone","photos","reminders","medialibrary","motion","health","siri","speech","toInternalServiceName","serviceName","_","has","toLower","Error","JSON","stringify","keys","formatStatus","status","includes","toUpper","execWix","args","fs","which","e","log","debug","util","quote","stdout","exec","stderr","message","Permissions","constructor","xcodeVersion","sharedResourcesDir","udid","tccDb","TCCDB","setAccess","bundleId","permissionsMapping","permissionsArg","toPairs","map","x","join","getAccess","sqlValue","count","execQuery","parseInt","split"],"sources":["../../lib/permissions.js"],"sourcesContent":["import _ from 'lodash';\nimport { fs, util } from '@appium/support';\nimport { exec } from 'teen_process';\nimport log from './logger';\nimport TCCDB from './tcc-db';\n\nconst STATUS_UNSET = 'unset';\nconst STATUS_YES = 'yes';\nconst STATUS_NO = 'no';\nconst WIX_SIM_UTILS = 'applesimutils';\nconst SERVICES = {\n  calendar: 'kTCCServiceCalendar',\n  camera: 'kTCCServiceCamera',\n  contacts: 'kTCCServiceAddressBook',\n  homekit: 'kTCCServiceWillow',\n  microphone: 'kTCCServiceMicrophone',\n  photos: 'kTCCServicePhotos',\n  reminders: 'kTCCServiceReminders',\n  medialibrary: 'kTCCServiceMediaLibrary',\n  motion: 'kTCCServiceMotion',\n  health: 'kTCCServiceMSO',\n  siri: 'kTCCServiceSiri',\n  speech: 'kTCCServiceSpeechRecognition',\n};\n\nfunction toInternalServiceName (serviceName) {\n  if (_.has(SERVICES, _.toLower(serviceName))) {\n    return SERVICES[_.toLower(serviceName)];\n  }\n  throw new Error(`'${serviceName}' is unknown. Only the following service names are supported: ${JSON.stringify(_.keys(SERVICES))}`);\n}\n\nfunction formatStatus (status) {\n  return [STATUS_UNSET, STATUS_NO].includes(status) ? _.toUpper(status) : status;\n}\n\nasync function execWix (args) {\n  try {\n    await fs.which(WIX_SIM_UTILS);\n  } catch (e) {\n    throw new Error(`${WIX_SIM_UTILS} binary has not been found in your PATH. ` +\n      `Please install it ('brew tap wix/brew && brew install wix/brew/applesimutils') to ` +\n      `be able to change application permissions`);\n  }\n\n  log.debug(`Executing: ${WIX_SIM_UTILS} ${util.quote(args)}`);\n  try {\n    const {stdout} = await exec(WIX_SIM_UTILS, args);\n    log.debug(`Command output: ${stdout}`);\n    return stdout;\n  } catch (e) {\n    throw new Error(`Cannot execute \"${WIX_SIM_UTILS} ${util.quote(args)}\". Original error: ${e.stderr || e.message}`);\n  }\n}\n\nclass Permissions {\n  constructor (xcodeVersion, sharedResourcesDir, udid) {\n    this.tccDb = new TCCDB(xcodeVersion, sharedResourcesDir);\n    this.udid = udid;\n  }\n\n  /**\n   * Sets permissions for the given application\n   *\n   * @param {string} bundleId - bundle identifier of the target application.\n   * @param {Object} permissionsMapping - An object, where keys ar  service names\n   * and values are corresponding state values. See https://github.com/wix/AppleSimulatorUtils\n   * for more details on available service names and statuses.\n   * @throws {Error} If there was an error while changing permissions.\n   */\n  async setAccess (bundleId, permissionsMapping) {\n    const permissionsArg = _.toPairs(permissionsMapping)\n      .map((x) => `${x[0]}=${formatStatus(x[1])}`)\n      .join(',');\n    return await execWix([\n      '--byId', this.udid,\n      '--bundle', bundleId,\n      '--setPermissions', permissionsArg,\n    ]);\n  }\n\n  /**\n   * Retrieves the current permission status for the given service and application.\n   *\n   * @param {string} bundleId - bundle identifier of the target application.\n   * @param {string} serviceName - the name of the service. Should be one of\n   * `SERVICES` keys.\n   * @returns {string} - The current status: yes/no/unset\n   * @throws {Error} If there was an error while retrieving permissions.\n   */\n  async getAccess (bundleId, serviceName) {\n    serviceName = toInternalServiceName(serviceName);\n\n    for (const [sqlValue, status] of [['0', STATUS_NO], ['1', STATUS_YES]]) {\n      const count = await this.tccDb.execQuery(`SELECT count(*) FROM 'access' WHERE client='?' AND allowed=? AND service='?'`,\n        bundleId, sqlValue, serviceName);\n      if (parseInt(count.split('=')[1], 10) > 0) {\n        return status;\n      }\n    }\n    return STATUS_UNSET;\n  }\n}\n\nexport default Permissions;\n"],"mappings":"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"}