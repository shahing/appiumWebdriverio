{"version":3,"file":"tail-until.js","names":["tailUntil","filePath","until","timeout","proc","SubProcess","startDetector","stdout","indexOf","B","resolve","reject","started","start","timedout","delay","then","Error","race","catch","finally","isRunning","stop","err","log","info","message"],"sources":["../../lib/tail-until.js"],"sourcesContent":["import { SubProcess } from 'teen_process';\nimport B from 'bluebird';\nimport log from './logger';\n\n// tails a file, promise resolves when input string is written to file\nasync function tailUntil (filePath, until, timeout = 5000) {\n  let proc = new SubProcess('tail', ['-f', '-n', '100', filePath]);\n\n  // // for debugging\n  // function consoleOut (...args) {\n  //   console.log(`>>> ${args}`); // eslint-disable-line no-console\n  // }\n  // proc.on('output', consoleOut);\n\n  const startDetector = (stdout) => stdout.indexOf(until) > -1;\n\n  return await new B((resolve, reject) => {\n    const started = proc.start(startDetector);\n\n    /* eslint-disable promise/prefer-await-to-then */\n    const timedout = B.delay(timeout).then(function () {\n      return reject(new Error(`Tailing file ${filePath} failed after ${timeout}ms`));\n    });\n    /* eslint-enable */\n\n    B.race([started, timedout]).then(resolve).catch(reject);\n  }).finally(async () => {\n    // no matter what, stop the tail process\n    if (proc.isRunning) {\n      try {\n        await proc.stop();\n      } catch (err) {\n        // there is not much we can do here, unfortunately, but log\n        log.info(`Stopping tail process failed: ${err.message}`);\n      }\n    }\n  });\n}\n\nexport { tailUntil };\n"],"mappings":";;;;;;;;AAAA;AACA;AACA;AAGA,eAAeA,SAAS,CAAEC,QAAQ,EAAEC,KAAK,EAAEC,OAAO,GAAG,IAAI,EAAE;EACzD,IAAIC,IAAI,GAAG,IAAIC,wBAAU,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,EAAEJ,QAAQ,CAAC,CAAC;EAQhE,MAAMK,aAAa,GAAIC,MAAM,IAAKA,MAAM,CAACC,OAAO,CAACN,KAAK,CAAC,GAAG,CAAC,CAAC;EAE5D,OAAO,MAAM,IAAIO,iBAAC,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;IACtC,MAAMC,OAAO,GAAGR,IAAI,CAACS,KAAK,CAACP,aAAa,CAAC;IAGzC,MAAMQ,QAAQ,GAAGL,iBAAC,CAACM,KAAK,CAACZ,OAAO,CAAC,CAACa,IAAI,CAAC,YAAY;MACjD,OAAOL,MAAM,CAAC,IAAIM,KAAK,CAAE,gBAAehB,QAAS,iBAAgBE,OAAQ,IAAG,CAAC,CAAC;IAChF,CAAC,CAAC;IAGFM,iBAAC,CAACS,IAAI,CAAC,CAACN,OAAO,EAAEE,QAAQ,CAAC,CAAC,CAACE,IAAI,CAACN,OAAO,CAAC,CAACS,KAAK,CAACR,MAAM,CAAC;EACzD,CAAC,CAAC,CAACS,OAAO,CAAC,YAAY;IAErB,IAAIhB,IAAI,CAACiB,SAAS,EAAE;MAClB,IAAI;QACF,MAAMjB,IAAI,CAACkB,IAAI,EAAE;MACnB,CAAC,CAAC,OAAOC,GAAG,EAAE;QAEZC,eAAG,CAACC,IAAI,CAAE,iCAAgCF,GAAG,CAACG,OAAQ,EAAC,CAAC;MAC1D;IACF;EACF,CAAC,CAAC;AACJ"}