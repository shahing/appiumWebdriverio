"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger"));
var _lodash = _interopRequireDefault(require("lodash"));
var _support = require("@appium/support");
var _events = _interopRequireDefault(require("events"));
class RpcMessageHandler extends _events.default {
  constructor(isTargetBased = false) {
    super();
    this.isTargetBased = isTargetBased;
  }
  get isTargetBased() {
    return this._isTargetBased;
  }
  set isTargetBased(isTargetBased) {
    this._isTargetBased = !!isTargetBased;
  }
  async handleMessage(plist) {
    const selector = plist.__selector;
    if (!selector) {
      _logger.default.debug('Got an invalid plist');
      return;
    }
    const argument = plist.__argument;
    switch (selector) {
      case '_rpc_reportSetup:':
        this.emit('_rpc_reportSetup:', null, argument.WIRSimulatorNameKey, argument.WIRSimulatorBuildKey, argument.WIRSimulatorProductVersionKey);
        break;
      case '_rpc_reportConnectedApplicationList:':
        this.emit('_rpc_reportConnectedApplicationList:', null, argument.WIRApplicationDictionaryKey);
        break;
      case '_rpc_applicationSentListing:':
        this.emit('_rpc_forwardGetListing:', null, argument.WIRApplicationIdentifierKey, argument.WIRListingKey);
        break;
      case '_rpc_applicationConnected:':
        this.emit('_rpc_applicationConnected:', null, argument);
        break;
      case '_rpc_applicationDisconnected:':
        this.emit('_rpc_applicationDisconnected:', null, argument);
        break;
      case '_rpc_applicationUpdated:':
        this.emit('_rpc_applicationUpdated:', null, argument);
        break;
      case '_rpc_reportConnectedDriverList:':
        this.emit('_rpc_reportConnectedDriverList:', null, argument);
        break;
      case '_rpc_reportCurrentState:':
        this.emit('_rpc_reportCurrentState:', null, argument);
        break;
      case '_rpc_applicationSentData:':
        await this.handleDataMessage(plist);
        break;
      default:
        _logger.default.debug(`Debugger got a message for '${selector}' and have no ` + `handler, doing nothing.`);
    }
  }
  parseDataKey(plist) {
    try {
      return JSON.parse(plist.__argument.WIRMessageDataKey.toString('utf8'));
    } catch (err) {
      _logger.default.error(`Unparseable message data: ${_lodash.default.truncate(JSON.stringify(plist), {
        length: 100
      })}`);
      throw new Error(`Unable to parse message data: ${err.message}`);
    }
  }
  async dispatchDataMessage(msgId, method, params, result, error) {
    if (!_lodash.default.isEmpty(msgId)) {
      _logger.default.debug(`Handling message (id: '${msgId}')`);
    }
    if (msgId) {
      if (this.listenerCount(msgId)) {
        var _result;
        if (_lodash.default.has((_result = result) === null || _result === void 0 ? void 0 : _result.result, 'value')) {
          result = result.result.value;
        }
        this.emit(msgId, error, result);
      } else {
        _logger.default.error(`Web Inspector returned data for message '${msgId}' ` + `but we were not waiting for that message! ` + `result: '${JSON.stringify(result)}'; ` + `error: '${JSON.stringify(error)}'`);
      }
      return;
    }
    let eventNames = [method];
    let args = [params];
    switch (method) {
      case 'Page.frameStoppedLoading':
        eventNames.push('Page.frameNavigated');
      case 'Page.frameNavigated':
        args = [`'${method}' event`];
        break;
      case 'Timeline.eventRecorded':
        args = [params || params.record];
        break;
      case 'Console.messageAdded':
        args = [params.message];
        break;
      case 'Runtime.executionContextCreated':
        args = [params.context];
        break;
      default:
        break;
    }
    if (_lodash.default.startsWith(method, 'Network.')) {
      eventNames.push('NetworkEvent');
      args.push(method);
    }
    if (_lodash.default.startsWith(method, 'Console.')) {
      eventNames.push('ConsoleEvent');
      args.push(method);
    }
    for (const name of eventNames) {
      this.emit(name, error, ...args);
    }
  }
  async handleDataMessage(plist) {
    var _result2;
    const dataKey = this.parseDataKey(plist);
    let msgId = (dataKey.id || '').toString();
    let result = dataKey.result;
    let method = dataKey.method;
    let params;
    if (method === 'Target.targetCreated') {
      const app = plist.__argument.WIRApplicationIdentifierKey;
      const targetInfo = dataKey.params.targetInfo;
      this.emit('Target.targetCreated', null, app, targetInfo);
      return;
    } else if (method === 'Target.didCommitProvisionalTarget') {
      const app = plist.__argument.WIRApplicationIdentifierKey;
      const oldTargetId = dataKey.params.oldTargetId;
      const newTargetId = dataKey.params.newTargetId;
      this.emit('Target.didCommitProvisionalTarget', null, app, oldTargetId, newTargetId);
      return;
    } else if (method === 'Target.targetDestroyed') {
      const app = plist.__argument.WIRApplicationIdentifierKey;
      const targetInfo = dataKey.params.targetInfo || {
        targetId: dataKey.params.targetId
      };
      this.emit('Target.targetDestroyed', null, app, targetInfo);
      return;
    }
    if (!dataKey.error && this.isTargetBased) {
      if (dataKey.method !== 'Target.dispatchMessageFromTarget') {
        return;
      }
      let message;
      try {
        message = JSON.parse(dataKey.params.message);
        msgId = message.id;
        method = message.method;
        result = message.result || message;
        params = result.params;
      } catch (err) {
        _logger.default.error(`Unexpected message format from Web Inspector:`);
        this.warn(_support.util.jsonStringify(plist));
        throw err;
      }
    } else {
      params = dataKey.params;
    }
    let error = dataKey.error || null;
    if ((_result2 = result) !== null && _result2 !== void 0 && _result2.wasThrown) {
      var _result3, _result3$result, _result4, _result4$result, _result5, _result5$result, _result6, _result6$result;
      const message = (_result3 = result) !== null && _result3 !== void 0 && (_result3$result = _result3.result) !== null && _result3$result !== void 0 && _result3$result.value || (_result4 = result) !== null && _result4 !== void 0 && (_result4$result = _result4.result) !== null && _result4$result !== void 0 && _result4$result.description ? ((_result5 = result) === null || _result5 === void 0 ? void 0 : (_result5$result = _result5.result) === null || _result5$result === void 0 ? void 0 : _result5$result.value) || ((_result6 = result) === null || _result6 === void 0 ? void 0 : (_result6$result = _result6.result) === null || _result6$result === void 0 ? void 0 : _result6$result.description) : 'Error occurred in handling data message';
      error = new Error(message);
    }
    await this.dispatchDataMessage(msgId, method, params, result, error);
  }
}
exports.default = RpcMessageHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJScGNNZXNzYWdlSGFuZGxlciIsIkV2ZW50RW1pdHRlcnMiLCJjb25zdHJ1Y3RvciIsImlzVGFyZ2V0QmFzZWQiLCJfaXNUYXJnZXRCYXNlZCIsImhhbmRsZU1lc3NhZ2UiLCJwbGlzdCIsInNlbGVjdG9yIiwiX19zZWxlY3RvciIsImxvZyIsImRlYnVnIiwiYXJndW1lbnQiLCJfX2FyZ3VtZW50IiwiZW1pdCIsIldJUlNpbXVsYXRvck5hbWVLZXkiLCJXSVJTaW11bGF0b3JCdWlsZEtleSIsIldJUlNpbXVsYXRvclByb2R1Y3RWZXJzaW9uS2V5IiwiV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5IiwiV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5IiwiV0lSTGlzdGluZ0tleSIsImhhbmRsZURhdGFNZXNzYWdlIiwicGFyc2VEYXRhS2V5IiwiSlNPTiIsInBhcnNlIiwiV0lSTWVzc2FnZURhdGFLZXkiLCJ0b1N0cmluZyIsImVyciIsImVycm9yIiwiXyIsInRydW5jYXRlIiwic3RyaW5naWZ5IiwibGVuZ3RoIiwiRXJyb3IiLCJtZXNzYWdlIiwiZGlzcGF0Y2hEYXRhTWVzc2FnZSIsIm1zZ0lkIiwibWV0aG9kIiwicGFyYW1zIiwicmVzdWx0IiwiaXNFbXB0eSIsImxpc3RlbmVyQ291bnQiLCJoYXMiLCJ2YWx1ZSIsImV2ZW50TmFtZXMiLCJhcmdzIiwicHVzaCIsInJlY29yZCIsImNvbnRleHQiLCJzdGFydHNXaXRoIiwibmFtZSIsImRhdGFLZXkiLCJpZCIsImFwcCIsInRhcmdldEluZm8iLCJvbGRUYXJnZXRJZCIsIm5ld1RhcmdldElkIiwidGFyZ2V0SWQiLCJ3YXJuIiwidXRpbCIsImpzb25TdHJpbmdpZnkiLCJ3YXNUaHJvd24iLCJkZXNjcmlwdGlvbiJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9ycGMvcnBjLW1lc3NhZ2UtaGFuZGxlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgRXZlbnRFbWl0dGVycyBmcm9tICdldmVudHMnO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJwY01lc3NhZ2VIYW5kbGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVycyB7XG4gIGNvbnN0cnVjdG9yIChpc1RhcmdldEJhc2VkID0gZmFsc2UpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5pc1RhcmdldEJhc2VkID0gaXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIGdldCBpc1RhcmdldEJhc2VkICgpIHtcbiAgICByZXR1cm4gdGhpcy5faXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIHNldCBpc1RhcmdldEJhc2VkIChpc1RhcmdldEJhc2VkKSB7XG4gICAgdGhpcy5faXNUYXJnZXRCYXNlZCA9ICEhaXNUYXJnZXRCYXNlZDtcbiAgfVxuXG4gIGFzeW5jIGhhbmRsZU1lc3NhZ2UgKHBsaXN0KSB7XG4gICAgY29uc3Qgc2VsZWN0b3IgPSBwbGlzdC5fX3NlbGVjdG9yO1xuICAgIGlmICghc2VsZWN0b3IpIHtcbiAgICAgIGxvZy5kZWJ1ZygnR290IGFuIGludmFsaWQgcGxpc3QnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBhcmd1bWVudCA9IHBsaXN0Ll9fYXJndW1lbnQ7XG4gICAgc3dpdGNoIChzZWxlY3Rvcikge1xuICAgICAgY2FzZSAnX3JwY19yZXBvcnRTZXR1cDonOlxuICAgICAgICB0aGlzLmVtaXQoJ19ycGNfcmVwb3J0U2V0dXA6JyxcbiAgICAgICAgICBudWxsLFxuICAgICAgICAgIGFyZ3VtZW50LldJUlNpbXVsYXRvck5hbWVLZXksXG4gICAgICAgICAgYXJndW1lbnQuV0lSU2ltdWxhdG9yQnVpbGRLZXksXG4gICAgICAgICAgYXJndW1lbnQuV0lSU2ltdWxhdG9yUHJvZHVjdFZlcnNpb25LZXlcbiAgICAgICAgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonOlxuICAgICAgICB0aGlzLmVtaXQoJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0OicsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBhcmd1bWVudC5XSVJBcHBsaWNhdGlvbkRpY3Rpb25hcnlLZXlcbiAgICAgICAgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdfcnBjX2FwcGxpY2F0aW9uU2VudExpc3Rpbmc6JzpcbiAgICAgICAgdGhpcy5lbWl0KCdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOicsXG4gICAgICAgICAgbnVsbCxcbiAgICAgICAgICBhcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXksXG4gICAgICAgICAgYXJndW1lbnQuV0lSTGlzdGluZ0tleVxuICAgICAgICApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JzpcbiAgICAgICAgdGhpcy5lbWl0KCdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicsIG51bGwsIGFyZ3VtZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOic6XG4gICAgICAgIHRoaXMuZW1pdCgnX3JwY19hcHBsaWNhdGlvbkRpc2Nvbm5lY3RlZDonLCBudWxsLCBhcmd1bWVudCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnX3JwY19hcHBsaWNhdGlvblVwZGF0ZWQ6JzpcbiAgICAgICAgdGhpcy5lbWl0KCdfcnBjX2FwcGxpY2F0aW9uVXBkYXRlZDonLCBudWxsLCBhcmd1bWVudCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnX3JwY19yZXBvcnRDb25uZWN0ZWREcml2ZXJMaXN0Oic6XG4gICAgICAgIHRoaXMuZW1pdCgnX3JwY19yZXBvcnRDb25uZWN0ZWREcml2ZXJMaXN0OicsIG51bGwsIGFyZ3VtZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdfcnBjX3JlcG9ydEN1cnJlbnRTdGF0ZTonOlxuICAgICAgICB0aGlzLmVtaXQoJ19ycGNfcmVwb3J0Q3VycmVudFN0YXRlOicsIG51bGwsIGFyZ3VtZW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdfcnBjX2FwcGxpY2F0aW9uU2VudERhdGE6JzpcbiAgICAgICAgYXdhaXQgdGhpcy5oYW5kbGVEYXRhTWVzc2FnZShwbGlzdCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgbG9nLmRlYnVnKGBEZWJ1Z2dlciBnb3QgYSBtZXNzYWdlIGZvciAnJHtzZWxlY3Rvcn0nIGFuZCBoYXZlIG5vIGAgK1xuICAgICAgICAgIGBoYW5kbGVyLCBkb2luZyBub3RoaW5nLmApO1xuICAgIH1cbiAgfVxuXG4gIHBhcnNlRGF0YUtleSAocGxpc3QpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2UocGxpc3QuX19hcmd1bWVudC5XSVJNZXNzYWdlRGF0YUtleS50b1N0cmluZygndXRmOCcpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvcihgVW5wYXJzZWFibGUgbWVzc2FnZSBkYXRhOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkocGxpc3QpLCB7bGVuZ3RoOiAxMDB9KX1gKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIHBhcnNlIG1lc3NhZ2UgZGF0YTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkaXNwYXRjaERhdGFNZXNzYWdlIChtc2dJZCwgbWV0aG9kLCBwYXJhbXMsIHJlc3VsdCwgZXJyb3IpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgaWYgKCFfLmlzRW1wdHkobXNnSWQpKSB7XG4gICAgICBsb2cuZGVidWcoYEhhbmRsaW5nIG1lc3NhZ2UgKGlkOiAnJHttc2dJZH0nKWApO1xuICAgIH1cblxuICAgIGlmIChtc2dJZCkge1xuICAgICAgaWYgKHRoaXMubGlzdGVuZXJDb3VudChtc2dJZCkpIHtcbiAgICAgICAgaWYgKF8uaGFzKHJlc3VsdD8ucmVzdWx0LCAndmFsdWUnKSkge1xuICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5yZXN1bHQudmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lbWl0KG1zZ0lkLCBlcnJvciwgcmVzdWx0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5lcnJvcihgV2ViIEluc3BlY3RvciByZXR1cm5lZCBkYXRhIGZvciBtZXNzYWdlICcke21zZ0lkfScgYCArXG4gICAgICAgICAgYGJ1dCB3ZSB3ZXJlIG5vdCB3YWl0aW5nIGZvciB0aGF0IG1lc3NhZ2UhIGAgK1xuICAgICAgICAgIGByZXN1bHQ6ICcke0pTT04uc3RyaW5naWZ5KHJlc3VsdCl9JzsgYCArXG4gICAgICAgICAgYGVycm9yOiAnJHtKU09OLnN0cmluZ2lmeShlcnJvcil9J2ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBldmVudE5hbWVzID0gW21ldGhvZF07XG4gICAgbGV0IGFyZ3MgPSBbcGFyYW1zXTtcblxuICAgIC8vIHNvbWUgZXZlbnRzIGhhdmUgZGlmZmVyZW50IG5hbWVzLCBvciB0aGUgYXJndW1lbnRzIGFyZSBtYXBwZWQgZnJvbSB0aGVcbiAgICAvLyBwYXJhbWV0ZXJzIHJlY2VpdmVkXG4gICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgIGNhc2UgJ1BhZ2UuZnJhbWVTdG9wcGVkTG9hZGluZyc6XG4gICAgICAgIGV2ZW50TmFtZXMucHVzaCgnUGFnZS5mcmFtZU5hdmlnYXRlZCcpO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWZhbGx0aHJvdWdoXG4gICAgICBjYXNlICdQYWdlLmZyYW1lTmF2aWdhdGVkJzpcbiAgICAgICAgYXJncyA9IFtgJyR7bWV0aG9kfScgZXZlbnRgXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdUaW1lbGluZS5ldmVudFJlY29yZGVkJzpcbiAgICAgICAgYXJncyA9IFtwYXJhbXMgfHwgcGFyYW1zLnJlY29yZF07XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQ29uc29sZS5tZXNzYWdlQWRkZWQnOlxuICAgICAgICBhcmdzID0gW3BhcmFtcy5tZXNzYWdlXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdSdW50aW1lLmV4ZWN1dGlvbkNvbnRleHRDcmVhdGVkJzpcbiAgICAgICAgYXJncyA9IFtwYXJhbXMuY29udGV4dF07XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgLy8gcGFzc1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBpZiAoXy5zdGFydHNXaXRoKG1ldGhvZCwgJ05ldHdvcmsuJykpIHtcbiAgICAgIC8vIGFnZ3JlZ2F0ZSBOZXR3b3JrIGV2ZW50cywgYW5kIGFkZCBvcmlnaW5hbCBtZXRob2QgbmFtZSB0byB0aGUgYXJndW1lbnRzXG4gICAgICBldmVudE5hbWVzLnB1c2goJ05ldHdvcmtFdmVudCcpO1xuICAgICAgYXJncy5wdXNoKG1ldGhvZCk7XG4gICAgfVxuICAgIGlmIChfLnN0YXJ0c1dpdGgobWV0aG9kLCAnQ29uc29sZS4nKSkge1xuICAgICAgLy8gYWdncmVnYXRlIE5ldHdvcmsgZXZlbnRzLCBhbmQgYWRkIG9yaWdpbmFsIG1ldGhvZCBuYW1lIHRvIHRoZSBhcmd1bWVudHNcbiAgICAgIGV2ZW50TmFtZXMucHVzaCgnQ29uc29sZUV2ZW50Jyk7XG4gICAgICBhcmdzLnB1c2gobWV0aG9kKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgZXZlbnROYW1lcykge1xuICAgICAgdGhpcy5lbWl0KG5hbWUsIGVycm9yLCAuLi5hcmdzKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBoYW5kbGVEYXRhTWVzc2FnZSAocGxpc3QpIHtcbiAgICBjb25zdCBkYXRhS2V5ID0gdGhpcy5wYXJzZURhdGFLZXkocGxpc3QpO1xuICAgIGxldCBtc2dJZCA9IChkYXRhS2V5LmlkIHx8ICcnKS50b1N0cmluZygpO1xuICAgIGxldCByZXN1bHQgPSBkYXRhS2V5LnJlc3VsdDtcblxuICAgIGxldCBtZXRob2QgPSBkYXRhS2V5Lm1ldGhvZDtcbiAgICBsZXQgcGFyYW1zO1xuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ1RhcmdldC50YXJnZXRDcmVhdGVkJykge1xuICAgICAgLy8gdGhpcyBpcyBpbiByZXNwb25zZSB0byBhIGBfcnBjX2ZvcndhcmRTb2NrZXRTZXR1cDpgIGNhbGxcbiAgICAgIC8vIHRhcmdldEluZm86IHsgdGFyZ2V0SWQ6ICdwYWdlLTEnLCB0eXBlOiAncGFnZScgfVxuICAgICAgY29uc3QgYXBwID0gcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gICAgICBjb25zdCB0YXJnZXRJbmZvID0gZGF0YUtleS5wYXJhbXMudGFyZ2V0SW5mbztcbiAgICAgIHRoaXMuZW1pdCgnVGFyZ2V0LnRhcmdldENyZWF0ZWQnLCBudWxsLCBhcHAsIHRhcmdldEluZm8pO1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnVGFyZ2V0LmRpZENvbW1pdFByb3Zpc2lvbmFsVGFyZ2V0Jykge1xuICAgICAgY29uc3QgYXBwID0gcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gICAgICBjb25zdCBvbGRUYXJnZXRJZCA9IGRhdGFLZXkucGFyYW1zLm9sZFRhcmdldElkO1xuICAgICAgY29uc3QgbmV3VGFyZ2V0SWQgPSBkYXRhS2V5LnBhcmFtcy5uZXdUYXJnZXRJZDtcbiAgICAgIHRoaXMuZW1pdCgnVGFyZ2V0LmRpZENvbW1pdFByb3Zpc2lvbmFsVGFyZ2V0JywgbnVsbCwgYXBwLCBvbGRUYXJnZXRJZCwgbmV3VGFyZ2V0SWQpO1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAnVGFyZ2V0LnRhcmdldERlc3Ryb3llZCcpIHtcbiAgICAgIGNvbnN0IGFwcCA9IHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5O1xuICAgICAgY29uc3QgdGFyZ2V0SW5mbyA9IGRhdGFLZXkucGFyYW1zLnRhcmdldEluZm8gfHwge3RhcmdldElkOiBkYXRhS2V5LnBhcmFtcy50YXJnZXRJZH07XG4gICAgICB0aGlzLmVtaXQoJ1RhcmdldC50YXJnZXREZXN0cm95ZWQnLCBudWxsLCBhcHAsIHRhcmdldEluZm8pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghZGF0YUtleS5lcnJvciAmJiB0aGlzLmlzVGFyZ2V0QmFzZWQpIHtcbiAgICAgIGlmIChkYXRhS2V5Lm1ldGhvZCAhPT0gJ1RhcmdldC5kaXNwYXRjaE1lc3NhZ2VGcm9tVGFyZ2V0Jykge1xuICAgICAgICAvLyB0aGlzIHNvcnQgb2YgbWVzc2FnZSwgYXQgdGhpcyBwb2ludCwgaXMganVzdCBhbiBhY2tub3dsZWRnZW1lbnRcbiAgICAgICAgLy8gdGhhdCB0aGUgb3JpZ2luYWwgbWVzc2FnZSB3YXMgcmVjZWl2ZWRcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBhdCB0aGlzIHBvaW50LCB3ZSBoYXZlIGEgVGFyZ2V0LWJhc2VkIG1lc3NhZ2Ugd3JhcHBpbmcgYSBwcm90b2NvbCBtZXNzYWdlXG4gICAgICBsZXQgbWVzc2FnZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIG1lc3NhZ2UgPSBKU09OLnBhcnNlKGRhdGFLZXkucGFyYW1zLm1lc3NhZ2UpO1xuICAgICAgICBtc2dJZCA9IG1lc3NhZ2UuaWQ7XG4gICAgICAgIG1ldGhvZCA9IG1lc3NhZ2UubWV0aG9kO1xuICAgICAgICByZXN1bHQgPSBtZXNzYWdlLnJlc3VsdCB8fCBtZXNzYWdlO1xuICAgICAgICBwYXJhbXMgPSByZXN1bHQucGFyYW1zO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIGlmIHRoaXMgaGFwcGVucyB0aGVuIHNvbWUgYXNwZWN0IG9mIHRoZSBwcm90b2NvbCBpcyBtaXNzaW5nIHRvIHVzXG4gICAgICAgIC8vIHNvIHByaW50IHRoZSBlbnRpcmUgbWVzc2FnZSB0byBnZXQgdmlzaWJpaXR5IGludG8gd2hhdCBpcyBnb2luZyBvblxuICAgICAgICBsb2cuZXJyb3IoYFVuZXhwZWN0ZWQgbWVzc2FnZSBmb3JtYXQgZnJvbSBXZWIgSW5zcGVjdG9yOmApO1xuICAgICAgICB0aGlzLndhcm4odXRpbC5qc29uU3RyaW5naWZ5KHBsaXN0KSk7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zID0gZGF0YUtleS5wYXJhbXM7XG4gICAgfVxuXG4gICAgLy8gd2UgY2FuIGdldCBhbiBlcnJvciwgb3Igd2UgY2FuIGdldCBhIHJlc3BvbnNlIHRoYXQgaXMgYW4gZXJyb3JcbiAgICBsZXQgZXJyb3IgPSBkYXRhS2V5LmVycm9yIHx8IG51bGw7XG4gICAgaWYgKHJlc3VsdD8ud2FzVGhyb3duKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gKHJlc3VsdD8ucmVzdWx0Py52YWx1ZSB8fCByZXN1bHQ/LnJlc3VsdD8uZGVzY3JpcHRpb24pXG4gICAgICAgID8gKHJlc3VsdD8ucmVzdWx0Py52YWx1ZSB8fCByZXN1bHQ/LnJlc3VsdD8uZGVzY3JpcHRpb24pXG4gICAgICAgIDogJ0Vycm9yIG9jY3VycmVkIGluIGhhbmRsaW5nIGRhdGEgbWVzc2FnZSc7XG4gICAgICBlcnJvciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmRpc3BhdGNoRGF0YU1lc3NhZ2UobXNnSWQsIG1ldGhvZCwgcGFyYW1zLCByZXN1bHQsIGVycm9yKTtcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBR2UsTUFBTUEsaUJBQWlCLFNBQVNDLGVB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