"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger"));
var _utils = require("../utils");
var _events = _interopRequireDefault(require("./events"));
var _support = require("@appium/support");
var _asyncbox = require("asyncbox");
var _lodash = _interopRequireDefault(require("lodash"));
const APP_CONNECT_TIMEOUT_MS = 0;
const APP_CONNECT_INTERVAL_MS = 100;
const SELECT_APP_RETRIES = 20;
const SELECT_APP_RETRY_SLEEP_MS = 500;
const SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
const BLANK_PAGE_URL = 'about:blank';
async function setConnectionKey() {
  _logger.default.debug('Sending connection key request');
  await this.rpcClient.send('setConnectionKey', {}, false);
}
async function connect(timeout = APP_CONNECT_TIMEOUT_MS) {
  this.setup();
  this.initRpcClient();
  this.rpcClient.on('_rpc_reportSetup:', _lodash.default.noop);
  this.rpcClient.on('_rpc_forwardGetListing:', this.onPageChange.bind(this));
  this.rpcClient.on('_rpc_reportConnectedApplicationList:', this.onConnectedApplicationList.bind(this));
  this.rpcClient.on('_rpc_applicationConnected:', this.onAppConnect.bind(this));
  this.rpcClient.on('_rpc_applicationDisconnected:', this.onAppDisconnect.bind(this));
  this.rpcClient.on('_rpc_applicationUpdated:', this.onAppUpdate.bind(this));
  this.rpcClient.on('_rpc_reportConnectedDriverList:', this.onConnectedDriverList.bind(this));
  this.rpcClient.on('_rpc_reportCurrentState:', this.onCurrentState.bind(this));
  this.rpcClient.on('Page.frameDetached', this.frameDetached.bind(this));
  await this.rpcClient.connect();
  try {
    await this.setConnectionKey();
    if (timeout) {
      _logger.default.debug(`Waiting up to ${timeout}ms for applications to be reported`);
      try {
        await (0, _asyncbox.waitForCondition)(() => !_lodash.default.isEmpty(this.appDict), {
          waitMs: timeout,
          interval: APP_CONNECT_INTERVAL_MS
        });
      } catch (err) {
        _logger.default.debug(`Timed out waiting for applications to be reported`);
      }
    }
    return this.appDict || {};
  } catch (err) {
    _logger.default.error(`Error setting connection key: ${err.message}`);
    await this.disconnect();
    throw err;
  }
}
async function disconnect() {
  if (this.rpcClient) {
    await this.rpcClient.disconnect();
  }
  this.emit(_events.default.EVENT_DISCONNECT, true);
  this.teardown();
}
async function selectApp(currentUrl = null, maxTries = SELECT_APP_RETRIES, ignoreAboutBlankUrl = false) {
  const shouldCheckForTarget = this.rpcClient.shouldCheckForTarget;
  this.rpcClient.shouldCheckForTarget = false;
  try {
    const timer = new _support.timing.Timer().start();
    _logger.default.debug('Selecting application');
    if (!this.appDict || _lodash.default.isEmpty(this.appDict)) {
      _logger.default.debug('No applications currently connected.');
      return [];
    }
    const {
      appIdKey,
      pageDict
    } = await this.searchForApp(currentUrl, maxTries, ignoreAboutBlankUrl);
    if (!appIdKey || !pageDict) {
      _logger.default.errorAndThrow(`Could not connect to a valid app after ${maxTries} tries.`);
    }
    if (this.appIdKey !== appIdKey) {
      _logger.default.debug(`Received altered app id, updating from '${this.appIdKey}' to '${appIdKey}'`);
      this.appIdKey = appIdKey;
    }
    logApplicationDictionary(this.appDict);
    const pageArray = _lodash.default.isEmpty(this.appDict[appIdKey].pageArray) ? (0, _utils.pageArrayFromDict)(pageDict) : this.appDict[appIdKey].pageArray;
    _logger.default.debug(`Finally selecting app ${this.appIdKey}: ${(0, _utils.simpleStringify)(pageArray)}`);
    let fullPageArray = [];
    for (const [app, info] of _lodash.default.toPairs(this.appDict)) {
      if (!_lodash.default.isArray(info.pageArray) || !info.isActive) {
        continue;
      }
      const id = app.replace('PID:', '');
      for (const page of info.pageArray) {
        if (!(ignoreAboutBlankUrl && page.url === BLANK_PAGE_URL)) {
          let pageDict = _lodash.default.clone(page);
          pageDict.id = `${id}.${pageDict.id}`;
          pageDict.bundleId = info.bundleId;
          fullPageArray.push(pageDict);
        }
      }
    }
    _logger.default.debug(`Selected app after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    return fullPageArray;
  } finally {
    this.rpcClient.shouldCheckForTarget = shouldCheckForTarget;
  }
}
async function searchForApp(currentUrl, maxTries, ignoreAboutBlankUrl) {
  const bundleIds = this.includeSafari && !this.isSafari ? [this.bundleId, ...this.additionalBundleIds, SAFARI_BUNDLE_ID] : [this.bundleId, ...this.additionalBundleIds];
  try {
    return await (0, _asyncbox.retryInterval)(maxTries, SELECT_APP_RETRY_SLEEP_MS, async retryCount => {
      logApplicationDictionary(this.appDict);
      const possibleAppIds = (0, _utils.getPossibleDebuggerAppKeys)(bundleIds, this.appDict);
      _logger.default.debug(`Trying out the possible app ids: ${possibleAppIds.join(', ')} (try #${retryCount + 1} of ${maxTries})`);
      for (const attemptedAppIdKey of possibleAppIds) {
        try {
          if (!this.appDict[attemptedAppIdKey].isActive) {
            _logger.default.debug(`Skipping app '${attemptedAppIdKey}' because it is not active`);
            continue;
          }
          _logger.default.debug(`Attempting app '${attemptedAppIdKey}'`);
          const [appIdKey, pageDict] = await this.rpcClient.selectApp(attemptedAppIdKey, this.onAppConnect.bind(this));
          if (_lodash.default.isEmpty(pageDict)) {
            _logger.default.debug('Empty page dictionary received. Trying again.');
            continue;
          }
          this.appDict[appIdKey].pageArray = (0, _utils.pageArrayFromDict)(pageDict);
          const result = this.searchForPage(this.appDict, currentUrl, ignoreAboutBlankUrl);
          if (result) {
            return result;
          }
          if (currentUrl) {
            _logger.default.debug(`Received app, but expected url ('${currentUrl}') was not found. Trying again.`);
          } else {
            _logger.default.debug('Received app, but no match was found. Trying again.');
          }
        } catch (err) {
          _logger.default.debug(`Error checking application: '${err.message}'. Retrying connection`);
        }
      }
      retryCount++;
      throw new Error('Failed to find an app to select');
    }, 0);
  } catch (ign) {
    _logger.default.errorAndThrow(`Could not connect to a valid app after ${maxTries} tries.`);
  }
}
function searchForPage(appsDict, currentUrl = null, ignoreAboutBlankUrl = false) {
  for (const appDict of _lodash.default.values(appsDict)) {
    if (!appDict || !appDict.isActive || !appDict.pageArray || appDict.pageArray.promise) {
      continue;
    }
    for (const dict of appDict.pageArray) {
      if ((!ignoreAboutBlankUrl || dict.url !== BLANK_PAGE_URL) && (!currentUrl || dict.url === currentUrl || dict.url === `${currentUrl}/`)) {
        return {
          appIdKey: appDict.id,
          pageDict: dict
        };
      }
    }
  }
  return null;
}
async function selectPage(appIdKey, pageIdKey, skipReadyCheck = false) {
  this.appIdKey = `PID:${appIdKey}`;
  this.pageIdKey = pageIdKey;
  _logger.default.debug(`Selecting page '${pageIdKey}' on app '${this.appIdKey}' and forwarding socket setup`);
  const timer = new _support.timing.Timer().start();
  await this.rpcClient.selectPage(this.appIdKey, pageIdKey);
  if (!skipReadyCheck && !(await this.checkPageIsReady())) {
    await this.pageUnload();
  }
  _logger.default.debug(`Selected page after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
}
function logApplicationDictionary(apps) {
  function getValueString(key, value) {
    if (_lodash.default.isFunction(value)) {
      return '[Function]';
    }
    if (key === 'pageArray' && !_lodash.default.isArray(value)) {
      return `"Waiting for data"`;
    }
    return JSON.stringify(value);
  }
  _logger.default.debug('Current applications available:');
  for (const [app, info] of _lodash.default.toPairs(apps)) {
    _logger.default.debug(`    Application: "${app}"`);
    for (const [key, value] of _lodash.default.toPairs(info)) {
      if (key === 'pageArray' && Array.isArray(value) && value.length) {
        _logger.default.debug(`        ${key}:`);
        for (const page of value) {
          let prefix = '- ';
          for (const [k, v] of _lodash.default.toPairs(page)) {
            _logger.default.debug(`          ${prefix}${k}: ${JSON.stringify(v)}`);
            prefix = '  ';
          }
        }
      } else {
        const valueString = getValueString(key, value);
        _logger.default.debug(`        ${key}: ${valueString}`);
      }
    }
  }
}
function updateAppsWithDict(dict) {
  this.appDict = this.appDict || {};
  let [id, entry] = (0, _utils.appInfoFromDict)(dict);
  if (this.appDict[id]) {
    entry.pageArray = this.appDict[id].pageArray;
  }
  this.appDict[id] = entry;
  if (_lodash.default.isUndefined(entry.pageArray)) {
    entry.pageArray = (0, _utils.deferredPromise)();
  }
  if (!this.appIdKey) {
    this.appIdKey = (0, _utils.getDebuggerAppKey)(this.bundleId, this.appDict);
  }
}
var _default = {
  setConnectionKey,
  connect,
  disconnect,
  selectApp,
  searchForApp,
  searchForPage,
  selectPage,
  updateAppsWithDict
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBUFBfQ09OTkVDVF9USU1FT1VUX01TIiwiQVBQX0NPTk5FQ1RfSU5URVJWQUxfTVMiLCJTRUxFQ1RfQVBQX1JFVFJJRVMiLCJTRUxFQ1RfQVBQX1JFVFJZX1NMRUVQX01TIiwiU0FGQVJJX0JVTkRMRV9JRCIsIkJMQU5LX1BBR0VfVVJMIiwic2V0Q29ubmVjdGlvbktleSIsImxvZyIsImRlYnVnIiwicnBjQ2xpZW50Iiwic2VuZCIsImNvbm5lY3QiLCJ0aW1lb3V0Iiwic2V0dXAiLCJpbml0UnBjQ2xpZW50Iiwib24iLCJfIiwibm9vcCIsIm9uUGFnZUNoYW5nZSIsImJpbmQiLCJvbkNvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdCIsIm9uQXBwQ29ubmVjdCIsIm9uQXBwRGlzY29ubmVjdCIsIm9uQXBwVXBkYXRlIiwib25Db25uZWN0ZWREcml2ZXJMaXN0Iiwib25DdXJyZW50U3RhdGUiLCJmcmFtZURldGFjaGVkIiwid2FpdEZvckNvbmRpdGlvbiIsImlzRW1wdHkiLCJhcHBEaWN0Iiwid2FpdE1zIiwiaW50ZXJ2YWwiLCJlcnIiLCJlcnJvciIsIm1lc3NhZ2UiLCJkaXNjb25uZWN0IiwiZW1pdCIsImV2ZW50cyIsIkVWRU5UX0RJU0NPTk5FQ1QiLCJ0ZWFyZG93biIsInNlbGVjdEFwcCIsImN1cnJlbnRVcmwiLCJtYXhUcmllcyIsImlnbm9yZUFib3V0QmxhbmtVcmwiLCJzaG91bGRDaGVja0ZvclRhcmdldCIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsImFwcElkS2V5IiwicGFnZURpY3QiLCJzZWFyY2hGb3JBcHAiLCJlcnJvckFuZFRocm93IiwibG9nQXBwbGljYXRpb25EaWN0aW9uYXJ5IiwicGFnZUFycmF5IiwicGFnZUFycmF5RnJvbURpY3QiLCJzaW1wbGVTdHJpbmdpZnkiLCJmdWxsUGFnZUFycmF5IiwiYXBwIiwiaW5mbyIsInRvUGFpcnMiLCJpc0FycmF5IiwiaXNBY3RpdmUiLCJpZCIsInJlcGxhY2UiLCJwYWdlIiwidXJsIiwiY2xvbmUiLCJidW5kbGVJZCIsInB1c2giLCJnZXREdXJhdGlvbiIsImFzTWlsbGlTZWNvbmRzIiwidG9GaXhlZCIsImJ1bmRsZUlkcyIsImluY2x1ZGVTYWZhcmkiLCJpc1NhZmFyaSIsImFkZGl0aW9uYWxCdW5kbGVJZHMiLCJyZXRyeUludGVydmFsIiwicmV0cnlDb3VudCIsInBvc3NpYmxlQXBwSWRzIiwiZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMiLCJqb2luIiwiYXR0ZW1wdGVkQXBwSWRLZXkiLCJyZXN1bHQiLCJzZWFyY2hGb3JQYWdlIiwiRXJyb3IiLCJpZ24iLCJhcHBzRGljdCIsInZhbHVlcyIsInByb21pc2UiLCJkaWN0Iiwic2VsZWN0UGFnZSIsInBhZ2VJZEtleSIsInNraXBSZWFkeUNoZWNrIiwiY2hlY2tQYWdlSXNSZWFkeSIsInBhZ2VVbmxvYWQiLCJhcHBzIiwiZ2V0VmFsdWVTdHJpbmciLCJrZXkiLCJ2YWx1ZSIsImlzRnVuY3Rpb24iLCJKU09OIiwic3RyaW5naWZ5IiwiQXJyYXkiLCJsZW5ndGgiLCJwcmVmaXgiLCJrIiwidiIsInZhbHVlU3RyaW5nIiwidXBkYXRlQXBwc1dpdGhEaWN0IiwiZW50cnkiLCJhcHBJbmZvRnJvbURpY3QiLCJpc1VuZGVmaW5lZCIsImRlZmVycmVkUHJvbWlzZSIsImdldERlYnVnZ2VyQXBwS2V5Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL21peGlucy9jb25uZWN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGFwcEluZm9Gcm9tRGljdCwgcGFnZUFycmF5RnJvbURpY3QsIGdldERlYnVnZ2VyQXBwS2V5LFxuICAgICAgICAgZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMsIHNpbXBsZVN0cmluZ2lmeSwgZGVmZXJyZWRQcm9taXNlIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICcuL2V2ZW50cyc7XG5pbXBvcnQgeyB0aW1pbmcgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCwgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5cblxuY29uc3QgQVBQX0NPTk5FQ1RfVElNRU9VVF9NUyA9IDA7XG5jb25zdCBBUFBfQ09OTkVDVF9JTlRFUlZBTF9NUyA9IDEwMDtcbmNvbnN0IFNFTEVDVF9BUFBfUkVUUklFUyA9IDIwO1xuY29uc3QgU0VMRUNUX0FQUF9SRVRSWV9TTEVFUF9NUyA9IDUwMDtcbmNvbnN0IFNBRkFSSV9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLm1vYmlsZXNhZmFyaSc7XG5jb25zdCBCTEFOS19QQUdFX1VSTCA9ICdhYm91dDpibGFuayc7XG5cblxuYXN5bmMgZnVuY3Rpb24gc2V0Q29ubmVjdGlvbktleSAoKSB7XG4gIGxvZy5kZWJ1ZygnU2VuZGluZyBjb25uZWN0aW9uIGtleSByZXF1ZXN0Jyk7XG4gIC8vIHNlbmQgYnV0IG9ubHkgd2FpdCB0byBtYWtlIHN1cmUgdGhlIHNvY2tldCB3b3JrZWRcbiAgLy8gYXMgcmVzcG9uc2UgZnJvbSBXZWIgSW5zcGVjdG9yIGNhbiB0YWtlIGEgbG9uZyB0aW1lXG4gIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ3NldENvbm5lY3Rpb25LZXknLCB7fSwgZmFsc2UpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjb25uZWN0ICh0aW1lb3V0ID0gQVBQX0NPTk5FQ1RfVElNRU9VVF9NUykge1xuICB0aGlzLnNldHVwKCk7XG5cbiAgLy8gaW5pdGlhbGl6ZSB0aGUgcnBjIGNsaWVudFxuICB0aGlzLmluaXRScGNDbGllbnQoKTtcblxuICAvLyBsaXN0ZW4gZm9yIGJhc2ljIGRlYnVnZ2VyLWxldmVsIGV2ZW50c1xuICB0aGlzLnJwY0NsaWVudC5vbignX3JwY19yZXBvcnRTZXR1cDonLCBfLm5vb3ApO1xuICB0aGlzLnJwY0NsaWVudC5vbignX3JwY19mb3J3YXJkR2V0TGlzdGluZzonLCB0aGlzLm9uUGFnZUNoYW5nZS5iaW5kKHRoaXMpKTtcbiAgdGhpcy5ycGNDbGllbnQub24oJ19ycGNfcmVwb3J0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0OicsIHRoaXMub25Db25uZWN0ZWRBcHBsaWNhdGlvbkxpc3QuYmluZCh0aGlzKSk7XG4gIHRoaXMucnBjQ2xpZW50Lm9uKCdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicsIHRoaXMub25BcHBDb25uZWN0LmJpbmQodGhpcykpO1xuICB0aGlzLnJwY0NsaWVudC5vbignX3JwY19hcHBsaWNhdGlvbkRpc2Nvbm5lY3RlZDonLCB0aGlzLm9uQXBwRGlzY29ubmVjdC5iaW5kKHRoaXMpKTtcbiAgdGhpcy5ycGNDbGllbnQub24oJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOicsIHRoaXMub25BcHBVcGRhdGUuYmluZCh0aGlzKSk7XG4gIHRoaXMucnBjQ2xpZW50Lm9uKCdfcnBjX3JlcG9ydENvbm5lY3RlZERyaXZlckxpc3Q6JywgdGhpcy5vbkNvbm5lY3RlZERyaXZlckxpc3QuYmluZCh0aGlzKSk7XG4gIHRoaXMucnBjQ2xpZW50Lm9uKCdfcnBjX3JlcG9ydEN1cnJlbnRTdGF0ZTonLCB0aGlzLm9uQ3VycmVudFN0YXRlLmJpbmQodGhpcykpO1xuICB0aGlzLnJwY0NsaWVudC5vbignUGFnZS5mcmFtZURldGFjaGVkJywgdGhpcy5mcmFtZURldGFjaGVkLmJpbmQodGhpcykpO1xuXG4gIGF3YWl0IHRoaXMucnBjQ2xpZW50LmNvbm5lY3QoKTtcblxuICAvLyBnZXQgdGhlIGNvbm5lY3Rpb24gaW5mb3JtYXRpb24gYWJvdXQgdGhlIGFwcFxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc2V0Q29ubmVjdGlvbktleSgpO1xuICAgIGlmICh0aW1lb3V0KSB7XG4gICAgICBsb2cuZGVidWcoYFdhaXRpbmcgdXAgdG8gJHt0aW1lb3V0fW1zIGZvciBhcHBsaWNhdGlvbnMgdG8gYmUgcmVwb3J0ZWRgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oKCkgPT4gIV8uaXNFbXB0eSh0aGlzLmFwcERpY3QpLCB7XG4gICAgICAgICAgd2FpdE1zOiB0aW1lb3V0LFxuICAgICAgICAgIGludGVydmFsOiBBUFBfQ09OTkVDVF9JTlRFUlZBTF9NUyxcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBUaW1lZCBvdXQgd2FpdGluZyBmb3IgYXBwbGljYXRpb25zIHRvIGJlIHJlcG9ydGVkYCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmFwcERpY3QgfHwge307XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvcihgRXJyb3Igc2V0dGluZyBjb25uZWN0aW9uIGtleTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICBhd2FpdCB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZGlzY29ubmVjdCAoKSB7XG4gIGlmICh0aGlzLnJwY0NsaWVudCkge1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LmRpc2Nvbm5lY3QoKTtcbiAgfVxuICB0aGlzLmVtaXQoZXZlbnRzLkVWRU5UX0RJU0NPTk5FQ1QsIHRydWUpO1xuICB0aGlzLnRlYXJkb3duKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlbGVjdEFwcCAoY3VycmVudFVybCA9IG51bGwsIG1heFRyaWVzID0gU0VMRUNUX0FQUF9SRVRSSUVTLCBpZ25vcmVBYm91dEJsYW5rVXJsID0gZmFsc2UpIHtcbiAgY29uc3Qgc2hvdWxkQ2hlY2tGb3JUYXJnZXQgPSB0aGlzLnJwY0NsaWVudC5zaG91bGRDaGVja0ZvclRhcmdldDtcbiAgdGhpcy5ycGNDbGllbnQuc2hvdWxkQ2hlY2tGb3JUYXJnZXQgPSBmYWxzZTtcbiAgdHJ5IHtcbiAgICBjb25zdCB0aW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICAgIGxvZy5kZWJ1ZygnU2VsZWN0aW5nIGFwcGxpY2F0aW9uJyk7XG4gICAgaWYgKCF0aGlzLmFwcERpY3QgfHwgXy5pc0VtcHR5KHRoaXMuYXBwRGljdCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm8gYXBwbGljYXRpb25zIGN1cnJlbnRseSBjb25uZWN0ZWQuJyk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3Qge2FwcElkS2V5LCBwYWdlRGljdH0gPSBhd2FpdCB0aGlzLnNlYXJjaEZvckFwcChjdXJyZW50VXJsLCBtYXhUcmllcywgaWdub3JlQWJvdXRCbGFua1VybCk7XG5cbiAgICAvLyBpZiwgYWZ0ZXIgYWxsIHRoaXMsIHdlIGhhdmUgbm8gZGljdGlvbmFyeSwgd2UgaGF2ZSBmYWlsZWRcbiAgICBpZiAoIWFwcElkS2V5IHx8ICFwYWdlRGljdCkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYENvdWxkIG5vdCBjb25uZWN0IHRvIGEgdmFsaWQgYXBwIGFmdGVyICR7bWF4VHJpZXN9IHRyaWVzLmApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmFwcElkS2V5ICE9PSBhcHBJZEtleSkge1xuICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBhbHRlcmVkIGFwcCBpZCwgdXBkYXRpbmcgZnJvbSAnJHt0aGlzLmFwcElkS2V5fScgdG8gJyR7YXBwSWRLZXl9J2ApO1xuICAgICAgdGhpcy5hcHBJZEtleSA9IGFwcElkS2V5O1xuICAgIH1cblxuICAgIGxvZ0FwcGxpY2F0aW9uRGljdGlvbmFyeSh0aGlzLmFwcERpY3QpO1xuXG4gICAgLy8gdHJhbnNsYXRlIHRoZSBkaWN0aW9uYXJ5IGludG8gYSB1c2VmdWwgZm9ybSwgYW5kIHJldHVybiB0byBzZW5kZXJcbiAgICBjb25zdCBwYWdlQXJyYXkgPSBfLmlzRW1wdHkodGhpcy5hcHBEaWN0W2FwcElkS2V5XS5wYWdlQXJyYXkpXG4gICAgICA/IHBhZ2VBcnJheUZyb21EaWN0KHBhZ2VEaWN0KVxuICAgICAgOiB0aGlzLmFwcERpY3RbYXBwSWRLZXldLnBhZ2VBcnJheTtcbiAgICBsb2cuZGVidWcoYEZpbmFsbHkgc2VsZWN0aW5nIGFwcCAke3RoaXMuYXBwSWRLZXl9OiAke3NpbXBsZVN0cmluZ2lmeShwYWdlQXJyYXkpfWApO1xuXG4gICAgbGV0IGZ1bGxQYWdlQXJyYXkgPSBbXTtcbiAgICBmb3IgKGNvbnN0IFthcHAsIGluZm9dIG9mIF8udG9QYWlycyh0aGlzLmFwcERpY3QpKSB7XG4gICAgICBpZiAoIV8uaXNBcnJheShpbmZvLnBhZ2VBcnJheSkgfHwgIWluZm8uaXNBY3RpdmUpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBjb25zdCBpZCA9IGFwcC5yZXBsYWNlKCdQSUQ6JywgJycpO1xuICAgICAgZm9yIChjb25zdCBwYWdlIG9mIGluZm8ucGFnZUFycmF5KSB7XG4gICAgICAgIGlmICghKGlnbm9yZUFib3V0QmxhbmtVcmwgJiYgcGFnZS51cmwgPT09IEJMQU5LX1BBR0VfVVJMKSkge1xuICAgICAgICAgIGxldCBwYWdlRGljdCA9IF8uY2xvbmUocGFnZSk7XG4gICAgICAgICAgcGFnZURpY3QuaWQgPSBgJHtpZH0uJHtwYWdlRGljdC5pZH1gO1xuICAgICAgICAgIHBhZ2VEaWN0LmJ1bmRsZUlkID0gaW5mby5idW5kbGVJZDtcbiAgICAgICAgICBmdWxsUGFnZUFycmF5LnB1c2gocGFnZURpY3QpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBTZWxlY3RlZCBhcHAgYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgICByZXR1cm4gZnVsbFBhZ2VBcnJheTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLnJwY0NsaWVudC5zaG91bGRDaGVja0ZvclRhcmdldCA9IHNob3VsZENoZWNrRm9yVGFyZ2V0O1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlYXJjaEZvckFwcCAoY3VycmVudFVybCwgbWF4VHJpZXMsIGlnbm9yZUFib3V0QmxhbmtVcmwpIHtcbiAgY29uc3QgYnVuZGxlSWRzID0gdGhpcy5pbmNsdWRlU2FmYXJpICYmICF0aGlzLmlzU2FmYXJpXG4gICAgPyBbdGhpcy5idW5kbGVJZCwgLi4udGhpcy5hZGRpdGlvbmFsQnVuZGxlSWRzLCBTQUZBUklfQlVORExFX0lEXVxuICAgIDogW3RoaXMuYnVuZGxlSWQsIC4uLnRoaXMuYWRkaXRpb25hbEJ1bmRsZUlkc107XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHJldHJ5SW50ZXJ2YWwobWF4VHJpZXMsIFNFTEVDVF9BUFBfUkVUUllfU0xFRVBfTVMsIGFzeW5jIChyZXRyeUNvdW50KSA9PiB7XG4gICAgICBsb2dBcHBsaWNhdGlvbkRpY3Rpb25hcnkodGhpcy5hcHBEaWN0KTtcbiAgICAgIGNvbnN0IHBvc3NpYmxlQXBwSWRzID0gZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMoYnVuZGxlSWRzLCB0aGlzLmFwcERpY3QpO1xuICAgICAgbG9nLmRlYnVnKGBUcnlpbmcgb3V0IHRoZSBwb3NzaWJsZSBhcHAgaWRzOiAke3Bvc3NpYmxlQXBwSWRzLmpvaW4oJywgJyl9ICh0cnkgIyR7cmV0cnlDb3VudCArIDF9IG9mICR7bWF4VHJpZXN9KWApO1xuICAgICAgZm9yIChjb25zdCBhdHRlbXB0ZWRBcHBJZEtleSBvZiBwb3NzaWJsZUFwcElkcykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmICghdGhpcy5hcHBEaWN0W2F0dGVtcHRlZEFwcElkS2V5XS5pc0FjdGl2ZSkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGBTa2lwcGluZyBhcHAgJyR7YXR0ZW1wdGVkQXBwSWRLZXl9JyBiZWNhdXNlIGl0IGlzIG5vdCBhY3RpdmVgKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsb2cuZGVidWcoYEF0dGVtcHRpbmcgYXBwICcke2F0dGVtcHRlZEFwcElkS2V5fSdgKTtcbiAgICAgICAgICBjb25zdCBbYXBwSWRLZXksIHBhZ2VEaWN0XSA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbGVjdEFwcChhdHRlbXB0ZWRBcHBJZEtleSwgdGhpcy5vbkFwcENvbm5lY3QuYmluZCh0aGlzKSk7XG4gICAgICAgICAgLy8gaW4gaU9TIDguMiB0aGUgY29ubmVjdCBsb2dpYyBoYXBwZW5zLCBidXQgd2l0aCBhbiBlbXB0eSBkaWN0aW9uYXJ5XG4gICAgICAgICAgLy8gd2hpY2ggbGVhZHMgdG8gdGhlIHJlbW90ZSBkZWJ1Z2dlciBnZXR0aW5nIGRpc2Nvbm5lY3RlZCwgYW5kIGludG8gYSBsb29wXG4gICAgICAgICAgaWYgKF8uaXNFbXB0eShwYWdlRGljdCkpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnRW1wdHkgcGFnZSBkaWN0aW9uYXJ5IHJlY2VpdmVkLiBUcnlpbmcgYWdhaW4uJyk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBzYXZlIHRoZSBwYWdlIGFycmF5IGZvciB0aGlzIGFwcFxuICAgICAgICAgIHRoaXMuYXBwRGljdFthcHBJZEtleV0ucGFnZUFycmF5ID0gcGFnZUFycmF5RnJvbURpY3QocGFnZURpY3QpO1xuXG4gICAgICAgICAgLy8gaWYgd2UgYXJlIGxvb2tpbmcgZm9yIGEgcGFydGljdWxhciB1cmwsIG1ha2Ugc3VyZSB3ZVxuICAgICAgICAgIC8vIGhhdmUgdGhlIHJpZ2h0IHBhZ2UuIElnbm9yZSBlbXB0eSBvciB1bmRlZmluZWQgdXJscy5cbiAgICAgICAgICAvLyBJZ25vcmUgYWJvdXQ6YmxhbmsgaWYgcmVxdWVzdGVkLlxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuc2VhcmNoRm9yUGFnZSh0aGlzLmFwcERpY3QsIGN1cnJlbnRVcmwsIGlnbm9yZUFib3V0QmxhbmtVcmwpO1xuICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGN1cnJlbnRVcmwpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgYXBwLCBidXQgZXhwZWN0ZWQgdXJsICgnJHtjdXJyZW50VXJsfScpIHdhcyBub3QgZm91bmQuIFRyeWluZyBhZ2Fpbi5gKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCBhcHAsIGJ1dCBubyBtYXRjaCB3YXMgZm91bmQuIFRyeWluZyBhZ2Fpbi4nKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRXJyb3IgY2hlY2tpbmcgYXBwbGljYXRpb246ICcke2Vyci5tZXNzYWdlfScuIFJldHJ5aW5nIGNvbm5lY3Rpb25gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0cnlDb3VudCsrO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gZmluZCBhbiBhcHAgdG8gc2VsZWN0Jyk7XG4gICAgfSwgMCk7XG4gIH0gY2F0Y2ggKGlnbikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgY29ubmVjdCB0byBhIHZhbGlkIGFwcCBhZnRlciAke21heFRyaWVzfSB0cmllcy5gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzZWFyY2hGb3JQYWdlIChhcHBzRGljdCwgY3VycmVudFVybCA9IG51bGwsIGlnbm9yZUFib3V0QmxhbmtVcmwgPSBmYWxzZSkge1xuICBmb3IgKGNvbnN0IGFwcERpY3Qgb2YgXy52YWx1ZXMoYXBwc0RpY3QpKSB7XG4gICAgaWYgKCFhcHBEaWN0IHx8ICFhcHBEaWN0LmlzQWN0aXZlIHx8ICFhcHBEaWN0LnBhZ2VBcnJheSB8fCBhcHBEaWN0LnBhZ2VBcnJheS5wcm9taXNlKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGRpY3Qgb2YgYXBwRGljdC5wYWdlQXJyYXkpIHtcbiAgICAgIGlmICgoIWlnbm9yZUFib3V0QmxhbmtVcmwgfHwgZGljdC51cmwgIT09IEJMQU5LX1BBR0VfVVJMKSAmJlxuICAgICAgICAgICghY3VycmVudFVybCB8fCBkaWN0LnVybCA9PT0gY3VycmVudFVybCB8fCBkaWN0LnVybCA9PT0gYCR7Y3VycmVudFVybH0vYCkpIHtcbiAgICAgICAgcmV0dXJuIHsgYXBwSWRLZXk6IGFwcERpY3QuaWQsIHBhZ2VEaWN0OiBkaWN0IH07XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZWxlY3RQYWdlIChhcHBJZEtleSwgcGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayA9IGZhbHNlKSB7XG4gIHRoaXMuYXBwSWRLZXkgPSBgUElEOiR7YXBwSWRLZXl9YDtcbiAgdGhpcy5wYWdlSWRLZXkgPSBwYWdlSWRLZXk7XG5cbiAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgcGFnZSAnJHtwYWdlSWRLZXl9JyBvbiBhcHAgJyR7dGhpcy5hcHBJZEtleX0nIGFuZCBmb3J3YXJkaW5nIHNvY2tldCBzZXR1cGApO1xuXG4gIGNvbnN0IHRpbWVyID0gbmV3IHRpbWluZy5UaW1lcigpLnN0YXJ0KCk7XG5cbiAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VsZWN0UGFnZSh0aGlzLmFwcElkS2V5LCBwYWdlSWRLZXkpO1xuXG4gIC8vIG1ha2Ugc3VyZSBldmVyeXRoaW5nIGlzIHJlYWR5IHRvIGdvXG4gIGlmICghc2tpcFJlYWR5Q2hlY2sgJiYgIWF3YWl0IHRoaXMuY2hlY2tQYWdlSXNSZWFkeSgpKSB7XG4gICAgYXdhaXQgdGhpcy5wYWdlVW5sb2FkKCk7XG4gIH1cblxuICBsb2cuZGVidWcoYFNlbGVjdGVkIHBhZ2UgYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbn1cblxuZnVuY3Rpb24gbG9nQXBwbGljYXRpb25EaWN0aW9uYXJ5IChhcHBzKSB7XG4gIGZ1bmN0aW9uIGdldFZhbHVlU3RyaW5nIChrZXksIHZhbHVlKSB7XG4gICAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHtcbiAgICAgIHJldHVybiAnW0Z1bmN0aW9uXSc7XG4gICAgfVxuICAgIGlmIChrZXkgPT09ICdwYWdlQXJyYXknICYmICFfLmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICByZXR1cm4gYFwiV2FpdGluZyBmb3IgZGF0YVwiYDtcbiAgICB9XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbiAgfVxuICBsb2cuZGVidWcoJ0N1cnJlbnQgYXBwbGljYXRpb25zIGF2YWlsYWJsZTonKTtcbiAgZm9yIChjb25zdCBbYXBwLCBpbmZvXSBvZiBfLnRvUGFpcnMoYXBwcykpIHtcbiAgICBsb2cuZGVidWcoYCAgICBBcHBsaWNhdGlvbjogXCIke2FwcH1cImApO1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIF8udG9QYWlycyhpbmZvKSkge1xuICAgICAgaWYgKGtleSA9PT0gJ3BhZ2VBcnJheScgJiYgQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgICAgICAgICAke2tleX06YCk7XG4gICAgICAgIGZvciAoY29uc3QgcGFnZSBvZiB2YWx1ZSkge1xuICAgICAgICAgIGxldCBwcmVmaXggPSAnLSAnO1xuICAgICAgICAgIGZvciAoY29uc3QgW2ssIHZdIG9mIF8udG9QYWlycyhwYWdlKSkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGAgICAgICAgICAgJHtwcmVmaXh9JHtrfTogJHtKU09OLnN0cmluZ2lmeSh2KX1gKTtcbiAgICAgICAgICAgIHByZWZpeCA9ICcgICc7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCB2YWx1ZVN0cmluZyA9IGdldFZhbHVlU3RyaW5nKGtleSwgdmFsdWUpO1xuICAgICAgICBsb2cuZGVidWcoYCAgICAgICAgJHtrZXl9OiAke3ZhbHVlU3RyaW5nfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB1cGRhdGVBcHBzV2l0aERpY3QgKGRpY3QpIHtcbiAgLy8gZ2V0IHRoZSBkaWN0aW9uYXJ5IGVudHJ5IGludG8gYSBuaWNlIGZvcm0sIGFuZCBhZGQgaXQgdG8gdGhlXG4gIC8vIGFwcGxpY2F0aW9uIGRpY3Rpb25hcnlcbiAgdGhpcy5hcHBEaWN0ID0gdGhpcy5hcHBEaWN0IHx8IHt9O1xuICBsZXQgW2lkLCBlbnRyeV0gPSBhcHBJbmZvRnJvbURpY3QoZGljdCk7XG4gIGlmICh0aGlzLmFwcERpY3RbaWRdKSB7XG4gICAgLy8gcHJlc2VydmUgdGhlIHBhZ2UgZGljdGlvbmFyeSBmb3IgdGhpcyBlbnRyeVxuICAgIGVudHJ5LnBhZ2VBcnJheSA9IHRoaXMuYXBwRGljdFtpZF0ucGFnZUFycmF5O1xuICB9XG4gIHRoaXMuYXBwRGljdFtpZF0gPSBlbnRyeTtcblxuICAvLyBhZGQgYSBwcm9taXNlIHRvIGdldCB0aGUgcGFnZSBkaWN0aW9uYXJ5XG4gIGlmIChfLmlzVW5kZWZpbmVkKGVudHJ5LnBhZ2VBcnJheSkpIHtcbiAgICBlbnRyeS5wYWdlQXJyYXkgPSBkZWZlcnJlZFByb21pc2UoKTtcbiAgfVxuXG4gIC8vIHRyeSB0byBnZXQgdGhlIGFwcCBpZCBmcm9tIG91ciBjb25uZWN0ZWQgYXBwc1xuICBpZiAoIXRoaXMuYXBwSWRLZXkpIHtcbiAgICB0aGlzLmFwcElkS2V5ID0gZ2V0RGVidWdnZXJBcHBLZXkodGhpcy5idW5kbGVJZCwgdGhpcy5hcHBEaWN0KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCB7IHNldENvbm5lY3Rpb25LZXksIGNvbm5lY3QsIGRpc2Nvbm5lY3QsIHNlbGVjdEFwcCwgc2VhcmNoRm9yQXBwLCBzZWFyY2hGb3JQYWdlLCBzZWxlY3RQYWdlLCB1cGRhdGVBcHBzV2l0aERpY3QgfTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFHQSxNQUFNQSxzQkFBc0IsR0FBRyxDQUFDO0FBQ2hDLE1BQU1DLHVCQUF1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