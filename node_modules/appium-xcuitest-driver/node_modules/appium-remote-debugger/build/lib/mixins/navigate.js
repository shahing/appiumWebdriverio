"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger"));
var _utils = require("../utils");
var _events = _interopRequireDefault(require("./events"));
var _support = require("@appium/support");
var _lodash = _interopRequireDefault(require("lodash"));
var _bluebird = _interopRequireDefault(require("bluebird"));
function frameDetached() {
  this.emit(_events.default.EVENT_FRAMES_DETACHED);
}
async function pageLoad(startPageLoadTimer, pageLoadVerifyHook = _lodash.default.noop) {
  var _startPageLoadTimer;
  const timeoutMs = 500;
  if (!_lodash.default.isFunction((_startPageLoadTimer = startPageLoadTimer) === null || _startPageLoadTimer === void 0 ? void 0 : _startPageLoadTimer.getDuration)) {
    _logger.default.debug(`Page load timer not a timer. Creating new timer`);
    startPageLoadTimer = new _support.timing.Timer().start();
  }
  _logger.default.debug('Page loaded, verifying whether ready');
  this.pageLoading = true;
  const verify = async () => {
    this.pageLoadDelay = _support.util.cancellableDelay(timeoutMs);
    try {
      await this.pageLoadDelay;
    } catch (err) {
      if (err instanceof _bluebird.default.CancellationError) {
        return;
      }
    }
    if (!this.appIdKey) {
      _logger.default.debug('Not connected to an application. Ignoring page load');
      return;
    }
    if (_lodash.default.isFunction(pageLoadVerifyHook)) {
      await pageLoadVerifyHook();
    }
    const elapsedMs = startPageLoadTimer.getDuration().asMilliSeconds;
    if ((await this.checkPageIsReady()) || this.pageLoadMs > 0 && elapsedMs > this.pageLoadMs) {
      _logger.default.debug('Page is ready');
      this.pageLoading = false;
    } else {
      _logger.default.debug('Page was not ready, retrying');
      await verify();
    }
  };
  try {
    await verify();
  } finally {
    _logger.default.debug(`Page load completed in ${startPageLoadTimer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    this.pageLoading = false;
  }
}
function cancelPageLoad() {
  _logger.default.debug('Unregistering from page readiness notifications');
  this.pageLoading = false;
  if (this.pageLoadDelay) {
    this.pageLoadDelay.cancel();
  }
}
async function pageUnload() {
  _logger.default.debug('Page unloading');
  await this.waitForDom();
}
async function waitForDom(startPageLoadTimer, pageLoadVerifyHook) {
  _logger.default.debug('Waiting for dom...');
  await this.pageLoad(startPageLoadTimer, pageLoadVerifyHook);
}
async function checkPageIsReady() {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey
  });
  _logger.default.debug('Checking document readyState');
  const readyCmd = 'document.readyState;';
  let readyState = 'loading';
  try {
    readyState = await _bluebird.default.resolve(this.execute(readyCmd, true)).timeout(this.pageReadyTimeout);
  } catch (err) {
    if (!(err instanceof _bluebird.default.TimeoutError)) {
      throw err;
    }
    _logger.default.debug(`Page readiness check timed out after ${this.pageReadyTimeout}ms`);
    return false;
  }
  _logger.default.debug(`Document readyState is '${readyState}'`);
  return readyState === 'complete';
}
async function navToUrl(url, pageLoadVerifyHook) {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  this._navigatingToPage = true;
  try {
    _logger.default.debug(`Navigating to new URL: '${url}'`);
    const waitForFramePromise = this.waitForFrameNavigated();
    await this.rpcClient.send('Page.navigate', {
      url,
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
    if (!this.useNewSafari) {
      await _bluebird.default.delay(1000);
    }
    await waitForFramePromise;
    await this.waitForDom(new _support.timing.Timer().start(), pageLoadVerifyHook);
    await this.rpcClient.send('Console.enable', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
  } finally {
    this._navigatingToPage = false;
  }
}
async function waitForFrameNavigated() {
  let navEventListener;
  return await new _bluebird.default(async resolve => {
    _logger.default.debug('Waiting for frame navigated message...');
    const start = new _support.timing.Timer().start();
    navEventListener = (err, value) => {
      _logger.default.debug(`Frame navigated in ${start.getDuration().asMilliSeconds.toFixed(0)}ms from: ${value}`);
      if (!this.allowNavigationWithoutReload && !this.pageLoading) {
        resolve(value);
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');
        this.allowNavigationWithoutReload = false;
      }
      if (this.navigationDelay) {
        this.navigationDelay.cancel();
      }
    };
    this.rpcClient.once('Page.frameNavigated', navEventListener);
    if (!this.useNewSafari || this.pageLoadMs >= 0) {
      const timeout = this.useNewSafari ? this.pageLoadMs : 500;
      this.navigationDelay = _support.util.cancellableDelay(timeout);
      try {
        await this.navigationDelay;
        navEventListener(null, `${timeout}ms timeout`);
      } catch (err) {}
    }
  }).finally(() => {
    if (navEventListener) {
      this.rpcClient.off('Page.frameNavigated', navEventListener);
    }
  });
}
var _default = {
  frameDetached,
  pageLoad,
  cancelPageLoad,
  pageUnload,
  waitForDom,
  checkPageIsReady,
  navToUrl,
  waitForFrameNavigated
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcmFtZURldGFjaGVkIiwiZW1pdCIsImV2ZW50cyIsIkVWRU5UX0ZSQU1FU19ERVRBQ0hFRCIsInBhZ2VMb2FkIiwic3RhcnRQYWdlTG9hZFRpbWVyIiwicGFnZUxvYWRWZXJpZnlIb29rIiwiXyIsIm5vb3AiLCJ0aW1lb3V0TXMiLCJpc0Z1bmN0aW9uIiwiZ2V0RHVyYXRpb24iLCJsb2ciLCJkZWJ1ZyIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJwYWdlTG9hZGluZyIsInZlcmlmeSIsInBhZ2VMb2FkRGVsYXkiLCJ1dGlsIiwiY2FuY2VsbGFibGVEZWxheSIsImVyciIsIkIiLCJDYW5jZWxsYXRpb25FcnJvciIsImFwcElkS2V5IiwiZWxhcHNlZE1zIiwiYXNNaWxsaVNlY29uZHMiLCJjaGVja1BhZ2VJc1JlYWR5IiwicGFnZUxvYWRNcyIsInRvRml4ZWQiLCJjYW5jZWxQYWdlTG9hZCIsImNhbmNlbCIsInBhZ2VVbmxvYWQiLCJ3YWl0Rm9yRG9tIiwiY2hlY2tQYXJhbXMiLCJyZWFkeUNtZCIsInJlYWR5U3RhdGUiLCJyZXNvbHZlIiwiZXhlY3V0ZSIsInRpbWVvdXQiLCJwYWdlUmVhZHlUaW1lb3V0IiwiVGltZW91dEVycm9yIiwibmF2VG9VcmwiLCJ1cmwiLCJwYWdlSWRLZXkiLCJfbmF2aWdhdGluZ1RvUGFnZSIsIndhaXRGb3JGcmFtZVByb21pc2UiLCJ3YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQiLCJycGNDbGllbnQiLCJzZW5kIiwidXNlTmV3U2FmYXJpIiwiZGVsYXkiLCJuYXZFdmVudExpc3RlbmVyIiwidmFsdWUiLCJhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIiwibmF2aWdhdGlvbkRlbGF5Iiwib25jZSIsImZpbmFsbHkiLCJvZmYiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvbWl4aW5zL25hdmlnYXRlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGNoZWNrUGFyYW1zIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICcuL2V2ZW50cyc7XG5pbXBvcnQgeyB0aW1pbmcsIHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5mdW5jdGlvbiBmcmFtZURldGFjaGVkICgpIHtcbiAgdGhpcy5lbWl0KGV2ZW50cy5FVkVOVF9GUkFNRVNfREVUQUNIRUQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwYWdlTG9hZCAoc3RhcnRQYWdlTG9hZFRpbWVyLCBwYWdlTG9hZFZlcmlmeUhvb2sgPSBfLm5vb3ApIHtcbiAgY29uc3QgdGltZW91dE1zID0gNTAwO1xuICBpZiAoIV8uaXNGdW5jdGlvbihzdGFydFBhZ2VMb2FkVGltZXI/LmdldER1cmF0aW9uKSkge1xuICAgIGxvZy5kZWJ1ZyhgUGFnZSBsb2FkIHRpbWVyIG5vdCBhIHRpbWVyLiBDcmVhdGluZyBuZXcgdGltZXJgKTtcbiAgICBzdGFydFBhZ2VMb2FkVGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnUGFnZSBsb2FkZWQsIHZlcmlmeWluZyB3aGV0aGVyIHJlYWR5Jyk7XG4gIHRoaXMucGFnZUxvYWRpbmcgPSB0cnVlO1xuXG4gIGNvbnN0IHZlcmlmeSA9IGFzeW5jICgpID0+IHtcbiAgICB0aGlzLnBhZ2VMb2FkRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dE1zKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5wYWdlTG9hZERlbGF5O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIEIuQ2FuY2VsbGF0aW9uRXJyb3IpIHtcbiAgICAgICAgLy8gaWYgdGhlIHByb21pc2UgaGFzIGJlZW4gY2FuY2VsbGVkXG4gICAgICAgIC8vIHdlIHdhbnQgdG8gc2tpcCBjaGVja2luZyB0aGUgcmVhZGluZXNzXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB3ZSBjYW4gZ2V0IHRoaXMgY2FsbGVkIGluIHRoZSBtaWRkbGUgb2YgdHJ5aW5nIHRvIGZpbmQgYSBuZXcgYXBwXG4gICAgaWYgKCF0aGlzLmFwcElkS2V5KSB7XG4gICAgICBsb2cuZGVidWcoJ05vdCBjb25uZWN0ZWQgdG8gYW4gYXBwbGljYXRpb24uIElnbm9yaW5nIHBhZ2UgbG9hZCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChfLmlzRnVuY3Rpb24ocGFnZUxvYWRWZXJpZnlIb29rKSkge1xuICAgICAgYXdhaXQgcGFnZUxvYWRWZXJpZnlIb29rKCk7XG4gICAgfVxuXG4gICAgLy8gaWYgd2UgYXJlIHJlYWR5LCBvciB3ZSd2ZSBzcGVuZCB0b28gbXVjaCB0aW1lIG9uIHRoaXNcbiAgICBjb25zdCBlbGFwc2VkTXMgPSBzdGFydFBhZ2VMb2FkVGltZXIuZ2V0RHVyYXRpb24oKS5hc01pbGxpU2Vjb25kcztcbiAgICBpZiAoYXdhaXQgdGhpcy5jaGVja1BhZ2VJc1JlYWR5KCkgfHwgKHRoaXMucGFnZUxvYWRNcyA+IDAgJiYgZWxhcHNlZE1zID4gdGhpcy5wYWdlTG9hZE1zKSkge1xuICAgICAgbG9nLmRlYnVnKCdQYWdlIGlzIHJlYWR5Jyk7XG4gICAgICB0aGlzLnBhZ2VMb2FkaW5nID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnUGFnZSB3YXMgbm90IHJlYWR5LCByZXRyeWluZycpO1xuICAgICAgYXdhaXQgdmVyaWZ5KCk7XG4gICAgfVxuICB9O1xuICB0cnkge1xuICAgIGF3YWl0IHZlcmlmeSgpO1xuICB9IGZpbmFsbHkge1xuICAgIGxvZy5kZWJ1ZyhgUGFnZSBsb2FkIGNvbXBsZXRlZCBpbiAke3N0YXJ0UGFnZUxvYWRUaW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgICB0aGlzLnBhZ2VMb2FkaW5nID0gZmFsc2U7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2FuY2VsUGFnZUxvYWQgKCkge1xuICBsb2cuZGVidWcoJ1VucmVnaXN0ZXJpbmcgZnJvbSBwYWdlIHJlYWRpbmVzcyBub3RpZmljYXRpb25zJyk7XG4gIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgaWYgKHRoaXMucGFnZUxvYWREZWxheSkge1xuICAgIHRoaXMucGFnZUxvYWREZWxheS5jYW5jZWwoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBwYWdlVW5sb2FkICgpIHtcbiAgbG9nLmRlYnVnKCdQYWdlIHVubG9hZGluZycpO1xuICBhd2FpdCB0aGlzLndhaXRGb3JEb20oKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvckRvbSAoc3RhcnRQYWdlTG9hZFRpbWVyLCBwYWdlTG9hZFZlcmlmeUhvb2spIHtcbiAgbG9nLmRlYnVnKCdXYWl0aW5nIGZvciBkb20uLi4nKTtcbiAgYXdhaXQgdGhpcy5wYWdlTG9hZChzdGFydFBhZ2VMb2FkVGltZXIsIHBhZ2VMb2FkVmVyaWZ5SG9vayk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrUGFnZUlzUmVhZHkgKCkge1xuICBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXl9KTtcblxuICBsb2cuZGVidWcoJ0NoZWNraW5nIGRvY3VtZW50IHJlYWR5U3RhdGUnKTtcbiAgY29uc3QgcmVhZHlDbWQgPSAnZG9jdW1lbnQucmVhZHlTdGF0ZTsnO1xuICBsZXQgcmVhZHlTdGF0ZSA9ICdsb2FkaW5nJztcbiAgdHJ5IHtcbiAgICByZWFkeVN0YXRlID0gYXdhaXQgQi5yZXNvbHZlKHRoaXMuZXhlY3V0ZShyZWFkeUNtZCwgdHJ1ZSkpLnRpbWVvdXQodGhpcy5wYWdlUmVhZHlUaW1lb3V0KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCEoZXJyIGluc3RhbmNlb2YgQi5UaW1lb3V0RXJyb3IpKSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgUGFnZSByZWFkaW5lc3MgY2hlY2sgdGltZWQgb3V0IGFmdGVyICR7dGhpcy5wYWdlUmVhZHlUaW1lb3V0fW1zYCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGxvZy5kZWJ1ZyhgRG9jdW1lbnQgcmVhZHlTdGF0ZSBpcyAnJHtyZWFkeVN0YXRlfSdgKTtcblxuICByZXR1cm4gcmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJztcbn1cblxuYXN5bmMgZnVuY3Rpb24gbmF2VG9VcmwgKHVybCwgcGFnZUxvYWRWZXJpZnlIb29rKSB7XG4gIGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleSwgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleX0pO1xuXG4gIHRoaXMuX25hdmlnYXRpbmdUb1BhZ2UgPSB0cnVlO1xuXG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBOYXZpZ2F0aW5nIHRvIG5ldyBVUkw6ICcke3VybH0nYCk7XG5cbiAgICAvLyBiZWdpbiBsaXN0ZW5pbmcgZm9yIGZyYW1lIG5hdmlnYXRpb24gZXZlbnQsIHdoaWNoIHdpbGwgYmUgd2FpdGVkIGZvciBsYXRlclxuICAgIGNvbnN0IHdhaXRGb3JGcmFtZVByb21pc2UgPSB0aGlzLndhaXRGb3JGcmFtZU5hdmlnYXRlZCgpO1xuXG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnUGFnZS5uYXZpZ2F0ZScsIHtcbiAgICAgIHVybCxcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICB9KTtcblxuICAgIGlmICghdGhpcy51c2VOZXdTYWZhcmkpIHtcbiAgICAgIC8vIGEgc21hbGwgcGF1c2UgZm9yIHRoZSBicm93c2VyIHRvIGNhdGNoIHVwXG4gICAgICBhd2FpdCBCLmRlbGF5KDEwMDApO1xuICAgIH1cblxuICAgIC8vIHdhaXQgdW50aWwgdGhlIHBhZ2UgaGFzIGJlZW4gbmF2aWdhdGVkXG4gICAgYXdhaXQgd2FpdEZvckZyYW1lUHJvbWlzZTtcblxuICAgIGF3YWl0IHRoaXMud2FpdEZvckRvbShuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKSwgcGFnZUxvYWRWZXJpZnlIb29rKTtcblxuICAgIC8vIGVuYWJsZSBjb25zb2xlIGxvZ2dpbmcsIHNvIHdlIGdldCB0aGUgZXZlbnRzIChvdGhlcndpc2Ugd2Ugb25seVxuICAgIC8vIGdldCBub3RpZmllZCB3aGVuIG5hdmlnYXRpbmcgdG8gYSBsb2NhbCBwYWdlXG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnQ29uc29sZS5lbmFibGUnLCB7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgfSk7XG4gIH0gZmluYWxseSB7XG4gICAgdGhpcy5fbmF2aWdhdGluZ1RvUGFnZSA9IGZhbHNlO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdhaXRGb3JGcmFtZU5hdmlnYXRlZCAoKSB7XG4gIGxldCBuYXZFdmVudExpc3RlbmVyO1xuICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKHJlc29sdmUpID0+IHtcbiAgICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGZyYW1lIG5hdmlnYXRlZCBtZXNzYWdlLi4uJyk7XG4gICAgY29uc3Qgc3RhcnQgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcblxuICAgIC8vIGFkZCBhIGhhbmRsZXIgZm9yIHRoZSBgUGFnZS5mcmFtZU5hdmlnYXRlZGAgbWVzc2FnZVxuICAgIC8vIGZyb20gdGhlIHJlbW90ZSBkZWJ1Z2dlclxuICAgIG5hdkV2ZW50TGlzdGVuZXIgPSAoZXJyLCB2YWx1ZSkgPT4ge1xuICAgICAgbG9nLmRlYnVnKGBGcmFtZSBuYXZpZ2F0ZWQgaW4gJHtzdGFydC5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXMgZnJvbTogJHt2YWx1ZX1gKTtcbiAgICAgIGlmICghdGhpcy5hbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkICYmICF0aGlzLnBhZ2VMb2FkaW5nKSB7XG4gICAgICAgIHJlc29sdmUodmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKCdGcmFtZSBuYXZpZ2F0ZWQgYnV0IHdlIHdlcmUgd2FybmVkIGFib3V0IGl0LCBub3QgJyArXG4gICAgICAgICAgICAgICAgICAnY29uc2lkZXJpbmcgcGFnZSBzdGF0ZSB1bmxvYWRlZCcpO1xuICAgICAgICB0aGlzLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLm5hdmlnYXRpb25EZWxheSkge1xuICAgICAgICB0aGlzLm5hdmlnYXRpb25EZWxheS5jYW5jZWwoKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5ycGNDbGllbnQub25jZSgnUGFnZS5mcmFtZU5hdmlnYXRlZCcsIG5hdkV2ZW50TGlzdGVuZXIpO1xuXG4gICAgLy8gdGltZW91dCwgaW4gY2FzZSByZW1vdGUgZGVidWdnZXIgZG9lc24ndCByZXNwb25kLFxuICAgIC8vIG9yIHRha2VzIGEgbG9uZyB0aW1lXG4gICAgaWYgKCF0aGlzLnVzZU5ld1NhZmFyaSB8fCB0aGlzLnBhZ2VMb2FkTXMgPj0gMCkge1xuICAgICAgLy8gdXNlIHBhZ2VMb2FkTXMsIG9yIGEgc21hbGwgYW1vdW50IG9mIHRpbWVcbiAgICAgIGNvbnN0IHRpbWVvdXQgPSB0aGlzLnVzZU5ld1NhZmFyaSA/IHRoaXMucGFnZUxvYWRNcyA6IDUwMDtcbiAgICAgIHRoaXMubmF2aWdhdGlvbkRlbGF5ID0gdXRpbC5jYW5jZWxsYWJsZURlbGF5KHRpbWVvdXQpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5uYXZpZ2F0aW9uRGVsYXk7XG4gICAgICAgIG5hdkV2ZW50TGlzdGVuZXIobnVsbCwgYCR7dGltZW91dH1tcyB0aW1lb3V0YCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gbm90aGluZyB0byBkbzogd2Ugb25seSBnZXQgaGVyZSBpZiB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgICAgIC8vIGFscmVhZHkgbm90aWZpZWQgb2YgZnJhbWUgbmF2aWdhdGlvbiwgYW5kIHRoZSBkZWxheVxuICAgICAgICAvLyB3YXMgY2FuY2VsbGVkXG4gICAgICB9XG4gICAgfVxuICB9KS5maW5hbGx5KCgpID0+IHtcbiAgICBpZiAobmF2RXZlbnRMaXN0ZW5lcikge1xuICAgICAgdGhpcy5ycGNDbGllbnQub2ZmKCdQYWdlLmZyYW1lTmF2aWdhdGVkJywgbmF2RXZlbnRMaXN0ZW5lcik7XG4gICAgfVxuICB9KTtcbn1cblxuXG5leHBvcnQgZGVmYXVsdCB7IGZyYW1lRGV0YWNoZWQsIHBhZ2VMb2FkLCBjYW5jZWxQYWdlTG9hZCwgcGFnZVVubG9hZCwgd2FpdEZvckRvbSwgY2hlY2tQYWdlSXNSZWFkeSwgbmF2VG9VcmwsIHdhaXRGb3JGcmFtZU5hdmlnYXRlZCB9O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUdBLFNBQVNBLGFBQWEsR0FBSTtFQUN4QixJQUFJLENBQUNDLElBQUksQ0FBQ0MsZUFBTSxDQUFDQyxxQkFBcUIsQ0FBQztBQUN6QztBQUVBLGVBQWVDLFFBQVEsQ0FBRUMsa0JBQWtCLEVBQUVDLGtCQUFrQixHQUFHQyxlQUFDLENBQUNDLElBQUksRUFBRTtFQUFBO0VBQ3hFLE1BQU1DLFNBQVMsR0FBRyxHQUFHO0VBQ3JCLElBQUksQ0FBQ0YsZUFBQyxDQUFDRyxVQUFVLHdCQUFDTCxrQkFBa0Isd0RBQWxCLG9CQUFvQk0sV0FBVyxDQUFDLEVBQUU7SUFDbERDLGVBQUcsQ0FBQ0MsS0FBSyxDQUFFLGlEQUFnRCxDQUFDO0lBQzVEUixrQkFBa0IsR0FBRyxJQUFJUyxlQUFNLENBQUNDLEtBQUssRUFBRSxDQUFDQyxLQUFLLEVBQUU7RUFDakQ7RUFFQUosZUFBRyxDQUFDQyxLQUFLLENBQUMsc0NBQXNDLENBQUM7RUFDakQsSUFBSSxDQUFDSSxX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