{"version":3,"file":"timeout.js","names":["MIN_TIMEOUT","TimeoutMixin","Base","TimeoutCommands","timeouts","type","ms","script","pageLoad","implicit","util","hasValue","log","debug","JSON","stringify","newCommandTimeout","implicitWaitMJSONWP","pageLoadTimeoutMJSONWP","scriptTimeoutMJSONWP","Error","scriptTimeoutW3C","pageLoadTimeoutW3C","implicitWaitW3C","getTimeouts","command","newCommandTimeoutMs","implicitWaitMs","implicitWait","setImplicitWait","parseTimeoutArgument","errors","NotImplementedError","setNewCommandTimeout","managedDrivers","length","driver","_","isFunction","implicitWaitForCondition","condFn","wrappedCondFn","args","clearNewCommandTimeout","waitForCondition","waitMs","intervalMs","logger","duration","parseInt","isNaN","UnknownError"],"sources":["../../../../lib/basedriver/commands/timeout.js"],"sourcesContent":["// @ts-check\n\n/* eslint-disable no-unused-vars */\n/* eslint-disable require-await */\nimport {waitForCondition} from 'asyncbox';\nimport _ from 'lodash';\nimport {util} from '@appium/support';\nimport {errors} from '../../protocol';\n\nconst MIN_TIMEOUT = 0;\n\n/**\n * @param {import('../driver').BaseDriverBase} Base\n * @returns {TimeoutBase}\n */\nexport function TimeoutMixin(Base) {\n  /**\n   * @implements {ITimeoutCommands}\n   */\n  class TimeoutCommands extends Base {\n    async timeouts(type, ms, script, pageLoad, implicit) {\n      if (util.hasValue(type) && util.hasValue(ms)) {\n        this.log.debug(`MJSONWP timeout arguments: ${JSON.stringify({type, ms})}}`);\n\n        switch (type) {\n          case 'command':\n            await this.newCommandTimeout(ms);\n            return;\n          case 'implicit':\n            await this.implicitWaitMJSONWP(ms);\n            return;\n          case 'page load':\n            await this.pageLoadTimeoutMJSONWP(ms);\n            return;\n          case 'script':\n            await this.scriptTimeoutMJSONWP(ms);\n            return;\n          default:\n            throw new Error(`'${type}' type is not supported for MJSONWP timeout`);\n        }\n      }\n\n      // Otherwise assume it is W3C protocol\n      this.log.debug(\n        `W3C timeout argument: ${JSON.stringify({\n          script,\n          pageLoad,\n          implicit,\n        })}}`\n      );\n      if (util.hasValue(script)) {\n        await this.scriptTimeoutW3C(script);\n      }\n      if (util.hasValue(pageLoad)) {\n        await this.pageLoadTimeoutW3C(pageLoad);\n      }\n      if (util.hasValue(implicit)) {\n        await this.implicitWaitW3C(implicit);\n      }\n    }\n\n    async getTimeouts() {\n      return {\n        command: this.newCommandTimeoutMs,\n        implicit: this.implicitWaitMs,\n      };\n    }\n\n    // implicit\n    async implicitWaitW3C(ms) {\n      await this.implicitWait(ms);\n    }\n\n    async implicitWaitMJSONWP(ms) {\n      await this.implicitWait(ms);\n    }\n\n    async implicitWait(ms) {\n      await this.setImplicitWait(this.parseTimeoutArgument(ms));\n    }\n\n    // pageLoad\n    async pageLoadTimeoutW3C(ms) {\n      throw new errors.NotImplementedError('Not implemented yet for pageLoad.');\n    }\n\n    async pageLoadTimeoutMJSONWP(ms) {\n      throw new errors.NotImplementedError('Not implemented yet for pageLoad.');\n    }\n\n    // script\n    async scriptTimeoutW3C(ms) {\n      throw new errors.NotImplementedError('Not implemented yet for script.');\n    }\n\n    async scriptTimeoutMJSONWP(ms) {\n      throw new errors.NotImplementedError('Not implemented yet for script.');\n    }\n\n    // command\n    async newCommandTimeout(ms) {\n      this.setNewCommandTimeout(this.parseTimeoutArgument(ms));\n    }\n\n    setImplicitWait(ms) {\n      // eslint-disable-line require-await\n      this.implicitWaitMs = ms;\n      this.log.debug(`Set implicit wait to ${ms}ms`);\n      if (this.managedDrivers && this.managedDrivers.length) {\n        this.log.debug('Setting implicit wait on managed drivers');\n        for (let driver of this.managedDrivers) {\n          if (_.isFunction(driver.setImplicitWait)) {\n            driver.setImplicitWait(ms);\n          }\n        }\n      }\n    }\n\n    setNewCommandTimeout(ms) {\n      this.newCommandTimeoutMs = ms;\n      this.log.debug(`Set new command timeout to ${ms}ms`);\n      if (this.managedDrivers && this.managedDrivers.length) {\n        this.log.debug('Setting new command timeout on managed drivers');\n        for (let driver of this.managedDrivers) {\n          if (_.isFunction(driver.setNewCommandTimeout)) {\n            driver.setNewCommandTimeout(ms);\n          }\n        }\n      }\n    }\n\n    async implicitWaitForCondition(condFn) {\n      this.log.debug(`Waiting up to ${this.implicitWaitMs} ms for condition`);\n      let wrappedCondFn = async (...args) => {\n        // reset command timeout\n        await this.clearNewCommandTimeout();\n\n        return await condFn(...args);\n      };\n      return await waitForCondition(wrappedCondFn, {\n        waitMs: this.implicitWaitMs,\n        intervalMs: 500,\n        logger: this.log,\n      });\n    }\n\n    parseTimeoutArgument(ms) {\n      let duration = parseInt(ms, 10);\n      if (_.isNaN(duration) || duration < MIN_TIMEOUT) {\n        throw new errors.UnknownError(`Invalid timeout value '${ms}'`);\n      }\n      return duration;\n    }\n  }\n\n  return TimeoutCommands;\n}\n\n/**\n * @typedef {import('@appium/types').TimeoutCommands} ITimeoutCommands\n * @typedef {import('../driver').BaseDriverBase<ITimeoutCommands>} TimeoutBase\n */\n"],"mappings":"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"}